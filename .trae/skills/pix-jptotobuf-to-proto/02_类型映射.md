# 02_ç±»å‹æ˜ å°„

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ JProtobuf åˆ°æ ‡å‡† Protobuf çš„ç±»å‹æ˜ å°„è§„åˆ™ï¼ŒåŒ…æ‹¬åŸºæœ¬ç±»å‹ã€å¤æ‚ç±»å‹å’Œç‰¹æ®Šç±»å‹çš„æ˜ å°„ã€‚

## ğŸ”„ åŸºæœ¬ç±»å‹æ˜ å°„

### æ•´æ•°ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `FieldType.UINT64` | `uint64` | `uint64` | `long` | æ— ç¬¦å· 64 ä½æ•´æ•° |
| `FieldType.UINT32` | `uint32` | `uint32` | `int` | æ— ç¬¦å· 32 ä½æ•´æ•° |
| `FieldType.INT64` | `int64` | `int64` | `long` | æœ‰ç¬¦å· 64 ä½æ•´æ•° |
| `FieldType.INT32` | `int32` | `int32` | `int` | æœ‰ç¬¦å· 32 ä½æ•´æ•° |
| `FieldType.SINT64` | `sint64` | `int64` | `long` | ZigZag ç¼–ç çš„ 64 ä½æ•´æ•° |
| `FieldType.SINT32` | `sint32` | `int32` | `int` | ZigZag ç¼–ç çš„ 32 ä½æ•´æ•° |
| `FieldType.FIXED64` | `fixed64` | `uint64` | `long` | å›ºå®šé•¿åº¦çš„ 64 ä½æ•´æ•° |
| `FieldType.FIXED32` | `fixed32` | `uint32` | `int` | å›ºå®šé•¿åº¦çš„ 32 ä½æ•´æ•° |
| `FieldType.SFIXED64` | `sfixed64` | `int64` | `long` | å›ºå®šé•¿åº¦çš„æœ‰ç¬¦å· 64 ä½æ•´æ•° |
| `FieldType.SFIXED32` | `sfixed32` | `int32` | `int` | å›ºå®šé•¿åº¦çš„æœ‰ç¬¦å· 32 ä½æ•´æ•° |

### æµ®ç‚¹ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `FieldType.FLOAT` | `float` | `float32` | `float` | 32 ä½æµ®ç‚¹æ•° |
| `FieldType.DOUBLE` | `double` | `float64` | `double` | 64 ä½æµ®ç‚¹æ•° |

### å­—ç¬¦ä¸²å’Œå­—èŠ‚ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `FieldType.STRING` | `string` | `string` | `String` | UTF-8 å­—ç¬¦ä¸² |
| `FieldType.BYTES` | `bytes` | `[]byte` | `byte[]` | å­—èŠ‚æ•°ç»„ |

### å¸ƒå°”ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `FieldType.BOOL` | `bool` | `bool` | `boolean` | å¸ƒå°”å€¼ |

## ğŸ”„ å¤æ‚ç±»å‹æ˜ å°„

### åˆ—è¡¨ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `List<T>` | `repeated T` | `[]T` | `List<T>` | é‡å¤å­—æ®µ |

**ç¤ºä¾‹**ï¼š
```java
@Protobuf(fieldType = FieldType.OBJECT, order = 1, required = false)
public List<PT_CHANNEL_INFO> channel;
```

```protobuf
repeated ChannelInfo channel = 1;
```

### æ˜ å°„ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `Map<K,V>` | `map<K,V>` | `map[K]V` | `Map<K,V>` | é”®å€¼å¯¹æ˜ å°„ |

**ç¤ºä¾‹**ï¼š
```java
@Protobuf(fieldType = FieldType.OBJECT, order = 1, required = false)
public Map<String, String> metadata;
```

```protobuf
map<string, string> metadata = 1;
```

### åµŒå¥—æ¶ˆæ¯

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| è‡ªå®šä¹‰ç±» | åµŒå¥—æ¶ˆæ¯ | ç»“æ„ä½“ | å†…éƒ¨ç±» | åµŒå¥—æ¶ˆæ¯ç±»å‹ |

**ç¤ºä¾‹**ï¼š
```java
@Protobuf(fieldType = FieldType.OBJECT, order = 1, required = false)
public PT_CHANNEL_INFO channelInfo;
```

```protobuf
message ChannelInfo {
    int32 world = 1;
    int32 channel = 2;
    string ip = 3;
}
```

### æšä¸¾ç±»å‹

| JProtobuf ç±»å‹ | æ ‡å‡† Protobuf ç±»å‹ | Go ç±»å‹ | Java ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `enum` | `enum` | æšä¸¾ | æšä¸¾ | æšä¸¾ç±»å‹ |

**ç¤ºä¾‹**ï¼š
```java
public enum AccountType {
    NORMAL(0),
    VIP(1);
    
    private final int value;
}
```

```protobuf
enum AccountType {
    NORMAL = 0;
    VIP = 1;
}
```

## ğŸ”„ ç‰¹æ®Šç±»å‹æ˜ å°„

### å¯é€‰å­—æ®µ

| JProtobuf | æ ‡å‡† Protobuf | è¯´æ˜ |
| :--- | :--- | :--- |
| `required = false` | é»˜è®¤å¯é€‰ | Proto3 ä¸­æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ |
| `required = true` | æ— å¯¹åº”æ¦‚å¿µ | Proto3 ä¸æ”¯æŒ required å­—æ®µ |

### é»˜è®¤å€¼

| JProtobuf ç±»å‹ | é»˜è®¤å€¼ | æ ‡å‡† Protobuf é»˜è®¤å€¼ |
| :--- | :--- | :--- |
| `int32` | 0 | 0 |
| `int64` | 0 | 0 |
| `uint32` | 0 | 0 |
| `uint64` | 0 | 0 |
| `float` | 0.0 | 0.0 |
| `double` | 0.0 | 0.0 |
| `bool` | false | false |
| `string` | "" | "" |
| `bytes` | null | "" |
| `enum` | ç¬¬ä¸€ä¸ªæšä¸¾å€¼ | ç¬¬ä¸€ä¸ªæšä¸¾å€¼ |

### Oneof ç±»å‹

| JProtobuf | æ ‡å‡† Protobuf | è¯´æ˜ |
| :--- | :--- | :--- |
| ä¸æ”¯æŒ | `oneof` | Proto3 æ”¯æŒä¸€ä¸ªå­—æ®µåªèƒ½è®¾ç½®å…¶ä¸­ä¸€ä¸ªå€¼ |

**ç¤ºä¾‹**ï¼š
```protobuf
oneof result {
    string error_message = 1;
    int32 error_code = 2;
}
```

## ğŸ”„ ç±»å‹è½¬æ¢æ³¨æ„äº‹é¡¹

### 1. æ— ç¬¦å·ç±»å‹

JProtobuf ä¸­çš„ `UINT32` å’Œ `UINT64` åœ¨ Java ä¸­å¯¹åº” `int` å’Œ `long`ï¼Œä½†éœ€è¦æ³¨æ„ï¼š

- Java çš„ `int` å’Œ `long` æ˜¯æœ‰ç¬¦å·çš„
- åœ¨å¤„ç†æ— ç¬¦å·å€¼æ—¶ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä½è¿ç®—
- Go è¯­è¨€åŸç”Ÿæ”¯æŒæ— ç¬¦å·ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨

**ç¤ºä¾‹**ï¼š
```java
// Java: å¤„ç†æ— ç¬¦å· 32 ä½æ•´æ•°
int unsignedValue = -1;  // å®é™…è¡¨ç¤º 0xFFFFFFFF
long unsignedLongValue = unsignedValue & 0xFFFFFFFFL;  // è½¬æ¢ä¸º 4294967295
```

```go
// Go: ç›´æ¥ä½¿ç”¨æ— ç¬¦å·ç±»å‹
var unsignedValue uint32 = 4294967295
```

### 2. æµ®ç‚¹ç²¾åº¦

- `float` æ˜¯ 32 ä½æµ®ç‚¹æ•°ï¼Œç²¾åº¦çº¦ä¸º 7 ä½å°æ•°
- `double` æ˜¯ 64 ä½æµ®ç‚¹æ•°ï¼Œç²¾åº¦çº¦ä¸º 15 ä½å°æ•°
- åœ¨éœ€è¦é«˜ç²¾åº¦è®¡ç®—æ—¶ï¼Œåº”è¯¥ä½¿ç”¨ `double`

### 3. å­—ç¬¦ä¸²ç¼–ç 

- JProtobuf å’Œæ ‡å‡† Protobuf éƒ½ä½¿ç”¨ UTF-8 ç¼–ç 
- åœ¨å¤„ç†é ASCII å­—ç¬¦æ—¶ï¼Œéœ€è¦æ³¨æ„ç¼–ç é—®é¢˜
- Java çš„ `String` é»˜è®¤ä½¿ç”¨ UTF-16ï¼Œåºåˆ—åŒ–æ—¶ä¼šè½¬æ¢ä¸º UTF-8

### 4. å­—èŠ‚åº

- æ ‡å‡† Protobuf ä½¿ç”¨å˜é•¿ç¼–ç ï¼ˆVarintï¼‰
- å¯¹äºå›ºå®šé•¿åº¦ç±»å‹ï¼ˆ`fixed32`, `fixed64`ï¼‰ï¼Œä½¿ç”¨å°ç«¯å­—èŠ‚åº
- åœ¨è·¨è¯­è¨€é€šä¿¡æ—¶ï¼Œç¡®ä¿å­—èŠ‚åºä¸€è‡´

## ğŸ”„ æ˜ å°„ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•æ¶ˆæ¯

**JProtobuf**ï¼š
```java
@MessageMeta(module = 10000, cmd = 0)
public class REQ_LOGIN extends Message {
    @Protobuf(fieldType = FieldType.STRING, order = 1, required = false)
    public String openid;
    
    @Protobuf(fieldType = FieldType.INT32, order = 2, required = false)
    public Integer type;
    
    @Protobuf(fieldType = FieldType.STRING, order = 3, required = false)
    public String token;
}
```

**æ ‡å‡† Protobuf**ï¼š
```protobuf
message LoginRequest {
    string openid = 1;
    int32 type = 2;
    string token = 3;
}
```

### ç¤ºä¾‹ 2: åµŒå¥—æ¶ˆæ¯

**JProtobuf**ï¼š
```java
public class PT_CHANNEL_INFO {
    @Protobuf(fieldType = FieldType.INT32, order = 1, required = false)
    public Integer world;
    
    @Protobuf(fieldType = FieldType.INT32, order = 2, required = false)
    public Integer channel;
    
    @Protobuf(fieldType = FieldType.STRING, order = 3, required = false)
    public String ip;
}

@MessageMeta(module = 10000, cmd = 1)
public class RES_LOGIN extends Message {
    @Protobuf(fieldType = FieldType.OBJECT, order = 9, required = false)
    public List<PT_CHANNEL_INFO> channel;
}
```

**æ ‡å‡† Protobuf**ï¼š
```protobuf
message ChannelInfo {
    int32 world = 1;
    int32 channel = 2;
    string ip = 3;
}

message LoginResponse {
    repeated ChannelInfo channel = 9;
}
```

### ç¤ºä¾‹ 3: æšä¸¾ç±»å‹

**JProtobuf**ï¼š
```java
public enum AccountType {
    NORMAL(0),
    VIP(1),
    ADMIN(2);
    
    private final int value;
    
    AccountType(int value) {
        this.value = value;
    }
    
    public int getValue() {
        return value;
    }
}

@MessageMeta(module = 10001, cmd = 0)
public class REQ_ACCOUNT extends Message {
    @Protobuf(fieldType = FieldType.OBJECT, order = 1, required = false)
    public AccountType accountType;
}
```

**æ ‡å‡† Protobuf**ï¼š
```protobuf
enum AccountType {
    NORMAL = 0;
    VIP = 1;
    ADMIN = 2;
}

message AccountRequest {
    AccountType account_type = 1;
}
```

## ğŸ”„ ç±»å‹è½¬æ¢å·¥å…·

### Java åˆ° Proto è½¬æ¢

```java
public class TypeConverter {
    public static String toProtoType(FieldType fieldType) {
        switch (fieldType) {
            case INT32:
                return "int32";
            case INT64:
                return "int64";
            case UINT32:
                return "uint32";
            case UINT64:
                return "uint64";
            case FLOAT:
                return "float";
            case DOUBLE:
                return "double";
            case BOOL:
                return "bool";
            case STRING:
                return "string";
            case BYTES:
                return "bytes";
            default:
                return "unknown";
        }
    }
}
```

### Go åˆ° Proto è½¬æ¢

```go
package main

func toProtoType(goType string) string {
    switch goType {
    case "int32":
        return "int32"
    case "int64":
        return "int64"
    case "uint32":
        return "uint32"
    case "uint64":
        return "uint64"
    case "float32":
        return "float"
    case "float64":
        return "double"
    case "bool":
        return "bool"
    case "string":
        return "string"
    case "[]byte":
        return "bytes"
    default:
        return "unknown"
    }
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01_è¿ç§»æµç¨‹.md](./01_è¿ç§»æµç¨‹.md) - 7 æ­¥è¿ç§»æµç¨‹è¯¦è§£
- [03_å¸¸è§é—®é¢˜.md](./03_å¸¸è§é—®é¢˜.md) - å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
- [04_åŒæ¨¡å¼ç¼–è§£ç å™¨.md](./04_åŒæ¨¡å¼ç¼–è§£ç å™¨.md) - åŒæ¨¡å¼ç¼–è§£ç å™¨å®ç°
