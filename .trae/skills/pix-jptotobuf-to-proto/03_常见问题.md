# 03_å¸¸è§é—®é¢˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ—å‡ºä» JProtobuf åˆ°æ ‡å‡† Protobuf è¿ç§»è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„å¸¸è§é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

## ğŸ”§ é—®é¢˜åˆ†ç±»

| åˆ†ç±» | é—®é¢˜æ•°é‡ | ä¸¥é‡ç¨‹åº¦ |
| :--- | :--- | :--- |
| ä»£ç ç”Ÿæˆ | 6 | ä¸­ç­‰ |
| ç¼–è¯‘é”™è¯¯ | 5 | é«˜ |
| è¿è¡Œæ—¶é”™è¯¯ | 5 | é«˜ |
| é…ç½®é—®é¢˜ | 2 | ä¸­ç­‰ |
| æ€»è®¡ | 18 | - |

## ğŸ“ ä»£ç ç”Ÿæˆé—®é¢˜

### é—®é¢˜ 1: ç”Ÿæˆæ–‡ä»¶è¿‡å¤š

**é—®é¢˜æè¿°**ï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œ `buf generate` å‘½ä»¤æ—¶ï¼Œç”Ÿæˆäº†å¤§é‡æ–‡ä»¶ï¼Œè¿œè¶…é¢„æœŸã€‚

**åŸå› **ï¼šBuf å·¥å…·é»˜è®¤ä¼šç”Ÿæˆæ‰€æœ‰ proto æ–‡ä»¶çš„ä»£ç ï¼ŒåŒ…æ‹¬ä¾èµ–çš„ `common.proto` å’Œ `character.proto` æ–‡ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åˆ›å»ºç²¾ç®€çš„ proto æ–‡ä»¶ï¼Œä»…åŒ…å«å½“å‰æ‰¹æ¬¡æ‰€éœ€çš„æ¶ˆæ¯ç±»å‹
2. ä½¿ç”¨ `buf generate --path dnf/v1/auth_login.proto` å‚æ•°é™åˆ¶ç”ŸæˆèŒƒå›´
3. ç¡®ä¿åªç”Ÿæˆå¿…è¦çš„æ–‡ä»¶

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
cd /home/pix/dev/code/java/DnfGameServer/proto
buf generate --path dnf/v1/auth_login.proto
```

**é¢„é˜²æªæ–½**ï¼š
- ä½¿ç”¨ `--path` å‚æ•°æŒ‡å®šè¦ç”Ÿæˆçš„ proto æ–‡ä»¶
- åœ¨ proto æ–‡ä»¶ä¸­åªå®šä¹‰å¿…è¦çš„æ¶ˆæ¯ç±»å‹
- å®šæœŸæ¸…ç†ä¸éœ€è¦çš„ç”Ÿæˆæ–‡ä»¶

---

### é—®é¢˜ 2: Java package è·¯å¾„é—®é¢˜

**é—®é¢˜æè¿°**ï¼šç”Ÿæˆçš„ Java ä»£ç çš„ package è·¯å¾„ä¸ç¬¦åˆé¡¹ç›®è¦æ±‚ï¼Œéœ€è¦ç»Ÿä¸€ç®¡ç†ã€‚

**åŸå› **ï¼šBuf å·¥å…·é»˜è®¤ä½¿ç”¨ proto æ–‡ä»¶ä¸­çš„ package å£°æ˜ä½œä¸º Java packageï¼Œä½†é¡¹ç›®éœ€è¦ç»Ÿä¸€çš„ package ç®¡ç†ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `buf.gen.yaml` æ–‡ä»¶ä¸­æ·»åŠ  `managed.override` é…ç½®ï¼š
```yaml
managed:
  enabled: true
  disable:
    - file_option: go_package
      module: buf.build/googleapis/googleapis
  override:
    - file_option: java_package
      value: "com.dnfm.mina.protobuf.generated"
    - file_option: go_package_prefix
      value: gen
```
2. é‡æ–°ç”Ÿæˆ Java ä»£ç ï¼Œpackage è·¯å¾„æ­£ç¡®

**é¢„é˜²æªæ–½**ï¼š
- åœ¨é¡¹ç›®å¼€å§‹æ—¶é…ç½®å¥½ `managed.override`
- ç»Ÿä¸€ç®¡ç† package è·¯å¾„
- å®šæœŸæ£€æŸ¥ç”Ÿæˆçš„ä»£ç çš„ package è·¯å¾„

---

### é—®é¢˜ 3: Go æµ‹è¯•å¯¼å…¥é”™è¯¯

**é—®é¢˜æè¿°**ï¼šGo æµ‹è¯•æ–‡ä»¶ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `undefined: v1`ã€‚

**åŸå› **ï¼šæµ‹è¯•æ–‡ä»¶ä¸­çš„åŒ…å¯¼å…¥è·¯å¾„ä¸æ­£ç¡®ï¼Œä½¿ç”¨äº† `"dnf-go-client/gen/go/dnf/v1"` è€Œä¸æ˜¯åˆ«åå¯¼å…¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å°†æµ‹è¯•æ–‡ä»¶ä¸­çš„åŒ…å¯¼å…¥ä» `"dnf-go-client/gen/go/dnf/v1"` æ”¹ä¸º `dnfv1 "dnf-go-client/gen/go/dnf/v1"`
2. å°†æ‰€æœ‰ `v1.` æ›¿æ¢ä¸º `dnfv1.`
3. é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡

**ä»£ç ç¤ºä¾‹**ï¼š
```go
// é”™è¯¯çš„å¯¼å…¥æ–¹å¼
import "dnf-go-client/gen/go/dnf/v1"

// æ­£ç¡®çš„å¯¼å…¥æ–¹å¼
import dnfv1 "dnf-go-client/gen/go/dnf/v1"

// ä½¿ç”¨æ—¶
req := &dnfv1.LoginRequest{
    Openid: "test",
}
```

**é¢„é˜²æªæ–½**ï¼š
- ä½¿ç”¨åˆ«åå¯¼å…¥é¿å…åŒ…åå†²çª
- éµå¾ª Go çš„å‘½åçº¦å®š
- ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–ä»£ç 

---

### é—®é¢˜ 4: Go æµ‹è¯•ç¼ºå°‘ä¾èµ–

**é—®é¢˜æè¿°**ï¼šGo æµ‹è¯•è¿è¡Œå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `missing go.sum entry for module providing package github.com/golang/protobuf/proto`ã€‚

**åŸå› **ï¼šGo æ¨¡å—ç¼ºå°‘å¿…è¦çš„ä¾èµ–ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ‰§è¡Œ `go get -t ./test` æ·»åŠ æµ‹è¯•ä¾èµ–
2. é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
cd /home/pix/dev/code/java/DnfGameServer/dnf-go-client
go get -t ./test
cd test
go test -v
```

**é¢„é˜²æªæ–½**ï¼š
- å®šæœŸè¿è¡Œ `go mod tidy` æ¸…ç†ä¾èµ–
- ä½¿ç”¨ `go get` æ·»åŠ æ–°ä¾èµ–
- ç¡®ä¿ `go.sum` æ–‡ä»¶æ˜¯æœ€æ–°çš„

---

### é—®é¢˜ 5: æµ‹è¯•å‡½æ•°åé‡å¤

**é—®é¢˜æè¿°**ï¼šGo æµ‹è¯•ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `TestLoginRequest_Serialization redeclared in this block`ã€‚

**åŸå› **ï¼šå­˜åœ¨æ—§çš„ `auth_test.go` æ–‡ä»¶ï¼Œä¸æ–°çš„ `auth_login_test.go` æ–‡ä»¶ä¸­çš„æµ‹è¯•å‡½æ•°åå†²çªã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åˆ é™¤æ—§çš„ `auth_test.go` æ–‡ä»¶
2. é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
cd /home/pix/dev/code/java/DnfGameServer/dnf-go-client/test
rm auth_test.go
go test -v
```

**é¢„é˜²æªæ–½**ï¼š
- é¿å…åœ¨åŒä¸€ä¸ªç›®å½•ä¸­åˆ›å»ºå¤šä¸ªæµ‹è¯•æ–‡ä»¶
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•æ–‡ä»¶å
- å®šæœŸæ¸…ç†ä¸éœ€è¦çš„æµ‹è¯•æ–‡ä»¶

---

### é—®é¢˜ 6: ç¼–è¯‘é”™è¯¯ - æ‰¾ä¸åˆ°æ¶ˆæ¯æè¿°ç¬¦

**é—®é¢˜æè¿°**ï¼šJava ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `cannot find symbol variable internal_static_dnf_v1_PingResponse_descriptor`ã€‚

**åŸå› **ï¼šåœ¨ proto æ–‡ä»¶ä¸­æ·»åŠ äº†æ¶ˆæ¯å®šä¹‰ï¼Œä½†ç”Ÿæˆçš„ä»£ç ä¸­ç¼ºå°‘å¿…è¦çš„æè¿°ç¬¦å˜é‡ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä» proto æ–‡ä»¶ä¸­ç§»é™¤æœªå®ç°çš„æ¶ˆæ¯å®šä¹‰
2. åˆ é™¤ç”Ÿæˆçš„ç›¸å…³æ–‡ä»¶
3. é‡æ–°ç”Ÿæˆ Protobuf ä»£ç 
4. é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç¼–è¯‘æˆåŠŸ

**é¢„é˜²æªæ–½**ï¼š
- åªå®šä¹‰éœ€è¦å®ç°çš„æ¶ˆæ¯ç±»å‹
- å®šæœŸæ¸…ç†ä¸éœ€è¦çš„æ¶ˆæ¯å®šä¹‰
- ç¡®ä¿ proto æ–‡ä»¶å’Œç”Ÿæˆçš„ä»£ç ä¸€è‡´

## ğŸ”§ ç¼–è¯‘é”™è¯¯

### é—®é¢˜ 7: Java ç¼–è¯‘é”™è¯¯ - æ‰¾ä¸åˆ°ç¬¦å·

**é—®é¢˜æè¿°**ï¼šç”Ÿæˆçš„ Java ä»£ç ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºæ‰¾ä¸åˆ°ç¬¦å· `com.google.protobuf.Generated` å’Œ `com.google.protobuf.GeneratedFile`ã€‚

**åŸå› **ï¼šé¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ç™¾åº¦çš„ JProtobuf åº“ï¼Œä½†æ˜¯ç”Ÿæˆçš„ Java ä»£ç éœ€è¦ Google æ ‡å‡† Protobuf åº“çš„æ³¨è§£ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `pom.xml` æ–‡ä»¶ä¸­æ·»åŠ  Google æ ‡å‡† Protobuf åº“çš„ä¾èµ–ï¼š
```xml
<dependency>
    <groupId>com.google.protobuf</groupId>
    <artifactId>protobuf-java</artifactId>
    <version>4.33.5</version>
</dependency>
```
2. é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç¼–è¯‘æˆåŠŸ

**é¢„é˜²æªæ–½**ï¼š
- åœ¨é¡¹ç›®å¼€å§‹æ—¶æ·»åŠ å¿…è¦çš„ä¾èµ–
- å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬
- ä½¿ç”¨ `mvn dependency:tree` æ£€æŸ¥ä¾èµ–

---

### é—®é¢˜ 8: ç¼–è¯‘é”™è¯¯ - é‡å¤ç±»å®šä¹‰

**é—®é¢˜æè¿°**ï¼šJava ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `duplicate class: com.dnfm.mina.protobuf.generated.LoginRequest` ç­‰ã€‚

**åŸå› **ï¼š`src/main/java/com/dnfm/mina/protobuf/generated/` ç›®å½•ä¸‹å­˜åœ¨æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼Œä¸ `proto/gen/java/com/dnfm/mina/protobuf/generated/` ç›®å½•ä¸‹çš„æ–°æ–‡ä»¶å†²çªã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åˆ é™¤ `src/main/java/com/dnfm/mina/protobuf/generated/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
2. é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç¼–è¯‘æˆåŠŸ

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
cd /home/pix/dev/code/java/DnfGameServer
rm -rf src/main/java/com/dnfm/mina/protobuf/generated/
./mvnw clean compile
```

**é¢„é˜²æªæ–½**ï¼š
- ä½¿ç”¨ç»Ÿä¸€çš„ç”Ÿæˆä»£ç ç›®å½•
- å®šæœŸæ¸…ç†æ—§çš„ç”Ÿæˆæ–‡ä»¶
- ä½¿ç”¨ `gitignore` å¿½ç•¥ç”Ÿæˆæ–‡ä»¶

---

### é—®é¢˜ 9: Proto æ–‡ä»¶è¯­æ³•é”™è¯¯

**é—®é¢˜æè¿°**ï¼š`buf generate` å¤±è´¥ï¼Œæç¤º Proto æ–‡ä»¶è¯­æ³•é”™è¯¯ã€‚

**åŸå› **ï¼šProto æ–‡ä»¶ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå¦‚å­—æ®µ tag é‡å¤ã€ç±»å‹é”™è¯¯ç­‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Proto æ–‡ä»¶ä¸­çš„å­—æ®µåºå·
2. ç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰å”¯ä¸€çš„åºå·
3. ä» 1 å¼€å§‹è¿ç»­ç¼–å·
4. ä½¿ç”¨ `buf lint` æ£€æŸ¥ Proto æ–‡ä»¶

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
cd /home/pix/dev/code/java/DnfGameServer/proto
buf lint
buf format -w
```

**é¢„é˜²æªæ–½**ï¼š
- ä½¿ç”¨ `buf lint` æ£€æŸ¥ Proto æ–‡ä»¶
- ä½¿ç”¨ `buf format` æ ¼å¼åŒ– Proto æ–‡ä»¶
- éµå¾ª Proto æ–‡ä»¶å‘½åçº¦å®š

---

### é—®é¢˜ 10: Java æ’ä»¶é…ç½®é”™è¯¯

**é—®é¢˜æè¿°**ï¼š`buf generate` å¤±è´¥ï¼Œæç¤º `Unknown generator option: paths`ã€‚

**åŸå› **ï¼šJava æ’ä»¶ä¸æ”¯æŒ `paths` é€‰é¡¹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä» Java æ’ä»¶é…ç½®ä¸­ç§»é™¤ `opt: paths=source_relative`
2. é‡æ–°ç”Ÿæˆä»£ç 

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# é”™è¯¯çš„é…ç½®
plugins:
  - plugin: buf.build/protocolbuffers/java
    out: gen/java
    opt:
      paths: source_relative  # Java æ’ä»¶ä¸æ”¯æŒæ­¤é€‰é¡¹

# æ­£ç¡®çš„é…ç½®
plugins:
  - plugin: buf.build/protocolbuffers/java
    out: gen/java
```

**é¢„é˜²æªæ–½**ï¼š
- æŸ¥é˜…æ’ä»¶æ–‡æ¡£äº†è§£æ”¯æŒçš„é€‰é¡¹
- ä½¿ç”¨é»˜è®¤é…ç½®
- æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®

---

### é—®é¢˜ 11: ç±»å‹æ˜ å°„é”™è¯¯

**é—®é¢˜æè¿°**ï¼šè·¨è¯­è¨€ç±»å‹ä¸å…¼å®¹ï¼Œç¼–è¯‘æˆ–è¿è¡Œæ—¶é”™è¯¯ã€‚

**åŸå› **ï¼šJProtobuf å’Œæ ‡å‡† Protobuf çš„ç±»å‹æ˜ å°„ä¸æ­£ç¡®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ [02_ç±»å‹æ˜ å°„.md](./02_ç±»å‹æ˜ å°„.md) ä¸­çš„ç±»å‹æ˜ å°„è¡¨è¿›è¡Œæ˜ å°„
2. æµ‹è¯•è¾¹ç•Œå€¼å’Œæœ€å¤§å€¼
3. ç¡®ä¿æ— ç¬¦å·ç±»å‹æ­£ç¡®å¤„ç†

**é¢„é˜²æªæ–½**ï¼š
- å‚è€ƒ [02_ç±»å‹æ˜ å°„.md](./02_ç±»å‹æ˜ å°„.md) ä¸­çš„ç±»å‹æ˜ å°„è¡¨
- æµ‹è¯•è¾¹ç•Œå€¼å’Œæœ€å¤§å€¼
- ç¡®ä¿æ— ç¬¦å·ç±»å‹æ­£ç¡®å¤„ç†

## ğŸ”§ è¿è¡Œæ—¶é”™è¯¯

### é—®é¢˜ 12: è¿è¡Œæ—¶é”™è¯¯ - Unknown module ID

**é—®é¢˜æè¿°**ï¼šè¿è¡Œæ—¶é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `Unknown module ID: 10000` æˆ– `Unknown module ID: 10006`ã€‚

**åŸå› **ï¼šç¼–è§£ç å™¨ä¸­çš„ switch è¯­å¥æ²¡æœ‰æ­£ç¡®å¤„ç†æ‰€æœ‰ module IDï¼Œæˆ–è€… module ID å€¼é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Java æ¶ˆæ¯ç±»ä¸­çš„ `@MessageMeta` æ³¨è§£ï¼Œç¡®è®¤æ­£ç¡®çš„ module ID
2. æ›´æ–°ç¼–è§£ç å™¨ä¸­çš„ switch è¯­å¥ï¼Œä½¿ç”¨æ­£ç¡®çš„ module ID
3. æ³¨é‡Šæ‰æœªå®ç°çš„æ¶ˆæ¯å“åº”
4. é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// é”™è¯¯çš„ module ID
switch (moduleId) {
    case 10001:  // é”™è¯¯çš„ module ID
        return adaptLoginResponse(msg);
}

// æ­£ç¡®çš„ module ID
switch (moduleId) {
    case 10000:  // æ­£ç¡®çš„ module ID
        return adaptLoginResponse(msg);
}
```

**é¢„é˜²æªæ–½**ï¼š
- æ£€æŸ¥ Java æ¶ˆæ¯ç±»ä¸­çš„ `@MessageMeta` æ³¨è§£
- ç¡®è®¤ module ID å€¼
- æ›´æ–° switch è¯­å¥ä½¿ç”¨æ­£ç¡®çš„ module ID

---

### é—®é¢˜ 13: è¿è¡Œæ—¶é”™è¯¯ - NullPointerException

**é—®é¢˜æè¿°**ï¼šè¿è¡Œæ—¶é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º `java.lang.NullPointerException` åœ¨æ¶ˆæ¯é€‚é…æ–¹æ³•ä¸­ã€‚

**åŸå› **ï¼šJProtobuf æ¶ˆæ¯ä¸­çš„å­—æ®µå¯èƒ½ä¸º nullï¼Œä½†æ ‡å‡† Protobuf çš„ Builder æ–¹æ³•ä¸æ¥å— null å€¼ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨æ¶ˆæ¯é€‚é…æ–¹æ³•ä¸­ï¼Œä¸ºæ‰€æœ‰å­—æ®µæ·»åŠ  null æ£€æŸ¥
2. åªæœ‰åœ¨å­—æ®µä¸ä¸º null æ—¶æ‰è°ƒç”¨ Builder çš„ setter æ–¹æ³•
3. å¯¹åµŒå¥—å¯¹è±¡ä¹Ÿæ·»åŠ  null æ£€æŸ¥
4. é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// é”™è¯¯çš„ä»£ç 
private byte[] adaptLoginResponse(Message msg) throws Exception {
    RES_LOGIN oldResponse = (RES_LOGIN) msg;
    
    LoginResponse.Builder builder = LoginResponse.newBuilder();
    builder.setError(oldResponse.error);  // å¯èƒ½æŠ›å‡º NullPointerException
    builder.setAuthkey(oldResponse.authkey);  // å¯èƒ½æŠ›å‡º NullPointerException
    
    return builder.build().toByteArray();
}

// æ­£ç¡®çš„ä»£ç 
private byte[] adaptLoginResponse(Message msg) throws Exception {
    RES_LOGIN oldResponse = (RES_LOGIN) msg;
    
    LoginResponse.Builder builder = LoginResponse.newBuilder();
    
    if (oldResponse.error != null) {
        builder.setError(oldResponse.error);
    }
    if (oldResponse.authkey != null) {
        builder.setAuthkey(oldResponse.authkey);
    }
    
    return builder.build().toByteArray();
}
```

**é¢„é˜²æªæ–½**ï¼š
- ä¸ºæ‰€æœ‰å­—æ®µæ·»åŠ  null æ£€æŸ¥
- å¯¹åµŒå¥—å¯¹è±¡ä¹Ÿæ·»åŠ  null æ£€æŸ¥
- ä½¿ç”¨ Optional ç±»å‹å¤„ç†å¯èƒ½ä¸º null çš„å€¼

---

### é—®é¢˜ 14: åºåˆ—åŒ–ä¸å…¼å®¹

**é—®é¢˜æè¿°**ï¼šæ–°æ—§åè®®åºåˆ—åŒ–ç»“æœä¸å…¼å®¹ï¼Œå¯¼è‡´è§£æå¤±è´¥ã€‚

**åŸå› **ï¼šå­—æ®µåºå·ä¸ä¸€è‡´ã€å­—æ®µç±»å‹ä¸å…¼å®¹æˆ–å­—æ®µé¡ºåºæ”¹å˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¿æŒå­—æ®µåºå·ä¸€è‡´
2. ä¿æŒå­—æ®µç±»å‹å…¼å®¹
3. æµ‹è¯•åºåˆ—åŒ–/ååºåˆ—åŒ–å…¼å®¹æ€§
4. ä½¿ç”¨ `protoc --decode_raw` æ£€æŸ¥åºåˆ—åŒ–ç»“æœ

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
# æ£€æŸ¥åºåˆ—åŒ–ç»“æœ
protoc --decode_raw dnf.v1.LoginRequest < request.bin
```

**é¢„é˜²æªæ–½**ï¼š
- ä¿æŒå­—æ®µåºå·ä¸€è‡´
- ä¿æŒå­—æ®µç±»å‹å…¼å®¹
- æµ‹è¯•åºåˆ—åŒ–/ååºåˆ—åŒ–å…¼å®¹æ€§
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç† proto æ–‡ä»¶

## ğŸ”§ é…ç½®é—®é¢˜

### é—®é¢˜ 15: Maven é…ç½®é—®é¢˜ - ç”Ÿæˆä»£ç æœªåŒ…å«åœ¨ç¼–è¯‘è·¯å¾„

**é—®é¢˜æè¿°**ï¼šç”Ÿæˆçš„ Protobuf ä»£ç æ— æ³•è¢«ç¼–è¯‘å™¨æ‰¾åˆ°ï¼Œæç¤ºæ‰¾ä¸åˆ°ç±»ã€‚

**åŸå› **ï¼šMaven çš„ source ç›®å½•é…ç½®æ²¡æœ‰åŒ…å«ç”Ÿæˆçš„ä»£ç ç›®å½•ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `pom.xml` ä¸­æ·»åŠ  `build-helper-maven-plugin`ï¼š
```xml
<plugin>
    <groupId>org.codehaus.mojo</groupId>
    <artifactId>build-helper-maven-plugin</artifactId>
    <version>3.3.0</version>
    <executions>
        <execution>
            <id>add-source</id>
            <phase>generate-sources</phase>
            <goals>
                <goal>add-source</goal>
            </goals>
            <configuration>
                <sources>
                    <source>proto/gen/java</source>
                </sources>
            </configuration>
        </execution>
    </executions>
</plugin>
```
2. é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç¼–è¯‘æˆåŠŸ

**é¢„é˜²æªæ–½**ï¼š
- åœ¨é¡¹ç›®å¼€å§‹æ—¶é…ç½®å¥½ Maven æ’ä»¶
- ä½¿ç”¨ç»Ÿä¸€çš„ç”Ÿæˆä»£ç ç›®å½•
- å®šæœŸæ£€æŸ¥ Maven é…ç½®

---

### é—®é¢˜ 16: æœåŠ¡å¯åŠ¨å¤±è´¥

**é—®é¢˜æè¿°**ï¼šJava æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ— æ³•æ­£å¸¸å¯åŠ¨ã€‚

**åŸå› **ï¼šä¾èµ–ç¼ºå¤±ã€é…ç½®é”™è¯¯æˆ–ä»£ç é›†æˆé—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ä¾èµ–æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®é›†æˆ
3. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
4. ä½¿ç”¨ `mvn dependency:tree` æ£€æŸ¥ä¾èµ–

**å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
cd /home/pix/dev/code/java/DnfGameServer
./mvnw dependency:tree
./mvnw spring-boot:run
```

**é¢„é˜²æªæ–½**ï¼š
- æ£€æŸ¥ä¾èµ–æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®é›†æˆ
- æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- ä½¿ç”¨ `mvn dependency:tree` æ£€æŸ¥ä¾èµ–
## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01_è¿ç§»æµç¨‹.md](./01_è¿ç§»æµç¨‹.md) - 7 æ­¥è¿ç§»æµç¨‹è¯¦è§£
- [02_ç±»å‹æ˜ å°„.md](./02_ç±»å‹æ˜ å°„.md) - JProtobuf åˆ°æ ‡å‡† Protobuf ç±»å‹æ˜ å°„
- [04_åŒæ¨¡å¼ç¼–è§£ç å™¨.md](./04_åŒæ¨¡å¼ç¼–è§£ç å™¨.md) - åŒæ¨¡å¼ç¼–è§£ç å™¨å®ç°
- [05_è·¨è¯­è¨€é€šä¿¡æµ‹è¯•.md](./05_è·¨è¯­è¨€é€šä¿¡æµ‹è¯•.md) - è·¨è¯­è¨€é€šä¿¡æµ‹è¯•æŒ‡å—
- [06_ç»éªŒæ€»ç»“æ¨¡æ¿.md](./06_ç»éªŒæ€»ç»“æ¨¡æ¿.md) - ç»éªŒæ€»ç»“æ¨¡æ¿

## ğŸ“ æ‰¹æ¬¡03æ–°å¢é—®é¢˜

### é—®é¢˜ 17: Protoæ–‡ä»¶ç»“æ„ä¸åŒ¹é…

**é—®é¢˜æè¿°**ï¼šJavaçš„PT_CHARACTERç±»ä½¿ç”¨PT_CHARACTER_EQUIP_ONLY_INDEXç±»å‹çš„equipså­—æ®µï¼Œè€ŒProtoçš„Characterç±»ä½¿ç”¨CharacterEquipIndexç±»å‹çš„equipså­—æ®µï¼Œè¿™ä¸¤ç§ç»“æ„ä¸å…¼å®¹ã€‚

**æ ¹æœ¬åŸå› **ï¼š
- PT_CHARACTER_EQUIP_ONLY_INDEXåŒ…å«equiplistå’Œavatarlistä¸¤ä¸ªåˆ—è¡¨
- CharacterEquipIndexåŒ…å«13ä¸ªç‹¬ç«‹çš„è£…å¤‡æ§½ä½å­—æ®µ
- ä¸¤ç§ç»“æ„ä»£è¡¨ä¸åŒçš„æ•°æ®ç»„ç»‡æ–¹å¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨character.protoä¸­æ–°å¢CharacterWithEquipListæ¶ˆæ¯ç±»å‹ï¼š
```protobuf
message CharacterWithEquipList {
  int64 char_guid = 1;
  int64 last_logout = 2;
  int32 grow_type = 3;
  int32 sec_grow_type = 4;
  int32 job = 5;
  int32 level = 6;
  string name = 7;
  int32 fatigue = 8;
  int32 equip_score = 9;
  int32 character_frame = 10;
  CharacterEquipIndexList equips = 11;
  uint32 avatar_visible_flags = 12;
  int32 deletion_status = 13;
  int64 deletion_time = 14;
  int64 create_time = 15;
  bool change_name = 16;
}
```
2. æ›´æ–°CharacterListResponseä½¿ç”¨CharacterWithEquipListç±»å‹ï¼š
```protobuf
message CharacterListResponse {
  int32 error = 1;
  int32 version = 2;
  repeated JobLimitInfo limits = 3;
  repeated CharacterWithEquipList characters = 4;
  int32 count = 5;
  int32 adventure_union_level = 6;
  int64 adventure_union_exp = 7;
  int32 daily_create_char_count = 8;
  int32 daily_create_char_max_count = 9;
  string adventure_union_name = 10;
  int32 max_count = 11;
  string ignore_contents_blacklist = 12;
}
```
3. é‡æ–°ç”Ÿæˆä»£ç å¹¶æµ‹è¯•

**é¢„é˜²æªæ–½**ï¼š
- åœ¨è¿ç§»å‰éœ€è¦ä»”ç»†åˆ†æJavaå’ŒProtoçš„æ•°æ®ç»“æ„å·®å¼‚
- æ–°å¢æ¶ˆæ¯ç±»å‹æ¯”ä¿®æ”¹ç°æœ‰ç±»å‹æ›´å®‰å…¨
- ä¿æŒå‘åå…¼å®¹æ€§å¾ˆé‡è¦

**ç»éªŒæ•™è®­**ï¼š
- ä¸è¦å‡è®¾Javaå’ŒProtoçš„ç»“æ„å¯ä»¥ç›´æ¥å¯¹åº”
- å¯¹äºå¤æ‚åµŒå¥—ç»“æ„ï¼Œéœ€è¦åˆ›å»ºæ–°çš„æ¶ˆæ¯ç±»å‹
- ä¿æŒåŸæœ‰Characteræ¶ˆæ¯ç±»å‹ä¸å˜ï¼Œç”¨äºå…¶ä»–åœºæ™¯

---

### é—®é¢˜ 18: ç«¯å£é…ç½®æ··æ·†

**é—®é¢˜æè¿°**ï¼šGoå®¢æˆ·ç«¯è¿æ¥åˆ°HTTPç«¯å£20001ï¼Œå¯¼è‡´è¿æ¥å¤±è´¥ï¼Œæ— æ³•ä¸æ¸¸æˆæœåŠ¡å™¨é€šä¿¡ã€‚

**æ ¹æœ¬åŸå› **ï¼š
- HTTPæœåŠ¡å™¨ç«¯å£ï¼š20001ï¼ˆTomcatï¼‰
- æ¸¸æˆæœåŠ¡å™¨ç«¯å£ï¼š10001ï¼ˆMinaï¼‰
- ä¸¤ç§ç«¯å£æœåŠ¡ä¸åŒçš„åè®®å’Œç”¨é€”

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æŸ¥çœ‹game.propertiesæ–‡ä»¶ï¼Œç¡®è®¤æ¸¸æˆæœåŠ¡å™¨ç«¯å£ï¼š
```properties
game.serverPort=10001
game.serverIp=192.168.123.242
game.serverInetIp=0.0.0.0
```
2. ä¿®æ”¹Goå®¢æˆ·ç«¯è¿æ¥åˆ°æ­£ç¡®çš„ç«¯å£ï¼š
```go
conn, err := net.Dial("tcp", "127.0.0.1:10001")
```
3. é‡æ–°æµ‹è¯•ï¼Œè¿æ¥æˆåŠŸ

**é¢„é˜²æªæ–½**ï¼š
- éœ€è¦æ˜ç¡®åŒºåˆ†HTTPç«¯å£å’Œæ¸¸æˆTCPç«¯å£
- å»ºè®®ç»Ÿä¸€ç«¯å£é…ç½®ç®¡ç†
- æ–‡æ¡£åº”è¯¥æ˜ç¡®è¯´æ˜ä¸åŒç«¯å£çš„ç”¨é€”

**ç»éªŒæ•™è®­**ï¼š
- ç«¯å£é…ç½®åº”è¯¥ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶
- å»ºè®®åœ¨application.propertiesä¸­ç»Ÿä¸€é…ç½®æ‰€æœ‰ç«¯å£
- å¯åŠ¨æ—¶åº”è¯¥è®°å½•ç›‘å¬çš„ç«¯å£ï¼Œä¾¿äºè°ƒè¯•
- æ–‡æ¡£åº”è¯¥æ˜ç¡®è¯´æ˜ä¸åŒç«¯å£çš„åè®®å’Œç”¨é€”

**æœ€ä½³å®è·µ**ï¼š
```properties
# application.properties
# HTTPæœåŠ¡å™¨ç«¯å£
server.port=20001

# æ¸¸æˆæœåŠ¡å™¨ç«¯å£
game.server.port=10001

# æ—¥å¿—é…ç½®
logging.level.game.server=DEBUG
```

---

### é—®é¢˜ 19: è§’è‰²åˆ—è¡¨è¯·æ±‚éœ€è¦ç™»å½•

**é—®é¢˜æè¿°**ï¼šç›´æ¥å‘é€è§’è‰²åˆ—è¡¨è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨è¿”å›"openid ä¸ºç©º"é”™è¯¯ï¼Œæ— æ³•è·å–è§’è‰²åˆ—è¡¨ã€‚

**æ ¹æœ¬åŸå› **ï¼š
- è§’è‰²åˆ—è¡¨è¯·æ±‚éœ€è¦å…ˆç™»å½•è·å–openid
- æœåŠ¡å™¨ä¼šæ£€æŸ¥ä¼šè¯ä¸­çš„openidä¿¡æ¯
- æœªç™»å½•çš„ä¼šè¯æ— æ³•è®¿é—®è§’è‰²åˆ—è¡¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…ˆå‘é€ç™»å½•è¯·æ±‚è·å–openidï¼š
```go
loginReq := &dnfv1.LoginRequest{
    Openid: "test_openid_123",
    Type:   1,
    Token:  "test_token_123",
}
```
2. ç­‰å¾…ç™»å½•å“åº”
3. å†å‘é€è§’è‰²åˆ—è¡¨è¯·æ±‚ï¼š
```go
charListReq := &dnfv1.CharacterListRequest{}
```

**é¢„é˜²æªæ–½**ï¼š
- æŸäº›æ¶ˆæ¯æœ‰å‰ç½®æ¡ä»¶ï¼ˆå¦‚ç™»å½•ï¼‰
- æµ‹è¯•ç¯å¢ƒåº”è¯¥é…ç½®å®Œæ•´çš„æµ‹è¯•æ•°æ®
- å¯ä»¥é€šè¿‡ç¼–è§£ç æµ‹è¯•éªŒè¯æ¶ˆæ¯æ­£ç¡®æ€§ï¼Œæ— éœ€ä¾èµ–å®Œæ•´æµç¨‹

**ç»éªŒæ•™è®­**ï¼š
- ä¸æ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- æŸäº›æ¶ˆæ¯éœ€è¦ç‰¹å®šçš„ä¼šè¯çŠ¶æ€
- æµ‹è¯•ç¯å¢ƒåº”è¯¥é…ç½®å®Œæ•´çš„æµ‹è¯•è´¦æˆ·ä¿¡æ¯
- å¯ä»¥é€šè¿‡ç¼–è§£ç åŠŸèƒ½æµ‹è¯•éªŒè¯æ¶ˆæ¯æ­£ç¡®æ€§

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
å¦‚æœæ— æ³•å®Œæˆå®Œæ•´çš„ç™»å½•æµç¨‹ï¼Œå¯ä»¥é€šè¿‡ç¼–è§£ç åŠŸèƒ½æµ‹è¯•éªŒè¯æ¶ˆæ¯æ­£ç¡®æ€§ï¼š
```go
// æµ‹è¯•åºåˆ—åŒ–
charListResp := &dnfv1.CharacterListResponse{
    Error:                    0,
    Version:                  1,
    AdventureUnionLevel:       10,
    // ... å…¶ä»–å­—æ®µ
}
data, err := proto.Marshal(charListResp)

// æµ‹è¯•ååºåˆ—åŒ–
var parsedResp dnfv1.CharacterListResponse
if err := proto.Unmarshal(data, &parsedResp); err != nil {
    // å¤„ç†é”™è¯¯
}
```