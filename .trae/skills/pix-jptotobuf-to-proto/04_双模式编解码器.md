# 04_åŒæ¨¡å¼ç¼–è§£ç å™¨

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜åŒæ¨¡å¼ç¼–è§£ç å™¨çš„å®ç°ï¼Œæ”¯æŒä» JProtobuf åˆ°æ ‡å‡† Protobuf çš„å¹³æ»‘è¿‡æ¸¡ã€‚

## ğŸ¯ æ¸è¿›å¼è¿ç§»ç­–ç•¥

### ä¸ºä»€ä¹ˆéœ€è¦åŒæ¨¡å¼ç¼–è§£ç å™¨ï¼Ÿ

åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
1. **ä¿æŒç³»ç»Ÿç¨³å®š**ï¼šé¿å…ä¸€æ¬¡æ€§è¿ç§»æ‰€æœ‰æ¶ˆæ¯å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
2. **æ”¯æŒç°åº¦å‘å¸ƒ**ï¼šé€æ­¥åˆ‡æ¢åˆ°æ–°åè®®ï¼Œé™ä½é£é™©
3. **æä¾›å›é€€æ–¹æ¡ˆ**ï¼šå¦‚æœæ–°åè®®å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›é€€åˆ°æ—§åè®®
4. **å‡å°‘è¿ç§»é£é™©**ï¼šå°è§„æ¨¡ã€å¯æ§çš„è¿ç§»æ­¥ä¼

### åŒæ¨¡å¼æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MessageCodecFactory                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  protobuf.mode = jprotobuf (é»˜è®¤)                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚ JProtobuf      â”‚      â”‚ JProtobuf      â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ Decoder        â”‚â—€â”€â”€â”€â”€â–¶â”‚ Encoder        â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  protobuf.mode = standard (æ–°æ ‡å‡†)                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚ Standard       â”‚      â”‚ Standard       â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ Protobuf      â”‚      â”‚ Protobuf      â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ Decoder        â”‚â—€â”€â”€â”€â”€â–¶â”‚ Encoder        â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ MessageCodecFactory å®ç°

### é…ç½®æ–‡ä»¶

åœ¨ `application.properties` ä¸­é…ç½®ï¼š

```properties
# Protobufæ¨¡å¼ï¼šjprotobufï¼ˆé»˜è®¤ï¼‰æˆ– standardï¼ˆæ–°æ ‡å‡†Protobufï¼‰
protobuf.mode=standard
```

### å®ç°ä»£ç 

```java
package com.dnfm.mina.codec;

import org.apache.mina.core.session.IoSession;
import org.apache.mina.filter.codec.ProtocolCodecFactory;
import org.apache.mina.filter.codec.ProtocolDecoder;
import org.apache.mina.filter.codec.ProtocolEncoder;

public class MessageCodecFactory implements ProtocolCodecFactory {
    private static final String MODE_JPROTOBUF = "jprotobuf";
    private static final String MODE_STANDARD = "standard";
    
    public ProtocolDecoder getDecoder(IoSession session) throws Exception {
        String mode = getProtobufMode();
        System.out.println("===== MessageCodecFactory.getDecoder() è¢«è°ƒç”¨ï¼Œprotobuf.mode=" + mode + " =====");
        
        if (MODE_STANDARD.equals(mode)) {
            System.out.println("===== è¿”å› StandardProtobufDecoder =====");
            return new StandardProtobufDecoder();
        } else {
            System.out.println("===== è¿”å› JProtobufDecoder =====");
            return new JProtobufDecoder();
        }
    }
    
    public ProtocolEncoder getEncoder(IoSession session) throws Exception {
        String mode = getProtobufMode();
        System.out.println("===== MessageCodecFactory.getEncoder() è¢«è°ƒç”¨ï¼Œprotobuf.mode=" + mode + " =====");
        
        if (MODE_STANDARD.equals(mode)) {
            System.out.println("===== è¿”å› StandardProtobufEncoder =====");
            return new StandardProtobufEncoder();
        } else {
            System.out.println("===== è¿”å› JProtobufEncoder =====");
            return new JProtobufEncoder();
        }
    }
    
    private String getProtobufMode() {
        return System.getProperty("protobuf.mode", "jprotobuf");
    }
}
```

## ğŸ”§ StandardProtobufDecoder å®ç°

### åŠŸèƒ½è¯´æ˜

è§£ç æ ‡å‡† Protobuf æ ¼å¼çš„æ¶ˆæ¯å¹¶é€‚é…ä¸º JProtobuf æ¶ˆæ¯ã€‚

### å®ç°ä»£ç 

```java
package com.dnfm.mina.codec;

import com.dnfm.mina.protobuf.Message;
import com.dnfm.mina.protobuf.REQ_LOGIN;
import com.dnfm.mina.protobuf.generated.LoginRequest;
import org.apache.mina.core.buffer.IoBuffer;
import org.apache.mina.filter.codec.ProtocolDecoder;
import org.apache.mina.filter.codec.ProtocolDecoderOutput;

public class StandardProtobufDecoder implements ProtocolDecoder {
    
    @Override
    public void decode(IoSession session, IoBuffer buffer, ProtocolDecoderOutput out) throws Exception {
        int moduleId = buffer.getShort();
        int seq = buffer.get();
        int transactionId = buffer.get();
        buffer.getShort();
        
        Message msg = decodeMessage(moduleId, buffer);
        if (msg != null) {
            msg.transId = transactionId;
            out.write(msg);
        }
    }
    
    private Message decodeMessage(int moduleId, IoBuffer buffer) throws Exception {
        int bodyLen = buffer.remaining();
        byte[] body = new byte[bodyLen];
        buffer.get(body);
        
        switch (moduleId) {
            case 10000:
                return decodeLoginRequest(body);
            default:
                throw new Exception("Unknown module ID: " + moduleId);
        }
    }
    
    private Message decodeLoginRequest(byte[] body) throws Exception {
        LoginRequest newRequest = LoginRequest.parseFrom(body);
        
        REQ_LOGIN oldRequest = new REQ_LOGIN();
        oldRequest.openid = newRequest.getOpenid();
        oldRequest.type = newRequest.getType();
        oldRequest.token = newRequest.getToken();
        oldRequest.platID = newRequest.getPlatID();
        oldRequest.clientIP = newRequest.getClientIP();
        oldRequest.version = newRequest.getVersion();
        oldRequest.friendopenid = newRequest.getFriendopenid();
        oldRequest.cancelunregist = newRequest.getCancelunregist();
        oldRequest.countrycode = newRequest.getCountrycode();
        oldRequest.toyplatid = newRequest.getToyplatid();
        oldRequest.agetype = newRequest.getAgetype();
        
        return oldRequest;
    }
    
    @Override
    public void dispose(IoSession session) throws Exception {
    }
    
    @Override
    public void finishDecode(IoSession session, ProtocolDecoderOutput out) throws Exception {
    }
}
```

## ğŸ”§ StandardProtobufEncoder å®ç°

### åŠŸèƒ½è¯´æ˜

å°† JProtobuf æ¶ˆæ¯é€‚é…ä¸ºæ ‡å‡† Protobuf æ ¼å¼å¹¶ç¼–ç ã€‚

### å®ç°ä»£ç 

```java
package com.dnfm.mina.codec;

import com.dnfm.mina.protobuf.Message;
import com.dnfm.mina.protobuf.PT_CHANNEL_INFO;
import com.dnfm.mina.protobuf.PT_INTRUDE_INFO;
import com.dnfm.mina.protobuf.RES_LOGIN;
import com.dnfm.mina.protobuf.generated.ChannelInfo;
import com.dnfm.mina.protobuf.generated.IntrudeInfo;
import com.dnfm.mina.protobuf.generated.LoginResponse;
import org.apache.mina.core.buffer.IoBuffer;
import org.apache.mina.core.session.IoSession;
import org.apache.mina.filter.codec.ProtocolEncoder;
import org.apache.mina.filter.codec.ProtocolEncoderOutput;

public class StandardProtobufEncoder implements ProtocolEncoder {
    
    @Override
    public void encode(IoSession session, Object message, ProtocolEncoderOutput out) throws Exception {
        Message msg = (Message) message;
        int moduleId = msg.getModule();
        
        byte[] body = encodeMessage(moduleId, msg);
        
        int totalLen = body.length + 8;
        IoBuffer buffer = IoBuffer.allocate(totalLen);
        buffer.order(java.nio.ByteOrder.LITTLE_ENDIAN);
        buffer.putShort((short) totalLen);
        buffer.putShort((short) moduleId);
        buffer.put((byte) 1);
        buffer.put((byte) (msg.transId != null ? msg.transId : 0));
        buffer.putShort((short) 0);
        buffer.put(body);
        buffer.flip();
        
        out.write(buffer);
    }
    
    private byte[] encodeMessage(int moduleId, Message msg) throws Exception {
        switch (moduleId) {
            case 10000:
                return adaptLoginResponse(msg);
            default:
                throw new Exception("Unknown module ID: " + moduleId);
        }
    }
    
    private byte[] adaptLoginResponse(Message msg) throws Exception {
        RES_LOGIN oldResponse = (RES_LOGIN) msg;
        
        LoginResponse.Builder builder = LoginResponse.newBuilder();
        
        if (oldResponse.error != null) {
            builder.setError(oldResponse.error);
        }
        if (oldResponse.authkey != null) {
            builder.setAuthkey(oldResponse.authkey);
        }
        if (oldResponse.accountkey != null) {
            builder.setAccountkey(oldResponse.accountkey);
        }
        if (oldResponse.encrypt != null) {
            builder.setEncrypt(oldResponse.encrypt);
        }
        if (oldResponse.servertime != null) {
            builder.setServertime(oldResponse.servertime);
        }
        if (oldResponse.localtime != null) {
            builder.setLocaltime(oldResponse.localtime);
        }
        if (oldResponse.authority != null) {
            builder.setAuthority(oldResponse.authority);
        }
        if (oldResponse.key != null) {
            builder.setKey(oldResponse.key);
        }
        if (oldResponse.worldid != null) {
            builder.setWorldid(oldResponse.worldid);
        }
        
        if (oldResponse.channel != null) {
            for (PT_CHANNEL_INFO oldChannel : oldResponse.channel) {
                ChannelInfo.Builder channelBuilder = ChannelInfo.newBuilder();
                if (oldChannel.world != null) {
                    channelBuilder.setWorld(oldChannel.world);
                }
                if (oldChannel.channel != null) {
                    channelBuilder.setChannel(oldChannel.channel);
                }
                if (oldChannel.ip != null) {
                    channelBuilder.setIp(oldChannel.ip);
                }
                if (oldChannel.port != null) {
                    channelBuilder.setPort(oldChannel.port);
                }
                if (oldChannel.priority != null) {
                    channelBuilder.setPriority(oldChannel.priority);
                }
                builder.addChannel(channelBuilder.build());
            }
        }
        
        if (oldResponse.intrudeinfo != null) {
            IntrudeInfo.Builder intrudeBuilder = IntrudeInfo.newBuilder();
            if (oldResponse.intrudeinfo.ip != null) {
                intrudeBuilder.setIp(oldResponse.intrudeinfo.ip);
            }
            if (oldResponse.intrudeinfo.time != null) {
                intrudeBuilder.setTime(oldResponse.intrudeinfo.time);
            }
            builder.setIntrudeinfo(intrudeBuilder.build());
        }
        
        if (oldResponse.seeds != null) {
            for (Integer seed : oldResponse.seeds) {
                builder.addSeeds(seed);
            }
        }
        
        return builder.build().toByteArray();
    }
    
    @Override
    public void dispose(IoSession session) throws Exception {
    }
}
```

## ğŸ”§ å…³é”®æ³¨æ„äº‹é¡¹

### 1. Null æ£€æŸ¥

**é—®é¢˜**ï¼šJProtobuf å’Œæ ‡å‡† Protobuf å¯¹ null çš„å¤„ç†æ–¹å¼ä¸åŒ
- JProtobufï¼šå­—æ®µå¯ä»¥ä¸º null
- æ ‡å‡† Protobufï¼šBuilder æ–¹æ³•ä¸æ¥å— null å€¼

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨é€‚é…æ–¹æ³•ä¸­ä¸ºæ‰€æœ‰å­—æ®µæ·»åŠ  null æ£€æŸ¥

```java
if (oldResponse.error != null) {
    builder.setError(oldResponse.error);
}
```

### 2. Module ID æ˜ å°„

**é—®é¢˜**ï¼šç¼–è§£ç å™¨ä¸­çš„ switch è¯­å¥æ²¡æœ‰æ­£ç¡®å¤„ç†æ‰€æœ‰ module IDï¼Œæˆ–è€… module ID å€¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Java æ¶ˆæ¯ç±»ä¸­çš„ `@MessageMeta` æ³¨è§£
- ç¡®è®¤ module ID å€¼ï¼ˆä¾‹å¦‚ï¼š10000 è€Œä¸æ˜¯ 10001ï¼‰
- æ›´æ–° switch è¯­å¥ä½¿ç”¨æ­£ç¡®çš„ module ID

```java
@MessageMeta(module = 10000, cmd = 1)
public class RES_LOGIN extends Message {
    // ...
}

switch (moduleId) {
    case 10000:  // ä½¿ç”¨æ­£ç¡®çš„ module ID
        return adaptLoginResponse(msg);
}
```

### 3. åµŒå¥—å¯¹è±¡å¤„ç†

**é—®é¢˜**ï¼šåµŒå¥—å¯¹è±¡å¯èƒ½ä¸º nullï¼Œéœ€è¦æ·»åŠ  null æ£€æŸ¥

**è§£å†³æ–¹æ¡ˆ**ï¼šå¯¹åµŒå¥—å¯¹è±¡ä¹Ÿæ·»åŠ  null æ£€æŸ¥

```java
if (oldResponse.channel != null) {
    for (PT_CHANNEL_INFO oldChannel : oldResponse.channel) {
        ChannelInfo.Builder channelBuilder = ChannelInfo.newBuilder();
        if (oldChannel.world != null) {
            channelBuilder.setWorld(oldChannel.world);
        }
        // ...
    }
}
```

### 4. é…ç½®åˆ‡æ¢

**é—®é¢˜**ï¼šéœ€è¦æ”¯æŒç°åº¦å‘å¸ƒå’Œå›é€€æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åˆ‡æ¢ç¼–è§£ç å™¨

```properties
# ä½¿ç”¨ JProtobufï¼ˆæ—§åè®®ï¼‰
protobuf.mode=jprotobuf

# ä½¿ç”¨æ ‡å‡† Protobufï¼ˆæ–°åè®®ï¼‰
protobuf.mode=standard
```

## ğŸ“Š æ¶ˆæ¯é€‚é…æµç¨‹

### è§£ç æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  StandardProtobufDecoder                â”‚
â”‚                                                          â”‚
â”‚  1. è§£ææ¶ˆæ¯å¤´                                           â”‚
â”‚     - æ€»é•¿åº¦                                             â”‚
â”‚     - æ¨¡å—ID                                             â”‚
â”‚     - åºåˆ—å·                                             â”‚
â”‚     - äº‹åŠ¡ID                                             â”‚
â”‚                                                          â”‚
â”‚  2. è§£ææ¶ˆæ¯ä½“                                           â”‚
â”‚     - æ ¹æ®æ¨¡å—IDé€‰æ‹©è§£ç æ–¹æ³•                               â”‚
â”‚     - è§£ææ ‡å‡†Protobufæ¶ˆæ¯                                â”‚
â”‚                                                          â”‚
â”‚  3. æ¶ˆæ¯é€‚é…                                             â”‚
â”‚     - æ ‡å‡†Protobuf â†’ JProtobuf                           â”‚
â”‚     - å­—æ®µæ˜ å°„                                           â”‚
â”‚     - ç±»å‹è½¬æ¢                                           â”‚
â”‚                                                          â”‚
â”‚  4. è¿”å›JProtobufæ¶ˆæ¯                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–ç æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  StandardProtobufEncoder                 â”‚
â”‚                                                          â”‚
â”‚  1. æ¥æ”¶JProtobufæ¶ˆæ¯                                    â”‚
â”‚     - è·å–æ¨¡å—ID                                         â”‚
â”‚     - è·å–äº‹åŠ¡ID                                         â”‚
â”‚                                                          â”‚
â”‚  2. æ¶ˆæ¯é€‚é…                                             â”‚
â”‚     - JProtobuf â†’ æ ‡å‡†Protobuf                           â”‚
â”‚     - å­—æ®µæ˜ å°„                                           â”‚
â”‚     - ç±»å‹è½¬æ¢                                           â”‚
â”‚     - Nullæ£€æŸ¥                                           â”‚
â”‚                                                          â”‚
â”‚  3. æ„å»ºæ¶ˆæ¯å¤´                                           â”‚
â”‚     - æ€»é•¿åº¦                                             â”‚
â”‚     - æ¨¡å—ID                                             â”‚
â”‚     - åºåˆ—å·                                             â”‚
â”‚     - äº‹åŠ¡ID                                             â”‚
â”‚                                                          â”‚
â”‚  4. ç¼–ç æ¶ˆæ¯                                             â”‚
â”‚     - åºåˆ—åŒ–æ ‡å‡†Protobufæ¶ˆæ¯                              â”‚
â”‚     - æ·»åŠ æ¶ˆæ¯å¤´                                         â”‚
â”‚     - è¿”å›å­—èŠ‚æ•°ç»„                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹

1. **åœ¨ StandardProtobufDecoder ä¸­æ·»åŠ è§£ç æ–¹æ³•**ï¼š

```java
private Message decodeNewMessage(byte[] body) throws Exception {
    NewRequest newRequest = NewRequest.parseFrom(body);
    
    OLD_REQUEST oldRequest = new OLD_REQUEST();
    oldRequest.field1 = newRequest.getField1();
    oldRequest.field2 = newRequest.getField2();
    
    return oldRequest;
}
```

2. **åœ¨ switch è¯­å¥ä¸­æ·»åŠ  case**ï¼š

```java
switch (moduleId) {
    case 10000:
        return decodeLoginRequest(body);
    case 10001:  // æ–°å¢çš„æ¶ˆæ¯ç±»å‹
        return decodeNewMessage(body);
    default:
        throw new Exception("Unknown module ID: " + moduleId);
}
```

3. **åœ¨ StandardProtobufEncoder ä¸­æ·»åŠ ç¼–ç æ–¹æ³•**ï¼š

```java
private byte[] adaptNewResponse(Message msg) throws Exception {
    OLD_RESPONSE oldResponse = (OLD_RESPONSE) msg;
    
    NewResponse.Builder builder = NewResponse.newBuilder();
    
    if (oldResponse.field1 != null) {
        builder.setField1(oldResponse.field1);
    }
    if (oldResponse.field2 != null) {
        builder.setField2(oldResponse.field2);
    }
    
    return builder.build().toByteArray();
}
```

4. **åœ¨ switch è¯­å¥ä¸­æ·»åŠ  case**ï¼š

```java
switch (moduleId) {
    case 10000:
        return adaptLoginResponse(msg);
    case 10001:  // æ–°å¢çš„æ¶ˆæ¯ç±»å‹
        return adaptNewResponse(msg);
    default:
        throw new Exception("Unknown module ID: " + moduleId);
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01_è¿ç§»æµç¨‹.md](./01_è¿ç§»æµç¨‹.md) - 7 æ­¥è¿ç§»æµç¨‹è¯¦è§£
- [02_ç±»å‹æ˜ å°„.md](./02_ç±»å‹æ˜ å°„.md) - JProtobuf åˆ°æ ‡å‡† Protobuf ç±»å‹æ˜ å°„
- [03_å¸¸è§é—®é¢˜.md](./03_å¸¸è§é—®é¢˜.md) - å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
- [05_è·¨è¯­è¨€é€šä¿¡æµ‹è¯•.md](./05_è·¨è¯­è¨€é€šä¿¡æµ‹è¯•.md) - è·¨è¯­è¨€é€šä¿¡æµ‹è¯•æŒ‡å—
