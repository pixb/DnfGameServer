# 核心功能拆解

## 功能模块划分

### 1. 基础架构模块

#### 1.1 网络通信模块
**功能描述**：负责处理客户端与服务器的 TCP 连接、消息编解码、消息路由等。

**核心组件**：
- **Socket 服务器**：监听客户端连接
- **编解码器**：Protobuf 消息的序列化和反序列化
- **消息分发器**：根据消息 ID 路由到对应的处理器
- **会话管理器**：管理客户端连接会话
- **过滤器链**：处理消息的前置和后置逻辑

**关键类**：
- `GameServer`：游戏服务器启动类
- `ServerSocketIoHandler`：Socket 处理器
- `MessageDispatcher`：消息分发器
- `MessageFactory`：消息工厂
- `SessionManager`：会话管理器
- `SerializerHelper`：序列化助手

**技术要点**：
- 使用 Apache Mina 框架
- 基于 Protobuf 的二进制协议
- 支持消息注解路由
- 支持心跳检测
- 支持连接池管理

#### 1.2 数据库模块
**功能描述**：负责数据库连接、数据持久化、数据查询等。

**核心组件**：
- **数据源管理**：动态数据源切换
- **ORM 框架**：NutZ 数据库操作
- **实体模型**：数据库表对应的实体类
- **DAO 服务**：数据访问对象

**关键类**：
- `DynamicDataSource`：动态数据源
- `Db4CommonService`：公共数据库服务
- `Db4PlayerService`：玩家数据库服务
- `Db4AccountService`：账户数据库服务
- `BaseEntity`：基础实体类

**技术要点**：
- 使用 NutZ ORM 框架
- 支持多数据源
- 支持数据库事务
- 支持缓存优化

#### 1.3 配置管理模块
**功能描述**：负责游戏配置的加载、更新、缓存等。

**核心组件**：
- **配置加载器**：从文件加载配置
- **配置缓存**：缓存配置数据
- **配置热更新**：支持配置动态更新

**关键类**：
- `ServerService`：服务器配置服务
- `LoginDataPool`：登录数据池
- `ItemDataPool`：道具数据池
- `EquipDataPool`：装备数据池
- `SkillDataPool`：技能数据池

**技术要点**：
- 使用 JSON 或 XML 配置文件
- 支持配置热更新
- 支持配置缓存

#### 1.4 定时任务模块
**功能描述**：负责定时任务的调度和执行。

**核心组件**：
- **任务调度器**：定时任务调度
- **任务执行器**：任务执行线程池

**关键类**：
- `ScheduledService`：定时服务
- `SchedulerManager`：调度管理器
- `ModuleCounterSchedule`：模块计数调度

**技术要点**：
- 使用 Spring Scheduled
- 支持定时任务
- 支持异步执行

#### 1.5 日志模块
**功能描述**：负责日志的记录和管理。

**核心组件**：
- **日志记录器**：记录各种日志
- **日志分类**：按模块分类日志
- **日志级别**：支持不同日志级别

**关键类**：
- `LoggerSystem`：日志系统
- `LoggerBuilder`：日志构建器
- `LoggerUtils`：日志工具类

**技术要点**：
- 使用 SLF4J + Logback
- 支持日志分类
- 支持日志级别

### 2. 游戏业务模块

#### 2.1 登录认证模块
**功能描述**：负责玩家登录认证、角色选择、角色创建等。

**核心功能**：
- **登录认证**：验证玩家身份
- **角色列表**：获取玩家角色列表
- **角色创建**：创建新角色
- **角色删除**：删除角色
- **角色选择**：选择角色进入游戏

**关键类**：
- `LoginController`：登录控制器
- `RoleController`：角色控制器
- `AccountService`：账户服务
- `RoleService`：角色服务
- `Account`：账户实体
- `Role`：角色实体

**技术要点**：
- 支持多种登录方式
- 支持角色验证
- 支持角色数据初始化

#### 2.2 背包系统模块
**功能描述**：负责玩家背包、道具管理、道具使用等。

**核心功能**：
- **背包管理**：背包格子管理
- **道具获取**：获取道具
- **道具使用**：使用道具
- **道具丢弃**：丢弃道具
- **道具合成**：合成道具
- **道具分解**：分解道具

**关键类**：
- `BagController`：背包控制器
- `BagService`：背包服务
- `ConsumableBox`：消耗品背包
- `MaterialBox`：材料背包
- `EquipBox`：装备背包
- `MoneyBox`：货币背包

**技术要点**：
- 支持多种背包类型
- 支持道具堆叠
- 支持道具过期
- 支持道具绑定

#### 2.3 装备系统模块
**功能描述**：负责装备管理、装备强化、装备附魔等。

**核心功能**：
- **装备穿戴**：穿戴装备
- **装备卸下**：卸下装备
- **装备强化**：强化装备
- **装备附魔**：附魔装备
- **装备镶嵌**：镶嵌装备
- **装备继承**：继承装备

**关键类**：
- `EquipController`：装备控制器
- `EquipDataPool`：装备数据池
- `RoleEquip`：角色装备
- `EquipBox`：装备背包
- `UpgradeInfo`：升级信息

**技术要点**：
- 支持装备部位管理
- 支持装备强化等级
- 支持装备属性加成
- 支持装备套装效果

#### 2.4 技能系统模块
**功能描述**：负责技能管理、技能学习、技能升级等。

**核心功能**：
- **技能学习**：学习新技能
- **技能升级**：升级技能
- **技能遗忘**：遗忘技能
- **技能冷却**：技能冷却管理
- **技能释放**：技能释放逻辑

**关键类**：
- `SkillController`：技能控制器
- `SkillDataPool`：技能数据池
- `SkillBox`：技能背包
- `RoleSkill`：角色技能
- `SkillslotBox`：技能槽背包

**技术要点**：
- 支持技能树
- 支持技能冷却
- 支持技能消耗
- 支持技能效果

#### 2.5 好友系统模块
**功能描述**：负责好友关系管理、好友分组、在线状态等。

**核心功能**：
- **添加好友**：添加好友
- **删除好友**：删除好友
- **好友分组**：好友分组管理
- **在线状态**：好友在线状态
- **好友聊天**：好友私聊

**关键类**：
- `FriendController`：好友控制器
- `FriendBox`：好友背包
- `FriendInfo`：好友信息
- `FriendGroup`：好友分组
- `FriendVerify`：好友验证

**技术要点**：
- 支持好友关系
- 支持好友分组
- 支持在线状态
- 支持好友验证

#### 2.6 公会系统模块
**功能描述**：负责公会管理、公会成员、公会技能等。

**核心功能**：
- **创建公会**：创建公会
- **加入公会**：加入公会
- **退出公会**：退出公会
- **公会管理**：公会成员管理
- **公会技能**：公会技能学习

**关键类**：
- `GuildController`：公会控制器
- `GuildBox`：公会背包
- `GuildMember`：公会成员
- `GuildSkill`：公会技能

**技术要点**：
- 支持公会等级
- 支持公会成员
- 支持公会技能
- 支持公会活动

#### 2.7 邮件系统模块
**功能描述**：负责邮件发送、邮件接收、邮件附件等。

**核心功能**：
- **发送邮件**：发送邮件
- **接收邮件**：接收邮件
- **邮件附件**：邮件附件领取
- **邮件删除**：删除邮件

**关键类**：
- `MailService`：邮件服务
- `MailBox`：邮件背包
- `Mails`：邮件
- `MailItem`：邮件附件

**技术要点**：
- 支持系统邮件
- 支持玩家邮件
- 支持邮件附件
- 支持邮件过期

#### 2.8 副本系统模块
**功能描述**：负责副本管理、副本挑战、副本奖励等。

**核心功能**：
- **副本列表**：获取副本列表
- **进入副本**：进入副本
- **副本战斗**：副本战斗逻辑
- **副本结算**：副本结算奖励
- **副本记录**：副本记录统计

**关键类**：
- `Dungeon`：副本
- `DungeonCache`：副本缓存
- `PartyBoard`：队伍面板
- `HellPartyInfo`：地狱队伍信息

**技术要点**：
- 支持多种副本类型
- 支持副本难度
- 支持副本奖励
- 支持副本记录

#### 2.9 商城系统模块
**功能描述**：负责商品购买、交易、拍卖等。

**核心功能**：
- **商品列表**：获取商品列表
- **购买商品**：购买商品
- **拍卖行**：拍卖行交易
- **交易记录**：交易记录查询

**关键类**：
- `OnlineMallController`：商城控制器
- `OnlineMallInfo`：商城信息
- `Pay`：支付
- `Charge`：充值

**技术要点**：
- 支持多种商品类型
- 支持货币购买
- 支持拍卖行
- 支持交易记录

#### 2.10 成就系统模块
**功能描述**：负责成就管理、成就进度、成就奖励等。

**核心功能**：
- **成就列表**：获取成就列表
- **成就进度**：更新成就进度
- **成就奖励**：领取成就奖励

**关键类**：
- `AchievementController`：成就控制器
- `AchievementBox`：成就背包

**技术要点**：
- 支持多种成就类型
- 支持成就进度
- 支持成就奖励

#### 2.11 排名系统模块
**功能描述**：负责排行榜管理、排名更新、排名查询等。

**核心功能**：
- **排行榜**：获取排行榜
- **排名更新**：更新排名
- **排名查询**：查询排名

**关键类**：
- `RankController`：排名控制器

**技术要点**：
- 支持多种排行榜
- 支持实时排名
- 支持排名缓存

#### 2.12 PK 系统模块
**功能描述**：负责玩家对战、PK 记录、PK 积分等。

**核心功能**：
- **PK 请求**：发起 PK 请求
- **PK 战斗**：PK 战斗逻辑
- **PK 结算**：PK 结算奖励
- **PK 记录**：PK 记录统计

**关键类**：
- `PkController`：PK 控制器

**技术要点**：
- 支持 PK 模式
- 支持 PK 积分
- 支持 PK 记录

#### 2.13 组队系统模块
**功能描述**：负责队伍创建、加入、离开等。

**核心功能**：
- **创建队伍**：创建队伍
- **加入队伍**：加入队伍
- **离开队伍**：离开队伍
- **队伍管理**：队伍成员管理

**关键类**：
- `PartyController`：组队控制器
- `PartyService`：组队服务
- `DungeonParty`：副本队伍
- `DungeonPartyCache`：副本队伍缓存

**技术要点**：
- 支持队伍创建
- 支持队伍加入
- 支持队伍管理
- 支持队伍解散

#### 2.14 聊天系统模块
**功能描述**：负责聊天消息、聊天频道、聊天过滤等。

**核心功能**：
- **发送消息**：发送聊天消息
- **接收消息**：接收聊天消息
- **聊天频道**：多种聊天频道
- **聊天过滤**：敏感词过滤

**关键类**：
- `ChatController`：聊天控制器
- `ChatService`：聊天服务
- `ChatCache`：聊天缓存

**技术要点**：
- 支持多种聊天频道
- 支持敏感词过滤
- 支持聊天记录

#### 2.15 跨服系统模块
**功能描述**：负责跨服通信、跨服副本、跨服 PK 等。

**核心功能**：
- **跨服连接**：连接到跨服服务器
- **跨服通信**：跨服消息通信
- **跨服副本**：跨服副本挑战
- **跨服 PK**：跨服 PK 对战

**关键类**：
- `CrossServer`：跨服服务器
- `CrossTransportManager`：跨服传输管理器
- `Game2GameIoHandler`：游戏到游戏 IO 处理器
- `CCSession`：跨服会话

**技术要点**：
- 支持跨服连接
- 支持跨服通信
- 支持跨服功能

### 3. 辅助功能模块

#### 3.1 监控模块
**功能描述**：负责服务器监控、性能统计、告警等。

**核心功能**：
- **性能监控**：监控服务器性能
- **在线统计**：统计在线人数
- **消息统计**：统计消息处理量
- **告警通知**：异常告警通知

**关键类**：
- `GameMonitor`：游戏监控
- `GameMonitorMBean`：游戏监控 MBean
- `JmxClient`：JMX 客户端

**技术要点**：
- 使用 JMX 监控
- 支持性能统计
- 支持告警通知

#### 3.2 工具模块
**功能描述**：提供各种工具类和辅助函数。

**核心功能**：
- **字符串工具**：字符串处理
- **时间工具**：时间处理
- **加密工具**：加密解密
- **文件工具**：文件处理
- **JSON 工具**：JSON 处理

**关键类**：
- `StringUtil`：字符串工具
- `TimeUtil`：时间工具
- `DateUtils`：日期工具
- `MD5`：MD5 加密
- `DESUtil`：DES 加密
- `JsonUtils`：JSON 工具
- `FileUtils`：文件工具

**技术要点**：
- 提供常用工具类
- 支持多种格式处理
- 支持加密解密

## 依赖关系

### 模块依赖图

```
网络通信模块
    ↓
业务逻辑模块
    ↓
数据存储模块
    ↓
数据库
```

### 核心依赖关系

1. **网络通信模块**依赖：
   - 配置管理模块
   - 日志模块
   - 定时任务模块

2. **业务逻辑模块**依赖：
   - 网络通信模块
   - 数据存储模块
   - 配置管理模块
   - 日志模块

3. **数据存储模块**依赖：
   - 配置管理模块
   - 日志模块

4. **辅助功能模块**依赖：
   - 日志模块
   - 配置管理模块

## 优先级排序

### 第一优先级（核心基础）
1. 网络通信模块
2. 数据库模块
3. 配置管理模块
4. 日志模块

### 第二优先级（核心业务）
1. 登录认证模块
2. 背包系统模块
3. 装备系统模块
4. 技能系统模块

### 第三优先级（扩展业务）
1. 好友系统模块
2. 公会系统模块
3. 邮件系统模块
4. 副本系统模块
5. 商城系统模块

### 第四优先级（高级功能）
1. 成就系统模块
2. 排名系统模块
3. PK 系统模块
4. 组队系统模块
5. 聊天系统模块
6. 跨服系统模块

### 第五优先级（辅助功能）
1. 监控模块
2. 工具模块

## 技术难点

### 1. 网络通信
- 高并发连接处理
- 消息编解码性能
- 连接池管理
- 心跳检测

### 2. 数据一致性
- 数据库事务管理
- 缓存一致性
- 并发数据修改

### 3. 性能优化
- 内存管理
- 数据库查询优化
- 缓存策略
- 消息处理优化

### 4. 业务逻辑
- 复杂的游戏规则
- 状态机管理
- 事件系统
- 定时任务

### 5. 跨服通信
- 跨服连接管理
- 跨服消息路由
- 跨服数据同步
