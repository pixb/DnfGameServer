# 项目概述与需求分析

## 项目背景

DNF（地下城与勇士）游戏服务器是一个基于 Java 开发的多人在线角色扮演游戏（MMORPG）后端系统。该系统负责处理玩家的游戏逻辑、数据存储、网络通信、跨服交互等核心功能。本项目旨在将现有的 Java 服务器完整迁移到 Go 语言版本，保持所有功能和业务逻辑的一致性。

## 核心需求

### 1. 网络通信需求
- **TCP 长连接**：支持客户端与服务器的持久化 TCP 连接
- **协议序列化**：使用 Protobuf 进行高效的二进制协议序列化
- **消息路由**：支持基于注解的消息路由和分发机制
- **心跳检测**：实现客户端与服务器的心跳检测机制
- **连接管理**：支持会话管理、连接池、断线重连等功能

### 2. 数据存储需求
- **角色数据**：存储角色基本信息、属性、状态等
- **背包系统**：管理道具、装备、材料等物品数据
- **装备系统**：管理装备的强化、附魔、镶嵌等功能
- **技能系统**：管理角色技能、技能树、技能冷却等
- **好友系统**：管理好友关系、好友分组、在线状态等
- **公会系统**：管理公会成员、公会等级、公会技能等
- **邮件系统**：管理邮件发送、接收、附件等
- **副本系统**：管理副本进度、副本奖励、副本记录等
- **商城系统**：管理商品购买、交易、拍卖等
- **成就系统**：管理成就进度、成就奖励等
- **排名系统**：管理各种排行榜数据
- **PK 系统**：管理玩家对战、PK 记录、PK 积分等
- **组队系统**：管理队伍创建、加入、离开等

### 3. 业务逻辑需求
- **登录认证**：支持多种登录方式（openid、token 等）
- **角色管理**：支持角色创建、删除、切换等
- **道具使用**：支持道具的使用、消耗、合成等
- **装备强化**：支持装备的强化、升级、继承等
- **技能学习**：支持技能的学习、升级、遗忘等
- **副本挑战**：支持副本的进入、战斗、结算等
- **社交互动**：支持聊天、好友、公会等社交功能
- **交易系统**：支持玩家间交易、拍卖行等
- **活动系统**：支持各种游戏活动的参与和奖励
- **跨服功能**：支持跨服副本、跨服 PK 等

### 4. 性能需求
- **并发处理**：支持大量玩家同时在线
- **低延迟**：保证网络通信的低延迟
- **高吞吐**：支持高频率的消息处理
- **内存优化**：合理使用内存，避免内存泄漏
- **数据库优化**：优化数据库查询，提高响应速度

### 5. 安全需求
- **数据加密**：敏感数据需要加密存储
- **防作弊**：防止客户端作弊和非法操作
- **防刷屏**：防止恶意刷屏和攻击
- **权限控制**：严格控制操作权限
- **日志记录**：记录关键操作日志

## 技术栈概览

### Java 版本技术栈
- **语言**：Java 8+
- **框架**：Spring Boot
- **网络框架**：Apache Mina
- **协议序列化**：Protobuf
- **数据库 ORM**：NutZ
- **数据库**：MySQL
- **缓存**：Redis（可选）
- **定时任务**：Spring Scheduled
- **日志**：SLF4J + Logback

### Go 版本目标技术栈
- **语言**：Go 1.21+
- **框架**：Gin 或 Echo
- **网络框架**：net 或 gRPC
- **协议序列化**：Protobuf
- **数据库 ORM**：GORM 或 sqlx
- **数据库**：MySQL
- **缓存**：Redis
- **定时任务**：cron 或 robfig/cron
- **日志**：logrus 或 zap

## 项目结构

### Java 版本项目结构
```
src/main/java/com/dnfm/
├── common/           # 公共模块
│   ├── start/       # 启动配置
│   ├── db/          # 数据库服务
│   ├── thread/      # 线程池管理
│   ├── utils/       # 工具类
│   └── spring/      # Spring 配置
├── mina/            # 网络通信模块
│   ├── annotation/  # 注解定义
│   ├── cache/       # 缓存管理
│   ├── codec/       # 编解码器
│   ├── filter/      # 过滤器
│   ├── message/     # 消息处理
│   ├── session/     # 会话管理
│   └── udp/         # UDP 通信
├── cross/           # 跨服通信模块
│   ├── core/        # 跨服核心
│   ├── login/       # 跨服登录
│   └── logic/       # 跨服逻辑
├── game/            # 游戏业务模块
│   ├── achievement/ # 成就系统
│   ├── bag/         # 背包系统
│   ├── chat/        # 聊天系统
│   ├── config/      # 配置管理
│   ├── dungeon/     # 副本系统
│   ├── equip/       # 装备系统
│   ├── friend/      # 好友系统
│   ├── guild/       # 公会系统
│   ├── item/        # 道具系统
│   ├── login/       # 登录系统
│   ├── mail/        # 邮件系统
│   ├── make/        # 制造系统
│   ├── onlinemall/  # 商城系统
│   ├── party/       # 组队系统
│   ├── pk/          # PK 系统
│   ├── rank/        # 排名系统
│   ├── role/        # 角色系统
│   ├── skill/       # 技能系统
│   ├── support/     # 支持系统
│   └── utils/       # 工具类
└── http/            # HTTP 接口模块
    └── game/        # 游戏接口
```

### Go 版本目标项目结构
```
dnf-game-server/
├── cmd/              # 命令行入口
│   └── server/      # 服务器启动
├── internal/         # 内部模块
│   ├── common/      # 公共模块
│   │   ├── config/  # 配置管理
│   │   ├── db/      # 数据库服务
│   │   ├── utils/   # 工具类
│   │   └── logger/  # 日志管理
│   ├── network/     # 网络通信
│   │   ├── codec/   # 编解码器
│   │   ├── handler/ # 消息处理器
│   │   ├── session/ # 会话管理
│   │   └── filter/  # 过滤器
│   ├── cross/       # 跨服通信
│   │   ├── core/    # 跨服核心
│   │   ├── login/   # 跨服登录
│   │   └── logic/   # 跨服逻辑
│   └── game/        # 游戏业务
│       ├── achievement/ # 成就系统
│       ├── bag/         # 背包系统
│       ├── chat/        # 聊天系统
│       ├── config/      # 配置管理
│       ├── dungeon/     # 副本系统
│       ├── equip/       # 装备系统
│       ├── friend/      # 好友系统
│       ├── guild/       # 公会系统
│       ├── item/        # 道具系统
│       ├── login/       # 登录系统
│       ├── mail/        # 邮件系统
│       ├── make/        # 制造系统
│       ├── onlinemall/  # 商城系统
│       ├── party/       # 组队系统
│       ├── pk/          # PK 系统
│       ├── rank/        # 排名系统
│       ├── role/        # 角色系统
│       ├── skill/       # 技能系统
│       └── utils/       # 工具类
├── pkg/              # 公共包
│   ├── protobuf/    # Protobuf 生成代码
│   └── utils/       # 工具包
├── api/              # HTTP 接口
│   └── game/        # 游戏接口
├── configs/          # 配置文件
├── scripts/          # 脚本文件
├── proto/            # Protobuf 定义
└── docs/             # 文档
```

## 核心设计原则

### 1. 分层架构
- **网络层**：处理 TCP 连接、消息编解码
- **业务层**：处理游戏业务逻辑
- **数据层**：处理数据存储和查询

### 2. 模块化设计
- 每个业务系统独立成模块
- 模块间通过接口通信
- 降低耦合度，提高可维护性

### 3. 异步处理
- 使用 goroutine 处理并发请求
- 使用 channel 进行消息传递
- 避免阻塞主线程

### 4. 缓存优化
- 使用 Redis 缓存热点数据
- 减少数据库查询
- 提高响应速度

### 5. 错误处理
- 统一的错误处理机制
- 详细的错误日志
- 优雅的错误恢复

## 迁移目标

### 功能完整性
- 保持所有游戏功能的一致性
- 保持所有业务逻辑的一致性
- 保持所有数据结构的一致性

### 性能优化
- 提高并发处理能力
- 降低内存使用
- 提高响应速度

### 可维护性
- 清晰的代码结构
- 完善的文档
- 易于扩展

### 兼容性
- 保持与客户端的协议兼容
- 保持与数据库的兼容
- 保持与其他服务的兼容
