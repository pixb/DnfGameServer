# 批次07迁移计划

## 一、迁移概述

批次07将迁移连接战斗服务器、IDIP禁止列表和服务器简单数据相关的消息，包括连接战斗服务器、IDIP禁止列表查询、服务器简单数据加载和保存等功能。

## 二、迁移范围

### 2.1 连接战斗服务器 (ModuleID: 10014)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 连接战斗服务器请求 | REQ_CONNECT_BATTLE_SERVER | 0 | ✅ 已完成 |
| 连接战斗服务器响应 | RES_CONNECT_BATTLE_SERVER | 1 | ✅ 已完成 |

### 2.2 IDIP禁止列表 (ModuleID: 10017)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| IDIP禁止列表请求 | REQ_IDIP_PROHIBIT_LIST | 0 | ✅ 已完成 |
| IDIP禁止列表响应 | RES_IDIP_PROHIBIT_LIST | 1 | ✅ 已完成 |

### 2.3 服务器简单数据加载 (ModuleID: 10031)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 服务器简单数据加载请求 | REQ_LOAD_SERVER_SIMPLE_DATA | 0 | ✅ 已完成 |
| 服务器简单数据加载响应 | RES_LOAD_SERVER_SIMPLE_DATA | 1 | ✅ 已完成 |

### 2.4 服务器简单数据保存 (ModuleID: 10032)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 服务器简单数据保存请求 | REQ_SAVE_SERVER_SIMPLE_DATA | 0 | ✅ 已完成 |
| 服务器简单数据保存响应 | RES_SAVE_SERVER_SIMPLE_DATA | 1 | ✅ 已完成 |

## 三、消息分析

### 3.1 REQ_CONNECT_BATTLE_SERVER

**ModuleID**: 10014
**CMD**: 0
**字段定义**:
- `authkey` (string, order=1): 认证密钥
- `openid` (string, order=2): 开放ID
- `world` (int32, order=3): 世界ID
- `channel` (int32, order=4): 频道ID
- `charguid` (uint64, order=5): 角色GUID
- `type` (int32, order=6): 类型
- `dungeonguid` (uint64, order=7): 副本GUID

**Proto定义**:
```protobuf
message ConnectBattleServerRequest {
  string authkey = 1;
  string openid = 2;
  int32 world = 3;
  int32 channel = 4;
  uint64 charguid = 5;
  int32 type = 6;
  uint64 dungeonguid = 7;
}
```

### 3.2 RES_CONNECT_BATTLE_SERVER

**ModuleID**: 10014
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `authkey` (string, order=2): 认证密钥
- `bchannel` (int32, order=3): 战斗频道
- `servertime` (uint64, order=4): 服务器时间
- `encrypt` (bool, order=5): 是否加密
- `key` (string, order=6): 密钥
- `seeds` (List<int32>, order=7): 种子列表

**Proto定义**:
```protobuf
message ConnectBattleServerResponse {
  int32 error = 1;
  string authkey = 2;
  int32 bchannel = 3;
  uint64 servertime = 4;
  bool encrypt = 5;
  string key = 6;
  repeated int32 seeds = 7;
}
```

### 3.3 REQ_IDIP_PROHIBIT_LIST

**ModuleID**: 10017
**CMD**: 0
**字段定义**: 无字段（空消息）

**Proto定义**:
```protobuf
message IdipProhibitListRequest {
}
```

### 3.4 RES_IDIP_PROHIBIT_LIST

**ModuleID**: 10017
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `prohibit` (List<PT_PROHIBIT>, order=2): 禁止列表

**Proto定义**:
```protobuf
message IdipProhibitListResponse {
  int32 error = 1;
  repeated Prohibit prohibit = 2;
}
```

### 3.5 REQ_LOAD_SERVER_SIMPLE_DATA

**ModuleID**: 10031
**CMD**: 0
**字段定义**:
- `list` (List<PT_LOAD_SERVER_SIMPLE_DATA>, order=1): 数据列表

**Proto定义**:
```protobuf
message LoadServerSimpleDataRequest {
  repeated LoadServerSimpleData list = 1;
}
```

### 3.6 RES_LOAD_SERVER_SIMPLE_DATA

**ModuleID**: 10031
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `type` (int32, order=2): 类型
- `enumvalue` (int32, order=3): 枚举值
- `value` (string, order=4): 值

**Proto定义**:
```protobuf
message LoadServerSimpleDataResponse {
  int32 error = 1;
  int32 type = 2;
  int32 enumvalue = 3;
  string value = 4;
}
```

### 3.7 REQ_SAVE_SERVER_SIMPLE_DATA

**ModuleID**: 10032
**CMD**: 0
**字段定义**:
- `type` (int32, order=1): 类型
- `enumvalue` (int32, order=2): 枚举值
- `value` (string, order=3): 值

**Proto定义**:
```protobuf
message SaveServerSimpleDataRequest {
  int32 type = 1;
  int32 enumvalue = 2;
  string value = 3;
}
```

### 3.8 RES_SAVE_SERVER_SIMPLE_DATA

**ModuleID**: 10032
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码

**Proto定义**:
```protobuf
message SaveServerSimpleDataResponse {
  int32 error = 1;
}
```

## 四、数据结构定义

### 4.1 PT_PROHIBIT

**字段定义**:
- `target` (uint64, order=1): 目标
- `type` (ENUM_IDIP_PROHIBIT_TYPE.T, order=2): 类型
- `subtype` (List<int32>, order=3): 子类型列表
- `endtime` (int64, order=4): 结束时间
- `reason` (string, order=5): 原因
- `times` (List<int64>, order=6): 时间列表

**Proto定义**:
```protobuf
message Prohibit {
  uint64 target = 1;
  int32 type = 2;
  repeated int32 subtype = 3;
  int64 endtime = 4;
  string reason = 5;
  repeated int64 times = 6;
}
```

### 4.2 PT_LOAD_SERVER_SIMPLE_DATA

**字段定义**:
- `type` (int32, order=1): 类型
- `enumvalue` (int32, order=2): 枚举值

**Proto定义**:
```protobuf
message LoadServerSimpleData {
  int32 type = 1;
  int32 enumvalue = 2;
}
```

## 五、迁移步骤

### 步骤1: Proto文件更新

1. 创建或更新`battle.proto`文件，添加战斗服务器相关消息定义
2. 创建或更新`idip.proto`文件，添加IDIP相关消息定义
3. 创建或更新`server_data.proto`文件，添加服务器数据相关消息定义

### 步骤2: 代码生成

1. 使用buf工具生成Go代码
2. 使用buf工具生成Java代码

### 步骤3: 编解码器扩展

1. 在StandardProtobufDecoder中添加适配方法：
   - `adaptConnectBattleServerRequest(byte[] body)`
   - `adaptIdipProhibitListRequest(byte[] body)`
   - `adaptLoadServerSimpleDataRequest(byte[] body)`
   - `adaptSaveServerSimpleDataRequest(byte[] body)`

2. 在StandardProtobufEncoder中添加适配方法：
   - `adaptConnectBattleServerResponse(Message msg)`
   - `adaptIdipProhibitListResponse(Message msg)`
   - `adaptLoadServerSimpleDataResponse(Message msg)`
   - `adaptSaveServerSimpleDataResponse(Message msg)`

### 步骤4: 测试编写

1. 编写Go单元测试
2. 编写编解码测试程序

### 步骤5: 测试验证

1. 运行Go单元测试
2. 运行编解码测试
3. 验证跨语言通信

## 六、风险评估

### 6.1 技术风险

| 风险项 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| 枚举类型映射 | 中 | 需要查找ENUM_IDIP_PROHIBIT_TYPE定义 |
| 列表类型处理 | 低 | 参考之前的批次处理方式 |
| 字段类型映射 | 低 | 严格按照Java源码进行映射 |

### 6.2 兼容性风险

| 风险项 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| 与现有消息冲突 | 低 | 使用新的ModuleID |
| 字段顺序错误 | 低 | 严格按照Java源码的order值 |

## 七、预期成果

1. **Proto文件**:
   - battle.proto (战斗服务器相关消息)
   - idip.proto (IDIP相关消息)
   - server_data.proto (服务器数据相关消息)

2. **生成的代码**:
   - Go代码: gen/go/dnf/v1/
   - Java代码: gen/java/com/dnfm/mina/protobuf/generated/

3. **编解码器扩展**:
   - StandardProtobufDecoder新增4个适配方法
   - StandardProtobufEncoder新增4个适配方法

4. **测试文件**:
   - Go单元测试: test/batch07_test.go
   - 编解码测试: examples/batch07_codec.go

5. **文档**:
   - 迁移计划: devdoc/protobuf/batch_07/01_迁移计划.md
   - 迁移结果: devdoc/protobuf/batch_07/02_迁移结果.md

## 八、时间估算

| 步骤 | 预计时间 |
| :--- | :--- |
| Proto文件更新 | 15分钟 |
| 代码生成 | 5分钟 |
| 编解码器扩展 | 20分钟 |
| 测试编写 | 15分钟 |
| 测试验证 | 10分钟 |
| 文档编写 | 10分钟 |
| **总计** | **75分钟** |

---

**文档版本**: 1.0.0
**创建日期**: 2026-02-09
**创建人员**: AI Assistant
**状态**: ✅ 已完成
