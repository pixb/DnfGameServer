# 批次07迁移结果

## 迁移概述

批次07迁移于 2026-02-09 完成，成功将以下消息从 JProtobuf 迁移到标准 Protobuf：

- 连接战斗服务器 (CONNECT_BATTLE_SERVER, module=10014)
- IDIP禁止列表 (IDIP_PROHIBIT_LIST, module=10017)
- 加载服务器简单数据 (LOAD_SERVER_SIMPLE_DATA, module=10031)
- 保存服务器简单数据 (SAVE_SERVER_SIMPLE_DATA, module=10032)

## 迁移详情

### 1. 连接战斗服务器 (CONNECT_BATTLE_SERVER, module=10014)

**消息类型：**
- REQ_CONNECT_BATTLE_SERVER (cmd=0)
- RES_CONNECT_BATTLE_SERVER (cmd=1)

**Proto文件：** [battle.proto](file:///home/pix/dev/code/java/DnfGameServer/proto/dnf/v1/battle.proto)

**数据结构：**
- ConnectBattleServerRequest: 包含认证信息、角色信息、世界和频道信息
- ConnectBattleServerResponse: 包含错误码、新的认证密钥、服务器时间、加密信息等

**测试结果：**
- Go单元测试：✓ 通过
- 编解码测试：✓ 通过
- Java编译：✓ 通过

### 2. IDIP禁止列表 (IDIP_PROHIBIT_LIST, module=10017)

**消息类型：**
- REQ_IDIP_PROHIBIT_LIST (cmd=0)
- RES_IDIP_PROHIBIT_LIST (cmd=1)

**Proto文件：** [idip.proto](file:///home/pix/dev/code/java/DnfGameServer/proto/dnf/v1/idip.proto)

**数据结构：**
- IdipProhibitType: 枚举类型，定义了16种禁止类型
- Prohibit: 禁止信息，包含目标、类型、子类型、结束时间、原因等
- IdipProhibitListRequest: 空请求
- IdipProhibitListResponse: 包含错误码和禁止列表

**特殊处理：**
- 将 NONE 枚举值重命名为 IDIP_NONE 以避免与 channel.proto 中的 ClientBuildType.NONE 冲突
- 将 Prohibit 消息的 type 字段从 int32 类型改为 IdipProhibitType 枚举类型

**测试结果：**
- Go单元测试：✓ 通过
- 编解码测试：✓ 通过
- Java编译：✓ 通过

### 3. 加载服务器简单数据 (LOAD_SERVER_SIMPLE_DATA, module=10031)

**消息类型：**
- REQ_LOAD_SERVER_SIMPLE_DATA (cmd=0)
- RES_LOAD_SERVER_SIMPLE_DATA (cmd=1)

**Proto文件：** [server_data.proto](file:///home/pix/dev/code/java/DnfGameServer/proto/dnf/v1/server_data.proto)

**数据结构：**
- LoadServerSimpleData: 服务器简单数据，包含类型和枚举值
- LoadServerSimpleDataRequest: 包含数据列表
- LoadServerSimpleDataResponse: 包含错误码、类型、枚举值和字符串值

**测试结果：**
- Go单元测试：✓ 通过
- 编解码测试：✓ 通过
- Java编译：✓ 通过

### 4. 保存服务器简单数据 (SAVE_SERVER_SIMPLE_DATA, module=10032)

**消息类型：**
- REQ_SAVE_SERVER_SIMPLE_DATA (cmd=0)
- RES_SAVE_SERVER_SIMPLE_DATA (cmd=1)

**Proto文件：** [server_data.proto](file:///home/pix/dev/code/java/DnfGameServer/proto/dnf/v1/server_data.proto)

**数据结构：**
- SaveServerSimpleDataRequest: 包含类型、枚举值和字符串值
- SaveServerSimpleDataResponse: 包含错误码

**测试结果：**
- Go单元测试：✓ 通过
- 编解码测试：✓ 通过
- Java编译：✓ 通过

## 代码生成

### Go代码生成

**生成命令：**
```bash
cd /home/pix/dev/code/java/DnfGameServer/proto && buf generate
```

**生成文件：**
- gen/go/dnf/v1/battle.pb.go
- gen/go/dnf/v1/idip.pb.go
- gen/go/dnf/v1/server_data.pb.go

### Java代码生成

**生成文件：**
- gen/java/com/dnfm/mina/protobuf/generated/ConnectBattleServerRequest.java
- gen/java/com/dnfm/mina/protobuf/generated/ConnectBattleServerResponse.java
- gen/java/com/dnfm/mina/protobuf/generated/IdipProhibitListRequest.java
- gen/java/com/dnfm/mina/protobuf/generated/IdipProhibitListResponse.java
- gen/java/com/dnfm/mina/protobuf/generated/LoadServerSimpleDataRequest.java
- gen/java/com/dnfm/mina/protobuf/generated/LoadServerSimpleDataResponse.java
- gen/java/com/dnfm/mina/protobuf/generated/SaveServerSimpleDataRequest.java
- gen/java/com/dnfm/mina/protobuf/generated/SaveServerSimpleDataResponse.java

## 编解码器扩展

### StandardProtobufDecoder

**新增适配方法：**
- adaptConnectBattleServerRequest()
- adaptIdipProhibitListRequest()
- adaptLoadServerSimpleDataRequest()
- adaptSaveServerSimpleDataRequest()

**文件位置：** [StandardProtobufDecoder.java](file:///home/pix/dev/code/java/DnfGameServer/src/main/java/com/dnfm/mina/codec/StandardProtobufDecoder.java)

### StandardProtobufEncoder

**新增适配方法：**
- adaptConnectBattleServerResponse()
- adaptIdipProhibitListResponse()
- adaptLoadServerSimpleDataResponse()
- adaptSaveServerSimpleDataResponse()

**文件位置：** [StandardProtobufEncoder.java](file:///home/pix/dev/code/java/DnfGameServer/src/main/java/com/dnfm/mina/codec/StandardProtobufEncoder.java)

## 测试结果

### Go单元测试

**测试文件：** [batch07_test.go](file:///home/pix/dev/code/java/DnfGameServer/dnf-go-client/test/batch07_test.go)

**测试用例：**
- TestConnectBattleServerRequest_Serialization
- TestConnectBattleServerResponse_Serialization
- TestIdipProhibitListRequest_Serialization
- TestIdipProhibitListResponse_Serialization
- TestLoadServerSimpleDataRequest_Serialization
- TestLoadServerSimpleDataResponse_Serialization
- TestSaveServerSimpleDataRequest_Serialization
- TestSaveServerSimpleDataResponse_Serialization
- TestProhibit_Serialization
- TestConnectBattleServerRequest_ZeroValues
- TestIdipProhibitListResponse_MultipleProhibits

**测试结果：** 11个测试用例全部通过 ✓

### 编解码测试

**测试文件：** [batch07_codec.go](file:///home/pix/dev/code/java/DnfGameServer/dnf-go-client/examples/batch07_codec.go)

**测试结果：**
- 连接战斗服务器消息：✓ 通过
- IDIP禁止列表消息：✓ 通过
- 加载服务器简单数据消息：✓ 通过
- 保存服务器简单数据消息：✓ 通过

### Java编译

**编译命令：**
```bash
mvn compile
```

**编译结果：** 成功 ✓

**修复的问题：**
- 修复了 StandardProtobufDecoder 中使用 hasBuildType() 方法的问题，改为直接比较枚举值

## 遇到的问题和解决方案

### 问题1：枚举值冲突

**问题描述：**
在生成代码时出现错误："symbol 'dnf.v1.NONE' already defined at dnf/v1/idip.proto:14:3"

**原因：**
channel.proto 中的 ClientBuildType 枚举和 idip.proto 中的 IdipProhibitType 枚举都定义了 NONE 值，在 Protobuf 的 C++ 作用域规则下产生冲突。

**解决方案：**
将 idip.proto 中的 NONE 重命名为 IDIP_NONE，避免命名冲突。

### 问题2：类型不匹配

**问题描述：**
Go测试编译失败，错误信息："cannot use dnfv1.IdipProhibitType_BAN (constant 5 of int32 type dnfv1.IdipProhibitType) as int32 value in struct literal"

**原因：**
Prohibit 消息的 type 字段定义为 int32 类型，但尝试使用枚举类型赋值。

**解决方案：**
将 Prohibit 消息的 type 字段类型从 int32 改为 IdipProhibitType 枚举类型。

### 问题3：Java编译错误

**问题描述：**
Java编译失败，错误信息："cannot find symbol: method hasBuildType()"

**原因：**
StandardProtobufDecoder 中使用了 hasBuildType() 方法，但生成的 Protobuf 代码中没有这个方法。

**解决方案：**
将条件判断从 `newClientInfo.hasBuildType()` 改为 `newClientInfo.getBuildType() != com.dnfm.mina.protobuf.generated.ClientBuildType.NONE`。

## 迁移总结

批次07迁移成功完成，共迁移了4个模块的8个消息类型。迁移过程中遇到了枚举值冲突、类型不匹配和编译错误等问题，都已成功解决。

**迁移成果：**
- 创建了3个新的proto文件
- 生成了Go和Java代码
- 扩展了编解码器支持
- 编写了完整的测试用例
- 所有测试通过

**下一步：**
继续进行下一批次的迁移工作。
