# 批次37: 婚礼、世界突袭、观看书签、验证系统迁移计划

## 批次概述

**批次编号**: batch_37  
**批次描述**: 婚礼系统、世界突袭系统、观看书签系统、验证系统  
**迁移日期**: 2026-02-10  
**迁移状态**: ⏳ 待开始

## 迁移目标

本次迁移涵盖以下游戏系统模块：

1. **婚礼系统** (Wedding)
   - 婚礼留言簿管理
   - 婚礼邀请管理
   - 婚礼出席管理
   - 婚礼主题设置
   - 婚礼仪式配置
   - 婚礼准备管理
   - 婚礼红包排行

2. **世界突袭系统** (WorldRaid)
   - 世界突袭信息查询
   - 世界突袭排行查询

3. **观看书签系统** (Watching)
   - 观看书签管理

4. **验证系统** (Verification)
   - 客户端验证
   - 伤害数据验证

## 待迁移文件列表

### 婚礼系统 (7个文件)

| 文件名 | 描述 | 字段数 |
|--------|------|--------|
| PT_WEDDING_GUESTBOOK | 婚礼留言簿信息 | 5 |
| PT_WEDDING_INVITATION | 婚礼邀请信息 | 7 |
| PT_WEDDING_ATTENDANCE | 婚礼出席信息 | 4 |
| PT_WEDDING_THEME | 婚礼主题信息 | 5 |
| PT_WEDDING_THEME_CEREMONY | 婚礼仪式信息 | 2 |
| PT_WEDDING_PREPARATION | 婚礼准备信息 | 5 |
| PT_WEDDING_MONEYGIFT_RANKING | 婚礼红包排行信息 | 8 |

### 世界突袭系统 (2个文件)

| 文件名 | 描述 | 字段数 |
|--------|------|--------|
| PT_WORLD_RAID_INFO | 世界突袭信息 | 2 |
| PT_WORLD_RAID_RANKING | 世界突袭排行信息 | 9 |

### 观看书签系统 (1个文件)

| 文件名 | 描述 | 字段数 |
|--------|------|--------|
| PT_WATCHING_BOOKMARK | 观看书签信息 | 11 |

### 验证系统 (2个文件)

| 文件名 | 描述 | 字段数 |
|--------|------|--------|
| PT_VERIFICATION | 客户端验证信息 | 1 |
| PT_VERIFICATION_ADD_DAMAGE_DATA | 伤害数据验证信息 | 5 |

**总计**: 12个JProtobuf文件

## 文件结构分析

### PT_WEDDING_GUESTBOOK
```java
public class PT_WEDDING_GUESTBOOK {
   Long writerguid;           // 留言者GUID
   String writername;          // 留言者名称
   Integer writerjob;          // 留言者职业
   Long writedate;            // 留言日期
   String contents;            // 留言内容
}
```

### PT_WEDDING_INVITATION
```java
public class PT_WEDDING_INVITATION {
   Long marriageguid;          // 婚姻GUID
   Long inviterguid;           // 邀请者GUID
   String invitername;         // 邀请者名称
   Long spouseguid;            // 配偶GUID
   String spousename;          // 配偶名称
   Integer weddinghallindex;    // 婚礼大厅索引
   Integer weddingdate;         // 婚礼日期
}
```

### PT_WEDDING_ATTENDANCE
```java
public class PT_WEDDING_ATTENDANCE {
   Long attendanceguid;        // 出席GUID
   String attendancename;      // 出席名称
   Long gguid;                 // G GUID
   Integer replytype;           // 回复类型
}
```

### PT_WEDDING_THEME
```java
public class PT_WEDDING_THEME {
   Integer weddinghall;        // 婚礼大厅
   Integer officiant;          // 主持人
   List<Integer> guestlist;    // 宾客列表
   Integer dress;              // 礼服
   List<PT_WEDDING_THEME_CEREMONY> ceremonylist; // 仪式列表
}
```

### PT_WEDDING_THEME_CEREMONY
```java
public class PT_WEDDING_THEME_CEREMONY {
   Integer category;            // 类别
   Integer index;              // 索引
}
```

### PT_WEDDING_PREPARATION
```java
public class PT_WEDDING_PREPARATION {
   Long charguid;              // 负责人GUID
   PT_WEDDING_THEME theme;     // 婚礼主题
   Integer paymentamount;      // 支付金额
   Integer paymentgold;        // 支付金币
   Integer paymenttera;        // 支付泰拉
}
```

### PT_WEDDING_MONEYGIFT_RANKING
```java
public class PT_WEDDING_MONEYGIFT_RANKING {
   Long guid;                  // GUID
   Integer growtype;           // 成长类型
   Integer secondgrowtype;     // 第二成长类型
   Integer job;                // 职业
   Integer level;              // 等级
   String name;                // 名称
   Long rank;                  // 排名
   Long score;                 // 分数
}
```

### PT_WORLD_RAID_INFO
```java
public class PT_WORLD_RAID_INFO {
   Integer dungeonindex;       // 副本索引
   Long hp;                    // HP
}
```

### PT_WORLD_RAID_RANKING
```java
public class PT_WORLD_RAID_RANKING {
   Integer growtype;           // 成长类型
   Integer secondgrowtype;     // 第二成长类型
   Long guid;                  // GUID
   Integer job;                // 职业
   Integer level;              // 等级
   String name;                // 名称
   Integer rank;               // 排名
   Long score;                 // 分数
   Integer characterframe;     // 角色框
}
```

### PT_WATCHING_BOOKMARK
```java
public class PT_WATCHING_BOOKMARK {
   Long guid;                  // GUID
   String name;                // 名称
   Integer level;              // 等级
   Integer job;                // 职业
   Integer growtype;           // 成长类型
   Integer secondgrowtype;     // 第二成长类型
   Integer characterframe;     // 角色框
   String profileurl;          // 头像URL
   String profilename;         // 头像名称
   Long playtime;              // 游戏时间
   Integer lastpvpmatch;       // 最后PVP匹配
}
```

### PT_VERIFICATION
```java
public class PT_VERIFICATION {
   String clientstarttime;     // 客户端开始时间
}
```

### PT_VERIFICATION_ADD_DAMAGE_DATA
```java
public class PT_VERIFICATION_ADD_DAMAGE_DATA {
   Integer flag;               // 标志
   Integer damage;             // 伤害
   Integer itemindex;          // 物品索引
   Integer ifindex;            // IF索引
   Integer thenindex;          // THEN索引
}
```

## 迁移步骤

### 步骤1: 创建Protobuf定义文件

创建 `social_events.proto` 文件，包含所有社交事件相关的消息定义。

### 步骤2: 使用buf工具生成代码

```bash
cd /home/pix/dev/code/java/DnfGameServer/proto
buf generate dnf/v1/social_events.proto
```

### 步骤3: 编写Go单元测试

创建 `batch37_test.go` 文件，测试所有消息的序列化/反序列化。

### 步骤4: 运行测试并验证

```bash
cd /home/pix/dev/code/java/DnfGameServer/dnf-go-client/test
go test -v -run TestBatch37
```

### 步骤5: 验证Java编译

```bash
cd /home/pix/dev/code/java/DnfGameServer
mvn compile -DskipTests
```

### 步骤6: 更新迁移追踪系统

将批次37信息添加到数据库。

### 步骤7: 创建迁移结果文档

记录迁移过程中的所有信息和结果。

## 预期结果

- 生成1个Protobuf定义文件：`social_events.proto`
- 生成12个消息类型
- 生成Go代码文件：`social_events.pb.go`
- 生成30+个Java类文件
- 所有测试通过
- Java编译成功

## 注意事项

1. **嵌套消息处理**: PT_WEDDING_THEME 包含嵌套的 PT_WEDDING_THEME_CEREMONY 列表
2. **重复字段处理**: PT_WEDDING_THEME 包含 guestlist (repeated int32)
3. **GUID类型**: 使用 uint64 类型存储 GUID
4. **时间戳**: 使用 int64 类型存储时间戳

## 相关文件

- JProtobuf源文件: `/home/pix/dev/code/java/DnfGameServer/src/main/java/com/dnfm/mina/protobuf/`
- Protobuf定义: `/home/pix/dev/code/java/DnfGameServer/proto/dnf/v1/social_events.proto`
- Go测试: `/home/pix/dev/code/java/DnfGameServer/dnf-go-client/test/batch37_test.go`
- 迁移文档: `/home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/batch_37/`
