# 批次21: CHAT 模块迁移计划

## 一、迁移范围

### 1.1 消息类型

| ModuleID | 消息类型 | 功能描述 | 状态 |
| :--- | :--- | :--- | :--- |
| 10105 | 城镇聊天 | 发送城镇聊天消息 | ✅ 待迁移 |
| 13037 | 快速聊天 | 发送快速聊天消息 | ✅ 待迁移 |
| 27017 | 加载公会聊天 | 加载公会聊天记录 | ✅ 待迁移 |
| 10131 | 加载隐藏聊天 | 加载隐藏聊天列表 | ✅ 待迁移 |
| 10129 | 添加隐藏聊天 | 添加隐藏聊天 | ✅ 待迁移 |
| 10130 | 删除隐藏聊天 | 删除隐藏聊天 | ✅ 待迁移 |
| 10128 | 聊天频道列表 | 获取聊天频道列表 | ✅ 待迁移 |
| 14093 | 聊天框架标签列表 | 获取聊天框架标签列表 | ✅ 待迁移 |

### 1.2 源文件

| 文件名 | 路径 | 状态 |
| :--- | :--- | :--- |
| REQ_TOWN_CHAT.java | src/main/java/com/dnfm/mina/protobuf/REQ_TOWN_CHAT.java | ✅ 待迁移 |
| REQ_QUICK_CHATTING.java | src/main/java/com/dnfm/mina/protobuf/REQ_QUICK_CHATTING.java | ✅ 待迁移 |
| REQ_LOAD_GUILD_CHAT.java | src/main/java/com/dnfm/mina/protobuf/REQ_LOAD_GUILD_CHAT.java | ✅ 待迁移 |
| REQ_HIDDEN_CHATTING_LOAD.java | src/main/java/com/dnfm/mina/protobuf/REQ_HIDDEN_CHATTING_LOAD.java | ✅ 待迁移 |
| REQ_HIDDEN_CHATTING_ADD.java | src/main/java/com/dnfm/mina/protobuf/REQ_HIDDEN_CHATTING_ADD.java | ✅ 待迁移 |
| REQ_HIDDEN_CHATTING_DELETE.java | src/main/java/com/dnfm/mina/protobuf/REQ_HIDDEN_CHATTING_DELETE.java | ✅ 待迁移 |
| REQ_CHAT_CHANNEL_LIST.java | src/main/java/com/dnfm/mina/protobuf/REQ_CHAT_CHANNEL_LIST.java | ✅ 待迁移 |
| REQ_CHAT_FRAME_TAB_LIST.java | src/main/java/com/dnfm/mina/protobuf/REQ_CHAT_FRAME_TAB_LIST.java | ✅ 待迁移 |

### 1.3 目标文件

| 文件名 | 路径 | 状态 |
| :--- | :--- | :--- |
| chat.proto | proto/dnf/v1/chat.proto | ✅ 待生成 |

## 二、迁移步骤

### 2.1 分析与准备

1. **分析源文件结构**：了解JProtobuf注解和字段定义
2. **确定类型映射**：JProtobuf类型到标准Protobuf类型的映射
3. **设计Proto文件**：基于源文件设计标准Protobuf消息结构

### 2.2 实现与生成

1. **创建chat.proto文件**：定义消息结构和数据类型
2. **配置代码生成**：设置buf.gen.yaml配置文件
3. **生成代码**：使用buf generate生成Java和Go代码

### 2.3 集成与测试

1. **扩展编解码器**：修改StandardProtobufDecoder和StandardProtobufEncoder
2. **编写测试用例**：验证消息序列化/反序列化
3. **编译验证**：确保Java代码编译通过

## 三、数据结构设计

### 3.1 核心消息结构

#### 3.1.1 城镇聊天

```protobuf
// 城镇聊天请求
message TownChatRequest {
  int32 type = 1;         // 聊天类型
  string chat = 2;         // 聊天内容
  string voice = 3;        // 语音消息
  string voicetime = 4;    // 语音时长
  string name = 5;         // 发送者名称
  uint64 guid = 6;         // 发送者GUID
  int32 job = 7;           // 职业
  int32 level = 8;         // 等级
  int32 channel = 9;       // 频道
}

// 城镇聊天响应
message TownChatResponse {
  int32 error = 1;        // 错误码
  bool success = 2;        // 是否成功
}
```

#### 3.1.2 快速聊天

```protobuf
// 快速聊天请求
message QuickChattingRequest {
  int32 type = 1;         // 聊天类型
}

// 快速聊天响应
message QuickChattingResponse {
  int32 error = 1;        // 错误码
  bool success = 2;        // 是否成功
}
```

#### 3.1.3 加载公会聊天

```protobuf
// 加载公会聊天请求
message LoadGuildChatRequest {
  int32 sequence = 1;      // 序列号
}

// 加载公会聊天响应
message LoadGuildChatResponse {
  int32 error = 1;              // 错误码
  repeated GuildChat chats = 2;   // 聊天列表
  int32 total_count = 3;         // 总数量
}
```

#### 3.1.4 隐藏聊天

```protobuf
// 隐藏聊天信息
message HiddenChatting {
  uint64 guid = 1;       // GUID
  string name = 2;        // 名称
  int32 type = 3;         // 类型
}

// 加载隐藏聊天请求
message HiddenChattingLoadRequest {
}

// 加载隐藏聊天响应
message HiddenChattingLoadResponse {
  int32 error = 1;                      // 错误码
  repeated HiddenChatting chattings = 2;   // 隐藏聊天列表
  int32 total_count = 3;                 // 总数量
}

// 添加隐藏聊天请求
message HiddenChattingAddRequest {
  repeated HiddenChatting chattings = 1;  // 隐藏聊天列表
}

// 添加隐藏聊天响应
message HiddenChattingAddResponse {
  int32 error = 1;        // 错误码
  bool success = 2;        // 是否成功
}

// 删除隐藏聊天请求
message HiddenChattingDeleteRequest {
  repeated HiddenChatting chattings = 1;  // 隐藏聊天列表
}

// 删除隐藏聊天响应
message HiddenChattingDeleteResponse {
  int32 error = 1;        // 错误码
  bool success = 2;        // 是否成功
}
```

#### 3.1.5 聊天频道列表

```protobuf
// 聊天频道请求
message ChatChannelListRequest {
}

// 聊天频道信息
message ChatChannel {
  int32 channel_id = 1;   // 频道ID
  string name = 2;         // 频道名称
  int32 type = 3;         // 频道类型
  int32 max_users = 4;    // 最大用户数
  int32 current_users = 5; // 当前用户数
}

// 聊天频道列表响应
message ChatChannelListResponse {
  int32 error = 1;                 // 错误码
  repeated ChatChannel channels = 2;   // 频道列表
  int32 total_count = 3;            // 总数量
}
```

#### 3.1.6 聊天框架标签列表

```protobuf
// 聊天框架标签列表请求
message ChatFrameTabListRequest {
}

// 聊天框架标签列表响应
message ChatFrameTabListResponse {
  int32 error = 1;        // 错误码
  repeated string tabs = 2;  // 标签列表
}
```

#### 3.1.7 公会聊天

```protobuf
// 公会聊天信息
message GuildChat {
  uint64 guid = 1;       // 发送者GUID
  string name = 2;        // 发送者名称
  string content = 3;      // 聊天内容
  int32 type = 4;         // 聊天类型
  int64 timestamp = 5;    // 时间戳
  int32 job = 6;           // 职业
  int32 level = 7;         // 等级
}
```

### 3.2 数据类型映射

| JProtobuf类型 | 标准Protobuf类型 | 备注 |
| :--- | :--- | :--- |
| int | int32 | 整数类型 |
| long | uint64 | 无符号长整数类型 |
| String | string | 字符串类型 |
| boolean | bool | 布尔类型 |
| List<T> | repeated T | 列表类型 |
| 自定义对象 | message | 嵌套消息 |

## 四、编解码器扩展

### 4.1 StandardProtobufDecoder

**新增方法：**

- `adaptTownChatRequest(byte[] body)` - 城镇聊天请求解码
- `adaptQuickChattingRequest(byte[] body)` - 快速聊天请求解码
- `adaptLoadGuildChatRequest(byte[] body)` - 加载公会聊天请求解码
- `adaptHiddenChattingLoadRequest(byte[] body)` - 加载隐藏聊天请求解码
- `adaptHiddenChattingAddRequest(byte[] body)` - 添加隐藏聊天请求解码
- `adaptHiddenChattingDeleteRequest(byte[] body)` - 删除隐藏聊天请求解码
- `adaptChatChannelListRequest(byte[] body)` - 聊天频道列表请求解码
- `adaptChatFrameTabListRequest(byte[] body)` - 聊天框架标签列表请求解码

**支持的ModuleID：**
- 10105 - 城镇聊天
- 13037 - 快速聊天
- 27017 - 加载公会聊天
- 10131 - 加载隐藏聊天
- 10129 - 添加隐藏聊天
- 10130 - 删除隐藏聊天
- 10128 - 聊天频道列表
- 14093 - 聊天框架标签列表

### 4.2 StandardProtobufEncoder

**新增方法：**

- `adaptTownChatResponse(Message msg)` - 城镇聊天响应编码
- `adaptQuickChattingResponse(Message msg)` - 快速聊天响应编码
- `adaptLoadGuildChatResponse(Message msg)` - 加载公会聊天响应编码
- `adaptHiddenChattingLoadResponse(Message msg)` - 加载隐藏聊天响应编码
- `adaptHiddenChattingAddResponse(Message msg)` - 添加隐藏聊天响应编码
- `adaptHiddenChattingDeleteResponse(Message msg)` - 删除隐藏聊天响应编码
- `adaptChatChannelListResponse(Message msg)` - 聊天频道列表响应编码
- `adaptChatFrameTabListResponse(Message msg)` - 聊天框架标签列表响应编码

**支持的ModuleID：**
- 10105 - 城镇聊天
- 13037 - 快速聊天
- 27017 - 加载公会聊天
- 10131 - 加载隐藏聊天
- 10129 - 添加隐藏聊天
- 10130 - 删除隐藏聊天
- 10128 - 聊天频道列表
- 14093 - 聊天框架标签列表

## 五、测试计划

### 5.1 单元测试

| 测试文件 | 测试内容 | 状态 |
| :--- | :--- | :--- |
| batch21_test.go | TownChatRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | QuickChattingRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | LoadGuildChatRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | HiddenChattingLoadRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | HiddenChattingAddRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | HiddenChattingDeleteRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | ChatChannelListRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | ChatFrameTabListRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | HiddenChatting 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | ChatChannel 序列化/反序列化 | ✅ 待实现 |
| batch21_test.go | GuildChat 序列化/反序列化 | ✅ 待实现 |

### 5.2 编译验证

| 命令 | 验证内容 | 状态 |
| :--- | :--- | :--- |
| `mvn compile` | Java代码编译 | ✅ 待验证 |

## 六、时间计划

| 阶段 | 时间 | 任务 |
| :--- | :--- | :--- |
| 准备阶段 | 2026-02-09 | 分析源文件，设计Proto结构 |
| 实现阶段 | 2026-02-09 | 创建Proto文件，生成代码 |
| 集成阶段 | 2026-02-09 | 扩展编解码器，编写测试 |
| 验证阶段 | 2026-02-09 | 运行测试，验证编译 |
| 完成阶段 | 2026-02-09 | 更新文档，总结经验 |

## 七、风险评估

| 风险 | 概率 | 影响 | 应对措施 |
| :--- | :--- | :--- | :--- |
| 源文件不存在 | 中 | 高 | 基于功能需求设计消息结构 |
| 字段类型映射错误 | 低 | 中 | 参考已有批次的类型映射 |
| 编解码器集成失败 | 低 | 中 | 遵循已有批次的集成模式 |
| 测试用例失败 | 低 | 低 | 及时修复问题，确保功能正确 |

## 八、依赖关系

| 依赖项 | 版本 | 用途 | 状态 |
| :--- | :--- | :--- | :--- |
| protobuf | 3.21.0 | 协议定义 | ✅ 已就绪 |
| buf | 1.24.0 | 代码生成 | ✅ 已就绪 |
| go | 1.20+ | Go代码生成 | ✅ 已就绪 |
| java | 1.8+ | Java代码生成 | ✅ 已就绪 |

## 九、预期成果

1. **成功迁移聊天相关消息**：城镇聊天、快速聊天、加载公会聊天、隐藏聊天管理、聊天频道列表、聊天框架标签列表
2. **新增chat.proto文件**：定义聊天相关消息结构
3. **定义了聊天相关数据结构**：HiddenChatting, ChatChannel, GuildChat等
4. **扩展了编解码器支持**：添加了聊天模块的编解码方法
5. **验证了跨语言通信**：确保Java服务器和Go客户端能够正确通信
6. **Go单元测试通过**：验证消息序列化/反序列化正确性
7. **Java编译成功**：确保代码集成无错误

## 十、后续计划

- **批次22**：迁移其他模块消息
- **持续优化**：根据实际使用情况优化消息结构和编解码器性能
