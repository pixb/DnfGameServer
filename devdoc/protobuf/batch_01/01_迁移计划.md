# 批次 01 迁移计划

## 一、迁移概览

**批次编号**：batch_01
**迁移时间**：2026-02-08
**迁移文件数**：5个
**迁移状态**：执行中

## 二、迁移文件

### 2.1 Java文件列表

| 序号 | 文件名 | 文件路径 | 依赖 | 说明 |
|------|--------|----------|------|------|
| 1 | PT_CHANNEL_INFO.java | src/main/java/com/dnfm/mina/protobuf/PT_CHANNEL_INFO.java | 无 | 渠道信息 |
| 2 | PT_INTRUDE_MEMBER_INFO.java | src/main/java/com/dnfm/mina/protobuf/PT_INTRUDE_MEMBER_INFO.java | 无 | 入侵成员信息 |
| 3 | PT_INTRUDE_INFO.java | src/main/java/com/dnfm/mina/protobuf/PT_INTRUDE_INFO.java | PT_CHANNEL_INFO, PT_INTRUDE_MEMBER_INFO | 入侵信息 |
| 4 | REQ_LOGIN.java | src/main/java/com/dnfm/mina/protobuf/REQ_LOGIN.java | 无 | 登录请求 |
| 5 | RES_LOGIN.java | src/main/java/com/dnfm/mina/protobuf/RES_LOGIN.java | PT_CHANNEL_INFO, PT_INTRUDE_INFO | 登录响应 |

### 2.2 对应Proto文件
- **文件路径**：`proto/dnf/v1/auth_login.proto`
- **消息定义**：
  - `ChannelInfo`（对应 PT_CHANNEL_INFO）
  - `IntrudeMemberInfo`（对应 PT_INTRUDE_MEMBER_INFO）
  - `IntrudeInfo`（对应 PT_INTRUDE_INFO）
  - `LoginRequest`（对应 REQ_LOGIN）
  - `LoginResponse`（对应 RES_LOGIN）

## 三、迁移步骤

### 3.1 步骤1：分析Java文件
- 分析 5个Java文件的字段定义
- 确认 `@Protobuf` 注解的字段类型和顺序
- 映射到标准Protobuf类型
- 确认依赖关系

### 3.2 步骤2：生成Proto文件
- 在 `proto/dnf/v1/auth_login.proto` 中定义对应消息
- 保持字段序号和类型一致性
- 验证Proto文件语法正确
- 按照依赖顺序定义消息（基础类型 → 复合类型）

### 3.3 步骤3：生成Go代码
- 执行 `buf generate --path dnf/v1/auth_login.proto` 生成Go代码
- 生成路径：`dnf-go-client/gen/go/dnf/v1/auth_login.pb.go`
- 验证生成的Go代码编译通过

### 3.4 步骤4：编写Go测试用例
- 创建测试文件：`dnf-go-client/test/auth_login_test.go`
- 测试所有5个消息类型的序列化/反序列化
- 测试通过

### 3.5 步骤5：生成Java代码
- 执行 `buf generate --path dnf/v1/auth_login.proto` 生成Java代码
- 生成路径：`proto/gen/java/com/dnfm/mina/protobuf/generated/`
- 验证Java代码编译通过

### 3.6 步骤6：调试Java服务端
- 修改Java代码使用新生成的协议
- 编译项目：`mvn clean compile`
- 启动服务：`mvn spring-boot:run`
- 验证服务启动成功

### 3.7 步骤7：运行Go测试用例
- 再次运行Go测试用例
- 验证跨语言通信正常
- 本次迁移完毕

## 四、测试规划

### 4.1 Go测试用例
- **测试文件**：`dnf-go-client/test/auth_login_test.go`
- **测试内容**：
  - `ChannelInfo` 序列化/反序列化
  - `IntrudeMemberInfo` 序列化/反序列化
  - `IntrudeInfo` 序列化/反序列化
  - `LoginRequest` 序列化/反序列化
  - `LoginResponse` 序列化/反序列化
  - 字段值正确性验证
  - 边界值测试

### 4.2 Java测试用例
- **测试文件**：`src/test/java/com/dnfm/mina/protobuf/AuthLoginTest.java`
- **测试内容**：
  - 消息编解码
  - 服务端处理逻辑
  - 错误处理
  - 依赖关系验证

### 4.3 集成测试
- **测试场景**：Go客户端 → Java服务端
- **测试内容**：
  - 登录请求响应
  - 错误码处理
  - 并发性能

## 五、风险评估

### 5.1 技术风险
| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 类型映射错误 | 中 | 高 | 仔细检查类型映射，编写测试用例 |
| 字段序号不一致 | 低 | 高 | 保持与Java文件相同的字段序号 |
| 编译失败 | 中 | 中 | 分步骤编译，及时调试 |
| 依赖关系错误 | 低 | 高 | 按照依赖顺序迁移，充分测试 |

### 5.2 业务风险
| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 服务中断 | 低 | 高 | 保持新旧代码共存，灰度发布 |
| 功能回归 | 低 | 高 | 充分测试，保留回退方案 |

## 六、资源需求

### 6.1 人员
- 1名开发人员：负责迁移和测试

### 6.2 工具
- protoc：Protobuf编译器
- buf：Protobuf管理工具
- Go：Go语言环境
- Java：Java开发环境

### 6.3 时间
- 分析：0.5小时
- 生成Proto：0.5小时
- 生成代码：0.5小时
- 编写测试：1小时
- 调试：1小时
- 总计：3.5小时

## 七、预期产出

- ✅ 更新的 `proto/dnf/v1/auth_login.proto` 文件
- ✅ 生成的 `dnf-go-client/gen/go/dnf/v1/auth_login.pb.go` 文件
- ✅ Go测试用例通过（5个消息类型）
- ✅ 生成的Java代码编译通过（11个文件）
- ✅ Java服务端启动成功
- ✅ Go测试用例再次通过

## 八、后续计划

- **批次02**：迁移 `HEARTBEAT.java` 文件（REQ_HEARTBEAT + RES_HEARTBEAT）
- **批次03**：迁移 `LOGOUT.java` 文件（REQ_LOGOUT + RES_LOGOUT）
- **批次04**：迁移 `SELECT_CHARACTER.java` 文件（REQ_SELECT_CHARACTER + RES_SELECT_CHARACTER）

## 九、注意事项

1. **严格遵循渐进式原则**：每次只迁移1-2个文件
2. **保持字段序号一致**：确保与Java文件的字段序号相同
3. **充分测试**：每个步骤都要测试通过再进行下一步
4. **保留回退方案**：出现问题及时回滚
5. **记录迁移过程**：详细记录每一步的操作和结果
6. **文档先行**：所有操作前先更新文档
7. **测试先行**：每个批次都要有对应的测试用例

## 十、依赖关系图

```
PT_CHANNEL_INFO (无依赖)
    ↓
PT_INTRUDE_MEMBER_INFO (无依赖)
    ↓
PT_INTRUDE_INFO (依赖: PT_CHANNEL_INFO, PT_INTRUDE_MEMBER_INFO)
    ↓
RES_LOGIN (依赖: PT_CHANNEL_INFO, PT_INTRUDE_INFO)

REQ_LOGIN (无依赖，独立)
```
