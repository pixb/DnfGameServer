# 批次05迁移计划

## 一、迁移概述

批次05将迁移待机、角色删除、开始游戏和退出角色相关的消息，包括待机请求、角色删除、开始游戏和退出角色等功能。

## 二、迁移范围

### 2.1 待机消息 (ModuleID: 10001)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 待机请求 | REQ_STANDBY | 0 | 待迁移 |
| 待机响应 | RES_STANDBY | 1 | 待迁移 |

**字段映射**：
- REQ_STANDBY: 无字段（空消息）
- RES_STANDBY:
  - error (int32): 错误码
  - standby (int32): 待机状态
  - vip (int32): VIP等级
  - reconnect (int32): 重连状态

### 2.2 删除角色消息 (ModuleID: 10004)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 删除角色请求 | REQ_REMOVE_CHARACTER | 0 | 待迁移 |
| 删除角色响应 | RES_REMOVE_CHARACTER | 1 | 待迁移 |

**字段映射**：
- REQ_REMOVE_CHARACTER:
  - charguid (uint64): 角色GUID

- RES_REMOVE_CHARACTER:
  - error (int32): 错误码
  - charguid (uint64): 角色GUID
  - pendingtime (int64): 待定时间

### 2.3 开始游戏消息 (ModuleID: 10005)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 开始游戏请求 | REQ_START_GAME | 0 | 待迁移 |

**字段映射**：
- REQ_START_GAME:
  - charguid (uint64): 角色GUID
  - dungeonguid (uint64): 副本GUID
  - authkey (string): 认证密钥
  - accesstoken (string): 访问令牌
  - paytoken (string): 支付令牌
  - town (uint32): 城镇ID
  - area (uint32): 区域ID
  - posx (int32): X坐标
  - posy (int32): Y坐标
  - request (repeated PT_PROTOCOL_TRANSACTION): 请求列表
  - partyguid (uint64): 队伍GUID

### 2.4 退出角色消息 (ModuleID: 10007)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 退出角色请求 | REQ_EXIT_CHARACTER | 0 | 待迁移 |

**字段映射**：
- REQ_EXIT_CHARACTER:
  - world (int32): 世界ID
  - channel (int32): 频道ID
  - reservationtype (int32): 预约类型
  - exittype (int32): 退出类型

## 三、数据结构

### 3.1 PT_PROTOCOL_TRANSACTION

需要查看Java源码获取完整定义。

## 四、Proto文件更新

### 4.1 需要修复的问题

**问题1**: DeleteCharacterRequest的CMD值不正确
- 当前proto文件: cmd=1
- Java源码: cmd=0

**问题2**: DeleteCharacterResponse的CMD值不正确
- 当前proto文件: cmd=2
- Java源码: cmd=1

**问题3**: DeleteCharacterResponse字段不匹配
- 当前proto文件包含: error, remain_seconds
- Java源码包含: error, charguid, pendingtime

### 4.2 需要新增的消息

1. **StandbyRequest** (ModuleID: 10001, CMD: 0)
2. **StandbyResponse** (ModuleID: 10001, CMD: 1)
3. **StartGameRequest** (ModuleID: 10005, CMD: 0)
4. **ExitCharacterRequest** (ModuleID: 10007, CMD: 0)

### 4.3 需要新增的数据结构

1. **ProtocolTransaction** (对应PT_PROTOCOL_TRANSACTION)

## 五、迁移步骤

### 步骤1: 修复DeleteCharacter消息
- 修正CMD值
- 修正字段定义

### 步骤2: 新增Standby消息
- 定义StandbyRequest
- 定义StandbyResponse

### 步骤3: 新增StartGame消息
- 定义StartGameRequest
- 定义ProtocolTransaction数据结构

### 步骤4: 新增ExitCharacter消息
- 定义ExitCharacterRequest

### 步骤5: 生成代码
- 使用buf工具生成Go代码
- 使用buf工具生成Java代码

### 步骤6: 编写测试
- 编写Go单元测试
- 编写编解码测试

### 步骤7: 扩展编解码器
- 在StandardProtobufEncoder中添加适配方法
- 在StandardProtobufDecoder中添加适配方法

### 步骤8: 测试验证
- 运行Go测试
- 运行Java编译
- 进行跨语言通信测试

## 六、风险评估

### 6.1 高风险项

1. **CMD值不匹配**: 可能导致消息路由错误
2. **字段不匹配**: 可能导致数据丢失或解析错误
3. **复杂嵌套结构**: StartGameRequest包含PT_PROTOCOL_TRANSACTION，需要仔细处理

### 6.2 中风险项

1. **数据结构定义**: 需要准确映射Java数据结构
2. **类型转换**: 需要确保类型正确转换

### 6.3 低风险项

1. **测试覆盖**: 可以参考批次01-04的测试经验
2. **编解码器实现**: 已有前四次迁移的经验

## 七、预期成果

1. 成功迁移4个ModuleID的消息（10001, 10004, 10005, 10007）
2. 修复DeleteCharacter消息的CMD值和字段定义
3. 新增Standby、StartGame、ExitCharacter消息
4. 完整的测试覆盖
5. 跨语言通信验证通过

## 八、时间估算

- 分析和规划: 30分钟
- Proto文件更新: 30分钟
- 代码生成: 10分钟
- 测试编写: 30分钟
- 编解码器扩展: 30分钟
- 测试验证: 30分钟
- 文档整理: 20分钟

**总计**: 约3小时

---

**文档版本**: 1.0.0
**创建日期**: 2026-02-09
**创建人员**: AI Assistant
