#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¢å¼º Go æµ‹è¯•ç”¨ä¾‹ - æ·»åŠ å®é™…çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•
"""

import sqlite3
from pathlib import Path
from typing import List, Dict

class EnhancedTestGenerator:
    """å¢å¼ºçš„æµ‹è¯•ç”Ÿæˆå™¨"""
    
    def __init__(self, db_path: str, output_dir: str):
        self.db_path = db_path
        self.output_dir = Path(output_dir)
        self.conn = sqlite3.connect(db_path)
        self.conn.row_factory = sqlite3.Row
    
    def __del__(self):
        if hasattr(self, 'conn') and self.conn:
            self.conn.close()
    
    def get_batch_messages(self, batch_number: int) -> List[Dict]:
        """è·å–æ‰¹æ¬¡çš„æ¶ˆæ¯åˆ—è¡¨"""
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT 
                jm.message_name,
                pm.message_name as proto_name,
                pm.file_path as proto_file,
                jm.field_count
            FROM migration_records mr
            JOIN jprotobuf_messages jm ON mr.jprotobuf_message_id = jm.id
            JOIN proto_messages pm ON mr.proto_message_id = pm.id
            WHERE mr.batch_id = ?
            ORDER BY jm.message_name
        ''', (batch_number,))
        
        return [dict(row) for row in cursor.fetchall()]
    
    def generate_enhanced_test(self, batch_number: int, batch_name: str) -> str:
        """ç”Ÿæˆå¢å¼ºçš„æµ‹è¯•æ–‡ä»¶"""
        messages = self.get_batch_messages(batch_number)
        
        content = f'''// Code generated by generate_go_tests.py. DO NOT EDIT.
// Batch {batch_number}: {batch_name}
// Enhanced tests with actual serialization/deserialization

package tests

import (
\t"testing"
\t"google.golang.org/protobuf/proto"
\t"encoding/json"

\tdnfv1 "github.com/pixb/DnfGameServer/dnf-go-client/gen/dnf/v1"
)

'''
        
        for msg in messages:
            proto_name = msg['proto_name']
            field_count = msg['field_count']
            
            content += f'''
func Test{proto_name}Serialization(t *testing.T) {{
\t// Test {proto_name} - serialization and deserialization
\tmsg := &dnfv1.{proto_name}{{}}
\t
\t// Serialize the message
\tdata, err := proto.Marshal(msg)
\tif err != nil {{
\t\tt.Errorf("Failed to marshal {proto_name}: %v", err)
\t\treturn
\t}}
\t
\t// Deserialize the message
\tdecoded := &dnfv1.{proto_name}{{}}
\terr = proto.Unmarshal(data, decoded)
\tif err != nil {{
\t\tt.Errorf("Failed to unmarshal {proto_name}: %v", err)
\t\treturn
\t}}
\t
\t// Verify the decoded message matches the original
\tif !proto.Equal(msg, decoded) {{
\t\tt.Errorf("Decoded message does not match original for {proto_name}")
\t}}
\t
\tt.Logf("Successfully serialized and deserialized {proto_name} with {field_count} fields")
}}

func Test{proto_name}JSON(t *testing.T) {{
\t// Test {proto_name} - JSON serialization
\tmsg := &dnfv1.{proto_name}{{}}
\t
\t// Convert to JSON
\tjsonData, err := json.Marshal(msg)
\tif err != nil {{
\t\tt.Errorf("Failed to marshal {proto_name} to JSON: %v", err)
\t\treturn
\t}}
\t
\t// Convert from JSON
\tdecoded := &dnfv1.{proto_name}{{}}
\terr = json.Unmarshal(jsonData, decoded)
\tif err != nil {{
\t\tt.Errorf("Failed to unmarshal {proto_name} from JSON: %v", err)
\t\treturn
\t}}
\t
\tt.Logf("Successfully converted {proto_name} to/from JSON")
}}

func Test{proto_name}Clone(t *testing.T) {{
\t// Test {proto_name} - clone functionality
\tmsg := &dnfv1.{proto_name}{{}}
\t
\t// Clone the message
\tcloned := proto.Clone(msg).(*dnfv1.{proto_name})
\t
\t// Verify the cloned message matches the original
\tif !proto.Equal(msg, cloned) {{
\t\tt.Errorf("Cloned message does not match original for {proto_name}")
\t}}
\t
\tt.Logf("Successfully cloned {proto_name}")
}}

'''
        
        content += '''
// Test helper function to verify message structure
func verifyMessageStructure(t *testing.T, msg proto.Message, expectedFields int) {
\t// Get the message descriptor
\tmsgDesc := msg.ProtoReflect().Descriptor()
\t
\t// Count the fields
\tfieldCount := msgDesc.Fields().Len()
\t
\t// Log the field count
\tt.Logf("Message %s has %d fields", msgDesc.Name(), fieldCount)
\t
\t// Note: This is a basic structure verification
\t// In production, you might want to verify specific field types and tags
}
'''
        
        return content
    
    def generate_all_enhanced_tests(self):
        """ç”Ÿæˆæ‰€æœ‰æ‰¹æ¬¡çš„å¢å¼ºæµ‹è¯•"""
        cursor = self.conn.cursor()
        cursor.execute('SELECT DISTINCT batch_number, batch_name FROM migration_batches ORDER BY batch_number')
        batches = [dict(row) for row in cursor.fetchall()]
        
        print(f"ğŸ“ å¼€å§‹ç”Ÿæˆ {len(batches)} ä¸ªæ‰¹æ¬¡çš„å¢å¼ºæµ‹è¯•...")
        
        for batch in batches:
            batch_number = batch['batch_number']
            batch_name = batch['batch_name']
            
            # ç”Ÿæˆå¢å¼ºæµ‹è¯•
            test_content = self.generate_enhanced_test(batch_number, batch_name)
            
            # å†™å…¥æ–‡ä»¶
            test_file = self.output_dir / f"batch_{batch_number:02d}_{batch_name.lower()}_enhanced_test.go"
            test_file.write_text(test_content, encoding='utf-8')
            print(f"âœ… ç”Ÿæˆå¢å¼ºæµ‹è¯•: {test_file.name}")
        
        print(f"\nğŸ‰ æ‰€æœ‰æ‰¹æ¬¡å¢å¼ºæµ‹è¯•ç”Ÿæˆå®Œæˆï¼")

def main():
    """ä¸»å‡½æ•°"""
    db_path = '/home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/data/migration_system.db'
    output_dir = '/home/pix/dev/code/java/DnfGameServer/dnf-go-client/tests'
    
    generator = EnhancedTestGenerator(db_path, output_dir)
    generator.generate_all_enhanced_tests()

if __name__ == '__main__':
    main()
