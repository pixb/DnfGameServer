# 批次15: GUILD (续) 模块迁移计划

## 一、迁移范围

### 1.1 消息类型

| ModuleID | 消息类型 | 功能描述 | 状态 |
| :--- | :--- | :--- | :--- |
| 19004 | 公会成员列表 | 获取公会成员列表 | ✅ 待迁移 |
| 19005 | 公会捐赠 | 公会捐赠 | ✅ 待迁移 |
| 19006 | 公会技能 | 公会技能管理 | ✅ 待迁移 |
| 19007 | 公会仓库 | 公会仓库管理 | ✅ 待迁移 |

### 1.2 源文件

| 文件名 | 路径 | 状态 |
| :--- | :--- | :--- |
| REQ_GUILD_MEMBER_LIST.java | src/main/java/com/dnfm/mina/protobuf/REQ_GUILD_MEMBER_LIST.java | ✅ 待迁移 |
| REQ_GUILD_DONATE.java | src/main/java/com/dnfm/mina/protobuf/REQ_GUILD_DONATE.java | ✅ 待迁移 |
| REQ_GUILD_SKILL.java | src/main/java/com/dnfm/mina/protobuf/REQ_GUILD_SKILL.java | ✅ 待迁移 |
| REQ_GUILD_STORAGE.java | src/main/java/com/dnfm/mina/protobuf/REQ_GUILD_STORAGE.java | ✅ 待迁移 |

### 1.3 目标文件

| 文件名 | 路径 | 状态 |
| :--- | :--- | :--- |
| guild_ext.proto | proto/dnf/v1/guild_ext.proto | ✅ 待生成 |

## 二、迁移步骤

### 2.1 分析与准备

1. **分析源文件结构**：了解JProtobuf注解和字段定义
2. **确定类型映射**：JProtobuf类型到标准Protobuf类型的映射
3. **设计Proto文件**：基于源文件设计标准Protobuf消息结构

### 2.2 实现与生成

1. **创建guild_ext.proto文件**：定义消息结构和数据类型
2. **配置代码生成**：设置buf.gen.yaml配置文件
3. **生成代码**：使用buf generate生成Java和Go代码

### 2.3 集成与测试

1. **扩展编解码器**：修改StandardProtobufDecoder和StandardProtobufEncoder
2. **编写测试用例**：验证消息序列化/反序列化
3. **编译验证**：确保Java代码编译通过

## 三、数据结构设计

### 3.1 核心消息结构

#### 3.1.1 公会成员列表

```protobuf
// 公会成员列表请求
message GuildMemberListRequest {
  int32 character_id = 1;       // 角色ID
  int64 guild_id = 2;            // 公会ID
  int32 page = 3;                // 页码
  int32 page_size = 4;           // 每页数量
}

// 公会成员信息
message GuildMemberInfo {
  int32 character_id = 1;       // 角色ID
  string character_name = 2;     // 角色名称
  int32 level = 3;               // 角色等级
  int32 job = 4;                 // 角色职业
  int32 position = 5;            // 公会职位
  int64 join_time = 6;            // 加入时间
  int32 contribution = 7;        // 贡献值
  int32 online_status = 8;       // 在线状态
}

// 公会成员列表响应
message GuildMemberListResponse {
  int32 error = 1;              // 错误码
  int32 character_id = 2;       // 角色ID
  int64 guild_id = 3;            // 公会ID
  int32 total = 4;              // 总数
  int32 page = 5;               // 页码
  int32 page_size = 6;          // 每页数量
  repeated GuildMemberInfo members = 7;  // 成员列表
}
```

#### 3.1.2 公会捐赠

```protobuf
// 公会捐赠请求
message GuildDonateRequest {
  int32 character_id = 1;       // 角色ID
  int64 guild_id = 2;            // 公会ID
  int32 donate_type = 3;         // 捐赠类型
  int32 donate_amount = 4;       // 捐赠数量
}

// 公会捐赠响应
message GuildDonateResponse {
  int32 error = 1;              // 错误码
  int32 character_id = 2;       // 角色ID
  int64 guild_id = 3;            // 公会ID
  int32 donate_type = 4;         // 捐赠类型
  int32 donate_amount = 5;       // 捐赠数量
  int32 contribution = 6;        // 获得贡献值
  bool success = 7;              // 是否成功
}
```

#### 3.1.3 公会技能

```protobuf
// 公会技能请求
message GuildSkillRequest {
  int32 character_id = 1;       // 角色ID
  int64 guild_id = 2;            // 公会ID
  int32 skill_id = 3;            // 技能ID
  int32 operation = 4;           // 操作类型（学习/升级）
}

// 公会技能信息
message GuildSkillInfo {
  int32 skill_id = 1;            // 技能ID
  string skill_name = 2;         // 技能名称
  int32 level = 3;               // 技能等级
  int32 max_level = 4;           // 最大等级
  int32 effect_value = 5;        // 技能效果值
  int32 cost_contribution = 6;   // 学习所需贡献值
  int32 cost_guild_exp = 7;      // 学习所需公会经验
  bool is_learned = 8;           // 是否已学习
}

// 公会技能响应
message GuildSkillResponse {
  int32 error = 1;              // 错误码
  int32 character_id = 2;       // 角色ID
  int64 guild_id = 3;            // 公会ID
  int32 skill_id = 4;            // 技能ID
  GuildSkillInfo skill_info = 5;  // 技能信息
  bool success = 6;              // 是否成功
}
```

#### 3.1.4 公会仓库

```protobuf
// 公会仓库请求
message GuildStorageRequest {
  int32 character_id = 1;       // 角色ID
  int64 guild_id = 2;            // 公会ID
  int32 operation = 3;           // 操作类型（存入/取出）
  int32 item_id = 4;             // 物品ID
  int32 item_count = 5;          // 物品数量
}

// 公会仓库物品
message GuildStorageItem {
  int32 item_id = 1;             // 物品ID
  string item_name = 2;          // 物品名称
  int32 item_count = 3;          // 物品数量
  int32 item_level = 4;          // 物品等级
  int32 item_rarity = 5;          // 物品稀有度
  int64存入时间 = 6;              // 存入时间
  int32存入角色ID = 7;            // 存入角色ID
}

// 公会仓库响应
message GuildStorageResponse {
  int32 error = 1;              // 错误码
  int32 character_id = 2;       // 角色ID
  int64 guild_id = 3;            // 公会ID
  int32 operation = 4;           // 操作类型
  int32 item_id = 5;             // 物品ID
  int32 item_count = 6;          // 物品数量
  repeated GuildStorageItem items = 7;  // 仓库物品列表
  bool success = 8;              // 是否成功
}
```

### 3.2 数据类型映射

| JProtobuf类型 | 标准Protobuf类型 | 备注 |
| :--- | :--- | :--- |
| int | int32 | 整数类型 |
| long | int64 | 长整数类型 |
| String | string | 字符串类型 |
| boolean | bool | 布尔类型 |
| List<T> | repeated T | 列表类型 |
| 自定义对象 | message | 嵌套消息 |

## 四、编解码器扩展

### 4.1 StandardProtobufDecoder

**新增方法：**

- `adaptGuildMemberListRequest(byte[] body)` - 公会成员列表请求解码
- `adaptGuildDonateRequest(byte[] body)` - 公会捐赠请求解码
- `adaptGuildSkillRequest(byte[] body)` - 公会技能请求解码
- `adaptGuildStorageRequest(byte[] body)` - 公会仓库请求解码

**支持的ModuleID：**
- 19004 - 公会成员列表
- 19005 - 公会捐赠
- 19006 - 公会技能
- 19007 - 公会仓库

### 4.2 StandardProtobufEncoder

**新增方法：**

- `adaptGuildMemberListResponse(Message msg)` - 公会成员列表响应编码
- `adaptGuildDonateResponse(Message msg)` - 公会捐赠响应编码
- `adaptGuildSkillResponse(Message msg)` - 公会技能响应编码
- `adaptGuildStorageResponse(Message msg)` - 公会仓库响应编码

**支持的ModuleID：**
- 19004 - 公会成员列表
- 19005 - 公会捐赠
- 19006 - 公会技能
- 19007 - 公会仓库

## 五、测试计划

### 5.1 单元测试

| 测试文件 | 测试内容 | 状态 |
| :--- | :--- | :--- |
| batch15_test.go | GuildMemberListRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch15_test.go | GuildDonateRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch15_test.go | GuildSkillRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch15_test.go | GuildStorageRequest/Response 序列化/反序列化 | ✅ 待实现 |
| batch15_test.go | GuildMemberInfo 序列化/反序列化 | ✅ 待实现 |
| batch15_test.go | GuildSkillInfo 序列化/反序列化 | ✅ 待实现 |
| batch15_test.go | GuildStorageItem 序列化/反序列化 | ✅ 待实现 |

### 5.2 编译验证

| 命令 | 验证内容 | 状态 |
| :--- | :--- | :--- |
| `mvn compile` | Java代码编译 | ✅ 待验证 |

## 六、时间计划

| 阶段 | 时间 | 任务 |
| :--- | :--- | :--- |
| 准备阶段 | 2026-02-09 | 分析源文件，设计Proto结构 |
| 实现阶段 | 2026-02-09 | 创建Proto文件，生成代码 |
| 集成阶段 | 2026-02-09 | 扩展编解码器，编写测试 |
| 验证阶段 | 2026-02-09 | 运行测试，验证编译 |
| 完成阶段 | 2026-02-09 | 更新文档，总结经验 |

## 七、风险评估

| 风险 | 概率 | 影响 | 应对措施 |
| :--- | :--- | :--- | :--- |
| 源文件不存在 | 中 | 高 | 基于功能需求设计消息结构 |
| 字段类型映射错误 | 低 | 中 | 参考已有批次的类型映射 |
| 编解码器集成失败 | 低 | 中 | 遵循已有批次的集成模式 |
| 测试用例失败 | 低 | 低 | 及时修复问题，确保功能正确 |

## 八、依赖关系

| 依赖项 | 版本 | 用途 | 状态 |
| :--- | :--- | :--- | :--- |
| protobuf | 3.21.0 | 协议定义 | ✅ 已就绪 |
| buf | 1.24.0 | 代码生成 | ✅ 已就绪 |
| go | 1.20+ | Go代码生成 | ✅ 已就绪 |
| java | 1.8+ | Java代码生成 | ✅ 已就绪 |

## 九、预期成果

1. **成功迁移公会相关消息**：公会成员列表、公会捐赠、公会技能、公会仓库
2. **新增guild_ext.proto文件**：定义了公会相关消息结构
3. **定义了公会相关数据结构**：GuildMemberInfo, GuildSkillInfo, GuildStorageItem等
4. **扩展了编解码器支持**：添加了公会模块的编解码方法
5. **验证了跨语言通信**：确保Java服务器和Go客户端能够正确通信
6. **Go单元测试通过**：验证消息序列化/反序列化正确性
7. **Java编译成功**：确保代码集成无错误

## 十、后续计划

- **批次16**：迁移其他功能模块
- **持续优化**：根据实际使用情况优化消息结构和编解码器性能
