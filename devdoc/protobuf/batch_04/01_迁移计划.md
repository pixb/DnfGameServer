# 批次04迁移计划

## 一、迁移概述

批次04将迁移角色管理和频道管理相关的消息，包括创建角色、频道列表和进入频道等功能。

## 二、迁移范围

### 2.1 创建角色消息 (ModuleID: 10003)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 创建角色请求 | REQ_CREATE_CHARACTER | 0 | 待迁移 |
| 创建角色响应 | RES_CREATE_CHARACTER | 1 | 待迁移 |

**字段映射**：
- REQ_CREATE_CHARACTER:
  - job (int32): 职业
  - name (string): 角色名称

- RES_CREATE_CHARACTER:
  - error (int32): 错误码
  - charguid (uint64): 角色GUID
  - job (int32): 职业
  - name (string): 角色名称

### 2.2 频道列表消息 (ModuleID: 10008)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 频道列表请求 | REQ_CHANNEL_LIST | 0 | 待迁移 |
| 频道列表响应 | RES_CHANNEL_LIST | 1 | 待迁移 |

**字段映射**：
- REQ_CHANNEL_LIST:
  - type (int32): 类型
  - worldid (int32): 世界ID

- RES_CHANNEL_LIST:
  - error (int32): 错误码
  - list (repeated PT_CHANNEL): 频道列表
  - count (int32): 数量
  - integrations (repeated PT_INTEGRATION_WORLD): 集成世界列表
  - type (int32): 类型
  - integrationrecommands (repeated PT_CHANNEL): 集成推荐频道
  - worldrecommands (repeated PT_CHANNEL): 世界推荐频道

### 2.3 进入频道消息 (ModuleID: 10011)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 进入频道请求 | REQ_ENTER_CHANNEL | 0 | 待迁移 |

**字段映射**：
- REQ_ENTER_CHANNEL:
  - openid (string): OpenID
  - charguid (uint64): 角色GUID
  - authkey (string): 认证密钥
  - version (string): 版本
  - accesstoken (string): 访问令牌
  - launchinfo (int32): 启动信息
  - dungeonguid (uint64): 副本GUID
  - deviceinfo (PT_CLIENTINFO): 设备信息
  - registeredchannelid (string): 注册频道ID
  - installchannelid (string): 安装频道ID
  - isexternpackage (bool): 是否外部包
  - validusercheckcode (string): 有效用户检查码
  - toyPlatID (int32): 玩具平台ID
  - countrycode (string): 国家代码
  - language (string): 语言
  - adid (string): 广告ID
  - idfv (string): IDFV
  - isadult (bool): 是否成人

## 三、数据结构

### 3.1 PT_CHANNEL

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| world | int32 | 世界 |
| channel | int32 | 频道 |
| iP | string | IP地址 |
| port | int32 | 端口 |
| saturation | int32 | 饱和度 |
| integration | bool | 是否集成 |

### 3.2 PT_INTEGRATION_WORLD

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| world | int32 | 世界 |

### 3.3 PT_CLIENTINFO

需要查看Java源码获取完整定义。

## 四、Proto文件更新

### 4.1 需要修复的问题

**问题1**: CreateCharacterRequest的CMD值不正确
- 当前proto文件: cmd=1
- Java源码: cmd=0

**问题2**: CreateCharacterResponse的CMD值不正确
- 当前proto文件: cmd=2
- Java源码: cmd=1

**问题3**: CreateCharacterRequest字段不匹配
- 当前proto文件包含: name, job, grow_type, sec_grow_type, slot
- Java源码只包含: job, name

**问题4**: CreateCharacterResponse字段不匹配
- 当前proto文件包含: error, character
- Java源码包含: error, charguid, job, name

### 4.2 需要新增的消息

1. **ChannelListRequest** (ModuleID: 10008, CMD: 0)
2. **ChannelListResponse** (ModuleID: 10008, CMD: 1)
3. **EnterChannelRequest** (ModuleID: 10011, CMD: 0)

### 4.3 需要新增的数据结构

1. **Channel** (对应PT_CHANNEL)
2. **IntegrationWorld** (对应PT_INTEGRATION_WORLD)
3. **ClientInfo** (对应PT_CLIENTINFO)

## 五、迁移步骤

### 步骤1: 修复CreateCharacter消息
- 修正CMD值
- 修正字段定义

### 步骤2: 新增ChannelList消息
- 定义ChannelListRequest
- 定义ChannelListResponse
- 定义Channel和IntegrationWorld数据结构

### 步骤3: 新增EnterChannel消息
- 定义EnterChannelRequest
- 定义ClientInfo数据结构

### 步骤4: 生成代码
- 使用buf工具生成Go代码
- 使用buf工具生成Java代码

### 步骤5: 编写测试
- 编写Go单元测试
- 编写编解码测试

### 步骤6: 扩展编解码器
- 在StandardProtobufEncoder中添加适配方法
- 在StandardProtobufDecoder中添加适配方法

### 步骤7: 测试验证
- 运行Go测试
- 运行Java编译
- 进行跨语言通信测试

## 六、风险评估

### 6.1 高风险项

1. **CMD值不匹配**: 可能导致消息路由错误
2. **字段不匹配**: 可能导致数据丢失或解析错误
3. **复杂嵌套结构**: EnterChannelRequest包含PT_CLIENTINFO，需要仔细处理

### 6.2 中风险项

1. **数据结构定义**: 需要准确映射Java数据结构
2. **类型转换**: 需要确保类型正确转换

### 6.3 低风险项

1. **测试覆盖**: 可以参考批次01-03的测试经验
2. **编解码器实现**: 已有前三次迁移的经验

## 七、预期成果

1. 成功迁移3个ModuleID的消息（10003, 10008, 10011）
2. 修复CreateCharacter消息的CMD值和字段定义
3. 新增ChannelList和EnterChannel消息
4. 完整的测试覆盖
5. 跨语言通信验证通过

## 八、时间估算

- 分析和规划: 30分钟
- Proto文件更新: 30分钟
- 代码生成: 10分钟
- 测试编写: 30分钟
- 编解码器扩展: 30分钟
- 测试验证: 30分钟
- 文档整理: 20分钟

**总计**: 约3小时

---

**文档版本**: 1.0.0
**创建日期**: 2026-02-09
**创建人员**: AI Assistant
