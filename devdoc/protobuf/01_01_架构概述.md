# 架构概述

## 一、概述

本项目使用百度的 **jprotobuf** 框架实现Protocol Buffers协议，用于游戏客户端与服务器之间的通信。该框架通过注解方式定义protobuf消息，无需编写.proto文件，简化了开发流程。

## 二、核心技术栈

### 2.1 Protobuf框架
- **框架名称**：百度 jprotobuf (com.baidu.bjf.remoting.protobuf)
- **版本**：2.4.15
- **特点**：基于注解的protobuf实现，无需.proto文件

### 2.2 网络框架
- **框架名称**：Apache MINA
- **版本**：2.0.19
- **作用**：提供高性能的网络通信能力

### 2.3 依赖库
```xml
<dependency>
    <groupId>com.baidu</groupId>
    <artifactId>jprotobuf</artifactId>
    <version>2.4.15</version>
</dependency>
<dependency>
    <groupId>org.apache.mina</groupId>
    <artifactId>mina-core</artifactId>
    <version>2.0.19</version>
</dependency>
```

## 三、架构设计

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端                                 │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ 网络通信
                         │
┌────────────────────────▼────────────────────────────────────┐
│                   Apache MINA                              │
│  ┌──────────────┐         ┌──────────────┐               │
│  │ DNFEncoder   │         │ DNFDecoder   │               │
│  │  (编码器)     │         │  (解码器)     │               │
│  └──────┬───────┘         └──────┬───────┘               │
│         │                        │                         │
│         │                        │                         │
│  ┌──────▼──────────────────────▼───────┐                │
│  │      MessageCodecFactory             │                │
│  │      (编解码工厂)                     │                │
│  └──────────────────────────────────────┘                │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│              MessageFactory (消息工厂)                       │
│  ┌──────────────────────────────────────────┐              │
│  │  id2Clazz: Map<String, Class<?>>        │              │
│  │  clazz2Id: Map<Class<?>, String>        │              │
│  └──────────────────────────────────────────┘              │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│           SerializerHelper (序列化助手)                    │
│  ┌──────────────────────────────────────────┐              │
│  │  ProtobufProxy.create()                │              │
│  │  codec.encode() / codec.decode()       │              │
│  └──────────────────────────────────────────┘              │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│              Protobuf消息类 (100+个)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   LOGIN      │  │ AUTH_INFO    │  │ PT_CHARACTER │  │
│  │   (登录)      │  │  (认证)      │  │  (角色数据)   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 架构层次说明

#### 3.2.1 网络层
- **Apache MINA**：提供高性能的网络通信框架
- **DNFEncoder/DNFDecoder**：负责消息的编解码
- **MessageCodecFactory**：编解码器工厂

#### 3.2.2 协议层
- **MessageFactory**：消息工厂，负责消息注册和查找
- **SerializerHelper**：序列化助手，负责protobuf编解码
- **Message基类**：所有消息的基类

#### 3.2.3 业务层
- **CmdExecutor**：消息处理器，执行业务逻辑
- **MessageDispatcher**：消息分发器，路由消息到对应的处理器

### 3.3 数据流向

#### 3.3.1 客户端 → 服务器
```
客户端消息对象
    ↓
序列化 (SerializerHelper)
    ↓
加密 (Enc)
    ↓
添加消息头 (DNFEncoder)
    ↓
网络传输 (Apache MINA)
    ↓
服务器接收
```

#### 3.3.2 服务器 → 客户端
```
业务处理完成
    ↓
创建响应对象
    ↓
序列化 (SerializerHelper)
    ↓
加密 (Enc)
    ↓
添加消息头 (DNFEncoder)
    ↓
网络传输 (Apache MINA)
    ↓
客户端接收
```

## 四、技术特点

### 4.1 注解驱动
- 使用`@MessageMeta`注解标识消息的模块号和命令号
- 使用`@Protobuf`注解定义protobuf字段
- 无需编写.proto文件，简化开发流程

### 4.2 高性能
- 基于Apache MINA框架，支持高并发
- 预编译protobuf消息，减少运行时开销
- 使用对象池，减少对象创建

### 4.3 安全性
- 消息体加密传输
- 使用序列号作为加密参数
- 防止消息被篡改和窃听

### 4.4 可扩展
- 模块化设计，易于添加新消息
- 消息注册机制，自动扫描和注册
- 清晰的代码结构，便于维护
