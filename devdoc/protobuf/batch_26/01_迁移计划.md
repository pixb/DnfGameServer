# 批次26: 系统选项数据结构迁移计划

## 一、迁移范围

### 1.1 消息类型

| 消息类型 | 功能描述 | 状态 |
| :--- | :--- | :--- |
| ResSystemBuffAppendageList | 系统buff附加信息列表 | ✅ 待迁移 |
| PtSystemBuffAppendage | 系统buff附加信息 | ✅ 待迁移 |
| PtBattleOption | 战斗选项 | ✅ 待迁移 |
| EnumBattleOption | 枚举战斗选项 | ✅ 待迁移 |
| ResRandomoptionSelect | 随机选项选择 | ✅ 待迁移 |

### 1.2 源文件

| 文件名 | 路径 | 状态 |
| :--- | :--- | :--- |
| RES_SYSTEM_BUFF_APPENDAGE_LIST.java | src/main/java/com/dnfm/mina/protobuf/RES_SYSTEM_BUFF_APPENDAGE_LIST.java | ✅ 待迁移 |
| PT_SYSTEM_BUFF_APPENDAGE.java | src/main/java/com/dnfm/mina/protobuf/PT_SYSTEM_BUFF_APPENDAGE.java | ✅ 待迁移 |
| PT_BATTLE_OPTION.java | src/main/java/com/dnfm/mina/protobuf/PT_BATTLE_OPTION.java | ✅ 待迁移 |
| ENUM_BATTLE_OPTION.java | src/main/java/com/dnfm/mina/protobuf/ENUM_BATTLE_OPTION.java | ✅ 待迁移 |
| RES_RANDOMOPTION_SELECT.java | src/main/java/com/dnfm/mina/protobuf/RES_RANDOMOPTION_SELECT.java | ✅ 待迁移 |

### 1.3 目标文件

| 文件名 | 路径 | 状态 |
| :--- | :--- | :--- |
| option_types.proto | proto/dnf/v1/option_types.proto | ✅ 待生成 |

## 二、迁移步骤

### 2.1 分析与准备

1. **分析源文件结构**：了解JProtobuf注解和字段定义
2. **确定类型映射**：JProtobuf类型到标准Protobuf类型的映射
3. **设计Proto文件**：基于源文件设计标准Protobuf消息结构

### 2.2 实现与生成

1. **创建option_types.proto文件**：定义系统选项数据结构
2. **配置代码生成**：设置buf.gen.yaml配置文件
3. **生成代码**：使用buf generate生成Java和Go代码

### 2.3 集成与测试

1. **编写测试用例**：验证消息序列化/反序列化
2. **编译验证**：确保Java代码编译通过

## 三、数据结构设计

### 3.1 核心消息结构

#### 3.1.1 系统buff附加信息列表

```protobuf
// 系统buff附加信息列表
message ResSystemBuffAppendageList {
  repeated PtSystemBuffAppendage buffs = 1; // buff列表
  int32 total_count = 2;                    // 总数量
}
```

#### 3.1.2 系统buff附加信息

```protobuf
// 系统buff附加信息
message PtSystemBuffAppendage {
  int32 buff_id = 1;      // buff ID
  int32 duration = 2;      // 持续时间
  int32 level = 3;         // 等级
  repeated int32 effects = 4; // 效果列表
}
```

#### 3.1.3 战斗选项

```protobuf
// 战斗选项
message PtBattleOption {
  int32 option_id = 1;    // 选项ID
  int32 value = 2;         // 值
  string description = 3;   // 描述
}
```

#### 3.1.4 枚举战斗选项

```protobuf
// 枚举战斗选项
enum EnumBattleOption {
  BATTLE_OPTION_UNKNOWN = 0;
  BATTLE_OPTION_AUTO_ATTACK = 1;
  BATTLE_OPTION_AUTO_SKILL = 2;
  BATTLE_OPTION_AUTO_POTION = 3;
}
```

#### 3.1.5 随机选项选择

```protobuf
// 随机选项选择
message ResRandomoptionSelect {
  int32 option_id = 1;    // 选项ID
  int32 weight = 2;        // 权重
  repeated int32 values = 3; // 值列表
}
```

### 3.2 数据类型映射

| JProtobuf类型 | 标准Protobuf类型 | 备注 |
| :--- | :--- | :--- |
| int | int32 | 整数类型 |
| long | uint64 | 无符号长整数类型 |
| String | string | 字符串类型 |
| boolean | bool | 布尔类型 |
| List<T> | repeated T | 列表类型 |
| Enum | enum | 枚举类型 |
| 自定义对象 | message | 嵌套消息 |

## 四、测试计划

### 4.1 单元测试

| 测试文件 | 测试内容 | 状态 |
| :--- | :--- | :--- |
| batch26_test.go | ResSystemBuffAppendageList 序列化/反序列化 | ✅ 待实现 |
| batch26_test.go | PtSystemBuffAppendage 序列化/反序列化 | ✅ 待实现 |
| batch26_test.go | PtBattleOption 序列化/反序列化 | ✅ 待实现 |
| batch26_test.go | EnumBattleOption 序列化/反序列化 | ✅ 待实现 |
| batch26_test.go | ResRandomoptionSelect 序列化/反序列化 | ✅ 待实现 |

### 4.2 编译验证

| 命令 | 验证内容 | 状态 |
| :--- | :--- | :--- |
| `mvn compile` | Java代码编译 | ✅ 待验证 |

## 五、时间计划

| 阶段 | 时间 | 任务 |
| :--- | :--- | :--- |
| 准备阶段 | 2026-02-09 | 分析源文件，设计Proto结构 |
| 实现阶段 | 2026-02-09 | 创建Proto文件，生成代码 |
| 集成阶段 | 2026-02-09 | 编写测试 |
| 验证阶段 | 2026-02-09 | 运行测试，验证编译 |
| 完成阶段 | 2026-02-09 | 更新文档，总结经验 |

## 六、风险评估

| 风险 | 概率 | 影响 | 应对措施 |
| :--- | :--- | :--- | :--- |
| 源文件不存在 | 中 | 高 | 基于功能需求设计消息结构 |
| 字段类型映射错误 | 低 | 中 | 参考已有批次的类型映射 |
| Equip消息重复定义 | 中 | 中 | 删除重复的Equip消息定义 |
| 测试用例失败 | 低 | 低 | 及时修复问题，确保功能正确 |

## 七、依赖关系

| 依赖项 | 版本 | 用途 | 状态 |
| :--- | :--- | :--- | :--- |
| protobuf | 3.21.0 | 协议定义 | ✅ 已就绪 |
| buf | 1.24.0 | 代码生成 | ✅ 已就绪 |
| go | 1.20+ | Go代码生成 | ✅ 已就绪 |
| java | 1.8+ | Java代码生成 | ✅ 已就绪 |

## 八、预期成果

1. **成功迁移系统选项数据结构**：RES_SYSTEM_BUFF_APPENDAGE_LIST、PT_SYSTEM_BUFF_APPENDAGE、PT_BATTLE_OPTION、ENUM_BATTLE_OPTION和RES_RANDOMOPTION_SELECT
2. **新增option_types.proto文件**：定义系统选项数据结构
3. **定义了系统选项数据结构**：ResSystemBuffAppendageList、PtSystemBuffAppendage、PtBattleOption、EnumBattleOption和ResRandomoptionSelect
4. **验证了跨语言通信**：确保Java服务器和Go客户端能够正确通信
5. **Go单元测试通过**：验证消息序列化/反序列化正确性
6. **Java编译成功**：确保代码集成无错误

## 九、后续计划

- **批次27**：迁移杂项数据结构
- **持续优化**：根据实际使用情况优化消息结构
