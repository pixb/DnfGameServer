# 批次02迁移计划：PING和SESSION_LOGOUT

## 一、迁移目标

将PING和SESSION_LOGOUT消息从JProtobuf迁移到标准Protobuf。

## 二、迁移范围

### 2.1 PING消息
- **Module ID**: 10006
- **REQ_PING**: 空消息（cmd=0）
- **RES_PING**: error (INT32), responsetime (INT32)（cmd=1）
- **PING.Types.REQ**: timestamp (INT64)
- **PING.Types.RES**: error (INT32), timestamp (INT64)

### 2.2 SESSION_LOGOUT消息
- **SESSION_LOGOUT.Types.REQ**: authIndex (UINT64)
- **SESSION_LOGOUT.Types.RES**: error (INT32), serverType (INT32), serverKey (INT64)

### 2.3 HEARTBEAT消息
- **状态**: 暂不迁移（只有空的NOTI类，无实际字段）

## 三、消息分析

### 3.1 PING消息分析

#### REQ_PING
```java
@MessageMeta(module = 10006, cmd = 0)
public class REQ_PING extends Message {
}
```
- **特点**: 空消息，用于触发心跳响应
- **用途**: 客户端发送心跳请求，服务器返回心跳响应

#### RES_PING
```java
@MessageMeta(module = 10006, cmd = 1)
public class RES_PING extends Message {
    @Protobuf(fieldType = FieldType.INT32, order = 1, required = false)
    public Integer error;
    
    @Protobuf(fieldType = FieldType.INT32, order = 2, required = false)
    public Integer responsetime;
}
```
- **字段**:
  - error: 错误码（INT32）
  - responsetime: 响应时间（INT32）

#### PING.Types.REQ
```java
public static class REQ {
    @Protobuf(fieldType = FieldType.INT64, order = 1, required = false)
    public Long timestamp;
}
```
- **字段**:
  - timestamp: 时间戳（INT64）

#### PING.Types.RES
```java
public static class RES {
    @Protobuf(fieldType = FieldType.INT32, order = 1, required = false)
    public Integer error;
    
    @Protobuf(fieldType = FieldType.INT64, order = 2, required = false)
    public Long timestamp;
}
```
- **字段**:
  - error: 错误码（INT32）
  - timestamp: 时间戳（INT64）

**注意**: PING消息有两组定义，REQ_PING/RES_PING和PING.Types.REQ/PING.Types.RES。根据使用场景，我们优先迁移REQ_PING/RES_PING。

### 3.2 SESSION_LOGOUT消息分析

#### SESSION_LOGOUT.Types.REQ
```java
public static class REQ {
    @Protobuf(fieldType = FieldType.UINT64, order = 1, required = false)
    public Long authIndex;
}
```
- **字段**:
  - authIndex: 认证索引（UINT64）

#### SESSION_LOGOUT.Types.RES
```java
public static class RES {
    @Protobuf(fieldType = FieldType.INT32, order = 1, required = false)
    public Integer error;
    
    @Protobuf(fieldType = FieldType.INT32, order = 2, required = false)
    public Integer serverType;
    
    @Protobuf(fieldType = FieldType.INT64, order = 3, required = false)
    public Long serverKey;
}
```
- **字段**:
  - error: 错误码（INT32）
  - serverType: 服务器类型（INT32）
  - serverKey: 服务器密钥（INT64）

**注意**: SESSION_LOGOUT没有找到对应的REQ/RES类，只有Types.REQ和Types.RES。需要进一步确认是否有实际使用。

## 四、迁移计划

### 4.1 创建session.proto文件

定义PING和SESSION_LOGOUT消息的Protobuf定义：

```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "dnf/proto/v1;sessionv1";
option java_multiple_files = true;
option java_package = "com.dnfm.mina.protobuf.generated";
option java_outer_classname = "SessionProto";

// PING消息
message PingRequest {
    // 空消息，用于触发心跳响应
}

message PingResponse {
    int32 error = 1;
    int32 responsetime = 2;
}

message PingTypesRequest {
    int64 timestamp = 1;
}

message PingTypesResponse {
    int32 error = 1;
    int64 timestamp = 2;
}

// SESSION_LOGOUT消息
message SessionLogoutRequest {
    uint64 auth_index = 1;
}

message SessionLogoutResponse {
    int32 error = 1;
    int32 server_type = 2;
    int64 server_key = 3;
}
```

### 4.2 生成代码

使用buf工具生成Go和Java代码：

```bash
# 生成代码
buf generate

# 验证生成结果
ls proto/gen/java/com/dnfm/mina/protobuf/generated/
ls proto/gen/go/dnf/proto/v1/
```

### 4.3 更新编解码器

扩展StandardProtobufEncoder和StandardProtobufDecoder以支持PING和SESSION_LOGOUT消息：

#### StandardProtobufEncoder
```java
// 添加PING消息支持
case 10006:
    if (cmd == 0) {
        return adaptPingRequest(message);
    } else if (cmd == 1) {
        return adaptPingResponse(message);
    }
    break;

// 添加SESSION_LOGOUT消息支持
case 10007:
    if (cmd == 0) {
        return adaptSessionLogoutRequest(message);
    } else if (cmd == 1) {
        return adaptSessionLogoutResponse(message);
    }
    break;
```

#### StandardProtobufDecoder
```java
// 添加PING消息支持
case 10006:
    if (cmd == 0) {
        return parsePingRequest(data);
    } else if (cmd == 1) {
        return parsePingResponse(data);
    }
    break;

// 添加SESSION_LOGOUT消息支持
case 10007:
    if (cmd == 0) {
        return parseSessionLogoutRequest(data);
    } else if (cmd == 1) {
        return parseSessionLogoutResponse(data);
    }
    break;
```

### 4.4 编写测试用例

#### Go客户端测试
```go
// 测试PING消息
func TestPing(t *testing.T) {
    req := &sessionv1.PingRequest{}
    // 发送请求并验证响应
}

// 测试SESSION_LOGOUT消息
func TestSessionLogout(t *testing.T) {
    req := &sessionv1.SessionLogoutRequest{
        AuthIndex: 123456789,
    }
    // 发送请求并验证响应
}
```

#### Java服务器测试
```java
// 测试PING消息处理
@Test
public void testPingRequest() {
    // 创建PING请求并验证响应
}

// 测试SESSION_LOGOUT消息处理
@Test
public void testSessionLogoutRequest() {
    // 创建SESSION_LOGOUT请求并验证响应
}
```

## 五、迁移步骤

### 步骤1：创建session.proto文件
- 定义PING和SESSION_LOGOUT消息的Protobuf结构
- 确保字段类型和顺序与JProtobuf定义一致

### 步骤2：生成代码
- 使用buf工具生成Go代码
- 使用buf工具生成Java代码
- 验证生成的代码正确性

### 步骤3：更新编解码器
- 在StandardProtobufEncoder中添加PING和SESSION_LOGOUT的编码逻辑
- 在StandardProtobufDecoder中添加PING和SESSION_LOGOUT的解码逻辑
- 添加必要的null检查

### 步骤4：编写测试用例
- 编写Go客户端测试用例
- 编写Java服务器测试用例
- 验证跨语言通信

### 步骤5：运行测试
- 启动Java服务器
- 运行Go客户端测试
- 验证消息正确传输和解析

### 步骤6：记录结果
- 记录测试结果
- 更新迁移文档
- 总结经验教训

## 六、注意事项

1. **PING消息有两套定义**: REQ_PING/RES_PING和PING.Types.REQ/PING.Types.RES，需要确认实际使用的是哪一套
2. **SESSION_LOGOUT没有Module ID**: 需要确认SESSION_LOGOUT的实际Module ID，或者是否需要为其分配一个
3. **HEARTBEAT为空**: HEARTBEAT.java只包含空的NOTI类，暂不迁移
4. **字段类型映射**: 注意UINT64到uint64的映射，INT32到int32的映射
5. **null安全**: 在编解码器中添加null检查，避免NullPointerException

## 七、预期结果

1. 成功创建session.proto文件
2. 成功生成Go和Java代码
3. 成功更新编解码器支持PING和SESSION_LOGOUT
4. 测试用例全部通过
5. 跨语言通信正常工作

## 八、后续计划

- **批次03**: 迁移其他会话管理相关的消息
- **批次04**: 迁移角色管理相关的消息
- **批次05**: 迁移频道管理相关的消息
