# 批次03迁移计划：CHARACTER消息

## 一、迁移目标

将CHARACTER相关的消息从JProtobuf迁移到标准Protobuf，重点是CHARAC_LIST消息。

## 二、迁移范围

### 2.1 CHARACTER消息

#### CHARAC_LIST消息
- **Module ID**: 10002
- **REQ_CHARAC_LIST**: 空消息（cmd=0）
- **RES_CHARAC_LIST**: 包含角色列表、职业限制等信息（cmd=1）
- **状态**: ✅ Proto文件已存在，需要验证和测试

### 2.2 相关数据结构

#### PT_CHARACTER
- 角色基础信息
- 包含charguid, lastlogout, growtype, secgrowtype, job, level, name等字段

#### PT_JOB_LIMIT_INFO
- 职业限制信息
- 包含job, growtype, level字段

#### PT_CHARACTER_EQUIP_ONLY_INDEX
- 角色装备索引
- 包含equiplist和avatarlist

## 三、消息分析

### 3.1 REQ_CHARAC_LIST

```java
@MessageMeta(module = 10002, cmd = 0)
public class REQ_CHARAC_LIST extends Message {
}
```

**特点**: 空消息，用于请求角色列表

**用途**: 客户端发送角色列表请求，服务器返回所有可用角色

### 3.2 RES_CHARAC_LIST

```java
@MessageMeta(module = 10002, cmd = 1)
public class RES_CHARAC_LIST extends Message {
    @Protobuf(fieldType = FieldType.INT32, order = 1, required = false)
    public Integer error;
    
    @Protobuf(fieldType = FieldType.INT32, order = 2, required = false)
    public Integer version;
    
    @Protobuf(order = 3)
    public List<PT_JOB_LIMIT_INFO> limits;
    
    @Protobuf(order = 4)
    public List<PT_CHARACTER> characlist;
    
    @Protobuf(fieldType = FieldType.INT32, order = 5, required = false)
    public Integer count;
    
    @Protobuf(fieldType = FieldType.INT32, order = 6, required = false)
    public Integer adventureunionlevel;
    
    @Protobuf(fieldType = FieldType.INT64, order = 7, required = false)
    public Long adventureunionexp;
    
    @Protobuf(fieldType = FieldType.INT32, order = 8, required = false)
    public Integer dailycreatecharcount;
    
    @Protobuf(fieldType = FieldType.INT32, order = 9, required = false)
    public Integer dailycreatecharmaxcount;
    
    @Protobuf(fieldType = FieldType.STRING, order = 10, required = false)
    public String adventureunionname;
    
    @Protobuf(fieldType = FieldType.INT32, order = 11, required = false)
    public Integer maxcount;
    
    @Protobuf(fieldType = FieldType.STRING, order = 12, required = false)
    public String ignorecontentsblacklist;
}
```

**字段映射**：

| Java字段 | Proto字段 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| error | error | int32 | 错误码 |
| version | version | int32 | 版本号 |
| limits | limits | repeated JobLimitInfo | 职业限制列表 |
| characlist | characters | repeated Character | 角色列表 |
| count | count | int32 | 角色数量 |
| adventureunionlevel | adventure_union_level | int32 | 冒险联盟等级 |
| adventureunionexp | adventure_union_exp | int64 | 冒险联盟经验 |
| dailycreatecharcount | daily_create_char_count | int32 | 每日创建角色数量 |
| dailycreatecharmaxcount | daily_create_char_max_count | int32 | 每日创建角色最大数量 |
| adventureunionname | adventure_union_name | string | 冒险联盟名称 |
| maxcount | max_count | int32 | 最大角色数量 |
| ignorecontentsblacklist | ignore_contents_blacklist | string | 忽略内容黑名单 |

## 四、迁移步骤

### 步骤1：验证character.proto文件

- 验证CharacterListResponse字段是否与RES_CHARAC_LIST一致
- 验证Character消息是否与PT_CHARACTER一致
- 验证JobLimitInfo消息是否与PT_JOB_LIMIT_INFO一致

### 步骤2：生成代码

- 使用buf工具生成Go代码
- 使用buf工具生成Java代码
- 验证生成的代码正确性

### 步骤3：编写测试用例

- 编写CharacterListRequest序列化测试
- 编写CharacterListResponse序列化测试
- 编写Character序列化测试
- 编写JobLimitInfo序列化测试
- 编写边界值测试

### 步骤4：更新编解码器

- 在StandardProtobufEncoder中添加CharacterListResponse的编码逻辑
- 在StandardProtobufDecoder中添加CharacterListRequest的解码逻辑
- 实现消息适配方法

### 步骤5：实现Controller

- 在CharacterController中实现角色列表请求处理
- 返回CharacterListResponse

### 步骤6：运行跨语言通信测试

- 创建Go客户端测试程序
- 发送CharacterListRequest
- 接收CharacterListResponse
- 验证数据正确性

### 步骤7：记录迁移结果

- 记录迁移过程中的问题和解决方案
- 更新文档
- 总结经验

## 五、预期成果

### 5.1 技术成果

- ✅ 成功迁移CHARAC_LIST消息到标准Protobuf
- ✅ 实现双模式编解码器支持CHARAC_LIST
- ✅ 完成跨语言通信测试
- ✅ 验证编解码器的正确性

### 5.2 测试成果

- ✅ Go单元测试全部通过
- ✅ Java编译成功
- ✅ 服务端启动成功
- ✅ Go客户端与Java服务端通信正常
- ✅ 角色列表查询测试成功

### 5.3 文档成果

- ✅ 完整的迁移计划文档
- ✅ 详细的迁移结果文档
- ✅ 问题解决方案记录
- ✅ 最佳实践总结
- ✅ 改进建议

## 六、风险和挑战

### 6.1 潜在风险

1. **复杂嵌套结构**: CharacterListResponse包含多个嵌套消息，需要仔细处理
2. **字段映射**: 需要确保Java字段和Proto字段的正确映射
3. **数据一致性**: 需要确保迁移后的数据与原JProtobuf数据一致

### 6.2 应对策略

1. **充分测试**: 编写全面的测试用例，覆盖所有字段
2. **逐步验证**: 先测试简单消息，再测试复杂消息
3. **对比验证**: 对比JProtobuf和标准Protobuf的序列化结果

## 七、后续计划

- **批次04**: 迁移其他角色管理相关的消息
- **批次05**: 迁移频道管理相关的消息
- **批次06**: 迁移物品管理相关的消息

## 八、成功标准

1. ✅ character.proto文件验证通过
2. ✅ Go和Java代码生成成功
3. ✅ 所有测试用例通过
4. ✅ 编解码器扩展完成
5. ✅ 跨语言通信测试通过
6. ✅ 文档更新完成

---

**文档版本**: 1.0.0  
**创建日期**: 2026-02-09  
**创建人员**: AI Assistant
