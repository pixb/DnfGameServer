# 重构方案

## 一、整体架构

### 1.1 架构对比

```
┌─────────────────────────────────────────────────────────────┐
│                    当前架构 (JProtobuf)                      │
└─────────────────────────────────────────────────────────────┘
                          ↓ 重构
┌─────────────────────────────────────────────────────────────┐
│                    目标架构 (标准Protobuf)                   │
│                                                             │
│  ┌──────────────┐         ┌──────────────┐               │
│  │  Java客户端  │         │  Go服务器    │               │
│  │  (标准proto) │◄──────►│  (标准proto) │               │
│  └──────────────┘         └──────────────┘               │
│         │                        │                         │
│         │                        │                         │
│  ┌──────▼──────────────────────▼───────┐                │
│  │         .proto 文件                   │                │
│  │  (跨语言共享的协议定义)               │                │
│  └───────────────────────────────────────┘                │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 架构说明

#### 1.2.1 当前架构 (JProtobuf)

- **协议定义**：使用Java注解定义消息
- **代码生成**：运行时通过反射生成编解码器
- **语言限制**：仅支持Java
- **工具链**：依赖百度私有实现

#### 1.2.2 目标架构 (标准Protobuf)

- **协议定义**：使用.proto文件定义消息
- **代码生成**：使用protoc编译生成多语言代码
- **跨语言**：支持Java、Go、Python、TypeScript等
- **工具链**：使用标准工具（buf、protoc）

## 二、重构步骤

### 2.1 阶段1：准备工作

**目标**：了解当前代码结构，制定转换计划

#### 2.1.1 统计协议文件

```bash
# 统计包含@Protobuf注解的文件
grep -r "@Protobuf" src/main/java/com/dnfm/mina/protobuf --include="*.java" | wc -l
```

#### 2.1.2 分析消息类型

- REQ/RES消息对
- PT_数据结构
- ENUM_枚举类型
- NOTIFY_通知消息

#### 2.1.3 制定转换计划

- 确定转换优先级（核心模块优先）
- 制定文件组织结构
- 定义命名规范

### 2.2 阶段2：生成Proto文件

**目标**：从Java文件生成.proto文件

#### 2.2.1 推荐方法：手动转换少量文件

**重要原则**：
- **每次只迁移最少量的文件**（1-2个文件）
- **避免使用Python脚本一次性迁移**
- **确保每个文件转换后充分测试**
- **保持迁移的可控性**

**操作步骤**：

1. **选择一个核心文件**（如登录相关）
2. **手动创建对应的.proto文件**
3. **验证转换的准确性**
4. **测试通过后再迁移下一个文件**

**示例**：转换登录消息

```protobuf
// login.proto
syntax = "proto3";
package dnfm.protobuf;

// 登录请求
message LOGIN_REQ {
  uint64 userId = 1;
  uint32 roomId = 2;
  uint64 accessToken = 3;
}

// 登录响应
message LOGIN_RES {
  int32 error = 1;
  int32 playerId = 2;
  string udpHost = 3;
  int32 udpPort = 4;
}
```

#### 2.2.2 不推荐的方法

**避免使用Python脚本自动生成**：
- 一次性转换所有文件风险高
- 可能出现批量错误
- 难以定位和修复问题
- 不利于测试和验证

### 2.3 阶段3：生成Java代码

**目标**：使用protoc生成标准protobuf Java代码

#### 2.3.1 安装protoc

```bash
# Windows
# 下载protoc from https://github.com/protocolbuffers/protobuf/releases

# Linux/Mac
brew install protobuf
```

#### 2.3.2 生成Java代码

```bash
# 创建输出目录
mkdir -p gen/java

# 生成Java代码
protoc --java_out=gen/java proto/generated/common/*.proto
```

#### 2.3.3 集成到项目

修改pom.xml，添加protobuf依赖：

```xml
<dependencies>
    <!-- 标准protobuf依赖 -->
    <dependency>
        <groupId>com.google.protobuf</groupId>
        <artifactId>protobuf-java</artifactId>
        <version>3.21.12</version>
    </dependency>
</dependencies>

<build>
    <plugins>
        <!-- Protobuf Maven插件 -->
        <plugin>
            <groupId>org.xolstice.maven.plugins</groupId>
            <artifactId>protobuf-maven-plugin</artifactId>
            <version>0.6.1</version>
            <configuration>
                <protoSourceRoot>proto/generated</protoSourceRoot>
                <outputDirectory>target/generated-sources/protobuf/java</outputDirectory>
            </configuration>
            <executions>
                <execution>
                    <goals>
                        <goal>compile</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

### 2.4 阶段4：修改编码器和解码器

**目标**：适配标准protobuf的编解码

详见 [02_05_代码生成与集成.md](./02_05_代码生成与集成.md)

### 2.5 阶段5：测试验证

**目标**：验证转换的正确性

详见 [02_06_测试与验证.md](./02_06_测试与验证.md)

### 2.6 阶段6：渐进式迁移

**目标**：平滑迁移，避免一次性改动过大

#### 2.6.1 迁移策略

1. **双模式运行**
   - 保留JProtobuf编解码器
   - 新增标准protobuf编解码器
   - 通过配置切换

2. **分模块迁移**
   - 优先迁移核心模块（登录、角色）
   - 逐步迁移其他模块
   - 每个模块独立测试

3. **灰度发布**
   - 部分用户使用新协议
   - 监控错误率和性能
   - 逐步扩大使用范围

#### 2.6.2 配置示例

```yaml
# application.yml
protobuf:
  mode: standard  # jprotobuf | standard | hybrid
  migration:
    enabled: true
    modules:
      - LOGIN
      - AUTH_INFO
      - CHARACTER_INFO
```

## 三、迁移风险

### 3.1 技术风险

| 风险 | 说明 | 缓解措施 |
|------|------|---------|
| **数据不一致** | 转换过程中数据可能不一致 | 充分测试，对比验证 |
| **性能下降** | 新实现可能性能不如旧实现 | 性能测试，优化关键路径 |
| **兼容性问题** | 新旧协议可能不兼容 | 保留双模式，灰度发布 |

### 3.2 业务风险

| 风险 | 说明 | 缓解措施 |
|------|------|---------|
| **功能缺失** | 转换过程中可能遗漏功能 | 逐模块迁移，充分测试 |
| **服务中断** | 迁移可能导致服务中断 | 采用渐进式迁移，保留回退方案 |
| **用户体验** | 协议变更可能影响用户体验 | 保持向后兼容，灰度发布 |

### 3.3 管理风险

| 风险 | 说明 | 缓解措施 |
|------|------|---------|
| **进度延误** | 工作量可能超出预期 | 分阶段进行，及时调整计划 |
| **资源不足** | 需要额外的开发和测试资源 | 提前规划，合理分配资源 |
| **知识传递** | 团队需要学习新协议 | 提供培训，编写文档 |

## 四、迁移计划

### 4.1 时间规划

| 阶段 | 时间 | 主要任务 |
|------|------|---------|
| 准备阶段 | 1周 | 统计文件、分析消息、制定计划 |
| 核心模块迁移 | 2周 | 迁移登录、角色等核心模块 |
| 其他模块迁移 | 3周 | 迁移其他模块 |
| 测试验证 | 1周 | 单元测试、集成测试、性能测试 |
| 灰度发布 | 2周 | 逐步上线，监控指标 |
| 全量发布 | 1周 | 全面切换，清理旧代码 |

**总计**：10周

### 4.2 里程碑

- **M1**：完成准备工作（第1周）
- **M2**：核心模块迁移完成（第3周）
- **M3**：所有模块迁移完成（第6周）
- **M4**：测试验证通过（第7周）
- **M5**：灰度发布完成（第9周）
- **M6**：全量发布完成（第10周）

### 4.3 成功标准

1. **功能完整性**
   - 所有消息正确转换
   - 功能与旧实现一致
   - 通过所有测试用例

2. **性能指标**
   - 序列化性能不低于旧实现
   - 反序列化性能不低于旧实现
   - 内存使用不超过旧实现

3. **稳定性指标**
   - 错误率低于0.1%
   - 响应时间不超过旧实现
   - 系统可用性达到99.9%

4. **兼容性指标**
   - 支持多语言通信
   - 符合Protobuf标准
   - 可使用标准工具链
