# 文件组织

## 一、Proto文件目录结构

### 1.1 目录结构

```
proto/
├── generated/
│   ├── common/           # 通用消息
│   │   ├── login.proto
│   │   ├── character.proto
│   │   └── item.proto
│   ├── dungeon/          # 副本相关
│   │   ├── start_dungeon.proto
│   │   └── stage_info.proto
│   └── social/           # 社交相关
│       ├── party.proto
│       └── chat.proto
├── buf.yaml             # Buf配置
└── buf.gen.yaml         # Buf生成配置
```

### 1.2 目录说明

#### 1.2.1 common目录

**用途**：存放通用的消息定义

**包含文件**：
- `login.proto` - 登录相关消息
- `character.proto` - 角色相关消息
- `item.proto` - 物品相关消息

#### 1.2.2 dungeon目录

**用途**：存放副本相关的消息定义

**包含文件**：
- `start_dungeon.proto` - 开始副本
- `stage_info.proto` - 关卡信息

#### 1.2.3 social目录

**用途**：存放社交相关的消息定义

**包含文件**：
- `party.proto` - 组队相关
- `chat.proto` - 聊天相关

## 二、文件命名规范

### 2.1 Proto文件命名

| 模块 | 文件名 | 模块号范围 |
|------|--------|-----------|
| 通用类型 | `common.proto` | - |
| 认证 | `auth.proto` | 10000-10099 |
| 角色 | `character.proto` | 10100-10199 |
| 副本 | `dungeon.proto` | 10200-10299 |
| 好友 | `friend.proto` | 10300-10399 |
| 队伍 | `party.proto` | 10700-10799 |
| 聊天 | `chat.proto` | 10800-10899 |
| 公会 | `guild.proto` | 11600-11699 |
| 任务 | `quest.proto` | 11900-11999 |
| 技能 | `skill.proto` | 12000-12099 |
| 物品 | `item.proto` | 14000-14099 |
| 装备 | `equip.proto` | 14100-14199 |
| 商店 | `shop.proto` | 14300-14399 |
| 邮件 | `mail.proto` | 15000-15099 |
| 战斗 | `battle.proto` | 18000-18099 |

### 2.2 消息命名规范

#### 2.2.1 请求消息

**格式**：`{Action}Request`

**示例**：
- `LoginRequest` - 登录请求
- `CreateCharacterRequest` - 创建角色请求
- `StartDungeonRequest` - 开始副本请求

#### 2.2.2 响应消息

**格式**：`{Action}Response`

**示例**：
- `LoginResponse` - 登录响应
- `CreateCharacterResponse` - 创建角色响应
- `StartDungeonResponse` - 开始副本响应

#### 2.2.3 通知消息

**格式**：`{Action}Notification`

**示例**：
- `CharacterEnterNotification` - 角色进入通知
- `PartyJoinNotification` - 加入队伍通知
- `ChatMessageNotification` - 聊天消息通知

#### 2.2.4 数据结构

**格式**：`{Name}`

**示例**：
- `Character` - 角色数据
- `Item` - 物品数据
- `Skill` - 技能数据

### 2.3 字段命名规范

**规则**：使用snake_case

**示例**：
```protobuf
message Character {
  int64 char_guid = 1;        // ✅ 正确
  string player_name = 2;       // ✅ 正确
  int32 max_hp = 3;           // ✅ 正确
  int64 CharGUID = 4;         // ❌ 错误
  string PlayerName = 5;       // ❌ 错误
  int32 MaxHP = 6;            // ❌ 错误
}
```

## 三、模块分类与组织

### 3.1 模块号映射

详见 [proto/MODULE_MAPPING.md](../../proto/MODULE_MAPPING.md)

### 3.2 文件组织原则

#### 3.2.1 按模块号范围分组

- 每个模块号范围对应一个proto文件
- 模块号范围：10000-10099 → auth.proto

#### 3.2.2 通用类型统一管理

- 所有枚举类型放在 `common.proto`
- 所有共享数据结构放在 `common.proto`
- 跨模块使用的消息放在 `common.proto`

#### 3.2.3 请求/响应配对

- 每个请求都有对应的响应
- 请求和响应在同一个proto文件中
- 请求和响应的字段序号独立

## 四、Proto文件模板

### 4.1 基本模板

```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "gen/dnf/v1";
option java_package = "com.dnfm.mina.protobuf.generated";
option java_outer_classname = "AuthProto";

// 导入通用类型
import "dnf/v1/common.proto";

// ========== 请求消息 ==========

// 登录请求 (module=10000, cmd=1)
message LoginRequest {
  string openid = 1;
  uint32 type = 2;
  string token = 3;
  uint32 plat_id = 4;
  string client_ip = 5;
  string version = 6;
}

// ========== 响应消息 ==========

// 登录响应 (module=10000, cmd=2)
message LoginResponse {
  int32 error = 1;
  string auth_key = 2;
  string account_key = 3;
  bool encrypt = 4;
  uint64 server_time = 5;
}

// ========== 通知消息 ==========

// 服务器关闭通知 (module=10000, cmd=100)
message ServerShutdownNotification {
  int32 reason = 1;
  int32 shutdown_time = 2;
}
```

### 4.2 注释规范

#### 4.2.1 单行注释

```protobuf
// 单行注释：简要说明消息用途

// 登录请求 (module=10000, cmd=1)
message LoginRequest {
  string openid = 1;
}
```

#### 4.2.2 多行注释

```protobuf
/*
 * 多行注释：详细说明字段含义
 * token用于验证用户身份
 * 有效期为30分钟
 */
string token = 2;
```

#### 4.2.3 字段注释

```protobuf
message LoginRequest {
  // 用户唯一标识
  string openid = 1;

  // 登录类型：1=正常登录, 2=游客登录
  uint32 type = 2;

  /*
   * 访问令牌
   * 用于验证用户身份
   * 有效期为30分钟
   */
  string token = 3;
}
```

## 五、buf.yaml配置

### 5.1 基本配置

```yaml
version: v2
deps:
  - buf.build/googleapis/googleapis

lint:
  use:
    - BASIC
    - ENUM_ZERO_VALUE_SUFFIX
    - FIELD_LOWER_SNAKE_CASE
    - MESSAGE_NAMES
  except:
    - ENUM_VALUE_PREFIX
    - FIELD_NOT_REQUIRED
    - PACKAGE_DIRECTORY_MATCH
    - PACKAGE_NO_IMPORT_CYCLE
    - PACKAGE_VERSION_SUFFIX
    - ENUM_ZERO_VALUE_SUFFIX
    - PACKAGE_SAME_DIRECTORY
  disallow_comment_ignores: true

breaking:
  use:
    - FILE
  except:
    - EXTENSION_NO_DELETE
    - FIELD_SAME_DEFAULT
```

### 5.2 配置说明

#### 5.2.1 deps

- **作用**：声明依赖的proto包
- **示例**：`buf.build/googleapis/googleapis`

#### 5.2.2 lint

- **作用**：配置代码规范检查规则
- **use**：启用的检查规则
- **except**：禁用的检查规则

#### 5.2.3 breaking

- **作用**：配置破坏性变更检查规则
- **use**：启用的检查规则
- **except**：禁用的检查规则

## 六、buf.gen.yaml配置

### 6.1 基本配置

```yaml
version: v2
managed:
  enabled: true
  disable:
    - file_option: go_package
      module: buf.build/googleapis/googleapis
  override:
    - file_option: go_package_prefix
      value: gen

plugins:
  # Java Protobuf代码生成
  - remote: buf.build/protocolbuffers/java
    out: gen/java
    opt: paths=source_relative

  # Java gRPC代码生成（可选）
  - remote: buf.build/grpc/java
    out: gen/java
    opt: paths=source_relative

  # Go代码生成（可选）
  # - remote: buf.build/protocolbuffers/go
  #   out: gen/go
  #   opt: paths=source_relative

  # TypeScript代码生成（可选）
  # - remote: buf.build/bufbuild/es
  #   out: gen/ts
  #   opt: target=ts
  #   include_imports: true
```

### 6.2 配置说明

#### 6.2.1 managed

- **作用**：管理proto选项
- **enabled**：启用管理
- **disable**：禁用特定模块的选项
- **override**：覆盖特定选项

#### 6.2.2 plugins

- **作用**：配置代码生成插件
- **remote**：远程插件地址
- **out**：输出目录
- **opt**：插件选项

### 6.3 多语言支持

如需支持多种语言，取消注释相应的插件配置。
