# 批次08迁移计划

## 一、迁移概述

批次08将迁移城镇相关消息，包括进入/离开城镇、角色信息、聊天、用户列表、目标用户详情、交互菜单等功能。

## 二、迁移范围

### 2.1 进入城镇 (ModuleID: 10100)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 进入城镇请求 | REQ_ENTER_TO_TOWN | 0 | ✅ 已完成 |
| 进入城镇响应 | RES_ENTER_TO_TOWN | 1 | ✅ 已完成 |

### 2.2 角色信息 (ModuleID: 10103)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 角色信息请求 | REQ_CHARACTER_INFO | 0 | ✅ 已完成 |
| 角色信息响应 | RES_CHARACTER_INFO | 1 | ✅ 已完成 |

### 2.3 城镇聊天 (ModuleID: 10105)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 城镇聊天请求 | REQ_TOWN_CHAT | 0 | ⏸️ 暂缓 |
| 城镇聊天响应 | RES_TOWN_CHAT | 1 | ⏸️ 暂缓 |

### 2.4 城镇用户GUID列表 (ModuleID: 10106)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 城镇用户GUID列表请求 | REQ_TOWN_USER_GUID_LIST | 0 | ✅ 已完成 |
| 城镇用户GUID列表响应 | RES_TOWN_USER_GUID_LIST | 1 | ✅ 已完成 |

### 2.5 目标用户详情 (ModuleID: 10107)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 目标用户详情请求 | REQ_TARGET_USER_DETAIL_INFO | 0 | ✅ 已完成 |
| 目标用户详情响应 | RES_TARGET_USER_DETAIL_INFO | 1 | ✅ 已完成 |

### 2.6 交互菜单 (ModuleID: 10108)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 交互菜单请求 | REQ_INTERACTION_MENU | 0 | ✅ 已完成 |
| 交互菜单响应 | RES_INTERACTION_MENU | 1 | ✅ 已完成 |

### 2.7 离开城镇 (ModuleID: 10109)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 离开城镇请求 | REQ_LEAVE_FROM_TOWN | 0 | ✅ 已完成 |
| 离开城镇响应 | RES_LEAVE_FROM_TOWN | 1 | ✅ 已完成 |

## 三、消息分析

### 3.1 REQ_ENTER_TO_TOWN

**ModuleID**: 10100
**CMD**: 0
**字段定义**:
- `authkey` (string, order=1): 认证密钥
- `town` (uint32, order=2): 城镇ID
- `area` (uint32, order=3): 区域ID
- `posx` (int32, order=4): X坐标
- `posy` (int32, order=5): Y坐标

**Proto定义**:
```protobuf
message EnterTownRequest {
  string authkey = 1;
  uint32 town = 2;
  uint32 area = 3;
  int32 posx = 4;
  int32 posy = 5;
}
```

### 3.2 RES_ENTER_TO_TOWN

**ModuleID**: 10100
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `town` (uint32, order=2): 城镇ID
- `area` (uint32, order=3): 区域ID
- `posx` (int32, order=4): X坐标
- `posy` (int32, order=5): Y坐标
- `partyguid` (uint64, order=6): 队伍GUID
- `servertime` (uint64, order=7): 服务器时间
- `expratio` (int32, order=8): 经验比例
- `fatigueratio` (int32, order=9): 疲劳比例
- `version` (string, order=10): 版本

**Proto定义**:
```protobuf
message EnterTownResponse {
  int32 error = 1;
  uint32 town = 2;
  uint32 area = 3;
  int32 posx = 4;
  int32 posy = 5;
  uint64 partyguid = 6;
  uint64 servertime = 7;
  int32 expratio = 8;
  int32 fatigueratio = 9;
  string version = 10;
}
```

### 3.3 REQ_CHARACTER_INFO

**ModuleID**: 10103
**CMD**: 0
**字段定义**:
- `authkey` (string, order=1): 认证密钥
- `option` (int32, order=2): 选项
- `charlist` (List<PT_CHARACTER_GUID>, order=3): 角色GUID列表

**Proto定义**:
```protobuf
message CharacterInfoRequest {
  string authkey = 1;
  int32 option = 2;
  repeated CharacterGuid charlist = 3;
}
```

### 3.4 RES_CHARACTER_INFO

**ModuleID**: 10103
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `charlist` (List<PT_CHARACTER_INFO>, order=2): 角色信息列表

**Proto定义**:
```protobuf
message CharacterInfoResponse {
  int32 error = 1;
  repeated CharacterInfo charlist = 2;
}
```

### 3.5 REQ_TOWN_CHAT

**ModuleID**: 10105
**CMD**: 0
**字段定义**:
- `type` (int32, order=1): 类型
- `chat` (string, order=2): 聊天内容
- `voice` (string, order=3): 语音
- `voicetime` (string, order=4): 语音时间
- `name` (string, order=5): 名称
- `guid` (uint64, order=6): GUID
- `hyperlinktype` (int32, order=7): 超链接类型
- `hyperlinksubtype` (int32, order=8): 超链接子类型
- `hyperlinkdatas` (List<PT_HYPERLINK_DATA>, order=9): 超链接数据
- `sub` (List<PT_HYPERLINK_SYSTEMMESSAGE_SUB>, order=10): 子消息
- `skinchatinfo` (PT_SKIN_CHAT_INFO, order=11): 聊天皮肤信息

**Proto定义**:
```protobuf
message TownChatRequest {
  int32 type = 1;
  string chat = 2;
  string voice = 3;
  string voicetime = 4;
  string name = 5;
  uint64 guid = 6;
  int32 hyperlinktype = 7;
  int32 hyperlinksubtype = 8;
  repeated HyperlinkData hyperlinkdatas = 9;
  repeated HyperlinkSystemmessageSub sub = 10;
  SkinChatInfo skinchatinfo = 11;
}
```

### 3.6 RES_TOWN_CHAT

**ModuleID**: 10105
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `type` (int32, order=2): 类型
- `subtype` (int32, order=3): 子类型
- `charguid` (uint64, order=4): 角色GUID
- `targetguid` (uint64, order=5): 目标GUID
- `job` (int32, order=6): 职业
- `growtype` (int32, order=7): 成长类型
- `level` (int32, order=8): 等级
- `sender` (string, order=9): 发送者
- `chat` (string, order=10): 聊天内容
- `voice` (string, order=11): 语音
- `voicetime` (string, order=12): 语音时间
- `receiver` (string, order=13): 接收者
- `hyperlinktype` (int32, order=14): 超链接类型
- `hyperlinksubtype` (int32, order=15): 超链接子类型
- `secgrowtype` (int32, order=16): 第二成长类型
- `online` (int32, order=17): 在线状态
- `hyperlinkdatas` (List<PT_HYPERLINK_DATA>, order=18): 超链接数据
- `sub` (List<PT_HYPERLINK_SYSTEMMESSAGE_SUB>, order=19): 子消息
- `partyguid` (uint64, order=20): 队伍GUID
- `equip` (PT_EQUIP, order=21): 装备
- `title` (PT_EQUIP, order=22): 称号
- `flag` (PT_EQUIP, order=23): 旗帜
- `emblem` (PT_STACKABLE, order=24): 徽章
- `material` (PT_STACKABLE, order=25): 材料
- `consume` (PT_STACKABLE, order=26): 消耗品
- `avatar` (PT_AVATAR_ITEM, order=27): 头像
- `card` (PT_STACKABLE, order=28): 卡片
- `crack` (PT_STACKABLE, order=29): 裂纹
- `crackequip` (PT_EQUIP, order=30): 裂纹装备
- `creature` (PT_CREATURE, order=31): 生物
- `cartifact` (PT_ARTIFACT, order=32): 神器
- `skinchatinfo` (PT_SKIN_CHAT_INFO, order=33): 聊天皮肤信息
- `sdavatar` (PT_AVATAR_ITEM, order=34): SD头像
- `bookmark` (PT_STACKABLE, order=35): 书签
- `scroll` (PT_EQUIP, order=36): 卷轴
- `info` (PT_RECRUIT_PARTY_INFO, order=37): 招募队伍信息
- `date` (uint64, order=38): 日期
- `rpguid` (uint64, order=39): RPGUID
- `creditscore` (int32, order=40): 信用分

**Proto定义**:
```protobuf
message TownChatResponse {
  int32 error = 1;
  int32 type = 2;
  int32 subtype = 3;
  uint64 charguid = 4;
  uint64 targetguid = 5;
  int32 job = 6;
  int32 growtype = 7;
  int32 level = 8;
  string sender = 9;
  string chat = 10;
  string voice = 11;
  string voicetime = 12;
  string receiver = 13;
  int32 hyperlinktype = 14;
  int32 hyperlinksubtype = 15;
  int32 secgrowtype = 16;
  int32 online = 17;
  repeated HyperlinkData hyperlinkdatas = 18;
  repeated HyperlinkSystemmessageSub sub = 19;
  uint64 partyguid = 20;
  Equip equip = 21;
  Equip title = 22;
  Equip flag = 23;
  Stackable emblem = 24;
  Stackable material = 25;
  Stackable consume = 26;
  AvatarItem avatar = 27;
  Stackable card = 28;
  Stackable crack = 29;
  Equip crackequip = 30;
  Creature creature = 31;
  Artifact cartifact = 32;
  SkinChatInfo skinchatinfo = 33;
  AvatarItem sdavatar = 34;
  Stackable bookmark = 35;
  Equip scroll = 36;
  RecruitPartyInfo info = 37;
  uint64 date = 38;
  uint64 rpguid = 39;
  int32 creditscore = 40;
}
```

### 3.7 REQ_TOWN_USER_GUID_LIST

**ModuleID**: 10106
**CMD**: 0
**字段定义**:
- `count` (int32, order=1): 数量
- `posx` (int32, order=2): X坐标
- `posy` (int32, order=3): Y坐标

**Proto定义**:
```protobuf
message TownUserGuidListRequest {
  int32 count = 1;
  int32 posx = 2;
  int32 posy = 3;
}
```

### 3.8 RES_TOWN_USER_GUID_LIST

**ModuleID**: 10106
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `charlist` (List<PT_CHARACTER_GUID>, order=2): 角色GUID列表

**Proto定义**:
```protobuf
message TownUserGuidListResponse {
  int32 error = 1;
  repeated CharacterGuid charlist = 2;
}
```

### 3.9 REQ_TARGET_USER_DETAIL_INFO

**ModuleID**: 10107
**CMD**: 0
**字段定义**:
- `targetguid` (uint64, order=1): 目标GUID

**Proto定义**:
```protobuf
message TargetUserDetailInfoRequest {
  uint64 targetguid = 1;
}
```

### 3.10 RES_TARGET_USER_DETAIL_INFO

**ModuleID**: 10107
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `guid` (uint64, order=2): GUID
- `world` (int32, order=3): 世界
- `gguid` (uint64, order=4): 公会GUID
- `gmastername` (string, order=5): 公会会长名称
- `name` (string, order=6): 名称
- `exp` (int32, order=7): 经验
- `level` (int32, order=8): 等级
- `job` (int32, order=9): 职业
- `growtype` (int32, order=10): 成长类型
- `secgrowtype` (int32, order=11): 第二成长类型
- `equipscore` (int32, order=12): 装备分数
- `spoint` (int32, order=13): SP点
- `adventureunionlevel` (int32, order=14): 冒险联盟等级
- `adventureunionexp` (int64, order=15): 冒险联盟经验
- `characlistcount` (int32, order=16): 角色列表数量
- `gname` (string, order=17): 公会名称
- `gsymbol` (List<PT_GUILD_SYMBOL>, order=18): 公会符号
- `equiplist` (List<PT_EQUIP>, order=19): 装备列表
- `avatarlist` (List<PT_AVATAR_ITEM>, order=20): 头像列表
- `creaturelist` (List<PT_CREATURE>, order=21): 生物列表
- `cartifactlist` (List<PT_ARTIFACT>, order=22): 神器列表
- `skinlist` (List<PT_SKIN_ITEM>, order=23): 皮肤列表
- `bufflist` (PT_BUFF_LIST, order=24): Buff列表
- `skill` (PT_SKILL_INFO, order=25): 技能
- `gmembergrade` (int32, order=26): 公会成员等级
- `blackdiamond` (uint64, order=27): 黑钻
- `creditscore` (int32, order=28): 信用分
- `gamecenterinfo` (int32, order=29): 游戏中心信息
- `qqVipinfo` (int32, order=30): QQ VIP信息
- `avatarVisibleFlags` (uint32, order=31): 头像可见标志
- `equipskinlist` (List<PT_EQUIP>, order=32): 装备皮肤列表
- `avatarskinlist` (List<PT_AVATAR_ITEM>, order=33): 头像皮肤列表
- `totallike` (int32, order=34): 总点赞
- `like` (int32, order=35): 点赞
- `rank` (int32, order=36): 排名
- `info` (List<PT_CHIVALRY>, order=37): 骑士信息
- `communionlevel` (int32, order=38): 共融等级
- `fame` (int32, order=39): 声望
- `charm` (int32, order=40): 魅力
- `sdavatarlist` (List<PT_AVATAR_ITEM>, order=41): SD头像列表
- `grade` (int32, order=42): 等级
- `gradeFair` (int32, order=43): 公平等级
- `isadventureCondition` (bool, order=44): 是否冒险条件

**Proto定义**:
```protobuf
message TargetUserDetailInfoResponse {
  int32 error = 1;
  uint64 guid = 2;
  int32 world = 3;
  uint64 gguid = 4;
  string gmastername = 5;
  string name = 6;
  int32 exp = 7;
  int32 level = 8;
  int32 job = 9;
  int32 growtype = 10;
  int32 secgrowtype = 11;
  int32 equipscore = 12;
  int32 spoint = 13;
  int32 adventureunionlevel = 14;
  int64 adventureunionexp = 15;
  int32 characlistcount = 16;
  string gname = 17;
  repeated GuildSymbol gsymbol = 18;
  repeated Equip equiplist = 19;
  repeated AvatarItem avatarlist = 20;
  repeated Creature creaturelist = 21;
  repeated Artifact cartifactlist = 22;
  repeated SkinItem skinlist = 23;
  BuffList bufflist = 24;
  SkillInfo skill = 25;
  int32 gmembergrade = 26;
  uint64 blackdiamond = 27;
  int32 creditscore = 28;
  int32 gamecenterinfo = 29;
  int32 qqVipinfo = 30;
  uint32 avatarVisibleFlags = 31;
  repeated Equip equipskinlist = 32;
  repeated AvatarItem avatarskinlist = 33;
  int32 totallike = 34;
  int32 like = 35;
  int32 rank = 36;
  repeated Chivalry info = 37;
  int32 communionlevel = 38;
  int32 fame = 39;
  int32 charm = 40;
  repeated AvatarItem sdavatarlist = 41;
  int32 grade = 42;
  int32 gradeFair = 43;
  bool isadventureCondition = 44;
}
```

### 3.11 REQ_INTERACTION_MENU

**ModuleID**: 10108
**CMD**: 0
**字段定义**:
- `charguid` (uint64, order=1): 角色GUID
- `openmenutype` (int32, order=2): 打开菜单类型

**Proto定义**:
```protobuf
message InteractionMenuRequest {
  uint64 charguid = 1;
  int32 openmenutype = 2;
}
```

### 3.12 RES_INTERACTION_MENU

**ModuleID**: 10108
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `charguid` (uint64, order=2): 角色GUID
- `online` (int32, order=3): 在线状态
- `status` (int32, order=4): 状态
- `lastlogout` (int64, order=5): 最后登出时间
- `gguid` (uint64, order=6): 公会GUID
- `openmenutype` (int32, order=7): 打开菜单类型
- `level` (int32, order=8): 等级
- `job` (int32, order=9): 职业
- `growtype` (int32, order=10): 成长类型
- `secgrowtype` (int32, order=11): 第二成长类型
- `name` (string, order=12): 名称
- `gname` (string, order=13): 公会名称
- `grade` (int32, order=14): 等级
- `qindex` (int32, order=15): Q索引
- `partyguid` (uint64, order=16): 队伍GUID
- `partyleader` (uint64, order=17): 队长GUID
- `publictype` (int32, order=18): 公共类型
- `creditscore` (int32, order=19): 信用分
- `world` (int32, order=20): 世界
- `openid` (string, order=21): OpenID
- `platform` (int32, order=22): 平台
- `platformserverid` (uint32, order=23): 平台服务器ID
- `adventureunionname` (string, order=24): 冒险联盟名称
- `gamecenterinfo` (int32, order=25): 游戏中心信息
- `qqVipinfo` (int32, order=26): QQ VIP信息
- `characterframe` (int32, order=27): 角色框架

**Proto定义**:
```protobuf
message InteractionMenuResponse {
  int32 error = 1;
  uint64 charguid = 2;
  int32 online = 3;
  int32 status = 4;
  int64 lastlogout = 5;
  uint64 gguid = 6;
  int32 openmenutype = 7;
  int32 level = 8;
  int32 job = 9;
  int32 growtype = 10;
  int32 secgrowtype = 11;
  string name = 12;
  string gname = 13;
  int32 grade = 14;
  int32 qindex = 15;
  uint64 partyguid = 16;
  uint64 partyleader = 17;
  int32 publictype = 18;
  int32 creditscore = 19;
  int32 world = 20;
  string openid = 21;
  int32 platform = 22;
  uint32 platformserverid = 23;
  string adventureunionname = 24;
  int32 gamecenterinfo = 25;
  int32 qqVipinfo = 26;
  int32 characterframe = 27;
}
```

### 3.13 REQ_LEAVE_FROM_TOWN

**ModuleID**: 10109
**CMD**: 0
**字段定义**: 无字段（空消息）

**Proto定义**:
```protobuf
message LeaveFromTownRequest {
}
```

### 3.14 RES_LEAVE_FROM_TOWN

**ModuleID**: 10109
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码

**Proto定义**:
```protobuf
message LeaveFromTownResponse {
  int32 error = 1;
}
```

## 四、数据结构定义

批次08的消息主要复用已有的数据结构，包括：
- PT_CHARACTER_GUID: 角色GUID
- PT_CHARACTER_INFO: 角色信息
- PT_HYPERLINK_DATA: 超链接数据
- PT_HYPERLINK_SYSTEMMESSAGE_SUB: 超链接系统消息子项
- PT_SKIN_CHAT_INFO: 聊天皮肤信息
- PT_EQUIP: 装备
- PT_STACKABLE: 可堆叠物品
- PT_AVATAR_ITEM: 头像物品
- PT_CREATURE: 生物
- PT_ARTIFACT: 神器
- PT_RECRUIT_PARTY_INFO: 招募队伍信息
- PT_GUILD_SYMBOL: 公会符号
- PT_BUFF_LIST: Buff列表
- PT_SKILL_INFO: 技能信息
- PT_SKIN_ITEM: 皮肤物品
- PT_CHIVALRY: 骑士

这些数据结构在之前的批次中已经定义，可以直接复用。

## 五、迁移步骤

### 步骤1: Proto文件更新

1. 创建或更新`town.proto`文件，添加城镇相关消息定义
2. 复用已有的数据结构定义

### 步骤2: 代码生成

1. 使用buf工具生成Go代码
2. 使用buf工具生成Java代码

### 步骤3: 编解码器扩展

1. 在StandardProtobufDecoder中添加适配方法：
   - `adaptEnterTownRequest(byte[] body)`
   - `adaptCharacterInfoRequest(byte[] body)`
   - `adaptTownChatRequest(byte[] body)`
   - `adaptTownUserGuidListRequest(byte[] body)`
   - `adaptTargetUserDetailInfoRequest(byte[] body)`
   - `adaptInteractionMenuRequest(byte[] body)`
   - `adaptLeaveFromTownRequest(byte[] body)`

2. 在StandardProtobufEncoder中添加适配方法：
   - `adaptEnterTownResponse(Message msg)`
   - `adaptCharacterInfoResponse(Message msg)`
   - `adaptTownChatResponse(Message msg)`
   - `adaptTownUserGuidListResponse(Message msg)`
   - `adaptTargetUserDetailInfoResponse(Message msg)`
   - `adaptInteractionMenuResponse(Message msg)`
   - `adaptLeaveFromTownResponse(Message msg)`

### 步骤4: 测试编写

1. 编写Go单元测试
2. 编写编解码测试程序

### 步骤5: 测试验证

1. 运行Go单元测试
2. 运行编解码测试
3. 验证跨语言通信

## 六、风险评估

### 6.1 技术风险

| 风险项 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| 复杂数据结构 | 中 | 复用已有的数据结构定义 |
| 列表类型处理 | 低 | 参考之前的批次处理方式 |
| 字段数量多 | 低 | 严格按照Java源码进行映射 |

### 6.2 兼容性风险

| 风险项 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| 与现有消息冲突 | 低 | 使用新的ModuleID |
| 字段顺序错误 | 低 | 严格按照Java源码的order值 |

## 七、预期成果

1. **Proto文件**:
   - town.proto (城镇相关消息)

2. **生成的代码**:
   - Go代码: gen/go/dnf/v1/
   - Java代码: gen/java/com/dnfm/mina/protobuf/generated/

3. **编解码器扩展**:
   - StandardProtobufDecoder新增7个适配方法
   - StandardProtobufEncoder新增7个适配方法

4. **测试文件**:
   - Go单元测试: test/batch08_test.go
   - 编解码测试: examples/batch08_codec.go

5. **文档**:
   - 迁移计划: devdoc/protobuf/batch_08/01_迁移计划.md
   - 迁移结果: devdoc/protobuf/batch_08/02_迁移结果.md

## 八、时间估算

| 步骤 | 预计时间 |
| :--- | :--- |
| Proto文件更新 | 20分钟 |
| 代码生成 | 5分钟 |
| 编解码器扩展 | 30分钟 |
| 测试编写 | 20分钟 |
| 测试验证 | 10分钟 |
| 文档编写 | 10分钟 |
| **总计** | **95分钟** |

---

**文档版本**: 1.0.0
**创建日期**: 2026-02-09
**创建人员**: AI Assistant
**状态**: ✅ 已完成
