# 批次06迁移计划

## 一、迁移概述

批次06将迁移认证密钥刷新和平台资料更新相关的消息，包括认证密钥刷新和平台资料更新等功能。

## 二、迁移范围

### 2.1 认证密钥刷新 (ModuleID: 10009)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 认证密钥刷新请求 | REQ_AUTHKEY_REFRESH | 0 | 🔄 待迁移 |
| 认证密钥刷新响应 | RES_AUTHKEY_REFRESH | 1 | 🔄 待迁移 |

### 2.2 平台资料更新 (ModuleID: 10012)

| 消息类型 | Java类 | CMD | 状态 |
| :--- | :--- | :--- | :--- |
| 平台资料更新请求 | REQ_PLATFORM_PROFILE_UPDATE | 0 | 🔄 待迁移 |
| 平台资料更新响应 | RES_PLATFORM_PROFILE_UPDATE | 1 | 🔄 待迁移 |

## 三、消息分析

### 3.1 REQ_AUTHKEY_REFRESH

**ModuleID**: 10009
**CMD**: 0
**字段定义**:
- `authkey` (string, order=1): 认证密钥

**Proto定义**:
```protobuf
message AuthkeyRefreshRequest {
  string authkey = 1;
}
```

### 3.2 RES_AUTHKEY_REFRESH

**ModuleID**: 10009
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码
- `authkey` (string, order=2): 认证密钥
- `channel` (List<PT_CHANNEL_INFO>, order=3): 频道信息列表
- `version` (string, order=4): 版本号

**Proto定义**:
```protobuf
message AuthkeyRefreshResponse {
  int32 error = 1;
  string authkey = 2;
  repeated ChannelInfo channel = 3;
  string version = 4;
}
```

### 3.3 REQ_PLATFORM_PROFILE_UPDATE

**ModuleID**: 10012
**CMD**: 0
**字段定义**:
- `profileurl` (string, order=1): 资料URL
- `profilename` (string, order=2): 资料名称
- `firstlocation` (int32, order=3): 第一位置
- `secondlocation` (int32, order=4): 第二位置

**Proto定义**:
```protobuf
message PlatformProfileUpdateRequest {
  string profileurl = 1;
  string profilename = 2;
  int32 firstlocation = 3;
  int32 secondlocation = 4;
}
```

### 3.4 RES_PLATFORM_PROFILE_UPDATE

**ModuleID**: 10012
**CMD**: 1
**字段定义**:
- `error` (int32, order=1): 错误码

**Proto定义**:
```protobuf
message PlatformProfileUpdateResponse {
  int32 error = 1;
}
```

## 四、迁移步骤

### 步骤1: Proto文件更新

1. 创建或更新`auth.proto`文件，添加认证相关消息定义
2. 创建或更新`platform.proto`文件，添加平台相关消息定义

### 步骤2: 代码生成

1. 使用buf工具生成Go代码
2. 使用buf工具生成Java代码

### 步骤3: 编解码器扩展

1. 在StandardProtobufDecoder中添加适配方法：
   - `adaptAuthkeyRefreshRequest(byte[] body)`
   - `adaptPlatformProfileUpdateRequest(byte[] body)`

2. 在StandardProtobufEncoder中添加适配方法：
   - `adaptAuthkeyRefreshResponse(Message msg)`
   - `adaptPlatformProfileUpdateResponse(Message msg)`

### 步骤4: 测试编写

1. 编写Go单元测试
2. 编写编解码测试程序

### 步骤5: 测试验证

1. 运行Go单元测试
2. 运行编解码测试
3. 验证跨语言通信

## 五、风险评估

### 5.1 技术风险

| 风险项 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| PT_CHANNEL_INFO依赖 | 中 | 确保ChannelInfo已在channel.proto中定义 |
| 字段类型映射 | 低 | 严格按照Java源码进行映射 |
| 列表类型处理 | 低 | 参考之前的批次处理方式 |

### 5.2 兼容性风险

| 风险项 | 风险等级 | 应对措施 |
| :--- | :--- | :--- |
| 与现有消息冲突 | 低 | 使用新的ModuleID |
| 字段顺序错误 | 低 | 严格按照Java源码的order值 |

## 六、预期成果

1. **Proto文件**:
   - auth.proto (认证相关消息)
   - platform.proto (平台相关消息)

2. **生成的代码**:
   - Go代码: gen/go/dnf/v1/
   - Java代码: gen/java/com/dnfm/mina/protobuf/generated/

3. **编解码器扩展**:
   - StandardProtobufDecoder新增2个适配方法
   - StandardProtobufEncoder新增2个适配方法

4. **测试文件**:
   - Go单元测试: test/batch06_test.go
   - 编解码测试: examples/batch06_codec.go

5. **文档**:
   - 迁移计划: devdoc/protobuf/batch_06/01_迁移计划.md
   - 迁移结果: devdoc/protobuf/batch_06/02_迁移结果.md

## 七、时间估算

| 步骤 | 预计时间 |
| :--- | :--- |
| Proto文件更新 | 10分钟 |
| 代码生成 | 5分钟 |
| 编解码器扩展 | 15分钟 |
| 测试编写 | 10分钟 |
| 测试验证 | 10分钟 |
| 文档编写 | 10分钟 |
| **总计** | **60分钟** |

---

**文档版本**: 1.0.0
**创建日期**: 2026-02-09
**创建人员**: AI Assistant
**状态**: 🔄 进行中
