# 事件系统 - 数据库设计文档

## 1. 概述
本文档描述了事件系统的数据库设计，包括表结构、字段说明、索引设计等内容。事件系统的数据库设计主要用于存储事件相关的配置信息和历史记录，支持事件系统的正常运行和数据分析。

## 2. 设计原则
- **最小化存储**：只存储必要的事件相关数据
- **高性能**：优化查询和写入性能
- **可扩展性**：支持未来事件类型和数据结构的扩展
- **可靠性**：确保数据的一致性和完整性

## 3. 表结构设计

### 3.1 事件配置表 (`event_config`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 配置ID |
| `event_type` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 事件类型 |
| `event_name` | `VARCHAR(100)` | `NOT NULL` | 事件名称 |
| `description` | `TEXT` | | 事件描述 |
| `enabled` | `BOOLEAN` | `DEFAULT TRUE` | 是否启用 |
| `async_support` | `BOOLEAN` | `DEFAULT FALSE` | 是否支持异步处理 |
| `priority` | `INT` | `DEFAULT 0` | 默认优先级 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- `PRIMARY KEY`：`id`
- `UNIQUE INDEX`：`event_type`
- `INDEX`：`enabled`

### 3.2 事件监听器表 (`event_listener`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 监听器ID |
| `listener_name` | `VARCHAR(100)` | `NOT NULL` | 监听器名称 |
| `description` | `TEXT` | | 监听器描述 |
| `class_path` | `VARCHAR(255)` | `NOT NULL` | 监听器类路径（Java实现）或函数名（Go实现） |
| `priority` | `INT` | `DEFAULT 0` | 监听器优先级 |
| `enabled` | `BOOLEAN` | `DEFAULT TRUE` | 是否启用 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- `PRIMARY KEY`：`id`
- `INDEX`：`enabled`
- `INDEX`：`priority`

### 3.3 监听器事件关联表 (`listener_event_mapping`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 关联ID |
| `listener_id` | `BIGINT` | `NOT NULL REFERENCES event_listener(id)` | 监听器ID |
| `event_type` | `VARCHAR(50)` | `NOT NULL` | 事件类型 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

**索引设计**：
- `PRIMARY KEY`：`id`
- `UNIQUE INDEX`：`(listener_id, event_type)`
- `INDEX`：`event_type`
- `INDEX`：`listener_id`

### 3.4 事件历史表 (`event_history`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 历史记录ID |
| `event_type` | `VARCHAR(50)` | `NOT NULL` | 事件类型 |
| `event_data` | `JSON` | | 事件数据（JSON格式） |
| `trigger_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 触发时间 |
| `process_time` | `INT` | | 处理时间（毫秒） |
| `status` | `VARCHAR(20)` | `DEFAULT 'SUCCESS'` | 处理状态（SUCCESS/FAILED） |
| `error_message` | `TEXT` | | 错误信息（如果有） |
| `player_id` | `BIGINT` | | 关联的玩家ID（如果有） |
| `server_id` | `INT` | | 服务器ID |

**索引设计**：
- `PRIMARY KEY`：`id`
- `INDEX`：`(event_type, trigger_time)`
- `INDEX`：`(player_id, trigger_time)`
- `INDEX`：`(server_id, trigger_time)`
- `INDEX`：`trigger_time`

### 3.5 事件统计表 (`event_statistics`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 统计ID |
| `event_type` | `VARCHAR(50)` | `NOT NULL` | 事件类型 |
| `date` | `DATE` | `NOT NULL` | 统计日期 |
| `trigger_count` | `INT` | `DEFAULT 0` | 触发次数 |
| `success_count` | `INT` | `DEFAULT 0` | 成功次数 |
| `failed_count` | `INT` | `DEFAULT 0` | 失败次数 |
| `avg_process_time` | `FLOAT` | `DEFAULT 0` | 平均处理时间（毫秒） |
| `max_process_time` | `INT` | `DEFAULT 0` | 最大处理时间（毫秒） |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- `PRIMARY KEY`：`id`
- `UNIQUE INDEX`：`(event_type, date)`
- `INDEX`：`date`

## 4. 数据传输对象 (DTOs)

### 4.1 事件配置DTO
```go
type EventConfigDTO struct {
    ID           int64  `json:"id"`
    EventType    string `json:"event_type" binding:"required"`
    EventName    string `json:"event_name" binding:"required"`
    Description  string `json:"description"`
    Enabled      bool   `json:"enabled"`
    AsyncSupport bool   `json:"async_support"`
    Priority     int    `json:"priority"`
    CreatedAt    string `json:"created_at"`
    UpdatedAt    string `json:"updated_at"`
}
```

### 4.2 事件监听器DTO
```go
type EventListenerDTO struct {
    ID          int64    `json:"id"`
    ListenerName string   `json:"listener_name" binding:"required"`
    Description  string   `json:"description"`
    ClassPath    string   `json:"class_path" binding:"required"`
    Priority     int      `json:"priority"`
    Enabled      bool     `json:"enabled"`
    EventTypes   []string `json:"event_types"`
    CreatedAt    string   `json:"created_at"`
    UpdatedAt    string   `json:"updated_at"`
}
```

### 4.3 事件历史DTO
```go
type EventHistoryDTO struct {
    ID           int64          `json:"id"`
    EventType    string         `json:"event_type"`
    EventData    map[string]interface{} `json:"event_data"`
    TriggerTime  string         `json:"trigger_time"`
    ProcessTime  int            `json:"process_time"`
    Status       string         `json:"status"`
    ErrorMessage string         `json:"error_message"`
    PlayerID     int64          `json:"player_id"`
    ServerID     int            `json:"server_id"`
}
```

### 4.4 事件统计DTO
```go
type EventStatisticsDTO struct {
    ID             int64   `json:"id"`
    EventType      string  `json:"event_type"`
    Date           string  `json:"date"`
    TriggerCount   int     `json:"trigger_count"`
    SuccessCount   int     `json:"success_count"`
    FailedCount    int     `json:"failed_count"`
    AvgProcessTime float64 `json:"avg_process_time"`
    MaxProcessTime int     `json:"max_process_time"`
    UpdatedAt      string  `json:"updated_at"`
}
```

## 5. 数据库操作

### 5.1 事件配置操作
- **新增配置**：插入新的事件配置
- **更新配置**：修改现有事件配置
- **删除配置**：删除事件配置
- **查询配置**：根据条件查询事件配置
- **启用/禁用配置**：修改配置的启用状态

### 5.2 监听器操作
- **新增监听器**：插入新的监听器
- **更新监听器**：修改现有监听器
- **删除监听器**：删除监听器
- **查询监听器**：根据条件查询监听器
- **启用/禁用监听器**：修改监听器的启用状态

### 5.3 监听器事件关联操作
- **新增关联**：为监听器添加事件类型关联
- **删除关联**：移除监听器的事件类型关联
- **查询关联**：查询监听器关联的事件类型

### 5.4 事件历史操作
- **记录历史**：插入事件历史记录
- **查询历史**：根据条件查询事件历史
- **统计历史**：统计事件触发情况
- **清理历史**：清理过期的事件历史记录

### 5.5 事件统计操作
- **更新统计**：更新事件统计数据
- **查询统计**：查询事件统计信息
- **生成报表**：生成事件统计报表

## 6. 性能优化

### 6.1 索引优化
- **事件历史表**：针对高频查询场景添加合适的索引
- **监听器事件关联表**：添加复合索引提高关联查询性能
- **事件配置表**：为常用查询字段添加索引

### 6.2 存储优化
- **事件历史表**：考虑使用分区表按时间分区
- **事件数据**：使用JSON格式存储事件数据，减少表结构变更
- **定期清理**：定期清理过期的事件历史数据

### 6.3 查询优化
- **批量操作**：使用批量插入和更新减少数据库交互
- **分页查询**：对大量数据的查询使用分页
- **缓存机制**：缓存常用的事件配置和监听器信息

### 6.4 写入优化
- **异步写入**：事件历史记录可以异步写入，提高事件处理性能
- **批量写入**：将多个事件历史记录批量插入
- **延迟写入**：对非关键事件可以延迟写入，减少数据库压力

## 7. 数据一致性

### 7.1 事务管理
- **监听器注册**：监听器和事件类型关联的注册使用事务
- **配置更新**：事件配置的更新使用事务

### 7.2 数据同步
- **内存与数据库同步**：事件配置和监听器信息在内存和数据库之间保持同步
- **定期刷新**：定期从数据库刷新配置信息

### 7.3 错误处理
- **写入失败**：事件历史写入失败时的重试机制
- **数据恢复**：数据库故障后的恢复策略

## 8. 扩展性考虑

### 8.1 事件类型扩展
- **动态注册**：支持运行时动态注册新的事件类型
- **配置驱动**：通过配置文件或数据库配置管理事件类型

### 8.2 数据结构扩展
- **JSON字段**：使用JSON字段存储事件数据，支持灵活的数据结构
- **版本控制**：为事件数据添加版本控制，支持不同版本的数据结构

### 8.3 存储扩展
- **分库分表**：对于大型系统，考虑使用分库分表
- **读写分离**：使用读写分离提高系统性能

## 9. 监控与维护

### 9.1 监控指标
- **事件触发频率**：监控各类事件的触发频率
- **事件处理延迟**：监控事件处理的延迟时间
- **事件处理失败率**：监控事件处理的失败率
- **数据库操作性能**：监控数据库操作的性能

### 9.2 维护任务
- **定期备份**：定期备份事件配置和监听器信息
- **数据清理**：定期清理过期的事件历史数据
- **索引重建**：定期重建数据库索引

### 9.3 故障处理
- **数据库故障**：数据库故障时的降级策略
- **数据损坏**：数据损坏时的恢复策略

## 10. 迁移策略

### 10.1 表结构迁移
- **初始迁移**：创建初始表结构
- **结构变更**：表结构变更的迁移策略

### 10.2 数据迁移
- **历史数据迁移**：从旧系统迁移历史数据
- **配置数据迁移**：迁移事件配置和监听器配置

### 10.3 兼容性考虑
- **向前兼容**：确保新系统能够处理旧系统的事件数据
- **向后兼容**：确保旧系统能够处理新系统的事件数据