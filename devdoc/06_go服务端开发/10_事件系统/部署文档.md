# 事件系统 - 部署文档

## 1. 概述
本文档描述了事件系统的部署流程、配置选项和注意事项，确保事件系统能够正确部署和运行在生产环境中。

## 2. 部署环境准备

### 2.1 硬件环境
- **CPU**：至少4核
- **内存**：至少8GB
- **存储**：至少100GB可用空间
- **网络**：稳定的网络连接

### 2.2 软件环境
- **操作系统**：Linux/Unix (推荐Ubuntu 20.04+ 或 CentOS 7+)
- **Go版本**：1.20+
- **数据库**：MySQL 8.0+ (可选，用于存储事件配置和历史)
- **依赖管理**：Go Modules
- **监控工具**：Prometheus + Grafana (可选)

### 2.3 网络环境
- **端口**：事件系统本身不需要外部端口，但依赖的服务可能需要
- **防火墙**：确保必要的端口开放
- **网络延迟**：生产环境网络延迟应低于10ms

## 3. 部署前准备

### 3.1 代码准备
- **获取代码**：从版本控制系统获取最新代码
- **依赖安装**：执行`go mod tidy`安装依赖
- **代码编译**：执行`go build`编译代码

### 3.2 配置准备
- **配置文件**：准备事件系统的配置文件
- **环境变量**：设置必要的环境变量
- **数据库初始化**：如果使用数据库，初始化数据库结构和数据

### 3.3 资源准备
- **服务器资源**：确保服务器资源充足
- **存储资源**：确保存储资源充足
- **网络资源**：确保网络资源充足

## 4. 部署流程

### 4.1 编译构建

**步骤**：
1. **进入项目目录**：`cd /path/to/project`
2. **清理依赖**：`go mod tidy`
3. **编译代码**：`go build -o event-system ./cmd/event-system`
4. **验证构建**：`./event-system --version`

**输出示例**：
```
Event System v1.0.0
Build time: 2024-01-01 12:00:00
Go version: go1.20
```

### 4.2 配置部署

**步骤**：
1. **创建配置目录**：`mkdir -p /etc/event-system`
2. **复制配置文件**：`cp configs/config.yaml /etc/event-system/`
3. **编辑配置文件**：根据环境修改配置参数
4. **设置环境变量**：`export EVENT_SYSTEM_CONFIG=/etc/event-system/config.yaml`

**配置文件示例**：
```yaml
# 事件系统配置
server:
  host: 0.0.0.0
  port: 8080

event:
  async_workers: 4
  async_channel_size: 1000
  max_event_size: 1048576

database:
  enabled: true
  dsn: user:password@tcp(localhost:3306)/event_system?charset=utf8mb4&parseTime=True&loc=Local

logging:
  level: info
  format: json

metrics:
  enabled: true
  port: 9090
```

### 4.3 服务部署

**方式一：系统服务**

**步骤**：
1. **创建服务文件**：`/etc/systemd/system/event-system.service`
2. **编辑服务文件**：
   ```ini
   [Unit]
   Description=Event System
   After=network.target
   
   [Service]
   Type=simple
   User=event-system
   ExecStart=/usr/local/bin/event-system
   Restart=on-failure
   RestartSec=5s
   Environment=EVENT_SYSTEM_CONFIG=/etc/event-system/config.yaml
   
   [Install]
   WantedBy=multi-user.target
   ```
3. **启用服务**：`systemctl enable event-system`
4. **启动服务**：`systemctl start event-system`
5. **验证服务**：`systemctl status event-system`

**方式二：容器部署**

**步骤**：
1. **创建Dockerfile**：
   ```dockerfile
   FROM golang:1.20-alpine as builder
   WORKDIR /app
   COPY . .
   RUN go mod tidy && go build -o event-system ./cmd/event-system
   
   FROM alpine:latest
   WORKDIR /app
   COPY --from=builder /app/event-system .
   COPY configs/config.yaml .
   EXPOSE 8080 9090
   CMD ["./event-system"]
   ```
2. **构建镜像**：`docker build -t event-system:latest .`
3. **运行容器**：
   ```bash
   docker run -d \
     --name event-system \
     -p 8080:8080 \
     -p 9090:9090 \
     -v /path/to/config.yaml:/app/config.yaml \
     event-system:latest
   ```
4. **验证容器**：`docker ps -a | grep event-system`

### 4.4 数据库初始化

**步骤**：
1. **连接数据库**：`mysql -u root -p`
2. **创建数据库**：`CREATE DATABASE event_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
`
3. **创建用户**：`CREATE USER 'event_system'@'localhost' IDENTIFIED BY 'password';
`
4. **授权**：`GRANT ALL PRIVILEGES ON event_system.* TO 'event_system'@'localhost';
`
5. **刷新权限**：`FLUSH PRIVILEGES;
`
6. **导入 schema**：`mysql -u event_system -p event_system < sql/schema.sql`
7. **导入初始数据**：`mysql -u event_system -p event_system < sql/init_data.sql`

## 5. 配置管理

### 5.1 配置文件

**主要配置项**：
- **server.host**：服务器主机
- **server.port**：服务器端口
- **event.async_workers**：异步工作协程数量
- **event.async_channel_size**：异步事件通道大小
- **event.max_event_size**：最大事件大小
- **database.enabled**：是否启用数据库
- **database.dsn**：数据库连接字符串
- **logging.level**：日志级别
- **logging.format**：日志格式
- **metrics.enabled**：是否启用指标监控
- **metrics.port**：指标监控端口

### 5.2 环境变量

**主要环境变量**：
- **EVENT_SYSTEM_CONFIG**：配置文件路径
- **EVENT_SYSTEM_ENV**：运行环境（dev/test/prod）
- **EVENT_SYSTEM_LOG_LEVEL**：日志级别
- **EVENT_SYSTEM_DATABASE_DSN**：数据库连接字符串

### 5.3 配置热更新

**步骤**：
1. **修改配置文件**：编辑配置文件
2. **发送信号**：`kill -HUP <pid>` 或 `systemctl reload event-system`
3. **验证更新**：查看日志确认配置已更新

## 6. 服务管理

### 6.1 启动服务

**系统服务**：`systemctl start event-system`
**容器**：`docker start event-system`
**直接运行**：`./event-system`

### 6.2 停止服务

**系统服务**：`systemctl stop event-system`
**容器**：`docker stop event-system`
**直接运行**：`Ctrl+C` 或 `kill <pid>`

### 6.3 重启服务

**系统服务**：`systemctl restart event-system`
**容器**：`docker restart event-system`
**直接运行**：停止后重新启动

### 6.4 查看状态

**系统服务**：`systemctl status event-system`
**容器**：`docker ps -a | grep event-system`
**直接运行**：查看进程状态

### 6.5 查看日志

**系统服务**：`journalctl -u event-system`
**容器**：`docker logs event-system`
**直接运行**：查看控制台输出或日志文件

## 7. 健康检查

### 7.1 服务健康检查

**步骤**：
1. **检查服务状态**：`systemctl status event-system`
2. **检查进程**：`ps aux | grep event-system`
3. **检查端口**：`netstat -tulpn | grep event-system`
4. **检查API**：`curl http://localhost:8080/health`

**预期结果**：
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00Z",
  "components": {
    "event_manager": "ok",
    "database": "ok",
    "metrics": "ok"
  }
}
```

### 7.2 功能健康检查

**步骤**：
1. **触发测试事件**：`curl -X POST http://localhost:8080/api/events/test`
2. **查看事件处理**：查看日志确认事件处理
3. **检查数据库**：检查数据库中的事件记录
4. **检查指标**：检查监控指标

**预期结果**：
- 测试事件成功触发和处理
- 日志中无错误信息
- 数据库中存在事件记录
- 监控指标正常

### 7.3 性能健康检查

**步骤**：
1. **运行性能测试**：`wrk -t12 -c400 -d30s http://localhost:8080/api/events/trigger`
2. **查看性能指标**：查看监控指标中的性能数据
3. **检查系统资源**：查看CPU、内存、网络使用情况

**预期结果**：
- 请求成功率 > 99.9%
- 平均响应时间 < 100ms
- 系统资源使用正常

## 8. 故障处理

### 8.1 常见故障

**故障一：服务无法启动**

**症状**：服务启动失败，日志中报错
**可能原因**：
- 配置文件错误
- 端口被占用
- 数据库连接失败
- 权限不足

**解决方案**：
- 检查配置文件
- 检查端口占用情况
- 检查数据库连接
- 检查权限设置

**故障二：事件处理失败**

**症状**：事件触发后处理失败，日志中报错
**可能原因**：
- 监听器实现错误
- 事件数据格式错误
- 依赖服务失败
- 系统资源不足

**解决方案**：
- 检查监听器实现
- 检查事件数据格式
- 检查依赖服务状态
- 检查系统资源使用情况

**故障三：性能下降**

**症状**：事件处理延迟增加，系统响应变慢
**可能原因**：
- 系统负载过高
- 数据库性能下降
- 网络延迟增加
- 内存泄漏

**解决方案**：
- 检查系统负载
- 优化数据库性能
- 检查网络状态
- 检查内存使用情况

### 8.2 故障排查流程

**步骤**：
1. **收集信息**：查看日志、监控指标、系统状态
2. **分析问题**：根据收集的信息分析问题原因
3. **制定方案**：根据问题原因制定解决方案
4. **实施方案**：执行解决方案
5. **验证结果**：验证问题是否解决
6. **记录总结**：记录问题和解决方案

**工具**：
- **日志分析**：ELK Stack、Graylog
- **监控工具**：Prometheus、Grafana
- **系统工具**：top、vmstat、netstat
- **网络工具**：ping、traceroute、netstat

### 8.3 应急响应

**应急响应团队**：
- **负责人**：事件系统负责人
- **成员**：开发工程师、运维工程师、DBA

**应急响应流程**：
1. **发现问题**：监控系统报警或用户反馈
2. **确认问题**：验证问题是否真实存在
3. **分级处理**：根据问题严重程度分级处理
4. **实施解决方案**：执行应急解决方案
5. **验证恢复**：验证系统是否恢复正常
6. **后续处理**：分析问题原因，制定预防措施

**应急联系**：
- **电话**：XXXX-XXXXXXX
- **邮件**：XXXX@example.com
- **即时通讯**：企业微信/钉钉群组

## 9. 升级与回滚

### 9.1 升级流程

**步骤**：
1. **准备升级包**：获取最新代码，编译构建
2. **备份数据**：备份配置文件、数据库数据
3. **停止服务**：停止当前运行的服务
4. **部署新版本**：替换可执行文件和配置文件
5. **启动服务**：启动新版本服务
6. **验证服务**：验证服务是否正常运行
7. **监控运行**：监控服务运行状态

**注意事项**：
- 升级前必须备份数据
- 升级过程中可能会有服务中断
- 升级后需要验证所有功能

### 9.2 回滚流程

**步骤**：
1. **发现问题**：升级后发现问题
2. **停止服务**：停止当前运行的服务
3. **恢复备份**：恢复之前的备份数据
4. **启动旧版本**：启动旧版本服务
5. **验证服务**：验证服务是否正常运行
6. **分析问题**：分析升级失败的原因

**注意事项**：
- 回滚前必须停止服务
- 回滚后需要验证所有功能
- 分析升级失败原因，避免再次出现

### 9.3 版本管理

**版本号格式**：`major.minor.patch`
- **major**：重大变更，不兼容旧版本
- **minor**：新增功能，兼容旧版本
- **patch**： bug 修复，兼容旧版本

**版本发布流程**：
1. **代码冻结**：发布前冻结代码
2. **测试验证**：进行全面测试
3. **版本标记**：在版本控制系统中标记版本
4. **构建发布**：构建发布包
5. **部署发布**：部署到生产环境
6. **发布通知**：通知相关人员

## 10. 监控与维护

### 10.1 监控指标

**核心指标**：
- **事件触发率**：单位时间内事件的触发次数
- **事件处理延迟**：事件从触发到处理完成的时间
- **事件处理成功率**：事件处理成功的比例
- **异步队列长度**：异步事件队列的长度
- **系统资源使用**：CPU、内存、网络、磁盘使用情况

**监控工具**：
- **Prometheus**：收集和存储监控指标
- **Grafana**：可视化监控指标
- **Alertmanager**：处理告警

### 10.2 维护任务

**日常维护**：
- **日志检查**：定期检查日志，发现和解决问题
- **监控检查**：定期检查监控指标，发现异常
- **系统检查**：定期检查系统状态，确保系统正常运行

**定期维护**：
- **数据清理**：定期清理过期的事件数据
- **备份**：定期备份配置文件和数据库数据
- **优化**：根据监控指标优化系统配置
- **安全检查**：定期进行安全检查，发现和修复安全问题

**维护计划**：
| 维护任务 | 频率 | 负责人 |
|---------|------|--------|
| 日志检查 | 每日 | 运维工程师 |
| 监控检查 | 每小时 | 监控系统 |
| 系统检查 | 每周 | 运维工程师 |
| 数据清理 | 每月 | 运维工程师 |
| 备份 | 每日 | 备份系统 |
| 优化 | 季度 | 开发工程师 |
| 安全检查 | 季度 | 安全工程师 |

### 10.3 自动化运维

**自动化工具**：
- **Ansible**：自动化部署和配置管理
- **Jenkins**：自动化构建和部署
- **Prometheus + Grafana**：自动化监控和告警
- **ELK Stack**：自动化日志收集和分析

**自动化流程**：
1. **代码提交**：开发者提交代码
2. **自动构建**：Jenkins自动构建
3. **自动测试**：Jenkins自动运行测试
4. **自动部署**：Ansible自动部署到测试环境
5. **自动验证**：自动验证测试环境
6. **手动部署**：人工确认后部署到生产环境
7. **自动监控**：Prometheus自动监控
8. **自动告警**：Alertmanager自动告警

## 11. 安全管理

### 11.1 安全配置

**配置项**：
- **最小权限**：使用最小权限原则配置服务
- **密码管理**：使用安全的密码管理方式
- **网络安全**：配置网络安全策略
- **数据安全**：配置数据安全策略

**最佳实践**：
- 使用非root用户运行服务
- 使用环境变量或密钥管理系统存储敏感信息
- 配置防火墙，只开放必要的端口
- 加密传输和存储敏感数据

### 11.2 安全审计

**审计内容**：
- **访问审计**：记录所有访问事件
- **操作审计**：记录所有操作事件
- **配置审计**：记录所有配置变更
- **安全事件**：记录所有安全事件

**审计工具**：
- **系统审计**：auditd
- **应用审计**：应用内置审计功能
- **日志审计**：ELK Stack

### 11.3 安全漏洞管理

**漏洞管理流程**：
1. **漏洞扫描**：定期进行漏洞扫描
2. **漏洞评估**：评估漏洞的严重程度
3. **漏洞修复**：修复发现的漏洞
4. **验证修复**：验证漏洞是否修复
5. **记录跟踪**：记录漏洞的发现和修复过程

**扫描工具**：
- **静态扫描**：SonarQube、GoSec
- **动态扫描**：OWASP ZAP、Burp Suite
- **依赖扫描**：Dependency-Check、Snyk

## 12. 总结

通过本部署文档，您可以了解事件系统的部署流程、配置选项和维护方法。在部署过程中，请注意以下几点：

1. **准备充分**：在部署前确保环境准备充分，包括硬件、软件和网络环境。
2. **配置正确**：确保配置文件正确，特别是数据库连接、端口设置等关键配置。
3. **监控到位**：部署后确保监控系统正常运行，及时发现和解决问题。
4. **安全第一**：始终将安全放在首位，采取必要的安全措施。
5. **定期维护**：定期进行系统维护，确保系统的稳定性和性能。

如果在部署过程中遇到问题，请参考故障处理部分的内容，或联系技术支持团队。