# 日志系统设计文档

## 文档导航

- [系统概述](./11_日志系统/系统概述.md)
- [Java代码分析](./11_日志系统/Java代码分析.md)
- [Go实现方案](./11_日志系统/Go实现方案.md)
- [API文档](./11_日志系统/API文档.md)
- [数据库设计文档](./11_日志系统/数据库设计文档.md)
- [业务流程文档](./11_日志系统/业务流程文档.md)
- [测试用例文档](./11_日志系统/测试用例文档.md)
- [部署文档](./11_日志系统/部署文档.md)
- [监控与维护](./11_日志系统/监控与维护.md)
- [变更记录](./11_日志系统/变更记录.md)

## 概述

日志系统是游戏中的重要辅助功能，用于记录游戏内各种操作日志，包括玩家行为日志、系统日志、交易日志等。

## Java 代码分析

### 核心控制器
- **文件位置**: `src/main/java/com/dnfm/game/tlog/TlogController.java`
- **处理器数量**: 1 个 @RequestMapping 方法

### 核心功能

#### 1. 日志控制器数据 (REQ_TLOG_CONTROLLER_DATA)
- **方法**: `reqTlogControllerData(IoSession session, REQ_TLOG_CONTROLLER_DATA req_tlog_controller_data)`
- **功能**:
  - 处理日志控制器数据
  - 返回确认响应
  - 当前实现为空响应

## Go 实现方案

### 1. ProtoBuf 消息定义

#### tlog.proto
```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "gen/dnf/v1";

import "dnf/v1/common.proto";

// 日志类型
enum LogType {
    LOG_TYPE_UNKNOWN = 0;
    LOG_TYPE_LOGIN = 1;
    LOG_TYPE_LOGOUT = 2;
    LOG_TYPE_CHAT = 3;
    LOG_TYPE_TRADE = 4;
    LOG_TYPE_MAIL = 5;
    LOG_TYPE_SHOP = 6;
    LOG_TYPE_DUNGEON = 7;
    LOG_TYPE_PK = 8;
    LOG_TYPE_GUILD = 9;
    LOG_TYPE_PARTY = 10;
    LOG_TYPE_QUEST = 11;
    LOG_TYPE_ACHIEVEMENT = 12;
    LOG_TYPE_ITEM = 13;
    LOG_TYPE_MONEY = 14;
    LOG_TYPE_SYSTEM = 15;
}

// 日志数据
message TlogData {
    uint64 id = 1;
    uint64 role_id = 2;
    string role_name = 3;
    uint32 log_type = 4;
    string action = 5;
    string detail = 6;
    map<string, string> params = 7;
    uint64 timestamp = 8;
    string ip = 9;
    string device = 10;
}

// 日志控制器数据请求
message TlogControllerDataRequest {
    uint32 transid = 1;
    repeated TlogData logs = 2;
}

// 日志控制器数据响应
message TlogControllerDataResponse {
    uint32 transid = 1;
    uint32 error = 2;
    string message = 3;
}

// 日志查询请求
message TlogQueryRequest {
    uint64 role_id = 1;
    uint32 log_type = 2;
    uint64 start_time = 3;
    uint64 end_time = 4;
    uint32 page = 5;
    uint32 page_size = 6;
}

// 日志查询响应
message TlogQueryResponse {
    repeated TlogData logs = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 日志统计请求
message TlogStatisticsRequest {
    uint64 role_id = 1;
    uint32 log_type = 2;
    uint64 start_time = 3;
    uint64 end_time = 4;
}

// 日志统计响应
message TlogStatisticsResponse {
    map<uint32, uint64> count_by_type = 1;
    map<string, uint64> count_by_action = 2;
    uint32 error = 3;
    string message = 4;
}
```

### 2. 数据模型设计

#### models/tlog.go
```go
package models

import (
    "encoding/json"
    "time"
    "gorm.io/gorm"
)

// Tlog 日志
type Tlog struct {
    ID        uint64         `gorm:"primaryKey;column:id" json:"id"`
    RoleID    uint64         `gorm:"column:roleId;index:idx_role_time" json:"role_id"`
    RoleName  string         `gorm:"column:roleName;size:50" json:"role_name"`
    LogType   uint32         `gorm:"column:logType;index:idx_type_time" json:"log_type"`
    Action    string         `gorm:"column:action;size:100;index" json:"action"`
    Detail    string         `gorm:"column:detail;size:1000" json:"detail"`
    Params    string         `gorm:"column:params;type:text" json:"params"`
    Timestamp time.Time      `gorm:"column:timestamp;index:idx_role_time,idx_type_time" json:"timestamp"`
    IP        string         `gorm:"column:ip;size:50" json:"ip"`
    Device    string         `gorm:"column:device;size:100" json:"device"`
    CreateTime time.Time      `gorm:"column:createTime" json:"create_time"`
}

func (Tlog) TableName() string {
    return "t_tlog"
}

// GetParams 获取参数
func (t *Tlog) GetParams() map[string]string {
    if t.Params == "" {
        return make(map[string]string)
    }
    var params map[string]string
    json.Unmarshal([]byte(t.Params), &params)
    return params
}

// SetParams 设置参数
func (t *Tlog) SetParams(params map[string]string) {
    if params == nil {
        t.Params = ""
        return
    }
    data, _ := json.Marshal(params)
    t.Params = string(data)
}

// TlogSummary 日志汇总
type TlogSummary struct {
    ID        uint64    `gorm:"primaryKey;column:id" json:"id"`
    RoleID    uint64    `gorm:"column:roleId;index" json:"role_id"`
    LogType   uint32    `gorm:"column:logType;index" json:"log_type"`
    Action    string    `gorm:"column:action;size:100" json:"action"`
    Count     uint64    `gorm:"column:count" json:"count"`
    Date      time.Time `gorm:"column:date;index" json:"date"`
    CreateTime time.Time `gorm:"column:createTime" json:"create_time"`
}

func (TlogSummary) TableName() string {
    return "t_tlog_summary"
}
```

### 3. Handler 实现

#### handlers/tlog.go
```go
package handlers

import (
    "context"

    "github.com/pixb/DnfGameServer/dnf-go-server/internal/game/tlog_service"
    "github.com/pixb/DnfGameServer/dnf-go-server/internal/network"
    dnfv1 "github.com/pixb/DnfGameServer/dnf-go-server/proto/gen/dnf/v1"
    "google.golang.org/protobuf/proto"
)

type TlogHandler struct {
    tlogService *tlog_service.TlogService
}

func NewTlogHandler(tlogService *tlog_service.TlogService) *TlogHandler {
    return &TlogHandler{
        tlogService: tlogService,
    }
}

// TlogControllerDataHandler 日志控制器数据处理器
func (h *TlogHandler) TlogControllerDataHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.TlogControllerDataRequest)
    if !ok {
        return
    }

    // 记录日志
    for _, log := range req.Logs {
        err := h.tlogService.RecordLog(context.Background(), log)
        if err != nil {
            continue
        }
    }

    resp := &dnfv1.TlogControllerDataResponse{
        Transid: req.Transid,
        Error:   0,
    }
    sess.Send(resp)
}

// TlogQueryHandler 日志查询处理器
func (h *TlogHandler) TlogQueryHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.TlogQueryRequest)
    if !ok {
        return
    }

    logs, total, err := h.tlogService.QueryLogs(context.Background(), req.RoleId, req.LogType, req.StartTime, req.EndTime, req.Page, req.PageSize)
    if err != nil {
        h.sendError(sess, req, 1, "failed to query logs")
        return
    }

    resp := &dnfv1.TlogQueryResponse{
        Logs:  logs,
        Total: total,
        Error: 0,
    }
    sess.Send(resp)
}

// TlogStatisticsHandler 日志统计处理器
func (h *TlogHandler) TlogStatisticsHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.TlogStatisticsRequest)
    if !ok {
        return
    }

    countByType, countByAction, err := h.tlogService.GetStatistics(context.Background(), req.RoleId, req.LogType, req.StartTime, req.EndTime)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get statistics")
        return
    }

    resp := &dnfv1.TlogStatisticsResponse{
        CountByType:   countByType,
        CountByAction: countByAction,
        Error:         0,
    }
    sess.Send(resp)
}

func (h *TlogHandler) sendError(sess *network.Session, req proto.Message, code uint32, message string) {
    switch req.(type) {
    case *dnfv1.TlogControllerDataRequest:
        resp := &dnfv1.TlogControllerDataResponse{
            Transid: req.(*dnfv1.TlogControllerDataRequest).Transid,
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.TlogQueryRequest:
        resp := &dnfv1.TlogQueryResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.TlogStatisticsRequest:
        resp := &dnfv1.TlogStatisticsResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    }
}
```

### 4. Service 实现

#### tlog_service/tlog.go
```go
package tlog_service

import (
    "context"
    "time"

    "github.com/pixb/DnfGameServer/dnf-go-server/store"
    "github.com/pixb/DnfGameServer/dnf-go-server/internal/db/models"
    dnfv1 "github.com/pixb/DnfGameServer/dnf-go-server/proto/gen/dnf/v1"
)

type TlogService struct {
    store *store.Store
}

func NewTlogService(store *store.Store) *TlogService {
    return &TlogService{
        store: store,
    }
}

// RecordLog 记录日志
func (s *TlogService) RecordLog(ctx context.Context, log *dnfv1.TlogData) error {
    tlog := &models.Tlog{
        RoleID:    log.RoleId,
        RoleName:  log.RoleName,
        LogType:   log.LogType,
        Action:    log.Action,
        Detail:    log.Detail,
        Timestamp: time.Unix(int64(log.Timestamp), 0),
        IP:        log.Ip,
        Device:    log.Device,
        CreateTime: time.Now(),
    }

    tlog.SetParams(log.Params)

    return s.store.CreateTlog(ctx, tlog)
}

// QueryLogs 查询日志
func (s *TlogService) QueryLogs(ctx context.Context, roleID uint64, logType uint32, startTime, endTime uint64, page, pageSize uint32) ([]*dnfv1.TlogData, uint32, error) {
    offset := (page - 1) * pageSize

    var start, end time.Time
    if startTime > 0 {
        start = time.Unix(int64(startTime), 0)
    }
    if endTime > 0 {
        end = time.Unix(int64(endTime), 0)
    }

    logs, total, err := s.store.QueryTlogs(ctx, &store.FindTlog{
        RoleID:    &roleID,
        LogType:   &logType,
        StartTime: &start,
        EndTime:   &end,
    }, offset, pageSize)
    if err != nil {
        return nil, 0, err
    }

    result := make([]*dnfv1.TlogData, len(logs))
    for i, log := range logs {
        result[i] = &dnfv1.TlogData{
            Id:        log.ID,
            RoleId:    log.RoleID,
            RoleName:  log.RoleName,
            LogType:   log.LogType,
            Action:    log.Action,
            Detail:    log.Detail,
            Params:    log.GetParams(),
            Timestamp: uint64(log.Timestamp.Unix()),
            Ip:        log.IP,
            Device:    log.Device,
        }
    }

    return result, uint32(total), nil
}

// GetStatistics 获取统计数据
func (s *TlogService) GetStatistics(ctx context.Context, roleID uint64, logType uint32, startTime, endTime uint64) (map[uint32]uint64, map[string]uint64, error) {
    var start, end time.Time
    if startTime > 0 {
        start = time.Unix(int64(startTime), 0)
    }
    if endTime > 0 {
        end = time.Unix(int64(endTime), 0)
    }

    countByType, countByAction, err := s.store.GetTlogStatistics(ctx, &store.FindTlog{
        RoleID:    &roleID,
        LogType:   &logType,
        StartTime: &start,
        EndTime:   &end,
    })
    if err != nil {
        return nil, nil, err
    }

    return countByType, countByAction, nil
}

// RecordLoginLog 记录登录日志
func (s *TlogService) RecordLoginLog(ctx context.Context, roleID uint64, roleName string, ip, device string) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_LOGIN),
        Action:    "login",
        Detail:    "user login",
        Params:    map[string]string{},
        Timestamp: uint64(time.Now().Unix()),
        Ip:        ip,
        Device:    device,
    }

    return s.RecordLog(ctx, log)
}

// RecordLogoutLog 记录登出日志
func (s *TlogService) RecordLogoutLog(ctx context.Context, roleID uint64, roleName string, ip, device string) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_LOGOUT),
        Action:    "logout",
        Detail:    "user logout",
        Params:    map[string]string{},
        Timestamp: uint64(time.Now().Unix()),
        Ip:        ip,
        Device:    device,
    }

    return s.RecordLog(ctx, log)
}

// RecordTradeLog 记录交易日志
func (s *TlogService) RecordTradeLog(ctx context.Context, roleID uint64, roleName string, tradeType string, detail string, params map[string]string) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_TRADE),
        Action:    tradeType,
        Detail:    detail,
        Params:    params,
        Timestamp: uint64(time.Now().Unix()),
    }

    return s.RecordLog(ctx, log)
}

// RecordChatLog 记录聊天日志
func (s *TlogService) RecordChatLog(ctx context.Context, roleID uint64, roleName string, chatType string, content string, targetRoleID uint64) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_CHAT),
        Action:    chatType,
        Detail:    content,
        Params: map[string]string{
            "target_role_id": string(rune(targetRoleID)),
        },
        Timestamp: uint64(time.Now().Unix()),
    }

    return s.RecordLog(ctx, log)
}

// RecordShopLog 记录商店日志
func (s *TlogService) RecordShopLog(ctx context.Context, roleID uint64, roleName string, shopType string, itemIndex uint32, itemCount uint32, price uint64, currencyType uint32) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_SHOP),
        Action:    shopType,
        Detail:    "shop transaction",
        Params: map[string]string{
            "item_index":     string(rune(itemIndex)),
            "item_count":     string(rune(itemCount)),
            "price":          string(rune(price)),
            "currency_type":  string(rune(currencyType)),
        },
        Timestamp: uint64(time.Now().Unix()),
    }

    return s.RecordLog(ctx, log)
}

// RecordDungeonLog 记录副本日志
func (s *TlogService) RecordDungeonLog(ctx context.Context, roleID uint64, roleName string, dungeonIndex uint32, result string, score uint32) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_DUNGEON),
        Action:    "dungeon",
        Detail:    result,
        Params: map[string]string{
            "dungeon_index": string(rune(dungeonIndex)),
            "score":         string(rune(score)),
        },
        Timestamp: uint64(time.Now().Unix()),
    }

    return s.RecordLog(ctx, log)
}

// RecordItemLog 记录物品日志
func (s *TlogService) RecordItemLog(ctx context.Context, roleID uint64, roleName string, action string, itemIndex uint32, itemCount uint32, reason string) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_ITEM),
        Action:    action,
        Detail:    reason,
        Params: map[string]string{
            "item_index": string(rune(itemIndex)),
            "item_count": string(rune(itemCount)),
        },
        Timestamp: uint64(time.Now().Unix()),
    }

    return s.RecordLog(ctx, log)
}

// RecordMoneyLog 记录货币日志
func (s *TlogService) RecordMoneyLog(ctx context.Context, roleID uint64, roleName string, action string, moneyType uint32, amount uint64, reason string) error {
    log := &dnfv1.TlogData{
        RoleId:    roleID,
        RoleName:  roleName,
        LogType:   uint32(dnfv1.LogType_LOG_TYPE_MONEY),
        Action:    action,
        Detail:    reason,
        Params: map[string]string{
            "money_type": string(rune(moneyType)),
            "amount":     string(rune(amount)),
        },
        Timestamp: uint64(time.Now().Unix()),
    }

    return s.RecordLog(ctx, log)
}

// CleanOldLogs 清理旧日志
func (s *TlogService) CleanOldLogs(ctx context.Context, days int) error {
    cutoff := time.Now().AddDate(0, 0, -days)
    return s.store.DeleteOldTlogs(ctx, cutoff)
}
```

## 实现步骤

### 步骤 1: 创建 ProtoBuf 定义
1. 创建 `proto/dnf/v1/tlog.proto`
2. 定义所有日志相关的消息
3. 运行 `buf generate` 生成 Go 代码

### 步骤 2: 创建数据模型
1. 创建 `internal/db/models/tlog.go`
2. 定义 Tlog 和 TlogSummary 模型
3. 运行数据库迁移

### 步骤 3: 实现 Handler
1. 创建 `internal/game/handlers/tlog.go`
2. 实现所有日志相关的处理器
3. 注册消息路由

### 步骤 4: 实现 Service
1. 创建 `internal/game/tlog_service/tlog.go`
2. 实现业务逻辑
3. 集成数据库操作

### 步骤 5: 编写测试用例
1. 创建 `tests/tlog_test.go`
2. 编写所有功能的测试用例
3. 运行测试验证

### 步骤 6: 集成到主服务器
1. 在 `cmd/server/main.go` 中注册 Handler
2. 更新消息注册表
3. 测试完整流程

## 注意事项

1. **日志完整性**: 确保所有重要操作都有日志记录
2. **性能优化**: 日志写入需要考虑性能影响
3. **异步处理**: 考虑使用异步方式处理日志
4. **数据清理**: 定期清理过期日志数据
5. **敏感信息**: 避免记录敏感信息
6. **日志格式**: 保持日志格式的一致性
7. **错误处理**: 完善的错误处理和日志记录
8. **统计分析**: 支持日志数据的统计分析
9. **索引优化**: 合理设计数据库索引
10. **存储优化**: 考虑日志数据的存储优化
