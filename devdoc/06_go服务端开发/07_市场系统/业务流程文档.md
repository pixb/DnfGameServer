# 市场系统 - 业务流程文档

## 1. 物品上架流程

### 1.1 流程步骤

1. **验证请求**
   - 检查角色是否登录
   - 验证物品是否存在
   - 验证物品是否属于玩家
   - 验证物品数量是否足够

2. **执行上架**
   - 从背包移除物品
   - 创建市场物品记录
   - 设置过期时间（默认7天）

3. **更新状态**
   - 记录上架操作

4. **返回响应**
   - 返回市场物品ID
   - 返回上架结果

## 2. 物品购买流程

### 2.1 流程步骤

1. **验证请求**
   - 检查角色是否登录
   - 验证市场物品是否存在
   - 验证市场物品是否可购买
   - 验证购买数量是否足够
   - 验证买家货币是否足够

2. **执行购买**
   - 扣除买家货币
   - 添加物品到买家背包
   - 计算交易税收
   - 添加货币到卖家
   - 更新市场物品状态

3. **更新状态**
   - 记录交易记录
   - 处理物品数量为0的情况

4. **返回响应**
   - 返回购买结果
   - 返回物品信息

## 3. 物品下架流程

### 3.1 流程步骤

1. **验证请求**
   - 检查角色是否登录
   - 验证市场物品是否存在
   - 验证市场物品是否属于玩家

2. **执行下架**
   - 将物品返回到背包
   - 删除市场物品记录

3. **更新状态**
   - 记录下架操作

4. **返回响应**
   - 返回下架结果

## 4. 状态转换

| 状态 | 触发条件 | 转换动作 | 目标状态 |
| :--- | :--- | :--- | :--- |
| 初始状态 | 物品上架请求 | 执行上架 | 上架中 |
| 上架中 | 物品购买请求 | 执行购买 | 已卖出 |
| 上架中 | 物品下架请求 | 执行下架 | 已下架 |
| 上架中 | 物品过期 | 系统自动处理 | 已下架 |