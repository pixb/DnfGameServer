# 数据库迁移文档

## 概述

本文档描述如何将Java服务器的MySQL数据库迁移到Go服务端的SQLite数据库。

## 数据库架构对比

### Java服务器 (MySQL)

Java服务器使用MySQL数据库，包含3个数据库：

| 数据库名 | 用途 | 说明 |
|---------|------|------|
| game | 主游戏数据库 | 存储游戏核心数据 |
| login | 登录数据库 | 存储账户登录信息 |
| game_kuafu | 跨服数据库 | 存储跨服相关数据 |

**连接配置** (application.properties):
```properties
# 主数据库
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/game?characterEncoding=utf8&autoReconnect=true&failOverReadOnly=false&maxReconnects=10&useSSL=false
spring.datasource.username=root
spring.datasource.password=123456

# 登录数据库
custom.datasource.adb.url=jdbc:mysql://127.0.0.1:3306/login?characterEncoding=utf8&autoReconnect=true&failOverReadOnly=false&maxReconnects=10&useSSL=false
custom.datasource.adb.username=root
custom.datasource.adb.password=123456

# 跨服数据库
custom.datasource.kuafu.url=jdbc:mysql://127.0.0.1:3306/game_kuafu?characterEncoding=utf8&autoReconnect=true&failOverReadOnly=false&maxReconnects=10&useSSL=false
custom.datasource.kuafu.username=root
custom.datasource.kuafu.password=123456
```

### Go服务器 (SQLite)

Go服务器使用SQLite数据库，所有数据存储在单个SQLite文件中。

**连接配置**:
```bash
# 启动服务器时指定数据库文件
go run cmd/server/main.go serve --driver sqlite --dsn ./game.db
```

## 表结构映射

### 核心业务表

#### 1. 账户表

**MySQL (t_account)**:
```sql
CREATE TABLE `t_account` (
  `id` VARCHAR(255) NOT NULL COMMENT 'openid',
  `accountkey` VARCHAR(255) DEFAULT NULL COMMENT 'accountkey',
  `accumulatecera` BIGINT DEFAULT 0 COMMENT '累计充值',
  `userID` VARCHAR(255) DEFAULT NULL COMMENT '用户ID',
  `passwd` VARCHAR(255) DEFAULT NULL COMMENT '密码',
  `roleMaxCount` INT DEFAULT 3 COMMENT '最大角色数量',
  `isStop` TINYINT(1) DEFAULT 0 COMMENT '是否停用',
  `privilege` SMALLINT DEFAULT 0 COMMENT '权限等级',
  `score` INT DEFAULT 0 COMMENT '积分',
  `channelNo` VARCHAR(255) DEFAULT NULL COMMENT '渠道号',
  `createTime` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `zhanlingexp` INT DEFAULT 0 COMMENT '战令经验',
  `moneyBox` JSON DEFAULT NULL COMMENT '账户名下的各种货币',
  `epicPieceBox` JSON DEFAULT NULL COMMENT '装备碎片',
  `mailBox` JSON DEFAULT NULL COMMENT '账户邮箱',
  `storageline` INT DEFAULT 1 COMMENT '仓库行数',
  `accShopInfoBox` JSON DEFAULT NULL COMMENT '角色购买记录',
  `adventureReapInfo` JSON DEFAULT NULL COMMENT '冒险收获信息',
  `adventureUnionInfo` JSON DEFAULT NULL COMMENT '冒险联盟信息',
  `adStorageBox` JSON DEFAULT NULL COMMENT '账号金库',
  `advBookBox` JSON DEFAULT NULL COMMENT '冒险图鉴',
  `advUnionSubInfoBox` JSON DEFAULT NULL COMMENT '冒险联盟子信息',
  `activityBox` JSON DEFAULT NULL COMMENT '账号活动',
  `lastLoginTime` BIGINT DEFAULT 0 COMMENT '最后登录时间',
  PRIMARY KEY (`id`),
  KEY `idx_userID` (`userID`),
  KEY `idx_id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='账户表';
```

**SQLite (account)**:
```sql
CREATE TABLE IF NOT EXISTS account (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    row_status TEXT NOT NULL DEFAULT 'NORMAL',
    openid TEXT NOT NULL UNIQUE,
    account_key TEXT NOT NULL,
    auth_key TEXT NOT NULL,
    last_login_at INTEGER DEFAULT 0,
    last_login_ip TEXT DEFAULT '',
    authority INTEGER DEFAULT 0,
    status INTEGER DEFAULT 0
);
```

**字段映射**:

| MySQL字段 | SQLite字段 | 类型转换 | 说明 |
|----------|-----------|---------|------|
| id | id | VARCHAR → INTEGER | 主键，使用自增ID |
| openid | openid | VARCHAR → TEXT | 保持不变 |
| accountkey | account_key | VARCHAR → TEXT | 命名转换 |
| passwd | auth_key | VARCHAR → TEXT | 密码字段 |
| createTime | created_at | DATETIME → INTEGER | 时间戳转换 |
| lastLoginTime | last_login_at | BIGINT → INTEGER | 时间戳 |
| privilege | authority | SMALLINT → INTEGER | 权限等级 |
| isStop | status | TINYINT → INTEGER | 状态 |
| userID | - | VARCHAR → - | 通过openid关联 |
| JSON字段 | - | JSON → - | 需要拆分到独立表 |

#### 2. 角色表

**MySQL (t_role)**:
```sql
CREATE TABLE `t_role` (
  `roleId` INT NOT NULL COMMENT '角色ID',
  `uid` BIGINT NOT NULL COMMENT '角色唯一ID',
  `lastlogout` BIGINT DEFAULT 0 COMMENT '最后登出时间',
  `growtype` INT DEFAULT 0 COMMENT '成长类型',
  `secgrowtype` INT DEFAULT 0 COMMENT '第二成长类型',
  `job` INT DEFAULT 0 COMMENT '职业',
  `level` INT DEFAULT 1 COMMENT '等级',
  `name` VARCHAR(255) DEFAULT NULL COMMENT '角色名',
  `fatigue` INT DEFAULT 0 COMMENT '疲劳值',
  `equipscore` INT DEFAULT 229 COMMENT '装备评分',
  `characterframe` INT DEFAULT 0 COMMENT '角色边框',
  `money` INT DEFAULT 0 COMMENT '金币',
  `rescoin` INT DEFAULT 0 COMMENT '复活币',
  `contributioncoin` INT DEFAULT 0 COMMENT '贡献币',
  `magiccrystal` INT DEFAULT 0 COMMENT '魔晶',
  `highmagiccrystal` INT DEFAULT 0 COMMENT '高级魔晶',
  `cerascore` INT DEFAULT 0 COMMENT '点券',
  `pkcoin` INT DEFAULT 0 COMMENT 'PK币',
  `friendpoint` INT DEFAULT 0 COMMENT '好友点',
  `smallcoin` INT DEFAULT 0 COMMENT '小币',
  `avatarVisibleFlags` INT DEFAULT 0 COMMENT '头像可见标志',
  `deletionstatus` INT DEFAULT 0 COMMENT '删除状态',
  `deletiontime` BIGINT DEFAULT 0 COMMENT '删除时间',
  `createtime` BIGINT DEFAULT 0 COMMENT '创建时间',
  `changename` TINYINT(1) DEFAULT 0 COMMENT '是否改名',
  `openid` VARCHAR(255) DEFAULT NULL COMMENT 'openid',
  `exp` INT DEFAULT 200 COMMENT '经验值',
  `sp` INT DEFAULT 40 COMMENT 'SP点',
  `tp` INT DEFAULT 0 COMMENT 'TP点',
  `addsp` INT DEFAULT 0 COMMENT '附加SP',
  `addtp` INT DEFAULT 0 COMMENT '附加TP',
  `day` INT DEFAULT 0 COMMENT '天数',
  `score` INT DEFAULT 0 COMMENT '分数',
  `qindex` INT DEFAULT 100110 COMMENT '任务索引',
  `distName` VARCHAR(255) DEFAULT NULL COMMENT '区服名',
  `servername` VARCHAR(255) DEFAULT NULL COMMENT '服务器名',
  `updateTime` DATETIME DEFAULT NULL COMMENT '更新时间',
  `lockTime` BIGINT DEFAULT 0 COMMENT '封号时间',
  `pos` JSON DEFAULT NULL COMMENT '坐标数据',
  `storageline` INT DEFAULT 1 COMMENT '仓库行数',
  `wordTime` BIGINT DEFAULT 0 COMMENT '禁言时间',
  `weaponIndex` INT DEFAULT 0 COMMENT '武器index',
  `expratio` INT DEFAULT 100 COMMENT '经验比例',
  `fatigueratio` INT DEFAULT 100 COMMENT '疲劳比例',
  `adventurename` VARCHAR(255) DEFAULT '' COMMENT '冒险名称',
  `serverSimpleDataBox` JSON DEFAULT NULL COMMENT '服务器简单数据',
  `friendBox` JSON DEFAULT NULL COMMENT '好友箱',
  `titleBox` JSON DEFAULT NULL COMMENT '称号箱',
  `avatarBox` JSON DEFAULT NULL COMMENT '装扮背包',
  `emblemBox` JSON DEFAULT NULL COMMENT '徽章背包',
  `cardBox` JSON DEFAULT NULL COMMENT '卡片背包',
  `creatureBox` JSON DEFAULT NULL COMMENT '宠物背包',
  `artifactBox` JSON DEFAULT NULL COMMENT '宠物装备',
  `equipBox` JSON DEFAULT NULL COMMENT '装备背包',
  `equippedBox` JSON DEFAULT NULL COMMENT '已装备',
  `materialBox` JSON DEFAULT NULL COMMENT '材料背包',
  `consumableBox` JSON DEFAULT NULL COMMENT '消耗品背包',
  `roleShopInfoBox` JSON DEFAULT NULL COMMENT '角色购买记录',
  `crackEquipBox` JSON DEFAULT NULL COMMENT '强化装备箱',
  `crackBox` JSON DEFAULT NULL COMMENT '强化箱',
  `damageBox` JSON DEFAULT NULL COMMENT '伤害字体',
  `chatFrameBox` JSON DEFAULT NULL COMMENT '聊天边框',
  `charFrameBox` JSON DEFAULT NULL COMMENT '人物边框',
  `sdAvatarBox` JSON DEFAULT NULL COMMENT 'SD装扮箱',
  `bookmarkBox` JSON DEFAULT NULL COMMENT '书签箱',
  `scrollBox` JSON DEFAULT NULL COMMENT '卷轴箱',
  `moneyBox` JSON DEFAULT NULL COMMENT '金钱箱',
  `ceraShopBuyInfo` JSON DEFAULT NULL COMMENT '点券商店购买信息',
  `tutoBox` JSON DEFAULT NULL COMMENT '教程箱',
  `skillBox` JSON DEFAULT NULL COMMENT '技能箱',
  `skillslotBox` JSON DEFAULT NULL COMMENT '技能槽箱',
  `dungeonTicketsBox` JSON DEFAULT NULL COMMENT '副本门票箱',
  `tonicBox` JSON DEFAULT NULL COMMENT '魔力强化信息',
  `mailBox` JSON DEFAULT NULL COMMENT '邮箱',
  `sysMailBox` JSON DEFAULT NULL COMMENT '系统邮箱',
  `charStorageBox` JSON DEFAULT NULL COMMENT '角色金库',
  `rePurStoItem` JSON DEFAULT NULL COMMENT '回收仓库物品',
  `towerInfoBox` JSON DEFAULT NULL COMMENT '塔信息箱',
  `creatureErrandBox` JSON DEFAULT NULL COMMENT '宠物差事箱',
  `localRewardBox` JSON DEFAULT NULL COMMENT '本地奖励箱',
  `questInfoBox` JSON DEFAULT NULL COMMENT '任务信息箱',
  `sysBuffBox` JSON DEFAULT NULL COMMENT '系统Buff箱',
  `clearDungeonBox` JSON DEFAULT NULL COMMENT '通关副本箱',
  `achievementBox` JSON DEFAULT NULL COMMENT '成就箱',
  `collectionBox` JSON DEFAULT NULL COMMENT '收集箱',
  `noteMsgBox` JSON DEFAULT NULL COMMENT '便签消息箱',
  `essenceBox` JSON DEFAULT NULL COMMENT '精华箱',
  `auctionBox` JSON DEFAULT NULL COMMENT '拍卖箱',
  PRIMARY KEY (`uid`),
  KEY `idx_roleId` (`roleId`),
  KEY `idx_uid` (`uid`),
  KEY `idx_openid` (`openid`),
  KEY `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色表';
```

**SQLite (role)**:
```sql
CREATE TABLE IF NOT EXISTS role (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    row_status TEXT NOT NULL DEFAULT 'NORMAL',
    account_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    job INTEGER NOT NULL,
    level INTEGER DEFAULT 1,
    exp INTEGER DEFAULT 0,
    fatigue INTEGER DEFAULT 100,
    max_fatigue INTEGER DEFAULT 100,
    map_id INTEGER DEFAULT 0,
    x INTEGER DEFAULT 0,
    y INTEGER DEFAULT 0,
    channel INTEGER DEFAULT 0,
    UNIQUE(account_id, role_id),
    FOREIGN KEY (account_id) REFERENCES account(id) ON DELETE CASCADE
);
```

**字段映射**:

| MySQL字段 | SQLite字段 | 类型转换 | 说明 |
|----------|-----------|---------|------|
| uid | id | BIGINT → INTEGER | 主键 |
| roleId | role_id | INT → INTEGER | 角色ID |
| openid | account_id | VARCHAR → INTEGER | 外键关联 |
| name | name | VARCHAR → TEXT | 角色名 |
| job | job | INT → INTEGER | 职业 |
| level | level | INT → INTEGER | 等级 |
| exp | exp | INT → INTEGER | 经验值 |
| fatigue | fatigue | INT → INTEGER | 疲劳值 |
| createtime | created_at | BIGINT → INTEGER | 创建时间 |
| lastlogout | - | BIGINT → - | 可选字段 |
| pos.x | x | JSON → INTEGER | 坐标X |
| pos.y | y | JSON → INTEGER | 坐标Y |
| JSON字段 | - | JSON → - | 需要拆分到独立表 |

### 配置表

#### 3. 成就配置表

**MySQL (t_achievement_config)**:
```sql
CREATE TABLE `t_achievement_config` (
  `achievement_id` INT NOT NULL COMMENT '成就ID',
  `name` VARCHAR(255) DEFAULT NULL COMMENT '成就名称',
  `description` TEXT DEFAULT NULL COMMENT '成就描述',
  `target_value` INT DEFAULT 0 COMMENT '目标值',
  `reward_type` INT DEFAULT 0 COMMENT '奖励类型',
  `reward_value` INT DEFAULT 0 COMMENT '奖励值',
  PRIMARY KEY (`achievement_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='成就配置表';
```

**SQLite (t_achievement_config)**:
```sql
CREATE TABLE IF NOT EXISTS t_achievement_config (
    achievement_id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    target_value INTEGER DEFAULT 0,
    reward_type INTEGER DEFAULT 0,
    reward_value INTEGER DEFAULT 0,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);
```

#### 4. 成就记录表

**MySQL (t_achievement_record)**:
```sql
CREATE TABLE `t_achievement_record` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `role_id` BIGINT NOT NULL COMMENT '角色ID',
  `achievement_id` INT NOT NULL COMMENT '成就ID',
  `progress` INT DEFAULT 0 COMMENT '进度',
  `completed` TINYINT(1) DEFAULT 0 COMMENT '是否完成',
  `rewarded` TINYINT(1) DEFAULT 0 COMMENT '是否已领取奖励',
  `reward_time` DATETIME DEFAULT NULL COMMENT '奖励领取时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_achievement` (`role_id`, `achievement_id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_achievement_id` (`achievement_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='成就记录表';
```

**SQLite (t_achievement_record)**:
```sql
CREATE TABLE IF NOT EXISTS t_achievement_record (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_id INTEGER NOT NULL,
    achievement_id INTEGER NOT NULL,
    progress INTEGER DEFAULT 0,
    completed INTEGER DEFAULT 0,
    rewarded INTEGER DEFAULT 0,
    reward_time INTEGER DEFAULT 0,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    UNIQUE(role_id, achievement_id),
    FOREIGN KEY (role_id) REFERENCES role(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_achievement_record_role ON t_achievement_record(role_id);
CREATE INDEX IF NOT EXISTS idx_achievement_record_achievement ON t_achievement_record(achievement_id);
```

**字段映射**:

| MySQL字段 | SQLite字段 | 类型转换 | 说明 |
|----------|-----------|---------|------|
| id | id | INT → INTEGER | 主键 |
| role_id | role_id | BIGINT → INTEGER | 角色ID |
| achievement_id | achievement_id | INT → INTEGER | 成就ID |
| progress | progress | INT → INTEGER | 进度 |
| completed | completed | TINYINT → INTEGER | 是否完成 |
| rewarded | rewarded | TINYINT → INTEGER | 是否已领取 |
| reward_time | reward_time | DATETIME → INTEGER | 时间戳 |
| create_time | created_at | DATETIME → INTEGER | 创建时间 |
| update_time | updated_at | DATETIME → INTEGER | 更新时间 |

### 其他配置表

#### 5. 经验配置表 (p_exp)

**MySQL**:
```sql
CREATE TABLE `p_exp` (
  `level` INT NOT NULL COMMENT '等级',
  `exp` INT DEFAULT 0 COMMENT '经验值',
  PRIMARY KEY (`level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色经验配置表';
```

**SQLite**:
```sql
CREATE TABLE IF NOT EXISTS p_exp (
    level INTEGER PRIMARY KEY,
    exp INTEGER DEFAULT 0
);
```

#### 6. 物品配置表 (p_equip, p_consume)

**MySQL (p_equip)**:
```sql
CREATE TABLE `p_equip` (
  `index` INT NOT NULL COMMENT '装备索引',
  `name` VARCHAR(255) DEFAULT NULL COMMENT '装备名称',
  `score` INT DEFAULT 0 COMMENT '抗魔值',
  `minlevel` INT DEFAULT 0 COMMENT '最低使用等级',
  `equiptype` INT DEFAULT 0 COMMENT '装备类型',
  `grade` INT DEFAULT 0 COMMENT '品质',
  `weight` INT DEFAULT 0 COMMENT '重量',
  `rarity` INT DEFAULT 0 COMMENT '稀有度',
  `groupname` VARCHAR(255) DEFAULT NULL COMMENT '组名',
  `subtype` INT DEFAULT 0 COMMENT '子类型',
  `disjointList` JSON DEFAULT NULL COMMENT '分解列表',
  PRIMARY KEY (`index`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='装备配置表';
```

**SQLite (p_equip)**:
```sql
CREATE TABLE IF NOT EXISTS p_equip (
    item_id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    score INTEGER DEFAULT 0,
    min_level INTEGER DEFAULT 0,
    equip_type INTEGER DEFAULT 0,
    grade INTEGER DEFAULT 0,
    weight INTEGER DEFAULT 0,
    rarity INTEGER DEFAULT 0,
    group_name TEXT,
    subtype INTEGER DEFAULT 0,
    disjoint_list TEXT
);
```

## 数据类型转换规则

### 时间类型转换

| MySQL类型 | SQLite类型 | 转换方式 | 示例 |
|----------|-----------|---------|------|
| DATETIME | INTEGER | 转换为Unix时间戳 | `2024-01-01 00:00:00` → `1704067200` |
| TIMESTAMP | INTEGER | 转换为Unix时间戳 | `2024-01-01 00:00:00` → `1704067200` |
| BIGINT (时间戳) | INTEGER | 直接转换 | `1704067200` → `1704067200` |

### JSON类型转换

| MySQL类型 | SQLite类型 | 转换方式 | 说明 |
|----------|-----------|---------|------|
| JSON | TEXT | 保留为JSON字符串 | 需要在应用层解析 |
| JSON对象 | 拆分到独立表 | 反序列化后存储 | 推荐方式 |

### 数值类型转换

| MySQL类型 | SQLite类型 | 转换方式 | 说明 |
|----------|-----------|---------|------|
| TINYINT | INTEGER | 直接转换 | 0/1 |
| SMALLINT | INTEGER | 直接转换 | |
| INT | INTEGER | 直接转换 | |
| BIGINT | INTEGER | 直接转换 | 注意范围 |
| FLOAT | REAL | 直接转换 | |
| DOUBLE | REAL | 直接转换 | |
| DECIMAL | REAL | 直接转换 | 可能有精度损失 |

### 字符串类型转换

| MySQL类型 | SQLite类型 | 转换方式 | 说明 |
|----------|-----------|---------|------|
| VARCHAR | TEXT | 直接转换 | |
| TEXT | TEXT | 直接转换 | |
| CHAR | TEXT | 直接转换 | |

## 迁移步骤

### 步骤1: 导出MySQL数据

使用mysqldump导出MySQL数据：

```bash
# 导出game数据库
mysqldump -h 127.0.0.1 -P 3306 -u root -p123456 game > mysql-game.sql

# 导出login数据库
mysqldump -h 127.0.0.1 -P 3306 -u root -p123456 login > mysql-login.sql

# 导出game_kuafu数据库
mysqldump -h 127.0.0.1 -P 3306 -u root -p123456 game_kuafu > mysql-kuafu.sql
```

### 步骤2: 创建SQLite数据库

```bash
# 创建SQLite数据库
sqlite3 game.db < store/migration/sqlite/schema.sql
```

### 步骤3: 数据转换脚本

创建Python转换脚本 `migrate_data.py`:

```python
#!/usr/bin/env python3
import sqlite3
import mysql.connector
import json
from datetime import datetime

# MySQL连接配置
mysql_config = {
    'host': '127.0.0.1',
    'port': 3306,
    'user': 'root',
    'password': '123456',
    'database': 'game'
}

# SQLite数据库路径
sqlite_db = 'game.db'

def datetime_to_timestamp(dt_str):
    """将MySQL DATETIME转换为Unix时间戳"""
    if not dt_str:
        return 0
    try:
        dt = datetime.strptime(dt_str, '%Y-%m-%d %H:%M:%S')
        return int(dt.timestamp())
    except:
        return 0

def migrate_accounts(mysql_conn, sqlite_conn):
    """迁移账户数据"""
    print("迁移账户数据...")
    
    mysql_cursor = mysql_conn.cursor(dictionary=True)
    sqlite_cursor = sqlite_conn.cursor()
    
    mysql_cursor.execute("SELECT * FROM t_account")
    accounts = mysql_cursor.fetchall()
    
    for account in accounts:
        sql = """
        INSERT OR REPLACE INTO account 
        (openid, account_key, auth_key, last_login_at, authority, status, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """
        sqlite_cursor.execute(sql, (
            account['id'],
            account['accountkey'] or '',
            account['passwd'] or '',
            account['lastLoginTime'] or 0,
            account['privilege'] or 0,
            account['isStop'] or 0,
            datetime_to_timestamp(str(account['createTime'])),
            datetime_to_timestamp(str(account['createTime']))
        ))
    
    sqlite_conn.commit()
    print(f"迁移了 {len(accounts)} 条账户数据")

def migrate_roles(mysql_conn, sqlite_conn):
    """迁移角色数据"""
    print("迁移角色数据...")
    
    mysql_cursor = mysql_conn.cursor(dictionary=True)
    sqlite_cursor = sqlite_conn.cursor()
    
    mysql_cursor.execute("SELECT * FROM t_role")
    roles = mysql_cursor.fetchall()
    
    for role in roles:
        # 解析pos JSON
        pos = json.loads(role['pos']) if role['pos'] else {}
        x = pos.get('x', 0)
        y = pos.get('y', 0)
        
        sql = """
        INSERT OR REPLACE INTO role 
        (account_id, role_id, name, job, level, exp, fatigue, x, y, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """
        sqlite_cursor.execute(sql, (
            role['openid'],
            role['roleId'],
            role['name'],
            role['job'],
            role['level'],
            role['exp'],
            role['fatigue'],
            x,
            y,
            role['createtime'],
            role['createtime']
        ))
    
    sqlite_conn.commit()
    print(f"迁移了 {len(roles)} 条角色数据")

def migrate_achievement_config(mysql_conn, sqlite_conn):
    """迁移成就配置数据"""
    print("迁移成就配置数据...")
    
    mysql_cursor = mysql_conn.cursor(dictionary=True)
    sqlite_cursor = sqlite_conn.cursor()
    
    mysql_cursor.execute("SELECT * FROM t_achievement_config")
    configs = mysql_cursor.fetchall()
    
    for config in configs:
        sql = """
        INSERT OR REPLACE INTO t_achievement_config 
        (achievement_id, name, description, target_value, reward_type, reward_value)
        VALUES (?, ?, ?, ?, ?, ?)
        """
        sqlite_cursor.execute(sql, (
            config['achievement_id'],
            config['name'],
            config['description'],
            config['target_value'],
            config['reward_type'],
            config['reward_value']
        ))
    
    sqlite_conn.commit()
    print(f"迁移了 {len(configs)} 条成就配置数据")

def migrate_achievement_records(mysql_conn, sqlite_conn):
    """迁移成就记录数据"""
    print("迁移成就记录数据...")
    
    mysql_cursor = mysql_conn.cursor(dictionary=True)
    sqlite_cursor = sqlite_conn.cursor()
    
    mysql_cursor.execute("SELECT * FROM t_achievement_record")
    records = mysql_cursor.fetchall()
    
    for record in records:
        sql = """
        INSERT OR REPLACE INTO t_achievement_record 
        (role_id, achievement_id, progress, completed, rewarded, reward_time, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """
        sqlite_cursor.execute(sql, (
            record['role_id'],
            record['achievement_id'],
            record['progress'],
            record['completed'],
            record['rewarded'],
            datetime_to_timestamp(str(record['reward_time'])),
            datetime_to_timestamp(str(record['create_time'])),
            datetime_to_timestamp(str(record['update_time']))
        ))
    
    sqlite_conn.commit()
    print(f"迁移了 {len(records)} 条成就记录数据")

def migrate_config_tables(mysql_conn, sqlite_conn):
    """迁移配置表数据"""
    print("迁移配置表数据...")
    
    config_tables = [
        'p_exp',
        'p_equip',
        'p_consume',
        'p_skill',
        'p_npc',
        'p_gamemap',
        'p_dungeon'
    ]
    
    mysql_cursor = mysql_conn.cursor(dictionary=True)
    sqlite_cursor = sqlite_conn.cursor()
    
    for table_name in config_tables:
        try:
            mysql_cursor.execute(f"SELECT * FROM {table_name}")
            rows = mysql_cursor.fetchall()
            
            if not rows:
                continue
            
            columns = list(rows[0].keys())
            placeholders = ', '.join(['?' for _ in columns])
            column_names = ', '.join(columns)
            
            sql = f"INSERT OR REPLACE INTO {table_name} ({column_names}) VALUES ({placeholders})"
            
            for row in rows:
                values = [row[col] for col in columns]
                sqlite_cursor.execute(sql, values)
            
            sqlite_conn.commit()
            print(f"迁移了 {len(rows)} 条 {table_name} 数据")
            
        except Exception as e:
            print(f"迁移 {table_name} 失败: {e}")

def main():
    print("开始数据迁移...")
    
    # 连接MySQL
    mysql_conn = mysql.connector.connect(**mysql_config)
    
    # 连接SQLite
    sqlite_conn = sqlite3.connect(sqlite_db)
    
    try:
        # 迁移数据
        migrate_accounts(mysql_conn, sqlite_conn)
        migrate_roles(mysql_conn, sqlite_conn)
        migrate_achievement_config(mysql_conn, sqlite_conn)
        migrate_achievement_records(mysql_conn, sqlite_conn)
        migrate_config_tables(mysql_conn, sqlite_conn)
        
        print("数据迁移完成!")
        
    finally:
        mysql_conn.close()
        sqlite_conn.close()

if __name__ == '__main__':
    main()
```

### 步骤4: 执行迁移

```bash
# 安装依赖
pip install mysql-connector-python

# 执行迁移脚本
python migrate_data.py
```

### 步骤5: 验证数据

```bash
# 连接SQLite数据库
sqlite3 game.db

# 验证数据
SELECT COUNT(*) FROM account;
SELECT COUNT(*) FROM role;
SELECT COUNT(*) FROM t_achievement_config;
SELECT COUNT(*) FROM t_achievement_record;

# 查看示例数据
SELECT * FROM account LIMIT 5;
SELECT * FROM role LIMIT 5;
```

## 数据差异处理

### 1. JSON字段处理

MySQL中的JSON字段需要特殊处理：

**方案1: 保留为TEXT**
```sql
-- 直接存储JSON字符串
CREATE TABLE role (
    ...
    friend_box TEXT,
    title_box TEXT,
    ...
);
```

**方案2: 拆分到独立表（推荐）**
```sql
-- 好友表
CREATE TABLE role_friend (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_id INTEGER NOT NULL,
    friend_id INTEGER NOT NULL,
    friend_name TEXT,
    status INTEGER DEFAULT 0,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    FOREIGN KEY (role_id) REFERENCES role(id) ON DELETE CASCADE
);

-- 称号表
CREATE TABLE role_title (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_id INTEGER NOT NULL,
    title_id INTEGER NOT NULL,
    is_equipped INTEGER DEFAULT 0,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    FOREIGN KEY (role_id) REFERENCES role(id) ON DELETE CASCADE
);
```

### 2. 外键关系

MySQL和SQLite的外键处理方式不同：

**MySQL**:
```sql
FOREIGN KEY (role_id) REFERENCES t_role(uid) ON DELETE CASCADE
```

**SQLite**:
```sql
FOREIGN KEY (role_id) REFERENCES role(id) ON DELETE CASCADE
```

注意：SQLite需要在连接时启用外键约束：
```python
sqlite_conn = sqlite3.connect('game.db')
sqlite_conn.execute('PRAGMA foreign_keys = ON')
```

### 3. 自增主键

**MySQL**:
```sql
id INT NOT NULL AUTO_INCREMENT
```

**SQLite**:
```sql
id INTEGER PRIMARY KEY AUTOINCREMENT
```

### 4. 唯一约束

**MySQL**:
```sql
UNIQUE KEY `uk_role_achievement` (`role_id`, `achievement_id`)
```

**SQLite**:
```sql
UNIQUE(role_id, achievement_id)
```

## 性能优化

### 1. 批量插入

使用批量插入提高性能：

```python
# 批量插入示例
def batch_insert(sqlite_cursor, sql, data, batch_size=1000):
    for i in range(0, len(data), batch_size):
        batch = data[i:i+batch_size]
        sqlite_cursor.executemany(sql, batch)
        sqlite_conn.commit()
```

### 2. 索引优化

在迁移完成后创建索引：

```sql
-- 创建索引
CREATE INDEX idx_account_openid ON account(openid);
CREATE INDEX idx_role_account ON role(account_id);
CREATE INDEX idx_achievement_record_role ON t_achievement_record(role_id);
CREATE INDEX idx_achievement_record_achievement ON t_achievement_record(achievement_id);
```

### 3. 事务处理

使用事务确保数据一致性：

```python
sqlite_conn.execute('BEGIN TRANSACTION')
try:
    # 执行迁移操作
    migrate_accounts(mysql_conn, sqlite_conn)
    migrate_roles(mysql_conn, sqlite_conn)
    # ...
    sqlite_conn.commit()
except Exception as e:
    sqlite_conn.rollback()
    raise
```

## 回滚方案

如果迁移失败，可以回滚：

```bash
# 删除SQLite数据库
rm game.db

# 重新创建
sqlite3 game.db < store/migration/sqlite/schema.sql

# 重新执行迁移
python migrate_data.py
```

## 注意事项

1. **数据备份**: 迁移前务必备份MySQL数据
2. **停服迁移**: 建议在停服期间进行迁移，避免数据不一致
3. **数据验证**: 迁移后务必验证数据完整性
4. **性能测试**: 大数据量迁移时进行性能测试
5. **增量迁移**: 考虑实现增量迁移机制
6. **日志记录**: 记录迁移过程中的错误和警告

## 常见问题

### Q1: 时间戳转换错误

**问题**: MySQL DATETIME转换为时间戳时出错

**解决**: 使用标准格式转换
```python
def datetime_to_timestamp(dt_str):
    if not dt_str:
        return 0
    try:
        dt = datetime.strptime(dt_str, '%Y-%m-%d %H:%M:%S')
        return int(dt.timestamp())
    except:
        return 0
```

### Q2: JSON字段解析失败

**问题**: MySQL JSON字段解析失败

**解决**: 添加异常处理
```python
import json

try:
    pos = json.loads(role['pos']) if role['pos'] else {}
except:
    pos = {}
```

### Q3: 外键约束失败

**问题**: SQLite外键约束失败

**解决**: 启用外键约束
```python
sqlite_conn.execute('PRAGMA foreign_keys = ON')
```

### Q4: 大数据量迁移慢

**问题**: 大数据量迁移速度慢

**解决**: 使用批量插入和事务
```python
batch_size = 1000
for i in range(0, len(data), batch_size):
    batch = data[i:i+batch_size]
    cursor.executemany(sql, batch)
    conn.commit()
```

## 附录

### A. 完整的表结构映射

参见 `store/migration/sqlite/schema.sql` 和 `mysql-db/schema.sql`

### B. 迁移脚本完整版

参见 `migrate_data.py`

### C. 数据验证SQL

```sql
-- 验证账户数据
SELECT 
    COUNT(*) as total,
    COUNT(DISTINCT openid) as unique_openid
FROM account;

-- 验证角色数据
SELECT 
    COUNT(*) as total,
    COUNT(DISTINCT account_id) as unique_accounts,
    AVG(level) as avg_level
FROM role;

-- 验证成就数据
SELECT 
    COUNT(*) as total_records,
    COUNT(DISTINCT role_id) as unique_roles,
    COUNT(DISTINCT achievement_id) as unique_achievements,
    SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed_count
FROM t_achievement_record;

-- 验证配置数据
SELECT 
    COUNT(*) as total_configs
FROM t_achievement_config;
```

## 总结

本文档提供了从MySQL到SQLite的完整迁移方案，包括：

1. 数据库架构对比
2. 表结构映射
3. 数据类型转换规则
4. 详细的迁移步骤
5. 数据差异处理
6. 性能优化建议
7. 回滚方案
8. 常见问题解决

按照本文档的步骤，可以安全、高效地将Java服务器的MySQL数据迁移到Go服务端的SQLite数据库。
