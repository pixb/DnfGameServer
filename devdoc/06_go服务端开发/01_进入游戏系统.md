# 进入游戏系统设计文档

## 1. 系统概述

### 1.1 系统简介
- 系统名称：进入游戏系统
- 系统功能：玩家登录后进入游戏世界的核心流程，包括角色选择、数据加载、位置同步、心跳检测等功能
- 系统位置：游戏客户端与服务端交互的第一个核心系统，是玩家进入游戏世界的入口

### 1.2 核心流程
- 玩家登录客户端后，通过进入游戏系统选择角色、加载游戏数据、进入游戏世界
- 系统负责验证玩家身份、加载角色数据、同步游戏状态、处理心跳检测等核心功能
- 核心流程示意图：
  1. 玩家登录客户端
  2. 客户端发送角色列表请求
  3. 服务端返回角色列表
  4. 玩家选择角色
  5. 客户端发送开始游戏请求
  6. 服务端验证身份、加载数据、返回游戏初始化数据
  7. 玩家进入游戏世界
  8. 客户端与服务端保持心跳检测

## 2. Java 代码分析

### 2.1 核心控制器
- **文件位置**: `src/main/java/com/dnfm/game/enter/EnterGameController.java`
- **处理器数量**: 98 个 @RequestMapping 方法

### 2.2 核心功能

#### 2.2.1 开始游戏 (REQ_START_GAME)
- **方法**: `ReqStartGame(IoSession session, REQ_START_GAME reqStartGame)`
- **功能**:
  - 验证账户状态
  - 加载角色数据
  - 设置会话属性
  - 返回游戏初始化数据
  - 处理重连逻辑
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `reqStartGame`: 开始游戏请求对象
- **返回数据**:
  - 世界信息 (world, currentworld)
  - 位置信息 (town, area)
  - 角色信息 (level, exp, fatigue)
  - Buff 列表
  - 技能版本
  - 城镇间隔
  - 事件选择信息
  - 任务状态
  - SVN/GIT 版本信息

#### 2.2.2 角色列表 (REQ_CHARAC_LIST)
- **方法**: `ReqCharacList(IoSession session, REQ_CHARAC_LIST req_charac_list)`
- **功能**:
  - 根据 openid 获取角色列表
  - 返回角色基本信息
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_charac_list`: 角色列表请求对象
- **返回数据**:
  - 角色列表，包含角色基本信息

#### 2.2.3 角色信息 (REQ_CHARACTER_INFO)
- **方法**: `ReqCharacterInfo(IoSession session, REQ_CHARACTER_INFO req_character_info)`
- **功能**:
  - 获取指定角色的详细信息
  - 返回完整角色数据
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_character_info`: 角色信息请求对象
- **返回数据**:
  - 角色详细信息，包括属性、装备、技能等

#### 2.2.4 加载服务器简单数据 (REQ_LOAD_SERVER_SIMPLE_DATA)
- **方法**: `ReqLoadServerSimpleData(IoSession session, REQ_LOAD_SERVER_SIMPLE_DATA req_load_server_simple_data)`
- **功能**:
  - 加载服务器配置数据
  - 返回服务器简单数据
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_load_server_simple_data`: 加载服务器简单数据请求对象
- **返回数据**:
  - 服务器配置数据

#### 2.2.5 保存服务器简单数据 (REQ_SAVE_SERVER_SIMPLE_DATA)
- **方法**: `ReqSaveServerSimpleData(IoSession session, REQ_SAVE_SERVER_SIMPLE_DATA req_save_server_simple_data)`
- **功能**:
  - 保存玩家服务器简单数据
  - 更新玩家配置
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_save_server_simple_data`: 保存服务器简单数据请求对象
- **返回数据**:
  - 保存结果

#### 2.2.6 进入频道 (REQ_ENTER_CHANNEL)
- **方法**: `ReqEnterChannel(IoSession session, REQ_ENTER_CHANNEL req_enter_channel)`
- **功能**:
  - 玩家进入游戏频道
  - 更新在线状态
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_enter_channel`: 进入频道请求对象
- **返回数据**:
  - 进入频道结果

#### 2.2.7 进入城镇 (REQ_ENTER_TO_TOWN)
- **方法**: `ReqEnterToTown(IoSession session, REQ_ENTER_TO_TOWN req_enter_to_town)`
- **功能**:
  - 玩家进入城镇
  - 更新位置信息
  - 返回城镇信息
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_enter_to_town`: 进入城镇请求对象
- **返回数据**:
  - 城镇信息
  - 位置更新结果

#### 2.2.8 离开城镇 (REQ_LEAVE_FROM_TOWN)
- **方法**: `ReqLeaveFromTown(IoSession session, REQ_LEAVE_FROM_TOWN req_leave_from_town)`
- **功能**:
  - 玩家离开城镇
  - 更新位置状态
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_leave_from_town`: 离开城镇请求对象
- **返回数据**:
  - 离开城镇结果

#### 2.2.9 心跳检测 (REQ_PING)
- **方法**: `ReqPing(IoSession session, REQ_PING req_ping)`
- **功能**:
  - 客户端心跳检测
  - 返回 PONG 响应
  - 更新会话活跃时间
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_ping`: 心跳检测请求对象
- **返回数据**:
  - PONG 响应

#### 2.2.10 待机 (REQ_STANDBY)
- **方法**: `ReqStandby(IoSession session, REQ_STANDBY req_standby)`
- **功能**:
  - 玩家待机状态
  - 返回待机确认
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_standby`: 待机请求对象
- **返回数据**:
  - 待机确认

#### 2.2.11 每日重置 (REQ_DAILY_RESET)
- **方法**: `ReqDailyReset(IoSession session, REQ_DAILY_RESET req_daily_reset)`
- **功能**:
  - 每日数据重置
  - 疲劳值恢复
  - 商店购买记录清空
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_daily_reset`: 每日重置请求对象
- **返回数据**:
  - 每日重置结果

#### 2.2.12 交互菜单 (REQ_INTERACTION_MENU)
- **方法**: `REQ_INTERACTION_MENU(IoSession session, REQ_INTERACTION_MENU req_interaction_menu)`
- **功能**:
  - 获取角色交互菜单
  - 返回交互选项
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_interaction_menu`: 交互菜单请求对象
- **返回数据**:
  - 交互菜单选项

#### 2.2.13 非交易角色状态 (REQ_NOT_TRANSACTION_CHARACTER_STATE_INFO)
- **方法**: `REQ_NOT_TRANSACTION_CHARACTER_STATE_INFO(IoSession session, REQ_NOT_TRANSACTION_CHARACTER_STATE_INFO req_not_transaction_character_state_info)`
- **功能**:
  - 获取角色交易状态
  - 返回是否可交易
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `req_not_transaction_character_state_info`: 非交易角色状态请求对象
- **返回数据**:
  - 角色交易状态

#### 2.2.14 冒险联盟讨伐信息 (REQ_ADVENTURE_UNION_SUBDUE_INFO)
- **方法**: `ReqAdventureUnionSubdueInfo(IoSession session, REQ_ADVENTURE_UNION_SUBDUE_INFO reqAdventureUnionSubdueInfo)`
- **功能**:
  - 获取冒险联盟讨伐信息
  - 返回疲劳值、门票、入场道具
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `reqAdventureUnionSubdueInfo`: 冒险联盟讨伐信息请求对象
- **返回数据**:
  - 疲劳值信息
  - 门票信息
  - 入场道具信息

#### 2.2.15 PVP 记录信息 (REQ_PVP_RECORD_INFO)
- **方法**: `ReqPvpRecordInfo(IoSession session, REQ_PVP_RECORD_INFO reqPvpRecordInfo)`
- **功能**:
  - 获取 PVP 记录
  - 支持多种匹配类型
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `reqPvpRecordInfo`: PVP 记录信息请求对象
- **返回数据**:
  - PVP 记录信息

#### 2.2.16 IDIP 通知 (REQ_IDIP_NOTICES)
- **方法**: `ReqIdipNotices(IoSession session, REQ_IDIP_NOTICES reqIdipNotices)`
- **功能**:
  - 获取 IDIP 通知信息
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `reqIdipNotices`: IDIP 通知请求对象
- **返回数据**:
  - IDIP 通知信息

#### 2.2.17 黑色钻石信息 (REQ_BLACK_DIAMON_INFO)
- **方法**: `ReqBlackDiamonInfo(IoSession session, REQ_BLACK_DIAMON_INFO reqBlackDiamonInfo)`
- **功能**:
  - 获取黑色钻石信息
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `reqBlackDiamonInfo`: 黑色钻石信息请求对象
- **返回数据**:
  - 黑色钻石信息

#### 2.2.18 发送邀请好友列表 (REQ_SENDING_INVITE_FRIEND_LIST)
- **方法**: `ReqSendingInviteFriendList(IoSession session, REQ_SENDING_INVITE_FRIEND_LIST reqSendingInviteFriendList)`
- **功能**:
  - 获取发送邀请的好友列表
- **参数**:
  - `session`: IoSession 对象，客户端会话
  - `reqSendingInviteFriendList`: 发送邀请好友列表请求对象
- **返回数据**:
  - 好友列表

## 3. Go 实现方案

### 3.1 ProtoBuf 消息定义

#### enter_game.proto
```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "gen/dnf/v1";

import "dnf/v1/common.proto";

// 开始游戏请求
message StartGameRequest {
    uint64 charguid = 1;
    string authkey = 2;
    string accesstoken = 3;
    repeated ProtocolTransaction request = 4;
    uint32 town = 5;
}

// 协议事务
message ProtocolTransaction {
    uint32 type = 1;
    bytes data = 2;
}

// 开始游戏响应
message StartGameResponse {
    uint32 world = 1;
    uint32 currentworld = 2;
    uint32 town = 3;
    uint32 area = 4;
    uint32 level = 5;
    uint64 exp = 6;
    uint32 fatigue = 7;
    repeated DiningFoodBuffInfo bufflist = 8;
    uint32 partydisturb = 9;
    uint32 battletutorial = 10;
    uint32 qindex = 11;
    uint32 areaId = 12;
    uint32 expratio = 13;
    uint32 fatigueratio = 14;
    uint32 chatchnidx = 15;
    uint64 createcount = 16;
    ReturnUserInfo returnUserInfo = 17;
    BattlePassInfo battlePassInfo = 18;
    BattlePassInfo pvpBattlePassInfo = 19;
    uint32 intervalidtowncharacterinfoms = 20;
    InitSkill initskillversion = 21;
    repeated TownInterval towninterval = 22;
    bool adventurebookOpen = 23;
    uint32 svnrevision = 24;
    string gitrevision = 25;
    EventSelectInfo eventSelectInfo = 26;
    uint32 queststate = 27;
    uint32 error = 28;
    string message = 29;
}

// 角色列表请求
message CharacterListRequest {
    string openid = 1;
}

// 角色列表响应
message CharacterListResponse {
    repeated CharacterInfo characters = 1;
    uint32 error = 2;
    string message = 3;
}

// 角色信息
message CharacterInfo {
    uint64 charguid = 1;
    string name = 2;
    uint32 level = 3;
    uint32职业 = 4;
    uint32 gender = 5;
    uint32 hair = 6;
    uint32 face = 7;
    uint32 skin = 8;
    uint32 clothing = 9;
    uint32 weapon = 10;
    uint64 exp = 11;
    uint32 fatigue = 12;
    uint32 strength = 13;
    uint32 intelligence = 14;
    uint32 vitality = 15;
    uint32 spirit = 16;
}

// 角色信息请求
message CharacterInfoRequest {
    uint64 charguid = 1;
}

// 角色信息响应
message CharacterInfoResponse {
    CharacterInfo character = 1;
    uint32 error = 2;
    string message = 3;
}

// 心跳检测请求
message PingRequest {
    uint64 timestamp = 1;
}

// 心跳检测响应
message PingResponse {
    uint64 timestamp = 1;
    string message = 2;
}

// 每日重置请求
message DailyResetRequest {
    uint64 charguid = 1;
}

// 每日重置响应
message DailyResetResponse {
    uint32 error = 1;
    string message = 2;
}

// 进入频道请求
message EnterChannelRequest {
    uint64 charguid = 1;
    uint32 channel = 2;
}

// 进入频道响应
message EnterChannelResponse {
    uint32 error = 1;
    string message = 2;
}

// 进入城镇请求
message EnterTownRequest {
    uint64 charguid = 1;
    uint32 town = 2;
}

// 进入城镇响应
message EnterTownResponse {
    uint32 error = 1;
    string message = 2;
    uint32 town = 3;
    uint32 area = 4;
}

// 离开城镇请求
message LeaveTownRequest {
    uint64 charguid = 1;
}

// 离开城镇响应
message LeaveTownResponse {
    uint32 error = 1;
    string message = 2;
}

// 待机请求
message StandbyRequest {
    uint64 charguid = 1;
}

// 待机响应
message StandbyResponse {
    uint32 error = 1;
    string message = 2;
}

// 交互菜单请求
message InteractionMenuRequest {
    uint64 charguid = 1;
}

// 交互菜单响应
message InteractionMenuResponse {
    repeated MenuItem menuItems = 1;
    uint32 error = 2;
    string message = 3;
}

// 菜单项
message MenuItem {
    uint32 id = 1;
    string name = 2;
    uint32 type = 3;
}

// 非交易角色状态请求
message NotTransactionCharacterStateInfoRequest {
    uint64 charguid = 1;
}

// 非交易角色状态响应
message NotTransactionCharacterStateInfoResponse {
    bool canTransaction = 1;
    uint32 error = 2;
    string message = 3;
}

// 冒险联盟讨伐信息请求
message AdventureUnionSubdueInfoRequest {
    uint64 charguid = 1;
}

// 冒险联盟讨伐信息响应
message AdventureUnionSubdueInfoResponse {
    uint32 fatigue = 1;
    uint32 ticket = 2;
    repeated ItemInfo items = 3;
    uint32 error = 4;
    string message = 5;
}

// 物品信息
message ItemInfo {
    uint32 id = 1;
    string name = 2;
    uint32 count = 3;
}

// PVP 记录信息请求
message PvpRecordInfoRequest {
    uint64 charguid = 1;
    uint32 matchType = 2;
}

// PVP 记录信息响应
message PvpRecordInfoResponse {
    repeated PvpRecord records = 1;
    uint32 error = 2;
    string message = 3;
}

// PVP 记录
message PvpRecord {
    uint64 id = 1;
    uint32 matchType = 2;
    uint32 result = 3;
    uint32 kills = 4;
    uint32 deaths = 5;
    uint64 timestamp = 6;
}

// IDIP 通知请求
message IdipNoticesRequest {
}

// IDIP 通知响应
message IdipNoticesResponse {
    repeated NoticeInfo notices = 1;
    uint32 error = 2;
    string message = 3;
}

// 通知信息
message NoticeInfo {
    uint64 id = 1;
    string title = 2;
    string content = 3;
    uint64 startTime = 4;
    uint64 endTime = 5;
}

// 黑色钻石信息请求
message BlackDiamondInfoRequest {
    uint64 charguid = 1;
}

// 黑色钻石信息响应
message BlackDiamondInfoResponse {
    uint32 count = 1;
    uint32 error = 2;
    string message = 3;
}

// 发送邀请好友列表请求
message SendingInviteFriendListRequest {
    uint64 charguid = 1;
}

// 发送邀请好友列表响应
message SendingInviteFriendListResponse {
    repeated FriendInfo friends = 1;
    uint32 error = 2;
    string message = 3;
}

// 好友信息
message FriendInfo {
    uint64 charguid = 1;
    string name = 2;
    uint32 level = 3;
    uint32职业 = 4;
}

// 加载服务器简单数据请求
message LoadServerSimpleDataRequest {
    uint64 charguid = 1;
}

// 加载服务器简单数据响应
message LoadServerSimpleDataResponse {
    map<string, string> data = 1;
    uint32 error = 2;
    string message = 3;
}

// 保存服务器简单数据请求
message SaveServerSimpleDataRequest {
    uint64 charguid = 1;
    map<string, string> data = 2;
}

// 保存服务器简单数据响应
message SaveServerSimpleDataResponse {
    uint32 error = 1;
    string message = 2;
}

// 辅助消息定义
message DiningFoodBuffInfo {
    uint32 id = 1;
    uint32 time = 2;
}

message ReturnUserInfo {
    bool isReturn = 1;
    uint32 days = 2;
}

message BattlePassInfo {
    uint32 level = 1;
    uint64 exp = 2;
    uint32 rewards = 3;
}

message InitSkill {
    uint32 version = 1;
}

message TownInterval {
    uint32 id = 1;
    uint32 interval = 2;
}

message EventSelectInfo {
    uint32 id = 1;
    string name = 2;
}
```

### 3.2 服务端实现

#### 3.2.1 控制器
```go
package enter

import (
    "context"
    "fmt"

    "github.com/pixb/DnfGameServer/dnf-go-server/gen/dnf/v1"
    "github.com/pixb/DnfGameServer/dnf-go-server/store"
)

// EnterGameController 进入游戏控制器
type EnterGameController struct {
    store *store.Store
}

// NewEnterGameController 创建进入游戏控制器实例
func NewEnterGameController(store *store.Store) *EnterGameController {
    return &EnterGameController{store: store}
}

// StartGame 处理开始游戏请求
func (c *EnterGameController) StartGame(ctx context.Context, req *v1.StartGameRequest) (*v1.StartGameResponse, error) {
    // 验证账户状态
    // 加载角色数据
    // 设置会话属性
    // 返回游戏初始化数据
    // 处理重连逻辑
    return &v1.StartGameResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// CharacterList 处理角色列表请求
func (c *EnterGameController) CharacterList(ctx context.Context, req *v1.CharacterListRequest) (*v1.CharacterListResponse, error) {
    // 根据 openid 获取角色列表
    // 返回角色基本信息
    return &v1.CharacterListResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// CharacterInfo 处理角色信息请求
func (c *EnterGameController) CharacterInfo(ctx context.Context, req *v1.CharacterInfoRequest) (*v1.CharacterInfoResponse, error) {
    // 获取指定角色的详细信息
    // 返回完整角色数据
    return &v1.CharacterInfoResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// Ping 处理心跳检测请求
func (c *EnterGameController) Ping(ctx context.Context, req *v1.PingRequest) (*v1.PingResponse, error) {
    // 客户端心跳检测
    // 返回 PONG 响应
    // 更新会话活跃时间
    return &v1.PingResponse{
        Timestamp: req.Timestamp,
        Message:   "PONG",
    }, nil
}

// DailyReset 处理每日重置请求
func (c *EnterGameController) DailyReset(ctx context.Context, req *v1.DailyResetRequest) (*v1.DailyResetResponse, error) {
    // 每日数据重置
    // 疲劳值恢复
    // 商店购买记录清空
    return &v1.DailyResetResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// EnterChannel 处理进入频道请求
func (c *EnterGameController) EnterChannel(ctx context.Context, req *v1.EnterChannelRequest) (*v1.EnterChannelResponse, error) {
    // 玩家进入游戏频道
    // 更新在线状态
    return &v1.EnterChannelResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// EnterTown 处理进入城镇请求
func (c *EnterGameController) EnterTown(ctx context.Context, req *v1.EnterTownRequest) (*v1.EnterTownResponse, error) {
    // 玩家进入城镇
    // 更新位置信息
    // 返回城镇信息
    return &v1.EnterTownResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// LeaveTown 处理离开城镇请求
func (c *EnterGameController) LeaveTown(ctx context.Context, req *v1.LeaveTownRequest) (*v1.LeaveTownResponse, error) {
    // 玩家离开城镇
    // 更新位置状态
    return &v1.LeaveTownResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// Standby 处理待机请求
func (c *EnterGameController) Standby(ctx context.Context, req *v1.StandbyRequest) (*v1.StandbyResponse, error) {
    // 玩家待机状态
    // 返回待机确认
    return &v1.StandbyResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// InteractionMenu 处理交互菜单请求
func (c *EnterGameController) InteractionMenu(ctx context.Context, req *v1.InteractionMenuRequest) (*v1.InteractionMenuResponse, error) {
    // 获取角色交互菜单
    // 返回交互选项
    return &v1.InteractionMenuResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// NotTransactionCharacterStateInfo 处理非交易角色状态请求
func (c *EnterGameController) NotTransactionCharacterStateInfo(ctx context.Context, req *v1.NotTransactionCharacterStateInfoRequest) (*v1.NotTransactionCharacterStateInfoResponse, error) {
    // 获取角色交易状态
    // 返回是否可交易
    return &v1.NotTransactionCharacterStateInfoResponse{
        CanTransaction: true,
        Error:          0,
        Message:        "OK",
    }, nil
}

// AdventureUnionSubdueInfo 处理冒险联盟讨伐信息请求
func (c *EnterGameController) AdventureUnionSubdueInfo(ctx context.Context, req *v1.AdventureUnionSubdueInfoRequest) (*v1.AdventureUnionSubdueInfoResponse, error) {
    // 获取冒险联盟讨伐信息
    // 返回疲劳值、门票、入场道具
    return &v1.AdventureUnionSubdueInfoResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// PvpRecordInfo 处理 PVP 记录信息请求
func (c *EnterGameController) PvpRecordInfo(ctx context.Context, req *v1.PvpRecordInfoRequest) (*v1.PvpRecordInfoResponse, error) {
    // 获取 PVP 记录
    // 支持多种匹配类型
    return &v1.PvpRecordInfoResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// IdipNotices 处理 IDIP 通知请求
func (c *EnterGameController) IdipNotices(ctx context.Context, req *v1.IdipNoticesRequest) (*v1.IdipNoticesResponse, error) {
    // 获取 IDIP 通知信息
    return &v1.IdipNoticesResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// BlackDiamondInfo 处理黑色钻石信息请求
func (c *EnterGameController) BlackDiamondInfo(ctx context.Context, req *v1.BlackDiamondInfoRequest) (*v1.BlackDiamondInfoResponse, error) {
    // 获取黑色钻石信息
    return &v1.BlackDiamondInfoResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// SendingInviteFriendList 处理发送邀请好友列表请求
func (c *EnterGameController) SendingInviteFriendList(ctx context.Context, req *v1.SendingInviteFriendListRequest) (*v1.SendingInviteFriendListResponse, error) {
    // 获取发送邀请的好友列表
    return &v1.SendingInviteFriendListResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// LoadServerSimpleData 处理加载服务器简单数据请求
func (c *EnterGameController) LoadServerSimpleData(ctx context.Context, req *v1.LoadServerSimpleDataRequest) (*v1.LoadServerSimpleDataResponse, error) {
    // 加载服务器配置数据
    // 返回服务器简单数据
    return &v1.LoadServerSimpleDataResponse{
        Error:   0,
        Message: "OK",
    }, nil
}

// SaveServerSimpleData 处理保存服务器简单数据请求
func (c *EnterGameController) SaveServerSimpleData(ctx context.Context, req *v1.SaveServerSimpleDataRequest) (*v1.SaveServerSimpleDataResponse, error) {
    // 保存玩家服务器简单数据
    // 更新玩家配置
    return &v1.SaveServerSimpleDataResponse{
        Error:   0,
        Message: "OK",
    }, nil
}
```

#### 3.2.2 路由注册
```go
package api

import (
    "github.com/labstack/echo/v4"
    "github.com/pixb/DnfGameServer/dnf-go-server/gen/dnf/v1"
    "github.com/pixb/DnfGameServer/dnf-go-server/server/enter"
    "google.golang.org/grpc"
)

// APIV1Service API v1 服务
type APIV1Service struct {
    enterGameController *enter.EnterGameController
}

// NewAPIV1Service 创建 API v1 服务实例
func NewAPIV1Service(enterGameController *enter.EnterGameController) *APIV1Service {
    return &APIV1Service{enterGameController: enterGameController}
}

// RegisterRoutes 注册路由
func (s *APIV1Service) RegisterRoutes(e *echo.Echo) {
    // 进入游戏相关路由
    e.POST("/api/v1/enter/start-game", s.StartGame)
    e.POST("/api/v1/enter/character-list", s.CharacterList)
    e.POST("/api/v1/enter/character-info", s.CharacterInfo)
    e.POST("/api/v1/enter/ping", s.Ping)
    e.POST("/api/v1/enter/daily-reset", s.DailyReset)
    e.POST("/api/v1/enter/enter-channel", s.EnterChannel)
    e.POST("/api/v1/enter/enter-town", s.EnterTown)
    e.POST("/api/v1/enter/leave-town", s.LeaveTown)
    e.POST("/api/v1/enter/standby", s.Standby)
    e.POST("/api/v1/enter/interaction-menu", s.InteractionMenu)
    e.POST("/api/v1/enter/not-transaction-character-state", s.NotTransactionCharacterStateInfo)
    e.POST("/api/v1/enter/adventure-union-subdue-info", s.AdventureUnionSubdueInfo)
    e.POST("/api/v1/enter/pvp-record-info", s.PvpRecordInfo)
    e.POST("/api/v1/enter/idip-notices", s.IdipNotices)
    e.POST("/api/v1/enter/black-diamond-info", s.BlackDiamondInfo)
    e.POST("/api/v1/enter/sending-invite-friend-list", s.SendingInviteFriendList)
    e.POST("/api/v1/enter/load-server-simple-data", s.LoadServerSimpleData)
    e.POST("/api/v1/enter/save-server-simple-data", s.SaveServerSimpleData)
}

// RegisterGRPCServices 注册 gRPC 服务
func (s *APIV1Service) RegisterGRPCServices(server *grpc.Server) {
    v1.RegisterEnterGameServiceServer(server, s)
}

// 实现 gRPC 服务接口
func (s *APIV1Service) StartGame(ctx context.Context, req *v1.StartGameRequest) (*v1.StartGameResponse, error) {
    return s.enterGameController.StartGame(ctx, req)
}

func (s *APIV1Service) CharacterList(ctx context.Context, req *v1.CharacterListRequest) (*v1.CharacterListResponse, error) {
    return s.enterGameController.CharacterList(ctx, req)
}

func (s *APIV1Service) CharacterInfo(ctx context.Context, req *v1.CharacterInfoRequest) (*v1.CharacterInfoResponse, error) {
    return s.enterGameController.CharacterInfo(ctx, req)
}

func (s *APIV1Service) Ping(ctx context.Context, req *v1.PingRequest) (*v1.PingResponse, error) {
    return s.enterGameController.Ping(ctx, req)
}

func (s *APIV1Service) DailyReset(ctx context.Context, req *v1.DailyResetRequest) (*v1.DailyResetResponse, error) {
    return s.enterGameController.DailyReset(ctx, req)
}

func (s *APIV1Service) EnterChannel(ctx context.Context, req *v1.EnterChannelRequest) (*v1.EnterChannelResponse, error) {
    return s.enterGameController.EnterChannel(ctx, req)
}

func (s *APIV1Service) EnterTown(ctx context.Context, req *v1.EnterTownRequest) (*v1.EnterTownResponse, error) {
    return s.enterGameController.EnterTown(ctx, req)
}

func (s *APIV1Service) LeaveTown(ctx context.Context, req *v1.LeaveTownRequest) (*v1.LeaveTownResponse, error) {
    return s.enterGameController.LeaveTown(ctx, req)
}

func (s *APIV1Service) Standby(ctx context.Context, req *v1.StandbyRequest) (*v1.StandbyResponse, error) {
    return s.enterGameController.Standby(ctx, req)
}

func (s *APIV1Service) InteractionMenu(ctx context.Context, req *v1.InteractionMenuRequest) (*v1.InteractionMenuResponse, error) {
    return s.enterGameController.InteractionMenu(ctx, req)
}

func (s *APIV1Service) NotTransactionCharacterStateInfo(ctx context.Context, req *v1.NotTransactionCharacterStateInfoRequest) (*v1.NotTransactionCharacterStateInfoResponse, error) {
    return s.enterGameController.NotTransactionCharacterStateInfo(ctx, req)
}

func (s *APIV1Service) AdventureUnionSubdueInfo(ctx context.Context, req *v1.AdventureUnionSubdueInfoRequest) (*v1.AdventureUnionSubdueInfoResponse, error) {
    return s.enterGameController.AdventureUnionSubdueInfo(ctx, req)
}

func (s *APIV1Service) PvpRecordInfo(ctx context.Context, req *v1.PvpRecordInfoRequest) (*v1.PvpRecordInfoResponse, error) {
    return s.enterGameController.PvpRecordInfo(ctx, req)
}

func (s *APIV1Service) IdipNotices(ctx context.Context, req *v1.IdipNoticesRequest) (*v1.IdipNoticesResponse, error) {
    return s.enterGameController.IdipNotices(ctx, req)
}

func (s *APIV1Service) BlackDiamondInfo(ctx context.Context, req *v1.BlackDiamondInfoRequest) (*v1.BlackDiamondInfoResponse, error) {
    return s.enterGameController.BlackDiamondInfo(ctx, req)
}

func (s *APIV1Service) SendingInviteFriendList(ctx context.Context, req *v1.SendingInviteFriendListRequest) (*v1.SendingInviteFriendListResponse, error) {
    return s.enterGameController.SendingInviteFriendList(ctx, req)
}

func (s *APIV1Service) LoadServerSimpleData(ctx context.Context, req *v1.LoadServerSimpleDataRequest) (*v1.LoadServerSimpleDataResponse, error) {
    return s.enterGameController.LoadServerSimpleData(ctx, req)
}

func (s *APIV1Service) SaveServerSimpleData(ctx context.Context, req *v1.SaveServerSimpleDataRequest) (*v1.SaveServerSimpleDataResponse, error) {
    return s.enterGameController.SaveServerSimpleData(ctx, req)
}
```

## 4. API 文档

### 4.1 HTTP API

#### 4.1.1 开始游戏
- **URL**: `/api/v1/enter/start-game`
- **方法**: POST
- **请求参数**:
  | 参数名 | 类型 | 必需 | 描述 |
  |--------|------|------|------|
  | charguid | uint64 | 是 | 角色 GUID |
  | authkey | string | 是 | 认证密钥 |
  | accesstoken | string | 是 | 访问令牌 |
  | request | array | 是 | 协议事务列表 |
  | town | uint32 | 是 | 城镇 ID |
- **响应格式**:
  ```json
  {
    "world": 1,
    "currentworld": 1,
    "town": 1,
    "area": 1,
    "level": 1,
    "exp": 0,
    "fatigue": 156,
    "bufflist": [],
    "partydisturb": 0,
    "battletutorial": 0,
    "qindex": 0,
    "areaId": 1,
    "expratio": 100,
    "fatigueratio": 100,
    "chatchnidx": 0,
    "createcount": 0,
    "returnUserInfo": {
      "isReturn": false,
      "days": 0
    },
    "battlePassInfo": {
      "level": 1,
      "exp": 0,
      "rewards": 0
    },
    "pvpBattlePassInfo": {
      "level": 1,
      "exp": 0,
      "rewards": 0
    },
    "intervalidtowncharacterinfoms": 0,
    "initskillversion": {
      "version": 1
    },
    "towninterval": [],
    "adventurebookOpen": false,
    "svnrevision": 1,
    "gitrevision": "abc123",
    "eventSelectInfo": {
      "id": 0,
      "name": ""
    },
    "queststate": 0,
    "error": 0,
    "message": "OK"
  }
  ```

#### 4.1.2 角色列表
- **URL**: `/api/v1/enter/character-list`
- **方法**: POST
- **请求参数**:
  | 参数名 | 类型 | 必需 | 描述 |
  |--------|------|------|------|
  | openid | string | 是 | 玩家 OpenID |
- **响应格式**:
  ```json
  {
    "characters": [
      {
        "charguid": 1,
        "name": "测试角色",
        "level": 1,
        "职业": 1,
        "gender": 1,
        "hair": 1,
        "face": 1,
        "skin": 1,
        "clothing": 1,
        "weapon": 1,
        "exp": 0,
        "fatigue": 156,
        "strength": 10,
        "intelligence": 10,
        "vitality": 10,
        "spirit": 10
      }
    ],
    "error": 0,
    "message": "OK"
  }
  ```

#### 4.1.3 角色信息
- **URL**: `/api/v1/enter/character-info`
- **方法**: POST
- **请求参数**:
  | 参数名 | 类型 | 必需 | 描述 |
  |--------|------|------|------|
  | charguid | uint64 | 是 | 角色 GUID |
- **响应格式**:
  ```json
  {
    "character": {
      "charguid": 1,
      "name": "测试角色",
      "level": 1,
      "职业": 1,
      "gender": 1,
      "hair": 1,
      "face": 1,
      "skin": 1,
      "clothing": 1,
      "weapon": 1,
      "exp": 0,
      "fatigue": 156,
      "strength": 10,
      "intelligence": 10,
      "vitality": 10,
      "spirit": 10
    },
    "error": 0,
    "message": "OK"
  }
  ```

#### 4.1.4 心跳检测
- **URL**: `/api/v1/enter/ping`
- **方法**: POST
- **请求参数**:
  | 参数名 | 类型 | 必需 | 描述 |
  |--------|------|------|------|
  | timestamp | uint64 | 是 | 时间戳 |
- **响应格式**:
  ```json
  {
    "timestamp": 1620000000,
    "message": "PONG"
  }
  ```

### 4.2 gRPC API

#### 4.2.1 StartGame
- **服务**: EnterGameService
- **方法**: StartGame
- **请求消息**:
  ```protobuf
  StartGameRequest {
    charguid: 1
    authkey: "test-auth-key"
    accesstoken: "test-access-token"
    request: []
    town: 1
  }
  ```
- **响应消息**:
  ```protobuf
  StartGameResponse {
    world: 1
    currentworld: 1
    town: 1
    area: 1
    level: 1
    exp: 0
    fatigue: 156
    error: 0
    message: "OK"
  }
  ```

#### 4.2.2 CharacterList
- **服务**: EnterGameService
- **方法**: CharacterList
- **请求消息**:
  ```protobuf
  CharacterListRequest {
    openid: "test-openid"
  }
  ```
- **响应消息**:
  ```protobuf
  CharacterListResponse {
    characters: [{
      charguid: 1
      name: "测试角色"
      level: 1
      职业: 1
      gender: 1
    }]
    error: 0
    message: "OK"
  }
  ```

## 5. 数据库设计文档

### 5.1 表结构

#### 5.1.1 characters 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| charguid | BIGINT | PRIMARY KEY | 角色 GUID |
| openid | VARCHAR(255) | NOT NULL | 玩家 OpenID |
| name | VARCHAR(50) | NOT NULL | 角色名称 |
| level | INT | NOT NULL | 角色等级 |
| 职业 | INT | NOT NULL | 角色职业 |
| gender | INT | NOT NULL | 角色性别 |
| hair | INT | NOT NULL | 角色发型 |
| face | INT | NOT NULL | 角色脸型 |
| skin | INT | NOT NULL | 角色肤色 |
| clothing | INT | NOT NULL | 角色服装 |
| weapon | INT | NOT NULL | 角色武器 |
| exp | BIGINT | NOT NULL | 角色经验 |
| fatigue | INT | NOT NULL | 角色疲劳值 |
| strength | INT | NOT NULL | 角色力量 |
| intelligence | INT | NOT NULL | 角色智力 |
| vitality | INT | NOT NULL | 角色体力 |
| spirit | INT | NOT NULL | 角色精神 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 5.1.2 character_states 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY | 状态 ID |
| charguid | BIGINT | NOT NULL | 角色 GUID |
| state_type | INT | NOT NULL | 状态类型 |
| state_value | VARCHAR(255) | NOT NULL | 状态值 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 5.1.3 server_simple_data 表
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY | 数据 ID |
| charguid | BIGINT | NOT NULL | 角色 GUID |
| data_key | VARCHAR(255) | NOT NULL | 数据键 |
| data_value | VARCHAR(255) | NOT NULL | 数据值 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 5.2 索引设计

#### 5.2.1 characters 表索引
| 索引名 | 字段 | 类型 | 描述 |
|--------|------|------|------|
| idx_openid | openid | 普通索引 | 加速根据 openid 查询角色列表 |

#### 5.2.2 character_states 表索引
| 索引名 | 字段 | 类型 | 描述 |
|--------|------|------|------|
| idx_charguid | charguid | 普通索引 | 加速根据 charguid 查询角色状态 |
| idx_charguid_state_type | charguid, state_type | 联合索引 | 加速根据 charguid 和 state_type 查询角色状态 |

#### 5.2.3 server_simple_data 表索引
| 索引名 | 字段 | 类型 | 描述 |
|--------|------|------|------|
| idx_charguid | charguid | 普通索引 | 加速根据 charguid 查询服务器简单数据 |
| idx_charguid_data_key | charguid, data_key | 联合索引 | 加速根据 charguid 和 data_key 查询服务器简单数据 |

### 5.3 关系图
- **characters** 表与 **character_states** 表是一对多关系，一个角色可以有多个状态
- **characters** 表与 **server_simple_data** 表是一对多关系，一个角色可以有多个服务器简单数据

## 6. 业务流程文档

### 6.1 流程描述
1. **角色列表流程**:
   - 客户端发送角色列表请求，包含玩家 openid
   - 服务端根据 openid 查询角色列表
   - 服务端返回角色列表响应，包含角色基本信息

2. **开始游戏流程**:
   - 客户端发送开始游戏请求，包含角色 charguid、认证信息等
   - 服务端验证认证信息
   - 服务端加载角色数据
   - 服务端返回游戏初始化数据，包含世界信息、角色信息、位置信息等
   - 客户端根据返回数据初始化游戏世界

3. **心跳检测流程**:
   - 客户端定期发送心跳检测请求，包含时间戳
   - 服务端接收心跳检测请求，更新会话活跃时间
   - 服务端返回心跳检测响应，包含相同的时间戳和 PONG 消息
   - 客户端接收心跳检测响应，确认连接正常

4. **每日重置流程**:
   - 客户端发送每日重置请求
   - 服务端执行每日重置逻辑，包括疲劳值恢复、商店购买记录清空等
   - 服务端返回每日重置响应，包含重置结果

### 6.2 流程图

#### 6.2.1 开始游戏流程
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 客户端      │     │ 服务端      │     │ 数据库      │     │ 客户端      │
├─────────────┤     ├─────────────┤     ├─────────────┤     ├─────────────┤
│ 1. 发送开始 │────>│ 2. 验证认证 │────>│ 3. 加载角色 │────>│ 6. 初始化游 │
│ 游戏请求    │     │ 信息        │     │ 数据        │     │ 戏世界      │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
         ^                  │                  │                  │
         │                  │                  │                  │
         │                  │ 4. 构造游戏初    │                  │
         │                  │ 始化数据         │                  │
         │                  │                  │                  │
         │                  └──────────────────┘                  │
         │                  │                                    │
         │                  ▼                                    │
         │         ┌─────────────┐                               │
         │         │ 服务端      │                               │
         │         ├─────────────┤                               │
         └─────────│ 5. 返回游戏 │<───────────────────────────────┘
                  │ 初始化数据  │
                  └─────────────┘
```

### 6.3 状态转换

#### 6.3.1 角色状态转换
| 状态 | 事件 | 下一状态 | 动作 |
|------|------|----------|------|
| 离线 | 开始游戏 | 在线 | 加载角色数据、初始化游戏世界 |
| 在线 | 心跳检测 | 在线 | 更新会话活跃时间 |
| 在线 | 客户端断开 | 离线 | 清理会话资源 |
| 在线 | 每日重置 | 在线 | 恢复疲劳值、清空购买记录 |

## 7. 测试用例文档

### 7.1 测试目标
- 验证进入游戏系统的核心功能是否正常工作
- 验证系统对各种异常情况的处理能力
- 验证系统在高并发场景下的性能和稳定性

### 7.2 测试场景

#### 7.2.1 场景 1: 正常开始游戏
- **测试步骤**:
  1. 客户端发送角色列表请求
  2. 服务端返回角色列表
  3. 客户端选择角色并发送开始游戏请求
  4. 服务端验证认证信息、加载角色数据
  5. 服务端返回游戏初始化数据
  6. 客户端初始化游戏世界
- **预期结果**:
  - 客户端成功进入游戏世界
  - 游戏初始化数据正确
  - 服务端日志无错误

#### 7.2.2 场景 2: 无效认证信息
- **测试步骤**:
  1. 客户端发送开始游戏请求，包含无效的认证信息
  2. 服务端验证认证信息
  3. 服务端返回错误响应
- **预期结果**:
  - 服务端返回认证错误
  - 客户端无法进入游戏世界

#### 7.2.3 场景 3: 心跳检测
- **测试步骤**:
  1. 客户端发送开始游戏请求，成功进入游戏世界
  2. 客户端定期发送心跳检测请求
  3. 服务端接收心跳检测请求，返回响应
  4. 持续一段时间后，检查连接状态
- **预期结果**:
  - 客户端与服务端连接保持正常
  - 服务端会话活跃时间持续更新

#### 7.2.4 场景 4: 每日重置
- **测试步骤**:
  1. 客户端发送开始游戏请求，成功进入游戏世界
  2. 客户端发送每日重置请求
  3. 服务端执行每日重置逻辑
  4. 服务端返回每日重置响应
  5. 客户端检查重置结果
- **预期结果**:
  - 服务端返回重置成功
  - 角色疲劳值恢复
  - 商店购买记录清空

### 7.3 测试数据
- **角色数据**:
  - charguid: 1
  - openid: "test-openid"
  - name: "测试角色"
  - level: 1
  - 职业: 1
  - gender: 1
  - exp: 0
  - fatigue: 156

- **认证信息**:
  - authkey: "test-auth-key"
  - accesstoken: "test-access-token"

- **心跳检测数据**:
  - timestamp: 1620000000

## 8. 部署文档

### 8.1 环境要求
- **操作系统**: Linux (Ubuntu 18.04+)
- **Go 版本**: 1.16+
- **数据库**: SQLite 3+
- **依赖服务**: 无

### 8.2 安装步骤
1. **克隆代码库**:
   ```bash
   git clone https://github.com/pixb/DnfGameServer.git
   cd DnfGameServer/dnf-go-server
   ```

2. **安装依赖**:
   ```bash
   go mod download
   ```

3. **编译项目**:
   ```bash
   go build -o dnf-go-server ./cmd/server/main.go
   ```

4. **配置环境**:
   ```bash
   cp config.dev.yaml config.yaml
   # 编辑 config.yaml 文件，配置数据库连接等信息
   ```

5. **启动服务**:
   ```bash
   ./dnf-go-server serve --driver="sqlite" --dsn="./game.db" --mode="dev"
   ```

### 8.3 配置说明

#### 8.3.1 配置文件
```yaml
# config.yaml
server:
  port: 8081
  mode: dev

database:
  driver: sqlite
  dsn: ./game.db

logging:
  level: info
  format: json
```

#### 8.3.2 环境变量
| 变量名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| SERVER_PORT | int | 8081 | 服务器端口 |
| SERVER_MODE | string | dev | 服务器模式 (dev/prod) |
| DATABASE_DRIVER | string | sqlite | 数据库驱动 (sqlite/mysql/postgres) |
| DATABASE_DSN | string | ./game.db | 数据库连接字符串 |
| LOG_LEVEL | string | info | 日志级别 (debug/info/warn/error) |
| LOG_FORMAT | string | json | 日志格式 (json/text) |

## 9. 监控与维护

### 9.1 监控指标
- **连接数**: 监控当前活跃的客户端连接数
- **请求数**: 监控每秒处理的请求数
- **响应时间**: 监控请求的平均响应时间
- **错误率**: 监控请求的错误率
- **心跳检测**: 监控心跳检测的成功率

### 9.2 日志管理
- **日志级别**: 默认使用 info 级别，生产环境可调整为 warn 级别
- **日志格式**: 默认使用 json 格式，便于日志收集和分析
- **日志存储**: 日志默认输出到标准输出，可通过配置重定向到文件
- **日志轮转**: 建议使用外部日志轮转工具，如 logrotate，定期轮转日志文件

### 9.3 常见问题

#### 9.3.1 问题 1: 客户端无法连接服务端
- **原因**: 可能是服务端未启动、网络连接问题、端口被占用等
- **解决方案**: 检查服务端状态、网络连接、端口占用情况，确保服务端正常运行

#### 9.3.2 问题 2: 角色数据加载失败
- **原因**: 可能是数据库连接问题、角色数据不存在、SQL 语句错误等
- **解决方案**: 检查数据库连接、角色数据是否存在、SQL 语句是否正确

#### 9.3.3 问题 3: 心跳检测失败
- **原因**: 可能是网络连接不稳定、服务端处理能力不足、客户端发送频率过高等
- **解决方案**: 检查网络连接、服务端负载、客户端发送频率，适当调整心跳检测间隔

#### 9.3.4 问题 4: 每日重置失败
- **原因**: 可能是数据库事务失败、重置逻辑错误、并发重置冲突等
- **解决方案**: 检查数据库事务、重置逻辑、并发控制，确保每日重置操作的原子性

## 10. 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 1.0 | 2026-02-17 | 系统自动生成 | 初始版本 |
| 1.1 | 2026-02-24 | 人工编辑 | 按照新模板完善文档，添加 API 文档、数据库设计文档、业务流程文档等内容 |
