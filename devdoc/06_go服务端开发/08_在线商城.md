# 在线商城系统设计文档

## 1. 系统概述

### 1.1 系统简介
在线商城系统是游戏内官方商城功能，支持玩家使用游戏货币或真实货币购买游戏道具、礼包等。系统提供商品展示、分类浏览、搜索、购买等核心功能，为玩家提供便捷的游戏内购物体验。

### 1.2 核心功能
- **商品管理**：支持多种商品类型、价格设置、库存管理
- **分类系统**：多级分类管理，方便玩家浏览
- **搜索功能**：按名称、类型、价格范围搜索商品
- **购买系统**：支持多种货币类型，购买限制，购买记录
- **推荐系统**：智能推荐热门商品、新品等
- **促销活动**：支持限时折扣、促销礼包等活动

### 1.3 系统架构
- **客户端**：游戏客户端，负责展示商城界面和处理用户交互
- **服务端**：Go服务端，处理业务逻辑和数据存储
- **数据库**：MySQL，存储商品信息、购买记录等数据

### 1.4 依赖关系
- **核心库**：Go标准库、gRPC、GORM
- **外部服务**：数据库服务、Redis缓存服务
- **其他系统**：背包系统（物品发放）、货币系统（货币扣除）

## Java 代码分析

### 核心控制器
- **文件位置**: `src/main/java/com/dnfm/game/onlinemall/OnlineMallController.java`
- **处理器数量**: 0 个（当前为空类，待实现）

### 核心功能

在线商城系统目前为空类，需要实现以下功能：

#### 1. 商城列表查询
- **功能**: 查询商城中的商品列表
- **参数**:
  - 页码
  - 每页数量
  - 商品类型
  - 排序方式
- **返回内容**:
  - 商品列表
  - 总数量

#### 2. 商城商品详情
- **功能**: 查询商城商品的详细信息
- **参数**:
  - 商品 ID
- **返回内容**:
  - 商品详细信息
  - 购买限制
  - 促销信息

#### 3. 商城购买
- **功能**: 玩家购买商城商品
- **参数**:
  - 商品 ID
  - 购买数量
  - 货币类型
- **返回内容**:
  - 购买结果
  - 物品信息
  - 剩余购买次数

#### 4. 商城推荐
- **功能**: 获取推荐商品列表
- **参数**:
  - 推荐类型
  - 数量限制
- **返回内容**:
  - 推荐商品列表

#### 5. 商城分类
- **功能**: 获取商城商品分类
- **参数**: 无
- **返回内容**:
  - 分类列表

#### 6. 商城搜索
- **功能**: 搜索商城商品
- **参数**:
  - 商品名称
  - 商品类型
  - 价格范围
- **返回内容**:
  - 搜索结果列表

#### 7. 购买记录
- **功能**: 查询玩家购买记录
- **参数**:
  - 页码
  - 每页数量
- **返回内容**:
  - 购买记录列表
  - 总数量

## Go 实现方案

### 1. ProtoBuf 消息定义

#### onlinemall.proto
```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "gen/dnf/v1";

import "dnf/v1/common.proto";

// 商城商品信息
message OnlineMallItem {
    uint32 id = 1;
    string name = 2;
    string description = 3;
    uint32 item_type = 4;
    uint32 item_index = 5;
    uint32 item_count = 6;
    bool bind = 7;
    uint64 price = 8;
    uint32 currency_type = 9;
    uint32 original_price = 10;
    uint32 sale_quota = 11;
    uint32 sale_count = 12;
    bool for_sale = 13;
    bool recommend = 14;
    uint32 page = 15;
    string barcode = 16;
    uint64 start_time = 17;
    uint64 end_time = 18;
    uint32 buy_limit = 19;
    uint32 buy_count = 20;
    string unit = 21;
}

// 商城列表请求
message OnlineMallListRequest {
    uint32 page = 1;
    uint32 page_size = 2;
    uint32 item_type = 3;
    uint32 sort_type = 4;
}

// 商城列表响应
message OnlineMallListResponse {
    repeated OnlineMallItem items = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 商城商品详情请求
message OnlineMallDetailRequest {
    uint32 item_id = 1;
}

// 商城商品详情响应
message OnlineMallDetailResponse {
    OnlineMallItem item = 1;
    uint32 error = 2;
    string message = 3;
}

// 商城购买请求
message OnlineMallBuyRequest {
    uint32 item_id = 1;
    uint32 buy_count = 2;
    uint32 currency_type = 3;
}

// 商城购买响应
message OnlineMallBuyResponse {
    OnlineMallItem item = 1;
    repeated StackableItem rewards = 2;
    uint32 remaining_count = 3;
    uint32 error = 4;
    string message = 5;
}

// 商城推荐请求
message OnlineMallRecommendRequest {
    uint32 recommend_type = 1;
    uint32 limit = 2;
}

// 商城推荐响应
message OnlineMallRecommendResponse {
    repeated OnlineMallItem items = 1;
    uint32 error = 2;
    string message = 3;
}

// 商城分类请求
message OnlineMallCategoryRequest {
}

// 商城分类响应
message OnlineMallCategoryResponse {
    repeated CategoryInfo categories = 1;
    uint32 error = 2;
    string message = 3;
}

// 分类信息
message CategoryInfo {
    uint32 id = 1;
    string name = 2;
    uint32 parent_id = 3;
    uint32 sort = 4;
}

// 商城搜索请求
message OnlineMallSearchRequest {
    string item_name = 1;
    uint32 item_type = 2;
    uint64 min_price = 3;
    uint64 max_price = 4;
    uint32 page = 5;
    uint32 page_size = 6;
}

// 商城搜索响应
message OnlineMallSearchResponse {
    repeated OnlineMallItem items = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 购买记录请求
message OnlineMallBuyRecordRequest {
    uint32 page = 1;
    uint32 page_size = 2;
}

// 购买记录响应
message OnlineMallBuyRecordResponse {
    repeated BuyRecordInfo records = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 购买记录信息
message BuyRecordInfo {
    uint64 id = 1;
    uint32 item_id = 2;
    string item_name = 3;
    uint32 item_count = 4;
    uint64 price = 5;
    uint32 currency_type = 6;
    uint64 buy_time = 7;
}
```

### 2. 数据模型设计

#### models/onlinemall.go
```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// OnlineMallItem 商城商品
type OnlineMallItem struct {
    ID           uint64    `gorm:"primaryKey;column:id" json:"id"`
    Name         string    `gorm:"column:name;size:100" json:"name"`
    Description  string    `gorm:"column:description;size:500" json:"description"`
    ItemType     uint32    `gorm:"column:itemType;index" json:"item_type"`
    ItemIndex    uint32    `gorm:"column:itemIndex" json:"item_index"`
    ItemCount    uint32    `gorm:"column:itemCount" json:"item_count"`
    Bind         bool      `gorm:"column:bind" json:"bind"`
    Price        uint64    `gorm:"column:price" json:"price"`
    CurrencyType uint32    `gorm:"column:currencyType" json:"currency_type"`
    OriginalPrice uint32    `gorm:"column:originalPrice" json:"original_price"`
    SaleQuota    uint32    `gorm:"column:saleQuota" json:"sale_quota"`
    SaleCount    uint32    `gorm:"column:saleCount" json:"sale_count"`
    ForSale      bool      `gorm:"column:forSale;index" json:"for_sale"`
    Recommend    bool      `gorm:"column:recommend;index" json:"recommend"`
    Page         uint32    `gorm:"column:page" json:"page"`
    Barcode      string    `gorm:"column:barcode;size:50" json:"barcode"`
    StartTime    time.Time `gorm:"column:startTime" json:"start_time"`
    EndTime      time.Time `gorm:"column:endTime" json:"end_time"`
    BuyLimit     uint32    `gorm:"column:buyLimit" json:"buy_limit"`
    Unit         string    `gorm:"column:unit;size:20" json:"unit"`
    Sort         uint32    `gorm:"column:sort" json:"sort"`
    CreateTime   time.Time `gorm:"column:createTime" json:"create_time"`
    UpdateTime   time.Time `gorm:"column:updateTime" json:"update_time"`
}

func (OnlineMallItem) TableName() string {
    return "t_online_mall_item"
}

// OnlineMallBuyRecord 商城购买记录
type OnlineMallBuyRecord struct {
    ID           uint64    `gorm:"primaryKey;column:id" json:"id"`
    RoleID       uint64    `gorm:"column:roleId;index" json:"role_id"`
    ItemID       uint32    `gorm:"column:itemId;index" json:"item_id"`
    ItemName     string    `gorm:"column:itemName;size:100" json:"item_name"`
    ItemCount    uint32    `gorm:"column:itemCount" json:"item_count"`
    Price        uint64    `gorm:"column:price" json:"price"`
    CurrencyType uint32    `gorm:"column:currencyType" json:"currency_type"`
    BuyTime      time.Time `gorm:"column:buyTime;index" json:"buy_time"`
    CreateTime   time.Time `gorm:"column:createTime" json:"create_time"`
}

func (OnlineMallBuyRecord) TableName() string {
    return "t_online_mall_buy_record"
}

// OnlineMallCategory 商城分类
type OnlineMallCategory struct {
    ID        uint64    `gorm:"primaryKey;column:id" json:"id"`
    Name      string    `gorm:"column:name;size:50" json:"name"`
    ParentID  uint32    `gorm:"column:parentId;index" json:"parent_id"`
    Sort      uint32    `gorm:"column:sort" json:"sort"`
    Status    uint32    `gorm:"column:status;default:1" json:"status"`
    CreateTime time.Time `gorm:"column:createTime" json:"create_time"`
    UpdateTime time.Time `gorm:"column:updateTime" json:"update_time"`
}

func (OnlineMallCategory) TableName() string {
    return "t_online_mall_category"
}

// OnlineMallBuyLimit 商城购买限制
type OnlineMallBuyLimit struct {
    ID        uint64    `gorm:"primaryKey;column:id" json:"id"`
    RoleID    uint64    `gorm:"column:roleId;index" json:"role_id"`
    ItemID    uint32    `gorm:"column:itemId;index" json:"item_id"`
    BuyCount  uint32    `gorm:"column:buyCount" json:"buy_count"`
    BuyDate   time.Time `gorm:"column:buyDate;index" json:"buy_date"`
    CreateTime time.Time `gorm:"column:createTime" json:"create_time"`
    UpdateTime time.Time `gorm:"column:updateTime" json:"update_time"`
}

func (OnlineMallBuyLimit) TableName() string {
    return "t_online_mall_buy_limit"
}
```

### 3. Handler 实现

#### handlers/onlinemall.go
```go
package handlers

import (
    "context"

    "github.com/pixb/DnfGameServer/dnf-go-server/internal/game/onlinemall_service"
    "github.com/pixb/DnfGameServer/dnf-go-server/internal/network"
    dnfv1 "github.com/pixb/DnfGameServer/dnf-go-server/proto/gen/dnf/v1"
    "google.golang.org/protobuf/proto"
)

type OnlineMallHandler struct {
    onlinemallService *onlinemall_service.OnlineMallService
}

func NewOnlineMallHandler(onlinemallService *onlinemall_service.OnlineMallService) *OnlineMallHandler {
    return &OnlineMallHandler{
        onlinemallService: onlinemallService,
    }
}

// OnlineMallListHandler 商城列表处理器
func (h *OnlineMallHandler) OnlineMallListHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallListRequest)
    if !ok {
        return
    }

    items, total, err := h.onlinemallService.GetMallList(context.Background(), req.Page, req.PageSize, req.ItemType, req.SortType)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get mall list")
        return
    }

    resp := &dnfv1.OnlineMallListResponse{
        Items:  items,
        Total:  total,
        Error:  0,
    }
    sess.Send(resp)
}

// OnlineMallDetailHandler 商城商品详情处理器
func (h *OnlineMallHandler) OnlineMallDetailHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallDetailRequest)
    if !ok {
        return
    }

    item, err := h.onlinemallService.GetMallItemDetail(context.Background(), req.ItemId)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get mall item detail")
        return
    }

    resp := &dnfv1.OnlineMallDetailResponse{
        Item:  item,
        Error: 0,
    }
    sess.Send(resp)
}

// OnlineMallBuyHandler 商城购买处理器
func (h *OnlineMallHandler) OnlineMallBuyHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallBuyRequest)
    if !ok {
        return
    }

    item, rewards, remainingCount, err := h.onlinemallService.BuyMallItem(context.Background(), sess.RoleID, req.ItemId, req.BuyCount, req.CurrencyType)
    if err != nil {
        h.sendError(sess, req, 1, "failed to buy mall item")
        return
    }

    resp := &dnfv1.OnlineMallBuyResponse{
        Item:           item,
        Rewards:        rewards,
        RemainingCount: remainingCount,
        Error:          0,
    }
    sess.Send(resp)
}

// OnlineMallRecommendHandler 商城推荐处理器
func (h *OnlineMallHandler) OnlineMallRecommendHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallRecommendRequest)
    if !ok {
        return
    }

    items, err := h.onlinemallService.GetRecommendItems(context.Background(), req.RecommendType, req.Limit)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get recommend items")
        return
    }

    resp := &dnfv1.OnlineMallRecommendResponse{
        Items:  items,
        Error:  0,
    }
    sess.Send(resp)
}

// OnlineMallCategoryHandler 商城分类处理器
func (h *OnlineMallHandler) OnlineMallCategoryHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallCategoryRequest)
    if !ok {
        return
    }

    categories, err := h.onlinemallService.GetMallCategories(context.Background())
    if err != nil {
        h.sendError(sess, req, 1, "failed to get mall categories")
        return
    }

    resp := &dnfv1.OnlineMallCategoryResponse{
        Categories: categories,
        Error:      0,
    }
    sess.Send(resp)
}

// OnlineMallSearchHandler 商城搜索处理器
func (h *OnlineMallHandler) OnlineMallSearchHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallSearchRequest)
    if !ok {
        return
    }

    items, total, err := h.onlinemallService.SearchMallItems(context.Background(), req.ItemName, req.ItemType, req.MinPrice, req.MaxPrice, req.Page, req.PageSize)
    if err != nil {
        h.sendError(sess, req, 1, "failed to search mall items")
        return
    }

    resp := &dnfv1.OnlineMallSearchResponse{
        Items:  items,
        Total:  total,
        Error:  0,
    }
    sess.Send(resp)
}

// OnlineMallBuyRecordHandler 购买记录处理器
func (h *OnlineMallHandler) OnlineMallBuyRecordHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.OnlineMallBuyRecordRequest)
    if !ok {
        return
    }

    records, total, err := h.onlinemallService.GetBuyRecords(context.Background(), sess.RoleID, req.Page, req.PageSize)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get buy records")
        return
    }

    resp := &dnfv1.OnlineMallBuyRecordResponse{
        Records: records,
        Total:   total,
        Error:   0,
    }
    sess.Send(resp)
}

func (h *OnlineMallHandler) sendError(sess *network.Session, req proto.Message, code uint32, message string) {
    switch req.(type) {
    case *dnfv1.OnlineMallListRequest:
        resp := &dnfv1.OnlineMallListResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.OnlineMallDetailRequest:
        resp := &dnfv1.OnlineMallDetailResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.OnlineMallBuyRequest:
        resp := &dnfv1.OnlineMallBuyResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.OnlineMallRecommendRequest:
        resp := &dnfv1.OnlineMallRecommendResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.OnlineMallCategoryRequest:
        resp := &dnfv1.OnlineMallCategoryResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.OnlineMallSearchRequest:
        resp := &dnfv1.OnlineMallSearchResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.OnlineMallBuyRecordRequest:
        resp := &dnfv1.OnlineMallBuyRecordResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    }
}
```

### 4. Service 实现

#### onlinemall_service/onlinemall.go
```go
package onlinemall_service

import (
    "context"
    "time"

    "github.com/pixb/DnfGameServer/dnf-go-server/store"
    "github.com/pixb/DnfGameServer/dnf-go-server/internal/db/models"
    dnfv1 "github.com/pixb/DnfGameServer/dnf-go-server/proto/gen/dnf/v1"
)

type OnlineMallService struct {
    store *store.Store
}

func NewOnlineMallService(store *store.Store) *OnlineMallService {
    return &OnlineMallService{
        store: store,
    }
}

// GetMallList 获取商城列表
func (s *OnlineMallService) GetMallList(ctx context.Context, page, pageSize, itemType, sortType uint32) ([]*dnfv1.OnlineMallItem, uint32, error) {
    offset := (page - 1) * pageSize

    items, total, err := s.store.GetOnlineMallItems(ctx, &store.FindOnlineMallItem{
        ItemType: itemType,
        ForSale:  true,
    }, offset, pageSize)
    if err != nil {
        return nil, 0, err
    }

    return items, uint32(total), nil
}

// GetMallItemDetail 获取商城商品详情
func (s *OnlineMallService) GetMallItemDetail(ctx context.Context, itemID uint32) (*dnfv1.OnlineMallItem, error) {
    item, err := s.store.GetOnlineMallItemByID(ctx, itemID)
    if err != nil {
        return nil, err
    }

    return item, nil
}

// BuyMallItem 购买商城商品
func (s *OnlineMallService) BuyMallItem(ctx context.Context, roleID uint64, itemID, buyCount, currencyType uint32) (*dnfv1.OnlineMallItem, []*dnfv1.StackableItem, uint32, error) {
    // 1. 获取商品信息
    item, err := s.store.GetOnlineMallItemByID(ctx, itemID)
    if err != nil {
        return nil, nil, 0, err
    }

    // 2. 检查商品是否在售
    if !item.ForSale {
        return nil, nil, 0, store.ErrInvalidParam
    }

    // 3. 检查购买限制
    if item.BuyLimit > 0 {
        buyLimit, err := s.store.GetOnlineMallBuyLimit(ctx, roleID, itemID, time.Now())
        if err == nil && buyLimit.BuyCount >= item.BuyLimit {
            return nil, nil, 0, store.ErrInvalidParam
        }
    }

    // 4. 计算总价
    totalPrice := uint64(item.Price) * uint64(buyCount)

    // 5. 扣除货币
    err = s.store.DeductMoney(ctx, roleID, totalPrice, currencyType)
    if err != nil {
        return nil, nil, 0, err
    }

    // 6. 添加物品到背包
    bagItem := &models.BagItem{
        RoleID:    roleID,
        ItemIndex: item.ItemIndex,
        Count:     item.ItemCount * buyCount,
        Bind:      item.Bind,
        CreateTime: time.Now(),
        UpdateTime: time.Now(),
    }

    err = s.store.CreateBagItem(ctx, bagItem)
    if err != nil {
        return nil, nil, 0, err
    }

    // 7. 更新购买限制
    if item.BuyLimit > 0 {
        buyLimit, err := s.store.GetOnlineMallBuyLimit(ctx, roleID, itemID, time.Now())
        if err == nil {
            buyLimit.BuyCount += buyCount
            buyLimit.UpdateTime = time.Now()
            s.store.UpdateOnlineMallBuyLimit(ctx, buyLimit)
        } else {
            newBuyLimit := &models.OnlineMallBuyLimit{
                RoleID:    roleID,
                ItemID:    itemID,
                BuyCount:  buyCount,
                BuyDate:   time.Now(),
                CreateTime: time.Now(),
                UpdateTime: time.Now(),
            }
            s.store.CreateOnlineMallBuyLimit(ctx, newBuyLimit)
        }
    }

    // 8. 记录购买
    record := &models.OnlineMallBuyRecord{
        RoleID:       roleID,
        ItemID:       itemID,
        ItemName:     item.Name,
        ItemCount:    buyCount,
        Price:        totalPrice,
        CurrencyType: currencyType,
        BuyTime:      time.Now(),
        CreateTime:   time.Now(),
    }

    err = s.store.CreateOnlineMallBuyRecord(ctx, record)
    if err != nil {
        return nil, nil, 0, err
    }

    // 9. 计算剩余购买次数
    remainingCount := uint32(0)
    if item.BuyLimit > 0 {
        buyLimit, _ := s.store.GetOnlineMallBuyLimit(ctx, roleID, itemID, time.Now())
        remainingCount = item.BuyLimit - buyLimit.BuyCount
    }

    // 10. 构建奖励列表
    rewards := []*dnfv1.StackableItem{
        {
            Index: item.ItemIndex,
            Count: item.ItemCount * buyCount,
            Bind:  item.Bind,
        },
    }

    return item, rewards, remainingCount, nil
}

// GetRecommendItems 获取推荐商品
func (s *OnlineMallService) GetRecommendItems(ctx context.Context, recommendType, limit uint32) ([]*dnfv1.OnlineMallItem, error) {
    items, _, err := s.store.GetOnlineMallItems(ctx, &store.FindOnlineMallItem{
        Recommend: true,
        ForSale:   true,
    }, 0, limit)
    if err != nil {
        return nil, err
    }

    return items, nil
}

// GetMallCategories 获取商城分类
func (s *OnlineMallService) GetMallCategories(ctx context.Context) ([]*dnfv1.CategoryInfo, error) {
    categories, err := s.store.GetOnlineMallCategories(ctx)
    if err != nil {
        return nil, err
    }

    return categories, nil
}

// SearchMallItems 搜索商城商品
func (s *OnlineMallService) SearchMallItems(ctx context.Context, itemName string, itemType uint32, minPrice, maxPrice uint64, page, pageSize uint32) ([]*dnfv1.OnlineMallItem, uint32, error) {
    offset := (page - 1) * pageSize

    items, total, err := s.store.SearchOnlineMallItems(ctx, itemName, itemType, minPrice, maxPrice, offset, pageSize)
    if err != nil {
        return nil, 0, err
    }

    return items, uint32(total), nil
}

// GetBuyRecords 获取购买记录
func (s *OnlineMallService) GetBuyRecords(ctx context.Context, roleID uint64, page, pageSize uint32) ([]*dnfv1.BuyRecordInfo, uint32, error) {
    offset := (page - 1) * pageSize

    records, total, err := s.store.GetOnlineMallBuyRecords(ctx, roleID, offset, pageSize)
    if err != nil {
        return nil, 0, err
    }

    return records, uint32(total), nil
}
```

## 5. 数据库设计文档

### 5.1 表结构

#### 5.1.1 商城商品表 (t_online_mall_item)
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 商品ID |
| `name` | `VARCHAR(100)` | `NOT NULL` | 商品名称 |
| `description` | `VARCHAR(500)` | `NOT NULL` | 商品描述 |
| `itemType` | `INT` | `NOT NULL INDEX` | 商品类型 |
| `itemIndex` | `INT` | `NOT NULL` | 物品索引 |
| `itemCount` | `INT` | `NOT NULL` | 物品数量 |
| `bind` | `BOOLEAN` | `NOT NULL DEFAULT FALSE` | 是否绑定 |
| `price` | `BIGINT` | `NOT NULL` | 价格 |
| `currencyType` | `INT` | `NOT NULL` | 货币类型 |
| `originalPrice` | `INT` | `NOT NULL DEFAULT 0` | 原价 |
| `saleQuota` | `INT` | `NOT NULL DEFAULT 0` | 销售配额 |
| `saleCount` | `INT` | `NOT NULL DEFAULT 0` | 已销售数量 |
| `forSale` | `BOOLEAN` | `NOT NULL DEFAULT TRUE INDEX` | 是否在售 |
| `recommend` | `BOOLEAN` | `NOT NULL DEFAULT FALSE INDEX` | 是否推荐 |
| `page` | `INT` | `NOT NULL DEFAULT 1` | 页码 |
| `barcode` | `VARCHAR(50)` | `DEFAULT NULL` | 条形码 |
| `startTime` | `DATETIME` | `NOT NULL` | 开始时间 |
| `endTime` | `DATETIME` | `NOT NULL` | 结束时间 |
| `buyLimit` | `INT` | `NOT NULL DEFAULT 0` | 购买限制 |
| `unit` | `VARCHAR(20)` | `NOT NULL DEFAULT '个'` | 单位 |
| `sort` | `INT` | `NOT NULL DEFAULT 0` | 排序 |
| `createTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updateTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 5.1.2 商城购买记录表 (t_online_mall_buy_record)
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `roleId` | `BIGINT` | `NOT NULL INDEX` | 角色ID |
| `itemId` | `INT` | `NOT NULL INDEX` | 商品ID |
| `itemName` | `VARCHAR(100)` | `NOT NULL` | 商品名称 |
| `itemCount` | `INT` | `NOT NULL` | 购买数量 |
| `price` | `BIGINT` | `NOT NULL` | 购买价格 |
| `currencyType` | `INT` | `NOT NULL` | 货币类型 |
| `buyTime` | `DATETIME` | `NOT NULL INDEX` | 购买时间 |
| `createTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 5.1.3 商城分类表 (t_online_mall_category)
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 分类ID |
| `name` | `VARCHAR(50)` | `NOT NULL` | 分类名称 |
| `parentId` | `INT` | `NOT NULL DEFAULT 0 INDEX` | 父分类ID |
| `sort` | `INT` | `NOT NULL DEFAULT 0` | 排序 |
| `status` | `INT` | `NOT NULL DEFAULT 1` | 状态 |
| `createTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updateTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 5.1.4 商城购买限制表 (t_online_mall_buy_limit)
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 限制ID |
| `roleId` | `BIGINT` | `NOT NULL INDEX` | 角色ID |
| `itemId` | `INT` | `NOT NULL INDEX` | 商品ID |
| `buyCount` | `INT` | `NOT NULL DEFAULT 0` | 购买数量 |
| `buyDate` | `DATE` | `NOT NULL INDEX` | 购买日期 |
| `createTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updateTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 5.2 索引设计
- **t_online_mall_item**: 为 `itemType`、`forSale`、`recommend` 字段创建索引，优化查询性能
- **t_online_mall_buy_record**: 为 `roleId`、`itemId`、`buyTime` 字段创建索引，优化查询性能
- **t_online_mall_category**: 为 `parentId` 字段创建索引，优化分类查询
- **t_online_mall_buy_limit**: 为 `roleId`、`itemId`、`buyDate` 字段创建联合索引，优化购买限制检查

## 6. 业务流程文档

### 6.1 核心业务流程

#### 6.1.1 商品浏览流程
1. 玩家打开商城界面
2. 系统加载商品分类
3. 玩家选择分类或搜索商品
4. 系统返回商品列表
5. 玩家查看商品详情

#### 6.1.2 商品购买流程
1. 玩家选择商品并点击购买
2. 系统检查商品状态（是否在售、是否过期）
3. 系统检查购买限制（是否达到购买上限）
4. 系统检查玩家货币（是否足够）
5. 系统扣除玩家货币
6. 系统添加物品到玩家背包
7. 系统记录购买记录
8. 系统更新购买限制
9. 系统返回购买结果

#### 6.1.3 商品推荐流程
1. 玩家打开商城推荐页面
2. 系统根据推荐类型获取推荐商品
3. 系统返回推荐商品列表
4. 玩家浏览推荐商品

### 6.2 状态转换

#### 6.2.1 商品状态转换
- **待上架** → **在售**：到开始时间自动转换
- **在售** → **下架**：到结束时间自动转换，或管理员手动下架
- **在售** → **售罄**：销售数量达到销售配额

#### 6.2.2 购买状态转换
- **待支付** → **已支付**：玩家完成支付
- **已支付** → **已完成**：物品发放成功

## 7. 测试用例文档

### 7.1 测试目标
- 验证在线商城系统的所有核心功能正常工作
- 确保系统在各种边界条件下的稳定性
- 验证系统的性能和并发处理能力

### 7.2 测试场景
- **商品管理测试**：添加、编辑、删除商品
- **分类管理测试**：创建、编辑、删除分类
- **商品浏览测试**：分类浏览、搜索、排序
- **购买测试**：正常购买、购买限制、货币不足
- **推荐测试**：热门推荐、新品推荐
- **促销测试**：限时折扣、促销活动

### 7.3 测试用例

#### 7.3.1 商品列表测试
| 测试ID | 测试名称 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| TC001 | 获取商品列表 | 1. 发送商品列表请求<br>2. 检查响应数据 | 成功返回商品列表 |
| TC002 | 按类型筛选 | 1. 发送带类型参数的请求<br>2. 检查响应数据 | 成功返回指定类型的商品 |
| TC003 | 分页测试 | 1. 发送带分页参数的请求<br>2. 检查响应数据 | 成功返回指定页的数据 |

#### 7.3.2 商品详情测试
| 测试ID | 测试名称 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| TC004 | 获取商品详情 | 1. 发送商品详情请求<br>2. 检查响应数据 | 成功返回商品详情 |
| TC005 | 获取不存在商品 | 1. 发送不存在商品ID的请求<br>2. 检查响应错误 | 返回错误信息 |

#### 7.3.3 购买测试
| 测试ID | 测试名称 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| TC006 | 正常购买 | 1. 发送购买请求<br>2. 检查响应数据 | 购买成功，物品到账 |
| TC007 | 货币不足 | 1. 发送货币不足的购买请求<br>2. 检查响应错误 | 返回货币不足错误 |
| TC008 | 购买限制 | 1. 达到购买限制后发送购买请求<br>2. 检查响应错误 | 返回购买限制错误 |

#### 7.3.4 搜索测试
| 测试ID | 测试名称 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| TC009 | 按名称搜索 | 1. 发送带名称参数的搜索请求<br>2. 检查响应数据 | 成功返回搜索结果 |
| TC010 | 按价格范围搜索 | 1. 发送带价格范围的搜索请求<br>2. 检查响应数据 | 成功返回指定价格范围的商品 |

## 8. 部署文档

### 8.1 环境要求
- **操作系统**: Linux (CentOS 7+) 或 macOS
- **Go版本**: 1.20+
- **数据库**: MySQL 5.7+
- **内存**: 2GB+
- **CPU**: 2核+

### 8.2 安装步骤
1. **安装Go环境**
   - 下载并安装Go 1.20+
   - 配置GOPATH和GOROOT

2. **安装依赖**
   ```bash
   go mod download
   ```

3. **编译项目**
   ```bash
   go build -o server cmd/server/main.go
   ```

4. **配置数据库**
   - 创建数据库
   - 运行数据库迁移脚本

5. **启动服务**
   ```bash
   ./server
   ```

### 8.3 配置说明
- **数据库配置**: 修改 `config/config.yaml` 中的数据库连接信息
- **服务配置**: 修改 `config/config.yaml` 中的服务端口、日志级别等
- **商城配置**: 修改 `config/onlinemall.yaml` 中的商城相关配置

## 9. 监控与维护

### 9.1 监控指标
- **商品访问量**: 统计商品的浏览次数
- **购买转化率**: 统计浏览到购买的转化率
- **销售金额**: 统计商城的总销售金额
- **热门商品**: 统计最受欢迎的商品
- **错误率**: 统计购买失败率等错误指标

### 9.2 日志管理
- **业务日志**: 记录商品操作、购买记录等业务日志
- **错误日志**: 记录系统错误、异常等信息
- **访问日志**: 记录API访问情况

### 9.3 常见问题
- **商品无法购买**: 检查商品状态、购买限制、货币数量
- **购买后物品未到账**: 检查背包系统是否正常，查看购买记录
- **商城加载缓慢**: 检查数据库性能，优化查询语句
- **推荐商品不准确**: 调整推荐算法参数

## 10. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
| :--- | :--- | :--- | :--- |
| v1.0 | 2026-02-24 | 初始版本，完成在线商城系统设计 | 系统管理员 |
| v1.1 | 2026-03-01 | 添加促销活动功能 | 系统管理员 |
| v1.2 | 2026-03-15 | 优化推荐算法 | 系统管理员 |
