# PK系统部署文档

## 1. 部署环境准备

### 1.1 硬件要求

| 环境 | CPU | 内存 | 磁盘 | 网络 |
| :--- | :--- | :--- | :--- | :--- |
| 开发环境 | 4核 | 8GB | 100GB | 100Mbps |
| 测试环境 | 8核 | 16GB | 200GB | 1Gbps |
| 生产环境 | 16核+ | 32GB+ | 500GB+ | 10Gbps+ |

### 1.2 软件要求

| 软件 | 版本 | 用途 | 安装命令 |
| :--- | :--- | :--- | :--- |
| CentOS | 7.6+ | 操作系统 | - |
| Go | 1.20+ | 开发语言 | `yum install golang` 或从官网下载 |
| MySQL | 8.0+ | 数据库 | `yum install mysql-server` |
| Redis | 7.0+ | 缓存 | `yum install redis` |
| Kafka | 3.0+ | 消息队列 | 从官网下载并解压 |
| Nginx | 1.18+ | 反向代理 | `yum install nginx` |
| Git | 2.20+ | 版本控制 | `yum install git` |

### 1.3 网络要求

| 端口 | 用途 | 协议 | 备注 |
| :--- | :--- | :--- | :--- |
| 8080 | API服务 | TCP | 可修改 |
| 3306 | MySQL | TCP | 默认端口 |
| 6379 | Redis | TCP | 默认端口 |
| 9092 | Kafka | TCP | 默认端口 |
| 2181 | ZooKeeper | TCP | Kafka依赖 |
| 80 | HTTP | TCP | Nginx默认端口 |
| 443 | HTTPS | TCP | Nginx默认端口 |

## 2. 部署步骤

### 2.1 代码获取

1. **克隆代码仓库**:

```bash
git clone https://github.com/dnf-game-server/dnf-game-server.git
cd dnf-game-server
```

2. **切换到Go服务端分支**:

```bash
git checkout go-server
```

### 2.2 依赖安装

1. **安装Go依赖**:

```bash
go mod tidy
```

2. **安装系统依赖**:

```bash
yum install -y gcc gcc-c++ make cmake
```

### 2.3 配置文件修改

1. **复制配置文件模板**:

```bash
cp config/config.yaml.template config/config.yaml
```

2. **修改配置文件**:

```yaml
# 服务器配置
server:
  port: 8080
  host: 0.0.0.0

# 数据库配置
database:
  dsn: "root:password@tcp(localhost:3306)/dnf_game?charset=utf8mb4&parseTime=True&loc=Local"
  max_idle_conns: 10
  max_open_conns: 100

# Redis配置
redis:
  addr: "localhost:6379"
  password: ""
  db: 0

# Kafka配置
kafka:
  brokers: ["localhost:9092"]
  topic: "pk-events"

# PK系统配置
pk:
  base_honor: 10
  level_bonus: 2
  combo_bonus: 1
  max_queue_time: 300
  battle_timeout: 600
```

### 2.4 数据库初始化

1. **创建数据库**:

```sql
CREATE DATABASE IF NOT EXISTS dnf_game CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. **执行数据库迁移脚本**:

```bash
go run cmd/migrate/main.go
```

或手动执行SQL脚本:

```sql
-- 创建PK记录表
CREATE TABLE IF NOT EXISTS t_pk_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    winner_id BIGINT NOT NULL,
    loser_id BIGINT NOT NULL,
    winner_honor_change INT NOT NULL,
    loser_honor_change INT NOT NULL,
    duration INT NOT NULL,
    winner_max_combo INT NOT NULL,
    loser_max_combo INT NOT NULL,
    battle_time DATETIME NOT NULL,
    battle_result VARCHAR(10) NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_winner_id (winner_id),
    INDEX idx_loser_id (loser_id),
    INDEX idx_winner_battle_time (winner_id, battle_time),
    INDEX idx_loser_battle_time (loser_id, battle_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建玩家PK数据表
CREATE TABLE IF NOT EXISTS t_player_pk_data (
    player_id BIGINT PRIMARY KEY,
    honor INT NOT NULL DEFAULT 0,
    honor_level INT NOT NULL DEFAULT 1,
    total_battles INT NOT NULL DEFAULT 0,
    wins INT NOT NULL DEFAULT 0,
    losses INT NOT NULL DEFAULT 0,
    draws INT NOT NULL DEFAULT 0,
    ranking INT NOT NULL DEFAULT 0,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_ranking (ranking),
    INDEX idx_honor (honor),
    INDEX idx_honor_player_id (honor, player_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建荣誉等级配置表
CREATE TABLE IF NOT EXISTS t_honor_level (
    id INT PRIMARY KEY AUTO_INCREMENT,
    level INT NOT NULL UNIQUE,
    min_honor INT NOT NULL,
    max_honor INT NOT NULL,
    level_name VARCHAR(20) NOT NULL,
    description VARCHAR(100) NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_level (level),
    INDEX idx_min_honor (min_honor)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建PK匹配队列表
CREATE TABLE IF NOT EXISTS t_pk_queue (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    player_id BIGINT NOT NULL UNIQUE,
    level INT NOT NULL,
    match_value INT NOT NULL,
    queue_time DATETIME NOT NULL,
    status VARCHAR(10) NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_player_id (player_id),
    INDEX idx_status (status),
    INDEX idx_status_level_match_value (status, level, match_value)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建PK战斗表
CREATE TABLE IF NOT EXISTS t_pk_battle (
    id VARCHAR(36) PRIMARY KEY,
    player1_id BIGINT NOT NULL,
    player2_id BIGINT NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME NULL,
    winner_id BIGINT NULL,
    status VARCHAR(10) NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_player1_id (player1_id),
    INDEX idx_player2_id (player2_id),
    INDEX idx_status (status),
    INDEX idx_player1_status (player1_id, status),
    INDEX idx_player2_status (player2_id, status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 插入荣誉等级数据
INSERT INTO t_honor_level (level, min_honor, max_honor, level_name, description) VALUES
(1, 0, 99, '新手', 'PK场的初学者'),
(2, 100, 499, '勇士', '已经掌握了基本的PK技巧'),
(3, 500, 999, '专家', 'PK场的常客'),
(4, 1000, 1999, '大师', 'PK场的高手'),
(5, 2000, 999999, '王者', 'PK场的传说');
```

### 2.5 服务构建

1. **编译API服务**:

```bash
go build -o output/pk-server cmd/pk/main.go
```

2. **编译工具脚本**:

```bash
go build -o output/migrate cmd/migrate/main.go
go build -o output/seed cmd/seed/main.go
```

### 2.6 服务启动

1. **启动MySQL**:

```bash
systemctl start mysqld
systemctl enable mysqld
```

2. **启动Redis**:

```bash
systemctl start redis
systemctl enable redis
```

3. **启动Kafka和ZooKeeper**:

```bash
# 启动ZooKeeper
bin/zookeeper-server-start.sh config/zookeeper.properties &

# 启动Kafka
bin/kafka-server-start.sh config/server.properties &
```

4. **创建Kafka主题**:

```bash
bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 3 --topic pk-events
```

5. **启动API服务**:

```bash
# 直接启动
./output/pk-server

# 或使用systemd管理
```

6. **配置Nginx反向代理**:

```nginx
upstream pk_server {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name api.dnf-game.com;

    location / {
        proxy_pass http://pk_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

7. **启动Nginx**:

```bash
systemctl start nginx
systemctl enable nginx
```

## 3. 服务管理

### 3.1 启动脚本

1. **创建启动脚本**:

```bash
#!/bin/bash

# 设置环境变量
export GIN_MODE=release
export HOST=0.0.0.0
export PORT=8080

# 启动服务
cd /path/to/dnf-game-server
./output/pk-server
```

2. **设置脚本权限**:

```bash
chmod +x start.sh
```

3. **使用systemd管理服务**:

```bash
# 创建systemd服务文件
cat > /etc/systemd/system/pk-server.service << EOF
[Unit]
Description=DNF Game PK Server
After=network.target mysql.service redis.service kafka.service

[Service]
Type=simple
User=root
WorkingDirectory=/path/to/dnf-game-server
ExecStart=/path/to/dnf-game-server/output/pk-server
Restart=always
RestartSec=5
Environment=GIN_MODE=release
Environment=HOST=0.0.0.0
Environment=PORT=8080

[Install]
WantedBy=multi-user.target
EOF

# 重新加载systemd配置
systemctl daemon-reload

# 启动服务
systemctl start pk-server

# 设置开机自启
systemctl enable pk-server
```

### 3.2 停止脚本

1. **创建停止脚本**:

```bash
#!/bin/bash

# 停止服务
pkill -f pk-server
```

2. **使用systemd停止服务**:

```bash
systemctl stop pk-server
```

### 3.3 重启脚本

1. **创建重启脚本**:

```bash
#!/bin/bash

# 停止服务
pkill -f pk-server

# 等待3秒
sleep 3

# 启动服务
cd /path/to/dnf-game-server
./output/pk-server
```

2. **使用systemd重启服务**:

```bash
systemctl restart pk-server
```

### 3.4 状态检查

1. **检查服务状态**:

```bash
systemctl status pk-server
```

2. **检查端口占用**:

```bash
netstat -tlnp | grep 8080
```

3. **检查日志**:

```bash
journalctl -u pk-server
```

## 4. 监控与维护

### 4.1 日志管理

1. **日志配置**:

```yaml
# config/config.yaml
log:
  level: info
  file: logs/pk-server.log
  max_size: 100
  max_backups: 10
  max_age: 30
```

2. **日志轮转**:

```bash
# 创建日志轮转配置文件
cat > /etc/logrotate.d/pk-server << EOF
/path/to/dnf-game-server/logs/pk-server.log {
    daily
    rotate 10
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
EOF
```

### 4.2 监控配置

1. **Prometheus配置**:

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'pk-server'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
```

2. **Grafana面板**:

- 创建PK系统监控面板，包含以下指标:
  - 请求量
  - 响应时间
  - 错误率
  - 匹配成功率
  - 战斗结束率
  - 系统资源使用率

### 4.3 告警配置

1. **Prometheus告警规则**:

```yaml
# alerts.yml
groups:
- name: pk-server-alerts
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High error rate"
      description: "Error rate is above 5% for 5 minutes"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High response time"
      description: "95th percentile response time is above 1 second for 5 minutes"

  - alert: ServiceDown
    expr: up{job="pk-server"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service down"
      description: "PK server is down"
```

2. **告警通知**:

- 配置邮件通知
- 配置Slack通知
- 配置短信通知

### 4.4 备份与恢复

1. **数据库备份**:

```bash
# 创建备份脚本
cat > backup.sh << EOF
#!/bin/bash

# 备份目录
BACKUP_DIR=/path/to/backup
DATE=$(date +%Y%m%d%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u root -p dnf_game > $BACKUP_DIR/dnf_game_$DATE.sql

# 压缩备份文件
tar -czf $BACKUP_DIR/dnf_game_$DATE.tar.gz $BACKUP_DIR/dnf_game_$DATE.sql

# 删除原始备份文件
rm $BACKUP_DIR/dnf_game_$DATE.sql

# 保留最近30天的备份
find $BACKUP_DIR -name "dnf_game_*.tar.gz" -mtime +30 -delete
EOF

# 设置脚本权限
chmod +x backup.sh

# 执行备份
./backup.sh

# 设置定时备份
crontab -e
# 添加以下行，每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh
```

2. **数据库恢复**:

```bash
# 解压备份文件
tar -xzf dnf_game_20230101000000.tar.gz

# 恢复数据库
mysql -u root -p dnf_game < dnf_game_20230101000000.sql
```

3. **配置文件备份**:

```bash
# 备份配置文件
cp config/config.yaml /path/to/backup/config.yaml.$(date +%Y%m%d%H%M%S)
```

### 4.5 常见问题处理

| 问题 | 可能原因 | 解决方案 |
| :--- | :--- | :--- |
| 服务启动失败 | 端口被占用 | 检查端口占用情况，修改配置文件中的端口 |
| 数据库连接失败 | 数据库服务未启动或配置错误 | 检查数据库服务状态，修改配置文件中的数据库连接信息 |
| Redis连接失败 | Redis服务未启动或配置错误 | 检查Redis服务状态，修改配置文件中的Redis连接信息 |
| Kafka连接失败 | Kafka服务未启动或配置错误 | 检查Kafka服务状态，修改配置文件中的Kafka连接信息 |
| 匹配失败 | 匹配队列中玩家不足 | 增加匹配池大小，调整匹配算法 |
| 战斗计算错误 | 战斗计算公式错误 | 检查并修正战斗计算公式 |
| 荣誉值计算错误 | 荣誉值计算公式错误 | 检查并修正荣誉值计算公式 |
| 排行榜更新失败 | 排行榜更新逻辑错误 | 检查并修正排行榜更新逻辑 |
| 系统响应缓慢 | 系统负载过高 | 增加服务器资源，优化代码性能 |
| 系统崩溃 | 内存溢出或代码bug | 检查日志，修复代码bug，增加服务器内存 |

## 5. 部署验证

### 5.1 功能验证

1. **测试PK场进入**:

```bash
curl -X POST http://localhost:8080/api/pk/queue \
  -H "Content-Type: application/json" \
  -d '{"playerId": 123, "level": 50, "matchValue": 1000}'
```

2. **测试PK记录查询**:

```bash
curl -X GET http://localhost:8080/api/pk/record/123
```

3. **测试排行榜查询**:

```bash
curl -X GET http://localhost:8080/api/pk/ranking
```

4. **测试玩家PK信息查询**:

```bash
curl -X GET http://localhost:8080/api/pk/info/123
```

### 5.2 性能验证

1. **使用JMeter进行压力测试**:

- 创建测试计划，设置100并发用户
- 测试API响应时间和成功率
- 验证系统在高负载下的稳定性

2. **使用ab进行性能测试**:

```bash
ab -n 1000 -c 100 http://localhost:8080/api/pk/ranking
```

### 5.3 安全验证

1. **测试SQL注入**:

```bash
curl -X POST http://localhost:8080/api/pk/queue \
  -H "Content-Type: application/json" \
  -d '{"playerId": "123 OR 1=1", "level": 50, "matchValue": 1000}'
```

2. **测试XSS攻击**:

```bash
curl -X POST http://localhost:8080/api/pk/queue \
  -H "Content-Type: application/json" \
  -d '{"playerId": 123, "level": 50, "matchValue": 1000, "name": "<script>alert(1)</script>"}'
```

3. **测试未授权访问**:

```bash
curl -X GET http://localhost:8080/api/pk/info/123
```

## 6. 部署文档更新记录

| 版本 | 更新日期 | 更新内容 | 更新人 |
| :--- | :--- | :--- | :--- |
| v1.0 | 2023-01-01 | 初始部署文档 | 系统管理员 |
| v1.1 | 2023-01-15 | 增加服务管理脚本 | 系统管理员 |
| v1.2 | 2023-02-01 | 增加监控与维护部分 | 系统管理员 |
| v1.3 | 2023-02-15 | 增加备份与恢复部分 | 系统管理员 |
| v1.4 | 2023-03-01 | 增加部署验证部分 | 系统管理员 |

## 7. 附录

### 7.1 配置文件说明

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `server.port` | int | 8080 | API服务端口 |
| `server.host` | string | 0.0.0.0 | API服务主机 |
| `database.dsn` | string | - | 数据库连接字符串 |
| `database.max_idle_conns` | int | 10 | 数据库最大空闲连接数 |
| `database.max_open_conns` | int | 100 | 数据库最大打开连接数 |
| `redis.addr` | string | localhost:6379 | Redis地址 |
| `redis.password` | string | "" | Redis密码 |
| `redis.db` | int | 0 | Redis数据库 |
| `kafka.brokers` | []string | ["localhost:9092"] | Kafka broker地址列表 |
| `kafka.topic` | string | pk-events | Kafka主题 |
| `pk.base_honor` | int | 10 | 基础荣誉值 |
| `pk.level_bonus` | int | 2 | 等级差距荣誉值奖励 |
| `pk.combo_bonus` | int | 1 | 连击荣誉值奖励 |
| `pk.max_queue_time` | int | 300 | 最大排队时间（秒） |
| `pk.battle_timeout` | int | 600 | 战斗超时时间（秒） |

### 7.2 环境变量说明

| 环境变量 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `GIN_MODE` | string | debug | Gin运行模式（debug/release/test） |
| `HOST` | string | 0.0.0.0 | API服务主机 |
| `PORT` | string | 8080 | API服务端口 |
| `DATABASE_DSN` | string | - | 数据库连接字符串 |
| `REDIS_ADDR` | string | localhost:6379 | Redis地址 |
| `REDIS_PASSWORD` | string | "" | Redis密码 |
| `REDIS_DB` | int | 0 | Redis数据库 |
| `KAFKA_BROKERS` | string | localhost:9092 | Kafka broker地址列表（逗号分隔） |
| `KAFKA_TOPIC` | string | pk-events | Kafka主题 |

### 7.3 命令参考

| 命令 | 说明 | 示例 |
| :--- | :--- | :--- |
| `go build` | 编译Go代码 | `go build -o output/pk-server cmd/pk/main.go` |
| `go run` | 运行Go代码 | `go run cmd/pk/main.go` |
| `go mod tidy` | 整理Go依赖 | `go mod tidy` |
| `systemctl start` | 启动系统服务 | `systemctl start pk-server` |
| `systemctl stop` | 停止系统服务 | `systemctl stop pk-server` |
| `systemctl status` | 查看系统服务状态 | `systemctl status pk-server` |
| `systemctl enable` | 设置系统服务开机自启 | `systemctl enable pk-server` |
| `journalctl -u` | 查看系统服务日志 | `journalctl -u pk-server` |
| `mysql` | 连接MySQL数据库 | `mysql -u root -p dnf_game` |
| `redis-cli` | 连接Redis | `redis-cli` |
| `kafka-topics.sh` | 管理Kafka主题 | `bin/kafka-topics.sh --list --bootstrap-server localhost:9092` |
| `netstat -tlnp` | 查看端口占用情况 | `netstat -tlnp | grep 8080` |
| `ps aux | grep` | 查看进程状态 | `ps aux | grep pk-server` |
| `top` | 查看系统资源使用情况 | `top` |
| `df -h` | 查看磁盘使用情况 | `df -h` |
| `free -h` | 查看内存使用情况 | `free -h` |