# 日志系统 - 数据库设计文档

## 1. 概述
本文档描述了日志系统的数据库设计，包括表结构、字段说明、索引设计等内容。日志系统的数据库设计主要用于存储结构化的日志数据，支持日志的查询、分析和审计。

## 2. 设计原则
- **结构化存储**：将日志数据结构化存储，便于查询和分析
- **高性能**：优化数据库结构和索引，提高查询性能
- **可扩展性**：支持日志数据的增长和扩展
- **可靠性**：确保日志数据的完整性和一致性
- **安全性**：保护敏感日志信息

## 3. 表结构设计

### 3.1 系统日志表 (`system_logs`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 日志ID |
| `log_time` | `DATETIME` | `NOT NULL` | 日志时间 |
| `level` | `VARCHAR(10)` | `NOT NULL` | 日志级别 (DEBUG, INFO, WARN, ERROR, FATAL, PANIC) |
| `logger_name` | `VARCHAR(100)` | `NOT NULL` | 日志记录器名称 |
| `message` | `TEXT` | `NOT NULL` | 日志消息 |
| `error` | `TEXT` | | 错误信息 |
| `caller_file` | `VARCHAR(255)` | | 调用文件 |
| `caller_line` | `INT` | | 调用行号 |
| `caller_function` | `VARCHAR(255)` | | 调用函数 |
| `server_id` | `INT` | | 服务器ID |
| `process_id` | `INT` | | 进程ID |
| `thread_id` | `VARCHAR(50)` | | 线程ID |
| `extra` | `JSON` | | 额外信息 (JSON格式) |

**索引设计**：
- `PRIMARY KEY`：`id`
- `INDEX`：`(log_time)`
- `INDEX`：`(level, log_time)`
- `INDEX`：`(logger_name, log_time)`
- `INDEX`：`(server_id, log_time)`

### 3.2 用户行为日志表 (`user_action_logs`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 日志ID |
| `log_time` | `DATETIME` | `NOT NULL` | 日志时间 |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID |
| `username` | `VARCHAR(100)` | `NOT NULL` | 用户名 |
| `action` | `VARCHAR(100)` | `NOT NULL` | 操作类型 |
| `target` | `VARCHAR(100)` | | 操作目标 |
| `target_id` | `BIGINT` | | 目标ID |
| `ip` | `VARCHAR(50)` | | IP地址 |
| `device` | `VARCHAR(100)` | | 设备信息 |
| `result` | `VARCHAR(20)` | `NOT NULL` | 操作结果 (SUCCESS, FAIL, PENDING) |
| `error_code` | `INT` | | 错误代码 |
| `error_message` | `TEXT` | | 错误消息 |
| `params` | `JSON` | | 操作参数 (JSON格式) |
| `server_id` | `INT` | | 服务器ID |

**索引设计**：
- `PRIMARY KEY`：`id`
- `INDEX`：`(log_time)`
- `INDEX`：`(user_id, log_time)`
- `INDEX`：`(action, log_time)`
- `INDEX`：`(result, log_time)`
- `INDEX`：`(server_id, log_time)`

### 3.3 业务操作日志表 (`business_logs`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 日志ID |
| `log_time` | `DATETIME` | `NOT NULL` | 日志时间 |
| `business_type` | `VARCHAR(100)` | `NOT NULL` | 业务类型 |
| `operation` | `VARCHAR(100)` | `NOT NULL` | 操作类型 |
| `business_id` | `BIGINT` | | 业务ID |
| `user_id` | `BIGINT` | | 操作用户ID |
| `amount` | `DECIMAL(20,2)` | | 金额 |
| `currency` | `VARCHAR(10)` | | 货币类型 |
| `status` | `VARCHAR(20)` | `NOT NULL` | 操作状态 (INIT, PROCESSING, SUCCESS, FAIL) |
| `error_code` | `INT` | | 错误代码 |
| `error_message` | `TEXT` | | 错误消息 |
| `details` | `JSON` | | 详细信息 (JSON格式) |
| `server_id` | `INT` | | 服务器ID |

**索引设计**：
- `PRIMARY KEY`：`id`
- `INDEX`：`(log_time)`
- `INDEX`：`(business_type, log_time)`
- `INDEX`：`(operation, log_time)`
- `INDEX`：`(business_id, log_time)`
- `INDEX`：`(user_id, log_time)`
- `INDEX`：`(status, log_time)`
- `INDEX`：`(server_id, log_time)`

### 3.4 安全事件日志表 (`security_logs`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 日志ID |
| `log_time` | `DATETIME` | `NOT NULL` | 日志时间 |
| `event_type` | `VARCHAR(100)` | `NOT NULL` | 事件类型 |
| `severity` | `VARCHAR(10)` | `NOT NULL` | 严重程度 (LOW, MEDIUM, HIGH, CRITICAL) |
| `user_id` | `BIGINT` | | 用户ID |
| `username` | `VARCHAR(100)` | | 用户名 |
| `ip` | `VARCHAR(50)` | `NOT NULL` | IP地址 |
| `device` | `VARCHAR(100)` | | 设备信息 |
| `action` | `VARCHAR(100)` | `NOT NULL` | 操作类型 |
| `result` | `VARCHAR(20)` | `NOT NULL` | 操作结果 (SUCCESS, FAIL, BLOCKED) |
| `description` | `TEXT` | `NOT NULL` | 事件描述 |
| `details` | `JSON` | | 详细信息 (JSON格式) |
| `server_id` | `INT` | | 服务器ID |

**索引设计**：
- `PRIMARY KEY`：`id`
- `INDEX`：`(log_time)`
- `INDEX`：`(event_type, log_time)`
- `INDEX`：`(severity, log_time)`
- `INDEX`：`(user_id, log_time)`
- `INDEX`：`(ip, log_time)`
- `INDEX`：`(server_id, log_time)`

### 3.5 日志聚合表 (`log_aggregations`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 聚合ID |
| `agg_date` | `DATE` | `NOT NULL` | 聚合日期 |
| `log_type` | `VARCHAR(50)` | `NOT NULL` | 日志类型 (system, user_action, business, security) |
| `level` | `VARCHAR(10)` | | 日志级别 |
| `count` | `INT` | `NOT NULL` | 日志数量 |
| `error_count` | `INT` | `NOT NULL DEFAULT 0` | 错误数量 |
| `server_id` | `INT` | | 服务器ID |

**索引设计**：
- `PRIMARY KEY`：`id`
- `UNIQUE INDEX`：`(agg_date, log_type, level, server_id)`
- `INDEX`：`(agg_date)`
- `INDEX`：`(log_type)`
- `INDEX`：`(server_id)`

## 4. 数据传输对象 (DTOs)

### 4.1 系统日志DTO
```go
type SystemLogDTO struct {
    ID             int64          `json:"id"`
    LogTime        string         `json:"log_time"`
    Level          string         `json:"level"`
    LoggerName     string         `json:"logger_name"`
    Message        string         `json:"message"`
    Error          string         `json:"error"`
    CallerFile     string         `json:"caller_file"`
    CallerLine     int            `json:"caller_line"`
    CallerFunction string         `json:"caller_function"`
    ServerID       int            `json:"server_id"`
    ProcessID      int            `json:"process_id"`
    ThreadID       string         `json:"thread_id"`
    Extra          map[string]interface{} `json:"extra"`
}
```

### 4.2 用户行为日志DTO
```go
type UserActionLogDTO struct {
    ID            int64          `json:"id"`
    LogTime       string         `json:"log_time"`
    UserID        int64          `json:"user_id"`
    Username      string         `json:"username"`
    Action        string         `json:"action"`
    Target        string         `json:"target"`
    TargetID      int64          `json:"target_id"`
    IP            string         `json:"ip"`
    Device        string         `json:"device"`
    Result        string         `json:"result"`
    ErrorCode     int            `json:"error_code"`
    ErrorMessage  string         `json:"error_message"`
    Params        map[string]interface{} `json:"params"`
    ServerID      int            `json:"server_id"`
}
```

### 4.3 业务操作日志DTO
```go
type BusinessLogDTO struct {
    ID            int64          `json:"id"`
    LogTime       string         `json:"log_time"`
    BusinessType  string         `json:"business_type"`
    Operation     string         `json:"operation"`
    BusinessID    int64          `json:"business_id"`
    UserID        int64          `json:"user_id"`
    Amount        float64        `json:"amount"`
    Currency      string         `json:"currency"`
    Status        string         `json:"status"`
    ErrorCode     int            `json:"error_code"`
    ErrorMessage  string         `json:"error_message"`
    Details       map[string]interface{} `json:"details"`
    ServerID      int            `json:"server_id"`
}
```

### 4.4 安全事件日志DTO
```go
type SecurityLogDTO struct {
    ID          int64          `json:"id"`
    LogTime     string         `json:"log_time"`
    EventType   string         `json:"event_type"`
    Severity    string         `json:"severity"`
    UserID      int64          `json:"user_id"`
    Username    string         `json:"username"`
    IP          string         `json:"ip"`
    Device      string         `json:"device"`
    Action      string         `json:"action"`
    Result      string         `json:"result"`
    Description string         `json:"description"`
    Details     map[string]interface{} `json:"details"`
    ServerID    int            `json:"server_id"`
}
```

### 4.5 日志聚合DTO
```go
type LogAggregationDTO struct {
    ID          int64   `json:"id"`
    AggDate     string  `json:"agg_date"`
    LogType     string  `json:"log_type"`
    Level       string  `json:"level"`
    Count       int     `json:"count"`
    ErrorCount  int     `json:"error_count"`
    ServerID    int     `json:"server_id"`
}
```

## 5. 数据库操作

### 5.1 系统日志操作
- **插入日志**：插入系统日志记录
- **查询日志**：根据条件查询系统日志
- **统计日志**：统计系统日志数量和分布
- **清理日志**：清理过期的系统日志

### 5.2 用户行为日志操作
- **插入日志**：插入用户行为日志记录
- **查询日志**：根据条件查询用户行为日志
- **统计日志**：统计用户行为日志数量和分布
- **分析行为**：分析用户行为模式

### 5.3 业务操作日志操作
- **插入日志**：插入业务操作日志记录
- **查询日志**：根据条件查询业务操作日志
- **统计日志**：统计业务操作日志数量和分布
- **分析业务**：分析业务操作模式和趋势

### 5.4 安全事件日志操作
- **插入日志**：插入安全事件日志记录
- **查询日志**：根据条件查询安全事件日志
- **统计日志**：统计安全事件日志数量和分布
- **分析安全**：分析安全事件模式和趋势

### 5.5 日志聚合操作
- **更新聚合**：更新日志聚合数据
- **查询聚合**：查询日志聚合数据
- **生成报表**：生成日志统计报表

## 6. 性能优化

### 6.1 索引优化
- **系统日志表**：针对常用查询条件添加合适的索引
- **用户行为日志表**：针对用户ID和操作类型添加索引
- **业务操作日志表**：针对业务类型和操作添加索引
- **安全事件日志表**：针对事件类型和严重程度添加索引
- **日志聚合表**：针对聚合日期和日志类型添加索引

### 6.2 存储优化
- **分区表**：对大表使用分区表，按时间分区
- **压缩存储**：对历史日志数据进行压缩存储
- **冷热分离**：将热数据和冷数据分离存储
- **批量插入**：使用批量插入减少数据库交互

### 6.3 查询优化
- **分页查询**：对大量数据的查询使用分页
- **字段选择**：只选择需要的字段，避免SELECT *
- **条件优化**：优化查询条件，使用索引
- **缓存机制**：缓存常用的查询结果

### 6.4 写入优化
- **异步写入**：使用异步写入减少对业务代码的影响
- **批量写入**：使用批量写入提高写入性能
- **延迟写入**：对非关键日志使用延迟写入
- **队列机制**：使用消息队列处理日志写入

## 7. 数据一致性

### 7.1 事务管理
- **日志写入**：使用事务确保日志数据的一致性
- **聚合更新**：使用事务确保聚合数据的一致性

### 7.2 数据同步
- **多服务器**：确保多服务器环境下的日志数据同步
- **主从复制**：使用主从复制提高数据可靠性

### 7.3 错误处理
- **写入失败**：处理日志写入失败的情况
- **数据恢复**：提供数据恢复机制

## 8. 扩展性考虑

### 8.1 数据量增长
- **分区策略**：按时间或服务器ID分区
- **分表策略**：按时间或日志类型分表
- **分库策略**：按服务器ID或业务类型分库

### 8.2 功能扩展
- **新日志类型**：支持添加新的日志类型
- **新字段**：支持添加新的日志字段
- **新索引**：支持添加新的索引

### 8.3 存储扩展
- **分布式存储**：使用分布式存储系统
- **云存储**：使用云存储服务
- **弹性伸缩**：支持存储的弹性伸缩

## 9. 监控与维护

### 9.1 监控指标
- **日志写入量**：单位时间内的日志写入量
- **日志查询性能**：日志查询的响应时间
- **数据库性能**：数据库的CPU、内存、磁盘使用情况
- **数据增长**：日志数据的增长速度

### 9.2 维护任务
- **数据清理**：定期清理过期日志数据
- **索引优化**：定期优化数据库索引
- **备份**：定期备份日志数据
- **统计**：定期生成日志统计数据

### 9.3 故障处理
- **写入失败**：处理日志写入失败的情况
- **查询缓慢**：处理日志查询缓慢的情况
- **数据丢失**：处理日志数据丢失的情况

## 10. 安全管理

### 10.1 访问控制
- **权限管理**：控制日志数据的访问权限
- **审计日志**：记录对日志数据的访问

### 10.2 数据保护
- **敏感信息**：过滤和加密敏感日志信息
- **数据传输**：加密日志数据的传输
- **数据存储**：加密敏感日志数据的存储

### 10.3 合规性
- **数据保留**：根据法规要求保留日志数据
- **数据销毁**：安全销毁过期日志数据
- **审计**：满足审计要求

## 11. 总结

本文档描述了日志系统的数据库设计，包括表结构、索引设计、DTOs和性能优化等内容。通过合理的数据库设计，可以确保日志系统的高性能、可扩展性和可靠性，为系统监控、问题排查、数据分析提供重要支持。

在实际应用中，应根据具体的业务需求和系统规模，调整数据库设计和优化策略，确保日志系统能够满足实际需求。