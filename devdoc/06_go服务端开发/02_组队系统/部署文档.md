# 组队系统部署文档

## 1. 环境准备

### 1.1 系统要求

| 组件 | 版本/要求 | 说明 |
| :--- | :--- | :--- |
| 操作系统 | Linux Ubuntu 20.04+ | 推荐使用Ubuntu 20.04或更高版本 |
| Go | 1.20+ | 编译和运行Go代码 |
| MySQL | 8.0+ | 存储队伍数据 |
| Redis | 7.0+ | 缓存热点数据 |
| Kafka | 3.0+ | 处理异步消息 |
| Nginx | 1.18+ | 反向代理和负载均衡 |
| Git | 2.20+ | 代码版本控制 |

### 1.2 网络要求

| 端口 | 用途 | 说明 |
| :--- | :--- | :--- |
| 8080 | HTTP API | 组队系统HTTP接口 |
| 8081 | WebSocket | 组队系统WebSocket接口 |
| 3306 | MySQL | 数据库连接 |
| 6379 | Redis | 缓存连接 |
| 9092 | Kafka | 消息队列连接 |

## 2. 部署步骤

### 2.1 代码获取

1. **克隆代码库**:
   ```bash
   git clone https://github.com/dnf-game-server/dnf-go-server.git
   cd dnf-go-server
   ```

2. **切换到组队系统分支**:
   ```bash
   git checkout feature/party-system
   ```

### 2.2 依赖安装

1. **安装Go依赖**:
   ```bash
   go mod tidy
   ```

2. **安装系统依赖**:
   ```bash
   sudo apt update
   sudo apt install -y mysql-server redis-server openjdk-11-jdk
   ```

3. **安装Kafka**:
   ```bash
   # 下载Kafka
   wget https://downloads.apache.org/kafka/3.0.0/kafka_2.13-3.0.0.tgz
   tar -xzf kafka_2.13-3.0.0.tgz
   cd kafka_2.13-3.0.0
   
   # 启动Zookeeper
   bin/zookeeper-server-start.sh config/zookeeper.properties &
   
   # 启动Kafka
   bin/kafka-server-start.sh config/server.properties &
   ```

### 2.3 配置文件设置

1. **复制配置文件**:
   ```bash
   cp config/config.yaml.example config/config.yaml
   ```

2. **编辑配置文件**:
   ```yaml
   # 服务器配置
   server:
     port: 8080
     host: 0.0.0.0

   # 数据库配置
   database:
     dsn: "root:password@tcp(localhost:3306)/dnf_game?charset=utf8mb4&parseTime=True&loc=Local"

   # Redis配置
   redis:
     addr: "localhost:6379"
     password: ""
     db: 0

   # Kafka配置
   kafka:
     brokers: ["localhost:9092"]
     topic: "party-events"

   # 队伍系统配置
   party:
     max_members: 4
     invitation_expiry_time: "5m"
     dungeon_enter_limit: 3
     chat_history_limit: 100
     websocket_ping_interval: "30s"
   ```

### 2.4 数据库初始化

1. **创建数据库**:
   ```bash
   mysql -u root -p
   CREATE DATABASE dnf_game CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   USE dnf_game;
   ```

2. **执行数据库脚本**:
   ```bash
   mysql -u root -p dnf_game < scripts/party_system.sql
   ```

### 2.5 编译和运行

1. **编译代码**:
   ```bash
   go build -o output/party-server cmd/party/main.go
   ```

2. **运行服务**:
   ```bash
   # 前台运行
   ./output/party-server
   
   # 后台运行
   nohup ./output/party-server > logs/party-server.log 2>&1 &
   ```

### 2.6 配置Nginx

1. **创建Nginx配置文件**:
   ```bash
   sudo nano /etc/nginx/sites-available/party-system
   ```

2. **编辑配置文件**:
   ```nginx
   server {
       listen 80;
       server_name party.example.com;

       location /api/party/ {
           proxy_pass http://localhost:8080;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
       }

       location /api/party/ws {
           proxy_pass http://localhost:8081;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

3. **启用配置**:
   ```bash
   sudo ln -s /etc/nginx/sites-available/party-system /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

## 3. 容器化部署

### 3.1 Docker Compose配置

1. **创建docker-compose.yml文件**:
   ```yaml
   version: '3.8'

   services:
     mysql:
       image: mysql:8.0
       environment:
         MYSQL_ROOT_PASSWORD: password
         MYSQL_DATABASE: dnf_game
       ports:
         - "3306:3306"
       volumes:
         - mysql-data:/var/lib/mysql
         - ./scripts/party_system.sql:/docker-entrypoint-initdb.d/init.sql

     redis:
       image: redis:7.0
       ports:
         - "6379:6379"

     zookeeper:
       image: confluentinc/cp-zookeeper:7.0.1
       environment:
         ZOOKEEPER_CLIENT_PORT: 2181
         ZOOKEEPER_TICK_TIME: 2000
       ports:
         - "2181:2181"

     kafka:
       image: confluentinc/cp-kafka:7.0.1
       depends_on:
         - zookeeper
       environment:
         KAFKA_BROKER_ID: 1
         KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
         KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
         KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
         KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
         KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
       ports:
         - "9092:9092"
         - "29092:29092"

     party-server:
       build:
         context: .
         dockerfile: Dockerfile.party
       depends_on:
         - mysql
         - redis
         - kafka
       ports:
         - "8080:8080"
         - "8081:8081"
       environment:
         - DATABASE_URL=mysql://root:password@mysql:3306/dnf_game
         - REDIS_URL=redis://redis:6379
         - KAFKA_BROKERS=kafka:9092

   volumes:
     mysql-data:
   ```

2. **创建Dockerfile**:
   ```dockerfile
   # Dockerfile.party
   FROM golang:1.20-alpine AS builder

   WORKDIR /app

   COPY go.mod go.sum ./
   RUN go mod download

   COPY . .

   RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o party-server cmd/party/main.go

   FROM alpine:latest

   WORKDIR /app

   COPY --from=builder /app/party-server .
   COPY --from=builder /app/config/config.yaml.example ./config/config.yaml

   EXPOSE 8080 8081

   CMD ["./party-server"]
   ```

3. **启动服务**:
   ```bash
   docker-compose up -d
   ```

## 4. 部署验证

### 4.1 服务状态检查

1. **检查服务是否启动**:
   ```bash
   # 查看进程
   ps aux | grep party-server
   
   # 查看端口
   netstat -tlnp | grep 8080
   netstat -tlnp | grep 8081
   ```

2. **检查日志**:
   ```bash
   tail -f logs/party-server.log
   ```

### 4.2 API测试

1. **测试创建队伍**:
   ```bash
   curl -X POST http://localhost:8080/api/party/create \
     -H "Content-Type: application/json" \
     -d '{"playerId": 123, "name": "测试队伍"}'
   ```

2. **测试获取队伍信息**:
   ```bash
   curl http://localhost:8080/api/party/info/1
   ```

### 4.3 数据库验证

1. **检查数据库表**:
   ```bash
   mysql -u root -p dnf_game
   SHOW TABLES;
   SELECT * FROM t_party;
   ```

## 5. 扩展部署

### 5.1 水平扩展

1. **多实例部署**:
   - 部署多个party-server实例
   - 使用Nginx进行负载均衡

2. **Nginx负载均衡配置**:
   ```nginx
   upstream party_servers {
       server localhost:8080;
       server localhost:8082;
       server localhost:8083;
   }

   server {
       listen 80;
       server_name party.example.com;

       location /api/party/ {
           proxy_pass http://party_servers;
           # 其他配置...
       }
   }
   ```

### 5.2 高可用配置

1. **数据库主从复制**:
   - 配置MySQL主从复制
   - 实现数据库高可用

2. **Redis集群**:
   - 配置Redis集群
   - 提高缓存可用性

3. **Kafka集群**:
   - 配置Kafka集群
   - 提高消息队列可靠性

## 6. 部署注意事项

### 6.1 安全配置

1. **数据库安全**:
   - 设置强密码
   - 限制数据库访问IP
   - 定期备份数据库

2. **服务安全**:
   - 使用HTTPS
   - 配置防火墙
   - 定期更新依赖

3. **Kafka安全**:
   - 配置Kafka认证
   - 限制Kafka访问

### 6.2 性能优化

1. **数据库优化**:
   - 调整MySQL参数
   - 优化数据库索引
   - 使用连接池

2. **服务优化**:
   - 调整Go运行参数
   - 优化内存使用
   - 使用缓存减少数据库查询

3. **网络优化**:
   - 配置TCP参数
   - 使用CDN加速静态资源
   - 优化WebSocket连接

### 6.3 故障处理

1. **服务故障**:
   - 检查日志
   - 重启服务
   - 查看系统资源

2. **数据库故障**:
   - 检查数据库状态
   - 恢复备份
   - 切换到从库

3. **消息队列故障**:
   - 检查Kafka状态
   - 重启Kafka服务
   - 重新发送消息

## 7. 监控与维护

### 7.1 监控配置

1. **Prometheus监控**:
   - 配置Prometheus采集指标
   - 配置Grafana面板

2. **日志监控**:
   - 配置ELK栈
   - 实时监控日志

3. **告警配置**:
   - 配置服务宕机告警
   - 配置数据库异常告警
   - 配置性能异常告警

### 7.2 定期维护

1. **数据库维护**:
   - 定期备份数据库
   - 清理过期数据
   - 优化数据库表

2. **服务维护**:
   - 定期重启服务
   - 更新依赖
   - 部署新版本

3. **系统维护**:
   - 清理系统日志
   - 更新系统补丁
   - 监控系统资源

## 8. 部署总结

- **部署方式**:
  - 支持传统部署和容器化部署
  - 可根据实际需求选择合适的部署方式

- **部署规模**:
  - 单实例部署适合开发和测试环境
  - 多实例部署适合生产环境
  - 高可用部署适合关键业务场景

- **部署建议**:
  - 遵循最小权限原则
  - 配置完善的监控和告警
  - 建立定期维护机制
  - 制定故障应急预案

- **后续优化**:
  - 自动化部署脚本
  - 持续集成/持续部署(CI/CD)
  - 服务网格集成