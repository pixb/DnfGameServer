# 事件系统设计文档

## 文档导航

本文档已拆分为以下子文档，便于维护和阅读：

- [系统概述](10_事件系统/系统概述.md)
- [Java代码分析](10_事件系统/Java代码分析.md)
- [Go实现方案](10_事件系统/Go实现方案.md)
- [API文档](10_事件系统/API文档.md)
- [数据库设计文档](10_事件系统/数据库设计文档.md)
- [业务流程文档](10_事件系统/业务流程文档.md)
- [测试用例文档](10_事件系统/测试用例文档.md)
- [部署文档](10_事件系统/部署文档.md)
- [监控与维护](10_事件系统/监控与维护.md)
- [变更记录](10_事件系统/变更记录.md)

## 概述

事件系统是游戏中的重要功能，用于管理游戏内各种活动事件，包括活动列表查询、活动参与、奖励领取等。

## Java 代码分析

### 核心控制器
- **文件位置**: `src/main/java/com/dnfm/game/event/EventController.java`
- **处理器数量**: 2 个 @RequestMapping 方法

### 核心功能

#### 1. 查询活动访问时间 (REQ_QUERY_ACCESS_TIME_BY_EVENT)
- **方法**: `ReqQueryAccessTimeByEvent(IoSession session, REQ_QUERY_ACCESS_TIME_BY_EVENT reqContentsPreviewReward)`
- **功能**:
  - 查询活动的访问时间
  - 返回当前服务器时间
  - 用于客户端同步时间

#### 2. 获取活动奖励 (REQ_EVENT_GET_REWARD)
- **方法**: `ReqEventGetReward(IoSession session, REQ_EVENT_GET_REWARD reqEventGetReward)`
- **功能**:
  - 获取活动奖励
  - 当前实现返回错误码 3（未实现）

## Go 实现方案

### 1. ProtoBuf 消息定义

#### event.proto
```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "gen/dnf/v1";

import "dnf/v1/common.proto";

// 活动信息
message EventInfo {
    uint32 id = 1;
    string name = 2;
    string description = 3;
    uint32 type = 4;
    uint32 status = 5;
    uint64 start_time = 6;
    uint64 end_time = 7;
    repeated EventReward rewards = 8;
    uint32 level_requirement = 9;
    uint32 vip_requirement = 10;
    string icon = 11;
    uint32 sort = 12;
}

// 活动奖励
message EventReward {
    uint32 id = 1;
    uint32 reward_type = 2;
    uint32 reward_index = 3;
    uint32 reward_count = 4;
    uint32 condition_type = 5;
    uint32 condition_value = 6;
    bool claimed = 7;
    uint64 claim_time = 8;
}

// 活动进度
message EventProgress {
    uint32 event_id = 1;
    uint32 progress_type = 2;
    uint32 progress_value = 3;
    uint32 target_value = 4;
    bool completed = 5;
}

// 查询活动列表请求
message EventListRequest {
    uint32 type = 1;
    uint32 status = 2;
}

// 查询活动列表响应
message EventListResponse {
    repeated EventInfo events = 1;
    uint32 error = 2;
    string message = 3;
}

// 查询活动详情请求
message EventDetailRequest {
    uint32 event_id = 1;
}

// 查询活动详情响应
message EventDetailResponse {
    EventInfo event = 1;
    repeated EventProgress progress = 2;
    uint32 error = 3;
    string message = 4;
}

// 查询活动访问时间请求
message QueryAccessTimeByEventRequest {
    uint32 transid = 1;
}

// 查询活动访问时间响应
message QueryAccessTimeByEventResponse {
    uint64 accesstime = 1;
    uint32 error = 2;
    string message = 3;
}

// 获取活动奖励请求
message EventGetRewardRequest {
    uint32 event_id = 1;
    uint32 reward_id = 2;
    uint32 transid = 3;
}

// 获取活动奖励响应
message EventGetRewardResponse {
    repeated StackableItem rewards = 1;
    uint32 error = 2;
    string message = 3;
}

// 活动进度更新请求
message EventProgressUpdateRequest {
    uint32 event_id = 1;
    uint32 progress_type = 2;
    uint32 progress_value = 3;
}

// 活动进度更新响应
message EventProgressUpdateResponse {
    repeated EventProgress progress = 1;
    uint32 error = 2;
    string message = 3;
}

// 活动参与请求
message EventParticipateRequest {
    uint32 event_id = 1;
    uint32 participate_type = 2;
}

// 活动参与响应
message EventParticipateResponse {
    uint32 error = 2;
    string message = 3;
}
```

### 2. 数据模型设计

#### models/event.go
```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// Event 活动
type Event struct {
    ID              uint64    `gorm:"primaryKey;column:id" json:"id"`
    Name            string    `gorm:"column:name;size:100" json:"name"`
    Description     string    `gorm:"column:description;size:500" json:"description"`
    Type            uint32    `gorm:"column:type;index" json:"type"`
    Status          uint32    `gorm:"column:status;index" json:"status"`
    StartTime       time.Time `gorm:"column:startTime;index" json:"start_time"`
    EndTime         time.Time `gorm:"column:endTime;index" json:"end_time"`
    LevelRequirement uint32   `gorm:"column:levelRequirement" json:"level_requirement"`
    VIPRequirement  uint32    `gorm:"column:vipRequirement" json:"vip_requirement"`
    Icon            string    `gorm:"column:icon;size:200" json:"icon"`
    Sort            uint32    `gorm:"column:sort" json:"sort"`
    CreateTime      time.Time `gorm:"column:createTime" json:"create_time"`
    UpdateTime      time.Time `gorm:"column:updateTime" json:"update_time"`
}

func (Event) TableName() string {
    return "t_event"
}

// EventReward 活动奖励
type EventReward struct {
    ID             uint64    `gorm:"primaryKey;column:id" json:"id"`
    EventID        uint32    `gorm:"column:eventId;index" json:"event_id"`
    RewardType     uint32    `gorm:"column:rewardType" json:"reward_type"`
    RewardIndex    uint32    `gorm:"column:rewardIndex" json:"reward_index"`
    RewardCount    uint32    `gorm:"column:rewardCount" json:"reward_count"`
    ConditionType  uint32    `gorm:"column:conditionType" json:"condition_type"`
    ConditionValue uint32    `gorm:"column:conditionValue" json:"condition_value"`
    Sort           uint32    `gorm:"column:sort" json:"sort"`
    CreateTime     time.Time `gorm:"column:createTime" json:"create_time"`
}

func (EventReward) TableName() string {
    return "t_event_reward"
}

// EventProgress 活动进度
type EventProgress struct {
    ID            uint64    `gorm:"primaryKey;column:id" json:"id"`
    RoleID        uint64    `gorm:"column:roleId;index:idx_role_event" json:"role_id"`
    EventID       uint32    `gorm:"column:eventId;index:idx_role_event" json:"event_id"`
    ProgressType  uint32    `gorm:"column:progressType" json:"progress_type"`
    ProgressValue uint32    `gorm:"column:progressValue" json:"progress_value"`
    TargetValue   uint32    `gorm:"column:targetValue" json:"target_value"`
    Completed     bool      `gorm:"column:completed" json:"completed"`
    CreateTime    time.Time `gorm:"column:createTime" json:"create_time"`
    UpdateTime    time.Time `gorm:"column:updateTime" json:"update_time"`
}

func (EventProgress) TableName() string {
    return "t_event_progress"
}

// EventRewardClaim 活动奖励领取记录
type EventRewardClaim struct {
    ID         uint64    `gorm:"primaryKey;column:id" json:"id"`
    RoleID     uint64    `gorm:"column:roleId;index" json:"role_id"`
    EventID    uint32    `gorm:"column:eventId;index" json:"event_id"`
    RewardID   uint32    `gorm:"column:rewardId;index" json:"reward_id"`
    ClaimTime  time.Time `gorm:"column:claimTime" json:"claim_time"`
    CreateTime time.Time `gorm:"column:createTime" json:"create_time"`
}

func (EventRewardClaim) TableName() string {
    return "t_event_reward_claim"
}

// EventParticipation 活动参与记录
type EventParticipation struct {
    ID             uint64    `gorm:"primaryKey;column:id" json:"id"`
    RoleID         uint64    `gorm:"column:roleId;index:idx_role_event" json:"role_id"`
    EventID        uint32    `gorm:"column:eventId;index:idx_role_event" json:"event_id"`
    ParticipateType uint32   `gorm:"column:participateType" json:"participate_type"`
    ParticipateTime time.Time `gorm:"column:participateTime" json:"participate_time"`
    CreateTime     time.Time `gorm:"column:createTime" json:"create_time"`
}

func (EventParticipation) TableName() string {
    return "t_event_participation"
}
```

### 3. Handler 实现

#### handlers/event.go
```go
package handlers

import (
    "context"

    "github.com/pixb/DnfGameServer/dnf-go-server/internal/game/event_service"
    "github.com/pixb/DnfGameServer/dnf-go-server/internal/network"
    dnfv1 "github.com/pixb/DnfGameServer/dnf-go-server/proto/gen/dnf/v1"
    "google.golang.org/protobuf/proto"
)

type EventHandler struct {
    eventService *event_service.EventService
}

func NewEventHandler(eventService *event_service.EventService) *EventHandler {
    return &EventHandler{
        eventService: eventService,
    }
}

// EventListHandler 活动列表处理器
func (h *EventHandler) EventListHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.EventListRequest)
    if !ok {
        return
    }

    events, err := h.eventService.GetEventList(context.Background(), req.Type, req.Status)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get event list")
        return
    }

    resp := &dnfv1.EventListResponse{
        Events: events,
        Error:  0,
    }
    sess.Send(resp)
}

// EventDetailHandler 活动详情处理器
func (h *EventHandler) EventDetailHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.EventDetailRequest)
    if !ok {
        return
    }

    event, progress, err := h.eventService.GetEventDetail(context.Background(), sess.RoleID, req.EventId)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get event detail")
        return
    }

    resp := &dnfv1.EventDetailResponse{
        Event:   event,
        Progress: progress,
        Error:   0,
    }
    sess.Send(resp)
}

// QueryAccessTimeByEventHandler 查询活动访问时间处理器
func (h *EventHandler) QueryAccessTimeByEventHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.QueryAccessTimeByEventRequest)
    if !ok {
        return
    }

    accessTime, err := h.eventService.GetAccessTime(context.Background())
    if err != nil {
        h.sendError(sess, req, 1, "failed to get access time")
        return
    }

    resp := &dnfv1.QueryAccessTimeByEventResponse{
        Accesstime: accessTime,
        Error:      0,
    }
    sess.Send(resp)
}

// EventGetRewardHandler 获取活动奖励处理器
func (h *EventHandler) EventGetRewardHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.EventGetRewardRequest)
    if !ok {
        return
    }

    rewards, err := h.eventService.GetEventReward(context.Background(), sess.RoleID, req.EventId, req.RewardId)
    if err != nil {
        h.sendError(sess, req, 3, "failed to get event reward")
        return
    }

    resp := &dnfv1.EventGetRewardResponse{
        Rewards: rewards,
        Error:   0,
    }
    sess.Send(resp)
}

// EventProgressUpdateHandler 活动进度更新处理器
func (h *EventHandler) EventProgressUpdateHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.EventProgressUpdateRequest)
    if !ok {
        return
    }

    progress, err := h.eventService.UpdateEventProgress(context.Background(), sess.RoleID, req.EventId, req.ProgressType, req.ProgressValue)
    if err != nil {
        h.sendError(sess, req, 1, "failed to update event progress")
        return
    }

    resp := &dnfv1.EventProgressUpdateResponse{
        Progress: progress,
        Error:    0,
    }
    sess.Send(resp)
}

// EventParticipateHandler 活动参与处理器
func (h *EventHandler) EventParticipateHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.EventParticipateRequest)
    if !ok {
        return
    }

    err := h.eventService.ParticipateEvent(context.Background(), sess.RoleID, req.EventId, req.ParticipateType)
    if err != nil {
        h.sendError(sess, req, 1, "failed to participate event")
        return
    }

    resp := &dnfv1.EventParticipateResponse{
        Error: 0,
    }
    sess.Send(resp)
}

func (h *EventHandler) sendError(sess *network.Session, req proto.Message, code uint32, message string) {
    switch req.(type) {
    case *dnfv1.EventListRequest:
        resp := &dnfv1.EventListResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.EventDetailRequest:
        resp := &dnfv1.EventDetailResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.QueryAccessTimeByEventRequest:
        resp := &dnfv1.QueryAccessTimeByEventResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.EventGetRewardRequest:
        resp := &dnfv1.EventGetRewardResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.EventProgressUpdateRequest:
        resp := &dnfv1.EventProgressUpdateResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    case *dnfv1.EventParticipateRequest:
        resp := &dnfv1.EventParticipateResponse{
            Error:   code,
            Message: message,
        }
        sess.Send(resp)
    }
}
```

### 4. Service 实现

#### event_service/event.go
```go
package event_service

import (
    "context"
    "time"

    "github.com/pixb/DnfGameServer/dnf-go-server/store"
    "github.com/pixb/DnfGameServer/dnf-go-server/internal/db/models"
    dnfv1 "github.com/pixb/DnfGameServer/dnf-go-server/proto/gen/dnf/v1"
)

type EventService struct {
    store *store.Store
}

func NewEventService(store *store.Store) *EventService {
    return &EventService{
        store: store,
    }
}

// GetEventList 获取活动列表
func (s *EventService) GetEventList(ctx context.Context, eventType, status uint32) ([]*dnfv1.EventInfo, error) {
    now := time.Now()

    events, err := s.store.GetEvents(ctx, &store.FindEvent{
        Type:   eventType,
        Status: status,
    })
    if err != nil {
        return nil, err
    }

    result := make([]*dnfv1.EventInfo, 0, len(events))
    for _, event := range events {
        // 检查活动是否在有效期内
        if now.Before(event.StartTime) || now.After(event.EndTime) {
            continue
        }

        // 获取活动奖励
        rewards, err := s.store.GetEventRewards(ctx, uint32(event.ID))
        if err != nil {
            continue
        }

        pbRewards := make([]*dnfv1.EventReward, len(rewards))
        for i, reward := range rewards {
            pbRewards[i] = &dnfv1.EventReward{
                Id:             reward.ID,
                RewardType:     reward.RewardType,
                RewardIndex:    reward.RewardIndex,
                RewardCount:    reward.RewardCount,
                ConditionType:  reward.ConditionType,
                ConditionValue: reward.ConditionValue,
            }
        }

        result = append(result, &dnfv1.EventInfo{
            Id:              uint32(event.ID),
            Name:            event.Name,
            Description:     event.Description,
            Type:            event.Type,
            Status:          event.Status,
            StartTime:       event.StartTime.Unix(),
            EndTime:         event.EndTime.Unix(),
            Rewards:         pbRewards,
            LevelRequirement: event.LevelRequirement,
            VipRequirement:  event.VIPRequirement,
            Icon:            event.Icon,
            Sort:            event.Sort,
        })
    }

    return result, nil
}

// GetEventDetail 获取活动详情
func (s *EventService) GetEventDetail(ctx context.Context, roleID uint64, eventID uint32) (*dnfv1.EventInfo, []*dnfv1.EventProgress, error) {
    // 1. 获取活动信息
    event, err := s.store.GetEventByID(ctx, eventID)
    if err != nil {
        return nil, nil, err
    }

    // 2. 获取活动奖励
    rewards, err := s.store.GetEventRewards(ctx, eventID)
    if err != nil {
        return nil, nil, err
    }

    pbRewards := make([]*dnfv1.EventReward, len(rewards))
    for i, reward := range rewards {
        pbRewards[i] = &dnfv1.EventReward{
            Id:             reward.ID,
            RewardType:     reward.RewardType,
            RewardIndex:    reward.RewardIndex,
            RewardCount:    reward.RewardCount,
            ConditionType:  reward.ConditionType,
            ConditionValue: reward.ConditionValue,
        }
    }

    // 3. 获取活动进度
    progressList, err := s.store.GetEventProgress(ctx, roleID, eventID)
    if err != nil {
        return nil, nil, err
    }

    pbProgress := make([]*dnfv1.EventProgress, len(progressList))
    for i, progress := range progressList {
        pbProgress[i] = &dnfv1.EventProgress{
            EventId:       progress.EventID,
            ProgressType:  progress.ProgressType,
            ProgressValue: progress.ProgressValue,
            TargetValue:   progress.TargetValue,
            Completed:     progress.Completed,
        }
    }

    eventInfo := &dnfv1.EventInfo{
        Id:              uint32(event.ID),
        Name:            event.Name,
        Description:     event.Description,
        Type:            event.Type,
        Status:          event.Status,
        StartTime:       event.StartTime.Unix(),
        EndTime:         event.EndTime.Unix(),
        Rewards:         pbRewards,
        LevelRequirement: event.LevelRequirement,
        VipRequirement:  event.VIPRequirement,
        Icon:            event.Icon,
        Sort:            event.Sort,
    }

    return eventInfo, pbProgress, nil
}

// GetAccessTime 获取访问时间
func (s *EventService) GetAccessTime(ctx context.Context) (uint64, error) {
    return time.Now().Unix(), nil
}

// GetEventReward 获取活动奖励
func (s *EventService) GetEventReward(ctx context.Context, roleID uint64, eventID, rewardID uint32) ([]*dnfv1.StackableItem, error) {
    // 1. 检查是否已领取
    claimed, err := s.store.GetEventRewardClaim(ctx, roleID, eventID, rewardID)
    if err == nil && claimed != nil {
        return nil, store.ErrInvalidParam
    }

    // 2. 获取奖励信息
    reward, err := s.store.GetEventRewardByID(ctx, rewardID)
    if err != nil {
        return nil, err
    }

    // 3. 检查活动进度是否满足条件
    progress, err := s.store.GetEventProgressByType(ctx, roleID, eventID, reward.ConditionType)
    if err != nil || progress.ProgressValue < reward.ConditionValue {
        return nil, store.ErrInvalidParam
    }

    // 4. 发放奖励
    bagItem := &models.BagItem{
        RoleID:    roleID,
        ItemIndex: reward.RewardIndex,
        Count:     reward.RewardCount,
        CreateTime: time.Now(),
        UpdateTime: time.Now(),
    }

    err = s.store.CreateBagItem(ctx, bagItem)
    if err != nil {
        return nil, err
    }

    // 5. 记录领取
    claim := &models.EventRewardClaim{
        RoleID:    roleID,
        EventID:   eventID,
        RewardID:  rewardID,
        ClaimTime: time.Now(),
        CreateTime: time.Now(),
    }

    err = s.store.CreateEventRewardClaim(ctx, claim)
    if err != nil {
        return nil, err
    }

    return []*dnfv1.StackableItem{
        {
            Index: reward.RewardIndex,
            Count: reward.RewardCount,
        },
    }, nil
}

// UpdateEventProgress 更新活动进度
func (s *EventService) UpdateEventProgress(ctx context.Context, roleID uint64, eventID, progressType, progressValue uint32) ([]*dnfv1.EventProgress, error) {
    // 1. 获取或创建进度记录
    progress, err := s.store.GetEventProgressByType(ctx, roleID, eventID, progressType)
    if err != nil {
        newProgress := &models.EventProgress{
            RoleID:        roleID,
            EventID:       eventID,
            ProgressType:  progressType,
            ProgressValue: progressValue,
            TargetValue:   progressValue,
            Completed:     progressValue >= progressValue,
            CreateTime:    time.Now(),
            UpdateTime:    time.Now(),
        }

        err = s.store.CreateEventProgress(ctx, newProgress)
        if err != nil {
            return nil, err
        }

        progress = newProgress
    } else {
        progress.ProgressValue += progressValue
        progress.Completed = progress.ProgressValue >= progress.TargetValue
        progress.UpdateTime = time.Now()

        err = s.store.UpdateEventProgress(ctx, progress)
        if err != nil {
            return nil, err
        }
    }

    // 2. 获取所有进度
    progressList, err := s.store.GetEventProgress(ctx, roleID, eventID)
    if err != nil {
        return nil, err
    }

    pbProgress := make([]*dnfv1.EventProgress, len(progressList))
    for i, p := range progressList {
        pbProgress[i] = &dnfv1.EventProgress{
            EventId:       p.EventID,
            ProgressType:  p.ProgressType,
            ProgressValue: p.ProgressValue,
            TargetValue:   p.TargetValue,
            Completed:     p.Completed,
        }
    }

    return pbProgress, nil
}

// ParticipateEvent 参与活动
func (s *EventService) ParticipateEvent(ctx context.Context, roleID uint64, eventID, participateType uint32) error {
    // 1. 检查活动是否存在
    event, err := s.store.GetEventByID(ctx, eventID)
    if err != nil {
        return err
    }

    // 2. 检查活动是否在有效期内
    now := time.Now()
    if now.Before(event.StartTime) || now.After(event.EndTime) {
        return store.ErrInvalidParam
    }

    // 3. 记录参与
    participation := &models.EventParticipation{
        RoleID:          roleID,
        EventID:         eventID,
        ParticipateType: participateType,
        ParticipateTime: time.Now(),
        CreateTime:      time.Now(),
    }

    return s.store.CreateEventParticipation(ctx, participation)
}
```

## 实现步骤

### 步骤 1: 创建 ProtoBuf 定义
1. 创建 `proto/dnf/v1/event.proto`
2. 定义所有事件相关的消息
3. 运行 `buf generate` 生成 Go 代码

### 步骤 2: 创建数据模型
1. 创建 `internal/db/models/event.go`
2. 定义 Event、EventReward、EventProgress、EventRewardClaim、EventParticipation 模型
3. 运行数据库迁移

### 步骤 3: 实现 Handler
1. 创建 `internal/game/handlers/event.go`
2. 实现所有事件相关的处理器
3. 注册消息路由

### 步骤 4: 实现 Service
1. 创建 `internal/game/event_service/event.go`
2. 实现业务逻辑
3. 集成数据库操作

### 步骤 5: 编写测试用例
1. 创建 `tests/event_test.go`
2. 编写所有功能的测试用例
3. 运行测试验证

### 步骤 6: 集成到主服务器
1. 在 `cmd/server/main.go` 中注册 Handler
2. 更新消息注册表
3. 测试完整流程

## 注意事项

1. **活动时间**: 正确处理活动开始和结束时间
2. **进度管理**: 正确管理活动进度和完成状态
3. **奖励发放**: 确保奖励发放的原子性
4. **重复领取**: 防止重复领取奖励
5. **活动状态**: 支持活动状态的动态切换
6. **权限验证**: 验证玩家是否有权限参与活动
7. **错误处理**: 完善的错误处理和日志记录
8. **性能优化**: 大量活动数据时需要优化查询性能
