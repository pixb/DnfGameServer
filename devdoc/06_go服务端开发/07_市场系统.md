# 市场系统设计文档

## 1. 系统概述

### 1.1 系统简介

市场系统是游戏中玩家之间进行物品交易的核心功能，支持玩家上架物品、购买物品、搜索物品等操作。该系统为玩家提供了一个安全、便捷的交易平台，促进游戏内经济的流通和活跃。

### 1.2 核心功能

- **市场列表查询**: 查询市场中的物品列表，支持分页、筛选和排序
- **物品上架**: 玩家将物品上架到市场，设置价格和数量
- **物品下架**: 玩家下架自己的物品，将物品重新收回背包
- **物品购买**: 玩家购买市场中的物品，自动完成交易流程
- **市场搜索**: 搜索市场中的物品，支持按名称、类型、等级和价格范围搜索
- **我的上架列表**: 查询玩家自己上架的物品，管理上架状态

### 1.3 系统架构

市场系统采用模块化设计，包括数据模型、业务逻辑、API接口三个主要层次：

1. **数据模型层**：负责数据存储和访问，包括市场物品和交易记录
2. **业务逻辑层**：实现核心交易功能，包括上架、下架、购买等操作
3. **API接口层**：提供HTTP和gRPC接口，处理客户端请求

### 1.4 依赖关系

- **背包系统**：物品操作依赖背包系统
- **角色系统**：角色信息和货币管理
- **物品系统**：物品数据和属性管理

## 2. Java 代码分析

### 2.1 核心控制器

| 控制器类 | 主要功能 | 关键方法 |
| :--- | :--- | :--- |
| `MarketController` | 市场系统主控制器 | `handleMarketList`, `handleMarketAdd`, `handleMarketRemove`, `handleMarketBuy`, `handleMarketSearch`, `handleMarketMyList` |

### 2.2 核心功能

#### 2.2.1 市场列表查询

**功能描述**：查询市场中的物品列表，支持分页、筛选和排序

**请求处理**：`REQ_MARKET_LIST`

**核心逻辑**：
1. 验证请求参数
2. 查询市场物品
3. 分页处理
4. 返回物品列表

#### 2.2.2 物品上架

**功能描述**：玩家将物品上架到市场，设置价格和数量

**请求处理**：`REQ_MARKET_ADD`

**核心逻辑**：
1. 验证物品存在性
2. 验证物品所有权
3. 从背包移除物品
4. 添加到市场

#### 2.2.3 物品下架

**功能描述**：玩家下架自己的物品，将物品重新收回背包

**请求处理**：`REQ_MARKET_REMOVE`

**核心逻辑**：
1. 验证市场物品存在性
2. 验证物品所有权
3. 将物品返回到背包
4. 删除市场物品

#### 2.2.4 物品购买

**功能描述**：玩家购买市场中的物品，自动完成交易流程

**请求处理**：`REQ_MARKET_BUY`

**核心逻辑**：
1. 验证市场物品存在性
2. 验证买家货币
3. 扣除买家货币
4. 添加物品到买家背包
5. 添加货币到卖家
6. 更新市场物品状态
7. 记录交易

#### 2.2.5 市场搜索

**功能描述**：搜索市场中的物品，支持按名称、类型、等级和价格范围搜索

**请求处理**：`REQ_MARKET_SEARCH`

**核心逻辑**：
1. 验证搜索参数
2. 执行搜索操作
3. 分页处理
4. 返回搜索结果

#### 2.2.6 我的上架列表

**功能描述**：查询玩家自己上架的物品，管理上架状态

**请求处理**：`REQ_MARKET_MY_LIST`

**核心逻辑**：
1. 验证角色身份
2. 查询玩家上架的物品
3. 分页处理
4. 返回上架列表

## 3. Go 实现方案

### 3.1 数据模型

#### 3.1.1 市场物品

```go
type MarketItem struct {
    ID           uint64    `gorm:"primaryKey;column:id" json:"id"`
    SellerGUID   uint64    `gorm:"column:sellerGuid;index" json:"seller_guid"`
    SellerName   string    `gorm:"column:sellerName;size:50" json:"seller_name"`
    ItemGUID     uint64    `gorm:"column:itemGuid;uniqueIndex" json:"item_guid"`
    ItemIndex    uint32    `gorm:"column:itemIndex;index" json:"item_index"`
    ItemCount    uint32    `gorm:"column:itemCount" json:"item_count"`
    Bind         bool      `gorm:"column:bind" json:"bind"`
    Quality      uint32    `gorm:"column:quality" json:"quality"`
    Level        uint32    `gorm:"column:level;index" json:"level"`
    Price        uint64    `gorm:"column:price;index" json:"price"`
    CurrencyType uint32    `gorm:"column:currencyType" json:"currency_type"`
    Status       uint32    `gorm:"column:status;default:0" json:"status"`
    CreateTime   time.Time `gorm:"column:createTime" json:"create_time"`
    ExpireTime   time.Time `gorm:"column:expireTime;index" json:"expire_time"`
    UpdateTime   time.Time `gorm:"column:updateTime" json:"update_time"`
}

func (MarketItem) TableName() string {
    return "t_market_item"
}
```

#### 3.1.2 市场交易记录

```go
type MarketRecord struct {
    ID          uint64    `gorm:"primaryKey;column:id" json:"id"`
    MarketID    uint64    `gorm:"column:marketId;index" json:"market_id"`
    SellerGUID  uint64    `gorm:"column:sellerGuid;index" json:"seller_guid"`
    BuyerGUID   uint64    `gorm:"column:buyerGuid;index" json:"buyer_guid"`
    ItemGUID    uint64    `gorm:"column:itemGuid" json:"item_guid"`
    ItemIndex   uint32    `gorm:"column:itemIndex" json:"item_index"`
    ItemCount   uint32    `gorm:"column:itemCount" json:"item_count"`
    Price       uint64    `gorm:"column:price" json:"price"`
    CurrencyType uint32   `gorm:"column:currencyType" json:"currency_type"`
    Tax         uint64    `gorm:"column:tax" json:"tax"`
    TradeTime   time.Time `gorm:"column:tradeTime" json:"trade_time"`
    CreateTime  time.Time `gorm:"column:createTime" json:"create_time"`
}

func (MarketRecord) TableName() string {
    return "t_market_record"
}
```

### 3.2 Protobuf 消息定义

```protobuf
syntax = "proto3";

package dnf.v1;

option go_package = "gen/dnf/v1";

import "dnf/v1/common.proto";

// 市场物品信息
message MarketItem {
    uint64 id = 1;
    uint64 seller_guid = 2;
    string seller_name = 3;
    uint64 item_guid = 4;
    uint32 item_index = 5;
    uint32 item_count = 6;
    bool bind = 7;
    uint32 quality = 8;
    uint32 level = 9;
    uint64 price = 10;
    uint32 currency_type = 11;
    uint64 create_time = 12;
    uint64 expire_time = 13;
}

// 市场列表请求
message MarketListRequest {
    uint32 page = 1;
    uint32 page_size = 2;
    uint32 item_type = 3;
    uint32 min_level = 4;
    uint32 max_level = 5;
    uint64 min_price = 6;
    uint64 max_price = 7;
}

// 市场列表响应
message MarketListResponse {
    repeated MarketItem items = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 物品上架请求
message MarketAddRequest {
    uint64 item_guid = 1;
    uint32 item_count = 2;
    uint64 price = 3;
    uint32 currency_type = 4;
}

// 物品上架响应
message MarketAddResponse {
    uint64 market_id = 1;
    uint32 error = 2;
    string message = 3;
}

// 物品下架请求
message MarketRemoveRequest {
    uint64 market_id = 1;
}

// 物品下架响应
message MarketRemoveResponse {
    uint32 error = 2;
    string message = 3;
}

// 物品购买请求
message MarketBuyRequest {
    uint64 market_id = 1;
    uint32 buy_count = 2;
}

// 物品购买响应
message MarketBuyResponse {
    MarketItem item = 1;
    uint32 error = 2;
    string message = 3;
}

// 市场搜索请求
message MarketSearchRequest {
    string item_name = 1;
    uint32 item_type = 2;
    uint32 min_level = 3;
    uint32 max_level = 4;
    uint64 min_price = 5;
    uint64 max_price = 6;
    uint32 page = 7;
    uint32 page_size = 8;
}

// 市场搜索响应
message MarketSearchResponse {
    repeated MarketItem items = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 我的上架列表请求
message MarketMyListRequest {
    uint32 page = 1;
    uint32 page_size = 2;
}

// 我的上架列表响应
message MarketMyListResponse {
    repeated MarketItem items = 1;
    uint32 total = 2;
    uint32 error = 3;
    string message = 4;
}

// 市场系统服务
service MarketService {
    // 市场列表查询
    rpc MarketList(MarketListRequest) returns (MarketListResponse);
    
    // 物品上架
    rpc MarketAdd(MarketAddRequest) returns (MarketAddResponse);
    
    // 物品下架
    rpc MarketRemove(MarketRemoveRequest) returns (MarketRemoveResponse);
    
    // 物品购买
    rpc MarketBuy(MarketBuyRequest) returns (MarketBuyResponse);
    
    // 市场搜索
    rpc MarketSearch(MarketSearchRequest) returns (MarketSearchResponse);
    
    // 我的上架列表
    rpc MarketMyList(MarketMyListRequest) returns (MarketMyListResponse);
}
```

### 3.3 核心 Handler 实现

#### 3.3.1 市场列表处理器

```go
func (h *MarketHandler) MarketListHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.MarketListRequest)
    if !ok {
        return
    }

    items, total, err := h.marketService.GetMarketList(context.Background(), req.Page, req.PageSize, req.ItemType, req.MinLevel, req.MaxLevel, req.MinPrice, req.MaxPrice)
    if err != nil {
        h.sendError(sess, req, 1, "failed to get market list")
        return
    }

    resp := &dnfv1.MarketListResponse{
        Items:  items,
        Total:  total,
        Error:  0,
    }
    sess.Send(resp)
}
```

#### 3.3.2 物品上架处理器

```go
func (h *MarketHandler) MarketAddHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.MarketAddRequest)
    if !ok {
        return
    }

    marketID, err := h.marketService.AddItemToMarket(context.Background(), sess.RoleID, req.ItemGuid, req.ItemCount, req.Price, req.CurrencyType)
    if err != nil {
        h.sendError(sess, req, 1, "failed to add item to market")
        return
    }

    resp := &dnfv1.MarketAddResponse{
        MarketId: marketID,
        Error:    0,
    }
    sess.Send(resp)
}
```

#### 3.3.3 物品购买处理器

```go
func (h *MarketHandler) MarketBuyHandler(sess *network.Session, msg proto.Message) {
    req, ok := msg.(*dnfv1.MarketBuyRequest)
    if !ok {
        return
    }

    item, err := h.marketService.BuyItemFromMarket(context.Background(), sess.RoleID, req.MarketId, req.BuyCount)
    if err != nil {
        h.sendError(sess, req, 1, "failed to buy item from market")
        return
    }

    resp := &dnfv1.MarketBuyResponse{
        Item:  item,
        Error: 0,
    }
    sess.Send(resp)
}
```

### 3.4 业务逻辑服务

```go
type MarketService struct {
    store *store.Store
}

// 获取市场列表
func (s *MarketService) GetMarketList(ctx context.Context, page, pageSize, itemType, minLevel, maxLevel uint32, minPrice, maxPrice uint64) ([]*dnfv1.MarketItem, uint32, error) {
    // 实现获取市场列表逻辑
}

// 物品上架
func (s *MarketService) AddItemToMarket(ctx context.Context, roleID, itemGUID uint64, itemCount uint32, price uint64, currencyType uint32) (uint64, error) {
    // 实现物品上架逻辑
}

// 物品下架
func (s *MarketService) RemoveItemFromMarket(ctx context.Context, roleID, marketID uint64) error {
    // 实现物品下架逻辑
}

// 购买物品
func (s *MarketService) BuyItemFromMarket(ctx context.Context, buyerID, marketID uint64, buyCount uint32) (*dnfv1.MarketItem, error) {
    // 实现购买物品逻辑
}

// 搜索市场
func (s *MarketService) SearchMarket(ctx context.Context, itemName string, itemType, minLevel, maxLevel uint32, minPrice, maxPrice uint64, page, pageSize uint32) ([]*dnfv1.MarketItem, uint32, error) {
    // 实现搜索市场逻辑
}

// 获取我的上架列表
func (s *MarketService) GetMyMarketList(ctx context.Context, roleID uint64, page, pageSize uint32) ([]*dnfv1.MarketItem, uint32, error) {
    // 实现获取我的上架列表逻辑
}
```

## 4. API 文档

### 4.1 HTTP 接口

| API路径 | 方法 | 模块/文件 | 类型 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| `/api/v1/market/list` | `GET` | `handler/market_handler.go` | `Router` | 市场列表查询 | `{"page": 1, "page_size": 20, "item_type": 1, "min_level": 1, "max_level": 100, "min_price": 0, "max_price": 1000000}` | `{"items": [...], "total": 100, "error": 0}` |
| `/api/v1/market/add` | `POST` | `handler/market_handler.go` | `Router` | 物品上架 | `{"item_guid": 123456, "item_count": 1, "price": 10000, "currency_type": 1}` | `{"market_id": 789012, "error": 0}` |
| `/api/v1/market/remove` | `POST` | `handler/market_handler.go` | `Router` | 物品下架 | `{"market_id": 789012}` | `{"error": 0}` |
| `/api/v1/market/buy` | `POST` | `handler/market_handler.go` | `Router` | 物品购买 | `{"market_id": 789012, "buy_count": 1}` | `{"item": {...}, "error": 0}` |
| `/api/v1/market/search` | `GET` | `handler/market_handler.go` | `Router` | 市场搜索 | `{"item_name": "剑", "item_type": 1, "min_level": 1, "max_level": 100, "min_price": 0, "max_price": 1000000, "page": 1, "page_size": 20}` | `{"items": [...], "total": 10, "error": 0}` |
| `/api/v1/market/my-list` | `GET` | `handler/market_handler.go` | `Router` | 我的上架列表 | `{"page": 1, "page_size": 20}` | `{"items": [...], "total": 5, "error": 0}` |

### 4.2 gRPC 接口

| 方法 | 服务 | 模块/文件 | 功能描述 | 请求 | 响应 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `MarketList` | `MarketService` | `proto/dnf/v1/market.proto` | 市场列表查询 | `MarketListRequest` | `MarketListResponse` |
| `MarketAdd` | `MarketService` | `proto/dnf/v1/market.proto` | 物品上架 | `MarketAddRequest` | `MarketAddResponse` |
| `MarketRemove` | `MarketService` | `proto/dnf/v1/market.proto` | 物品下架 | `MarketRemoveRequest` | `MarketRemoveResponse` |
| `MarketBuy` | `MarketService` | `proto/dnf/v1/market.proto` | 物品购买 | `MarketBuyRequest` | `MarketBuyResponse` |
| `MarketSearch` | `MarketService` | `proto/dnf/v1/market.proto` | 市场搜索 | `MarketSearchRequest` | `MarketSearchResponse` |
| `MarketMyList` | `MarketService` | `proto/dnf/v1/market.proto` | 我的上架列表 | `MarketMyListRequest` | `MarketMyListResponse` |

## 5. 数据库设计文档

### 5.1 表结构

#### 5.1.1 市场物品表 (`t_market_item`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 市场物品ID |
| `sellerGuid` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 卖家角色ID |
| `sellerName` | `VARCHAR(50)` | `NOT NULL` | 卖家角色名称 |
| `itemGuid` | `BIGINT UNSIGNED` | `NOT NULL UNIQUE INDEX` | 物品GUID |
| `itemIndex` | `INT UNSIGNED` | `NOT NULL INDEX` | 物品索引 |
| `itemCount` | `INT UNSIGNED` | `NOT NULL` | 物品数量 |
| `bind` | `BOOLEAN` | `NOT NULL DEFAULT FALSE` | 是否绑定 |
| `quality` | `INT UNSIGNED` | `NOT NULL` | 物品品质 |
| `level` | `INT UNSIGNED` | `NOT NULL INDEX` | 物品等级 |
| `price` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 物品价格 |
| `currencyType` | `INT UNSIGNED` | `NOT NULL` | 货币类型 |
| `status` | `INT UNSIGNED` | `NOT NULL DEFAULT 0` | 状态（0-上架中，1-已卖出，2-已下架） |
| `createTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `expireTime` | `DATETIME` | `NOT NULL INDEX` | 过期时间 |
| `updateTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 5.1.2 市场交易记录表 (`t_market_record`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 交易记录ID |
| `marketId` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 市场物品ID |
| `sellerGuid` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 卖家角色ID |
| `buyerGuid` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 买家角色ID |
| `itemGuid` | `BIGINT UNSIGNED` | `NOT NULL` | 物品GUID |
| `itemIndex` | `INT UNSIGNED` | `NOT NULL` | 物品索引 |
| `itemCount` | `INT UNSIGNED` | `NOT NULL` | 物品数量 |
| `price` | `BIGINT UNSIGNED` | `NOT NULL` | 交易价格 |
| `currencyType` | `INT UNSIGNED` | `NOT NULL` | 货币类型 |
| `tax` | `BIGINT UNSIGNED` | `NOT NULL` | 交易税收 |
| `tradeTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 交易时间 |
| `createTime` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 5.2 索引设计

| 表名 | 索引名 | 索引类型 | 索引字段 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| `t_market_item` | `idx_seller_guid` | `BTREE` | `sellerGuid` | 加速卖家物品查询 |
| `t_market_item` | `idx_item_guid` | `BTREE` | `itemGuid` | 加速物品唯一性验证 |
| `t_market_item` | `idx_item_index` | `BTREE` | `itemIndex` | 加速物品类型查询 |
| `t_market_item` | `idx_level` | `BTREE` | `level` | 加速等级范围查询 |
| `t_market_item` | `idx_price` | `BTREE` | `price` | 加速价格范围查询 |
| `t_market_item` | `idx_expire_time` | `BTREE` | `expireTime` | 加速过期物品清理 |
| `t_market_record` | `idx_market_id` | `BTREE` | `marketId` | 加速交易记录查询 |
| `t_market_record` | `idx_seller_guid` | `BTREE` | `sellerGuid` | 加速卖家交易记录查询 |
| `t_market_record` | `idx_buyer_guid` | `BTREE` | `buyerGuid` | 加速买家交易记录查询 |

## 6. 业务流程文档

### 6.1 物品上架流程

1. **验证请求**
   - 检查角色是否登录
   - 验证物品是否存在
   - 验证物品是否属于玩家
   - 验证物品数量是否足够

2. **执行上架**
   - 从背包移除物品
   - 创建市场物品记录
   - 设置过期时间（默认7天）

3. **更新状态**
   - 记录上架操作

4. **返回响应**
   - 返回市场物品ID
   - 返回上架结果

### 6.2 物品购买流程

1. **验证请求**
   - 检查角色是否登录
   - 验证市场物品是否存在
   - 验证市场物品是否可购买
   - 验证购买数量是否足够
   - 验证买家货币是否足够

2. **执行购买**
   - 扣除买家货币
   - 添加物品到买家背包
   - 计算交易税收
   - 添加货币到卖家
   - 更新市场物品状态

3. **更新状态**
   - 记录交易记录
   - 处理物品数量为0的情况

4. **返回响应**
   - 返回购买结果
   - 返回物品信息

### 6.3 物品下架流程

1. **验证请求**
   - 检查角色是否登录
   - 验证市场物品是否存在
   - 验证市场物品是否属于玩家

2. **执行下架**
   - 将物品返回到背包
   - 删除市场物品记录

3. **更新状态**
   - 记录下架操作

4. **返回响应**
   - 返回下架结果

### 6.4 状态转换

| 状态 | 触发条件 | 转换动作 | 目标状态 |
| :--- | :--- | :--- | :--- |
| 初始状态 | 物品上架请求 | 执行上架 | 上架中 |
| 上架中 | 物品购买请求 | 执行购买 | 已卖出 |
| 上架中 | 物品下架请求 | 执行下架 | 已下架 |
| 上架中 | 物品过期 | 系统自动处理 | 已下架 |

## 7. 测试用例文档

### 7.1 测试目标

验证市场系统的核心功能，包括市场列表查询、物品上架、物品下架、物品购买、市场搜索和我的上架列表等功能的正确性和稳定性。

### 7.2 测试场景

#### 7.2.1 市场列表查询测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 正常查询 | 1. 发送市场列表查询请求<br>2. 接收查询响应 | 成功返回市场物品列表 | `{"page": 1, "page_size": 20, "item_type": 1}` |
| 分页查询 | 1. 发送分页查询请求<br>2. 接收查询响应 | 成功返回指定页的数据 | `{"page": 2, "page_size": 20}` |
| 筛选查询 | 1. 发送带筛选条件的查询请求<br>2. 接收查询响应 | 成功返回符合条件的物品 | `{"page": 1, "page_size": 20, "min_level": 50, "max_level": 100}` |

#### 7.2.2 物品上架测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 正常上架 | 1. 发送物品上架请求<br>2. 接收上架响应 | 成功上架，返回市场物品ID | `{"item_guid": 123456, "item_count": 1, "price": 10000, "currency_type": 1}` |
| 物品不存在 | 1. 发送不存在物品的上架请求<br>2. 接收上架响应 | 上架失败，返回错误信息 | `{"item_guid": 999999, "item_count": 1, "price": 10000, "currency_type": 1}` |
| 物品不属于玩家 | 1. 发送他人物品的上架请求<br>2. 接收上架响应 | 上架失败，返回错误信息 | `{"item_guid": 123456, "item_count": 1, "price": 10000, "currency_type": 1}` |
| 数量不足 | 1. 发送数量超过背包数量的上架请求<br>2. 接收上架响应 | 上架失败，返回错误信息 | `{"item_guid": 123456, "item_count": 10, "price": 10000, "currency_type": 1}` |

#### 7.2.3 物品购买测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 正常购买 | 1. 发送物品购买请求<br>2. 接收购买响应 | 成功购买，返回物品信息 | `{"market_id": 789012, "buy_count": 1}` |
| 物品不存在 | 1. 发送不存在物品的购买请求<br>2. 接收购买响应 | 购买失败，返回错误信息 | `{"market_id": 999999, "buy_count": 1}` |
| 数量不足 | 1. 发送购买数量超过上架数量的请求<br>2. 接收购买响应 | 购买失败，返回错误信息 | `{"market_id": 789012, "buy_count": 10}` |
| 货币不足 | 1. 发送货币不足的购买请求<br>2. 接收购买响应 | 购买失败，返回错误信息 | `{"market_id": 789012, "buy_count": 1}` |

### 7.3 测试用例

| 测试用例ID | 测试用例名称 | 测试类型 | 优先级 | 关联API |
| :--- | :--- | :--- | :--- | :--- |
| TC001 | 市场列表查询 | 功能测试 | 高 | `/api/v1/market/list` |
| TC002 | 物品上架 | 功能测试 | 高 | `/api/v1/market/add` |
| TC003 | 物品下架 | 功能测试 | 高 | `/api/v1/market/remove` |
| TC004 | 物品购买 | 功能测试 | 高 | `/api/v1/market/buy` |
| TC005 | 市场搜索 | 功能测试 | 高 | `/api/v1/market/search` |
| TC006 | 我的上架列表 | 功能测试 | 高 | `/api/v1/market/my-list` |
| TC007 | 物品上架-物品不存在 | 异常测试 | 中 | `/api/v1/market/add` |
| TC008 | 物品上架-物品不属于玩家 | 异常测试 | 中 | `/api/v1/market/add` |
| TC009 | 物品购买-货币不足 | 异常测试 | 中 | `/api/v1/market/buy` |
| TC010 | 物品购买-数量不足 | 异常测试 | 中 | `/api/v1/market/buy` |

## 8. 部署文档

### 8.1 环境要求

| 依赖 | 版本/范围 | 用途 | 安装命令 |
| :--- | :--- | :--- | :--- |
| `Go` | `1.20+` | 开发和运行环境 | `apt install golang-go` |
| `MySQL` | `5.7+` | 数据库 | `apt install mysql-server` |
| `Redis` | `6.0+` | 缓存 | `apt install redis-server` |
| `buf` | `1.0+` | ProtoBuf 代码生成 | `npm install -g @bufbuild/buf` |

### 8.2 安装步骤

1. **安装依赖**

   ```bash
   # 安装 Go
   apt install golang-go

   # 安装 MySQL
   apt install mysql-server

   # 安装 Redis
   apt install redis-server

   # 安装 buf
   npm install -g @bufbuild/buf
   ```

2. **配置数据库**

   ```bash
   # 登录 MySQL
   mysql -u root -p

   # 创建数据库
   CREATE DATABASE dnf_game_server;

   # 创建用户并授权
   CREATE USER 'dnf'@'localhost' IDENTIFIED BY 'password';
   GRANT ALL PRIVILEGES ON dnf_game_server.* TO 'dnf'@'localhost';
   FLUSH PRIVILEGES;

   # 创建市场系统表
   source sql/market_system.sql;
   ```

3. **部署服务**

   ```bash
   # 克隆代码
   git clone https://github.com/pixb/DnfGameServer.git
   cd DnfGameServer/dnf-go-server

   # 生成 ProtoBuf 代码
   make generate

   # 编译服务
   make build

   # 启动服务
   make start
   ```

### 8.3 配置说明

| 配置项 | 类型 | 默认值 | 说明 | 所属文件/模块 |
| :--- | :--- | :--- | :--- | :--- |
| `ServerPort` | `int` | `8081` | 服务器端口 | `config/config.go` |
| `MySQLDSN` | `string` | `dnf:password@tcp(localhost:3306)/dnf_game_server?charset=utf8mb4&parseTime=True&loc=Local` | MySQL 连接字符串 | `config/config.go` |
| `RedisAddr` | `string` | `localhost:6379` | Redis 地址 | `config/config.go` |
| `LogLevel` | `string` | `info` | 日志级别 | `config/config.go` |
| `MarketItemExpireDays` | `int` | `7` | 市场物品过期天数 | `config/config.go` |
| `MarketTaxRate` | `float64` | `0.05` | 市场交易税率 | `config/config.go` |

## 9. 监控与维护

### 9.1 监控指标

| 指标名称 | 类型 | 说明 | 监控方式 |
| :--- | :--- | :--- | :--- |
| 市场物品数量 | `Gauge` | 当前市场中的物品数量 | Prometheus |
| 交易次数 | `Counter` | 市场交易的总次数 | Prometheus |
| 交易金额 | `Counter` | 市场交易的总金额 | Prometheus |
| 上架物品数量 | `Counter` | 上架物品的总数量 | Prometheus |
| 下架物品数量 | `Counter` | 下架物品的总数量 | Prometheus |
| 搜索请求次数 | `Counter` | 市场搜索的总请求次数 | Prometheus |
| 错误率 | `Counter` | 错误次数 / 总请求次数 | Prometheus |
| 响应时间 | `Histogram` | API 响应时间分布 | Prometheus |

### 9.2 日志管理

| 日志级别 | 说明 | 存储位置 |
| :--- | :--- | :--- |
| `debug` | 调试信息 | `logs/debug.log` |
| `info` | 普通信息 | `logs/info.log` |
| `warn` | 警告信息 | `logs/warn.log` |
| `error` | 错误信息 | `logs/error.log` |

### 9.3 常见问题

| 问题 | 原因 | 解决方案 |
| :--- | :--- | :--- |
| 物品上架失败 | 物品不存在或不属于玩家 | 验证物品所有权和存在性 |
| 物品购买失败 | 货币不足或物品已被购买 | 验证货币余额和物品状态 |
| 市场搜索缓慢 | 数据量过大或索引缺失 | 优化数据库索引和查询 |
| 过期物品未清理 | 定时任务未执行 | 检查定时任务配置 |
| 交易数据不一致 | 并发操作导致 | 确保交易操作的原子性 |

## 10. 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
| :--- | :--- | :--- | :--- |
| 1.0 | 2026-02-17 | 系统自动生成 | 初始版本 |
| 1.1 | 2026-02-24 | 人工编辑 | 按照模板完善文档，添加系统概述、Java代码分析、Go实现方案、API文档、数据库设计文档、业务流程文档、测试用例文档、部署文档、监控与维护和变更记录等章节 |
