# 成就系统设计文档

## 概述

成就系统是游戏中的重要功能模块，用于追踪和管理玩家的成就进度，提供成就奖励领取功能。

## 功能分析

### 核心功能

#### 1. 成就信息查询
- **功能**: 查询玩家的成就信息
- **请求**: `REQ_ACHIEVEMENT_INFO` (Module 10700)
- **响应**: `RES_ACHIEVEMENT_INFO` (Module 10700)
- **参数**:
  - `field_1`: 查询类型

#### 2. 成就奖励领取
- **功能**: 领取成就奖励
- **请求**: `REQ_ACHIEVEMENT_REWARD` (Module 10701)
- **响应**: `RES_ACHIEVEMENT_REWARD` (Module 10701)
- **参数**:
  - `field_1`: 成就ID
  - `field_2`: 奖励类型
  - `field_3`: 角色ID
- **返回内容**:
  - `adventureunionlevel`: 冒险联盟等级
  - `adventureunionexp`: 冒险联盟经验
  - `consumeitems`: 消耗的物品列表
  - `invenitems`: 背包物品列表

#### 3. 成就列表查询
- **功能**: 查询成就列表
- **请求**: `REQ_ACHIEVEMENT_LIST` (Module 10704)
- **响应**: `RES_ACHIEVEMENT_LIST` (Module 10704)
- **参数**:
  - `field_1`: 查询类型

#### 4. 成就额外奖励领取
- **功能**: 领取成就额外奖励
- **请求**: `REQ_ACHIEVEMENT_BONUS_REWARD` (Module 10706)
- **响应**: `RES_ACHIEVEMENT_BONUS_REWARD` (Module 10706)
- **参数**:
  - `field_1`: 成就ID
  - `field_2`: 奖励类型
  - `field_3`: 奖励索引
  - `field_4`: 奖励数量
  - `field_5`: 角色ID

## 数据模型设计

### 成就记录表 (t_achievement_record)

```go
type AchievementRecord struct {
    ID          uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID      uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    AchievementID uint32   `gorm:"column:achievement_id;index;not null" json:"achievementId"`
    Progress    int32     `gorm:"column:progress;default:0" json:"progress"`
    Completed   bool      `gorm:"column:completed;default:false" json:"completed"`
    Rewarded    bool      `gorm:"column:rewarded;default:false" json:"rewarded"`
    CompleteTime time.Time `gorm:"column:complete_time" json:"completeTime"`
    RewardTime  time.Time `gorm:"column:reward_time" json:"rewardTime"`
    CreateTime  time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
    UpdateTime  time.Time `gorm:"column:update_time;autoUpdateTime" json:"updateTime"`
}

func (AchievementRecord) TableName() string {
    return "t_achievement_record"
}
```

### 成就奖励表 (t_achievement_reward)

```go
type AchievementReward struct {
    ID            uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID        uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    AchievementID uint32   `gorm:"column:achievement_id;index;not null" json:"achievementId"`
    RewardType    uint32   `gorm:"column:reward_type;not null" json:"rewardType"`
    RewardIndex   uint32   `gorm:"column:reward_index;not null" json:"rewardIndex"`
    RewardCount   uint32   `gorm:"column:reward_count;not null" json:"rewardCount"`
    Claimed       bool      `gorm:"column:claimed;default:false" json:"claimed"`
    ClaimTime     time.Time `gorm:"column:claim_time" json:"claimTime"`
    CreateTime    time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (AchievementReward) TableName() string {
    return "t_achievement_reward"
}
```

### 成就配置表 (t_achievement_config)

```go
type AchievementConfig struct {
    ID            uint64  `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    AchievementID uint32  `gorm:"column:achievement_id;uniqueIndex;not null" json:"achievementId"`
    Name          string  `gorm:"column:name;not null" json:"name"`
    Description   string  `gorm:"column:description" json:"description"`
    Type          uint32  `gorm:"column:type;not null" json:"type"`
    TargetValue   int32   `gorm:"column:target_value;not null" json:"targetValue"`
    RewardType    uint32  `gorm:"column:reward_type;not null" json:"rewardType"`
    RewardIndex   uint32  `gorm:"column:reward_index;not null" json:"rewardIndex"`
    RewardCount   uint32  `gorm:"column:reward_count;not null" json:"rewardCount"`
    BonusReward   bool    `gorm:"column:bonus_reward;default:false" json:"bonusReward"`
    Status        uint32  `gorm:"column:status;default:1" json:"status"`
    CreateTime    time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
    UpdateTime    time.Time `gorm:"column:update_time;autoUpdateTime" json:"updateTime"`
}

func (AchievementConfig) TableName() string {
    return "t_achievement_config"
}
```

## Protobuf 消息定义

### 成就信息请求

```protobuf
message AchievementInfoRequest {
  int32 field_1 = 1;
}

message AchievementInfoResponse {
  repeated AchievementInfo achievements = 1;
  int32 error = 2;
  string message = 3;
}

message AchievementInfo {
  uint32 achievement_id = 1;
  string name = 2;
  string description = 3;
  int32 progress = 4;
  int32 target_value = 5;
  bool completed = 6;
  bool rewarded = 7;
}
```

### 成就奖励请求

```protobuf
message AchievementRewardRequest {
  int32 field_1 = 1;
  int32 field_2 = 2;
  uint64 field_3 = 3;
}

message AchievementRewardResponse {
  int32 adventureunionlevel = 1;
  uint64 adventureunionexp = 2;
  repeated StackableItem consumeitems = 3;
  PT_ITEMS invenitems = 4;
  int32 error = 5;
  string message = 6;
}

message StackableItem {
  uint32 index = 1;
  uint32 count = 2;
  bool bind = 3;
  uint64 acquisitiontime = 4;
}

message PT_ITEMS {
  repeated StackableItem consumeitems = 1;
}
```

### 成就列表请求

```protobuf
message AchievementListRequest {
  int32 field_1 = 1;
}

message AchievementListResponse {
  repeated AchievementInfo achievements = 1;
  int32 total = 2;
  int32 error = 3;
  string message = 4;
}
```

### 成就额外奖励请求

```protobuf
message AchievementBonusRewardRequest {
  int32 field_1 = 1;
  int32 field_2 = 2;
  int32 field_3 = 3;
  int32 field_4 = 4;
  int32 field_5 = 5;
}

message AchievementBonusRewardResponse {
  repeated StackableItem rewards = 1;
  int32 error = 2;
  string message = 3;
}
```

## API 设计

### gRPC Service

```protobuf
service GameService {
  // 成就相关
  rpc AchievementInfo(AchievementInfoRequest) returns (AchievementInfoResponse) {
    option (google.api.http) = {
      post: "/api/v1/achievement/info"
      body: "*"
    };
  }

  rpc AchievementReward(AchievementRewardRequest) returns (AchievementRewardResponse) {
    option (google.api.http) = {
      post: "/api/v1/achievement/reward"
      body: "*"
    };
  }

  rpc AchievementList(AchievementListRequest) returns (AchievementListResponse) {
    option (google.api.http) = {
      post: "/api/v1/achievement/list"
      body: "*"
    };
  }

  rpc AchievementBonusReward(AchievementBonusRewardRequest) returns (AchievementBonusRewardResponse) {
    option (google.api.http) = {
      post: "/api/v1/achievement/bonus_reward"
      body: "*"
    };
  }
}
```

## 业务逻辑

### 成就奖励领取流程

1. **验证请求**
   - 检查玩家是否登录
   - 验证成就ID是否有效
   - 检查成就是否已完成
   - 检查奖励是否已领取

2. **处理奖励**
   - 更新成就奖励状态
   - 发放奖励物品到玩家背包
   - 更新冒险联盟等级和经验

3. **返回响应**
   - 返回奖励物品信息
   - 返回冒险联盟等级和经验
   - 返回消耗的物品信息

### 成就进度更新

1. **监听游戏事件**
   - 玩家登录
   - 完成任务
   - 击败怪物
   - 获得物品
   - 等级提升

2. **更新成就进度**
   - 根据事件类型更新对应成就进度
   - 检查是否完成
   - 标记完成状态

3. **通知玩家**
   - 发送成就完成通知
   - 提示玩家领取奖励

## 测试用例设计

### 测试场景

1. **成就信息查询测试**
   - 查询所有成就
   - 查询已完成的成就
   - 查询未完成的成就

2. **成就奖励领取测试**
   - 领取已完成的成就奖励
   - 尝试领取未完成的成就奖励
   - 尝试重复领取奖励

3. **成就列表查询测试**
   - 查询成就列表
   - 分页查询
   - 按类型过滤

4. **成就额外奖励领取测试**
   - 领取额外奖励
   - 验证奖励物品
   - 检查背包更新

## 实现计划

### 阶段一：基础功能
1. 实现数据模型
2. 实现 Protobuf 消息定义
3. 实现基础 Handler

### 阶段二：业务逻辑
1. 实现成就 Service
2. 实现奖励发放逻辑
3. 实现进度更新逻辑

### 阶段三：集成测试
1. 编写测试用例
2. 集成到主服务器
3. 运行测试验证

## 注意事项

1. **并发安全**: 成就奖励领取需要考虑并发问题
2. **数据一致性**: 确保奖励发放和状态更新的原子性
3. **性能优化**: 成就进度更新需要批量处理
4. **错误处理**: 完善的错误提示和日志记录
5. **扩展性**: 设计支持成就类型的扩展

## 参考资源

### Java 代码
- `src/main/java/com/dnfm/game/achievement/AchievementController.java`

### Protobuf 定义
- `proto/dnf/v1/basic.proto`
- `proto/dnf/v1/batch_46_basic_res/basic_res.proto`
- `proto/dnf/v1/batch_73_basic_other/basic_other.proto`

### 相关模块
- 背包系统
- 冒险联盟系统
- 物品系统
