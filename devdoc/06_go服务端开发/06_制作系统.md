# 制作系统设计文档

## 1. 系统概述

### 1.1 系统简介

制作系统是游戏中的核心功能之一，提供玩家合成、分解、升级装备和物品的能力。该系统包括徽章升级、时装合成、物品制作、物品合成、物品分解、卡片合成等多个子系统，为玩家提供丰富的装备强化和物品获取途径。

### 1.2 核心功能

- **徽章升级系统**：升级徽章等级，提升角色属性
- **时装合成系统**：合成新时装，获取稀有外观
- **物品制作系统**：制作各种物品和装备
- **物品合成系统**：合成装备或时装
- **物品分解系统**：分解装备获取材料
- **卡片合成系统**：合成卡片提升稀有度
- **衣柜系统**：管理角色时装（预留功能）

### 1.3 系统架构

制作系统采用模块化设计，包括数据模型、业务逻辑、API接口三个主要层次：

1. **数据模型层**：负责数据存储和访问
2. **业务逻辑层**：实现核心制作功能
3. **API接口层**：提供HTTP和gRPC接口

### 1.4 依赖关系

- **背包系统**：物品操作依赖背包系统
- **角色系统**：角色信息和属性管理
- **物品系统**：物品数据和属性管理

## 2. Java 代码分析

### 2.1 核心控制器

| 控制器类 | 主要功能 | 关键方法 |
| :--- | :--- | :--- |
| `MakeController` | 制作系统主控制器 | `handleEmblemUpgrade`, `handleAvatarCompose`, `handleItemProduction`, `handleItemCombine`, `handleItemDisjoint`, `handleCardCompose` |

### 2.2 核心功能

#### 2.2.1 徽章升级

**功能描述**：升级徽章等级，支持使用护身符增加成功率

**请求处理**：`REQ_ITEM_EMBLEM_UPGRADE_INVEN`

**核心逻辑**：
1. 验证徽章存在性和数量
2. 计算升级成功率
3. 执行升级操作
4. 处理成功/失败情况
5. 消耗物品和金币

#### 2.2.2 时装合成

**功能描述**：合成时装，根据职业和装备类型随机生成新时装

**请求处理**：`REQ_ITEM_AVATAR_COMPOSE`

**核心逻辑**：
1. 验证时装存在性
2. 消耗合成材料和合成券
3. 随机生成新时装
4. 处理稀有度计算

#### 2.2.3 物品制作

**功能描述**：制作各种物品和装备

**请求处理**：`REQ_ITEM_PRODUCTION_INFO`, `REQ_ITEM_PRODUCTION_REGISTER`

**核心逻辑**：
1. 获取制作槽位信息
2. 验证配方存在性
3. 消耗材料和金币
4. 执行制作操作

#### 2.2.4 物品合成

**功能描述**：合成装备或时装

**请求处理**：`REQ_ITEM_COMBINE`

**核心逻辑**：
1. 验证目标物品和材料
2. 消耗材料和金币
3. 执行合成操作
4. 生成合成结果

#### 2.2.5 物品分解

**功能描述**：分解装备获取材料

**请求处理**：`REQ_ITEM_DISJOINT`

**核心逻辑**：
1. 验证装备存在性
2. 计算分解材料
3. 执行分解操作
4. 发放分解材料

#### 2.2.6 卡片合成

**功能描述**：合成卡片提升稀有度

**请求处理**：`REQ_CARD_COMPOSE`

**核心逻辑**：
1. 验证卡片存在性和数量
2. 计算合成成功率
3. 执行合成操作
4. 处理成功/失败情况

### 2.3 数据结构

| 数据结构 | 说明 | 关键字段 |
| :--- | :--- | :--- |
| `EmblemUpgradeRequest` | 徽章升级请求 | `index`, `trycount`, `talisman` |
| `AvatarComposeRequest` | 时装合成请求 | `guids` |
| `ItemProductionInfoRequest` | 物品制作信息请求 | `slottype` |
| `ItemProductionRegisterRequest` | 物品制作注册请求 | `slotindex`, `recipeindex`, `count` |
| `ItemCombineRequest` | 物品合成请求 | `index`, `materialitems`, `count` |
| `ItemDisjointRequest` | 物品分解请求 | `list` |
| `CardComposeRequest` | 卡片合成请求 | `usercardlist` |

## 3. Go 实现方案

### 3.1 数据模型

#### 3.1.1 徽章升级记录

```go
type EmblemUpgrade struct {
    ID           uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID       uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    EmblemIndex  int       `gorm:"column:emblem_index;not null" json:"emblemIndex"`
    Level        int       `gorm:"column:level;not null" json:"level"`
    TryCount     int       `gorm:"column:try_count;not null" json:"tryCount"`
    SuccessCount int       `gorm:"column:success_count;not null" json:"successCount"`
    CostMoney    int       `gorm:"column:cost_money;not null" json:"costMoney"`
    CostTalisman int       `gorm:"column:cost_talisman;not null" json:"costTalisman"`
    CreateTime   time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (EmblemUpgrade) TableName() string {
    return "t_emblem_upgrade"
}
```

#### 3.1.2 时装合成记录

```go
type AvatarCompose struct {
    ID          uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID      uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    AvatarGUIDs string    `gorm:"column:avatar_guids;type:text" json:"avatarGuids"`
    ResultIndex int       `gorm:"column:result_index;not null" json:"resultIndex"`
    ResultGUID  uint64    `gorm:"column:result_guid;not null" json:"resultGuid"`
    CostMoney   int       `gorm:"column:cost_money;not null" json:"costMoney"`
    CreateTime  time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (AvatarCompose) TableName() string {
    return "t_avatar_compose"
}
```

#### 3.1.3 物品制作记录

```go
type ItemProduction struct {
    ID          uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID      uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    SlotIndex   int       `gorm:"column:slot_index;not null" json:"slotIndex"`
    RecipeIndex int       `gorm:"column:recipe_index;not null" json:"recipeIndex"`
    Count       int       `gorm:"column:count;not null" json:"count"`
    ResultIndex int       `gorm:"column:result_index;not null" json:"resultIndex"`
    ResultCount int       `gorm:"column:result_count;not null" json:"resultCount"`
    CostMoney   int       `gorm:"column:cost_money;not null" json:"costMoney"`
    CreateTime  time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (ItemProduction) TableName() string {
    return "t_item_production"
}
```

#### 3.1.4 物品合成记录

```go
type ItemCombine struct {
    ID          uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID      uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    TargetIndex int       `gorm:"column:target_index;not null" json:"targetIndex"`
    MaterialList string    `gorm:"column:material_list;type:text" json:"materialList"`
    Count       int       `gorm:"column:count;not null" json:"count"`
    ResultGUID  uint64    `gorm:"column:result_guid;not null" json:"resultGuid"`
    CostMoney   int       `gorm:"column:cost_money;not null" json:"costMoney"`
    CreateTime  time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (ItemCombine) TableName() string {
    return "t_item_combine"
}
```

#### 3.1.5 物品分解记录

```go
type ItemDisjoint struct {
    ID          uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID      uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    EquipGUIDs  string    `gorm:"column:equip_guids;type:text" json:"equipGuids"`
    MaterialList string    `gorm:"column:material_list;type:text" json:"materialList"`
    CreateTime  time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (ItemDisjoint) TableName() string {
    return "t_item_disjoint"
}
```

#### 3.1.6 卡片合成记录

```go
type CardCompose struct {
    ID          uint64    `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
    RoleID      uint64    `gorm:"column:role_id;index;not null" json:"roleId"`
    CardList    string    `gorm:"column:card_list;type:text" json:"cardList"`
    ResultIndex int       `gorm:"column:result_index;not null" json:"resultIndex"`
    ResultCount int       `gorm:"column:result_count;not null" json:"resultCount"`
    CostMoney   int       `gorm:"column:cost_money;not null" json:"costMoney"`
    CreateTime  time.Time `gorm:"column:create_time;autoCreateTime" json:"createTime"`
}

func (CardCompose) TableName() string {
    return "t_card_compose"
}
```

### 3.2 Protobuf 消息定义

```protobuf
syntax = "proto3";

package dnf.v1.make;

option go_package = "dnf-go-server/proto/dnf/v1/make";

// 徽章升级请求
message EmblemUpgradeRequest {
    uint32 transId = 1;      // 事务ID
    int32 index = 2;         // 徽章索引
    int32 trycount = 3;      // 尝试次数
    int32 talisman = 4;      // 护身符数量
}

// 徽章升级响应
message EmblemUpgradeResponse {
    uint32 transId = 1;       // 事务ID
    int32 success = 2;        // 成功次数
    repeated RewardItem rewards = 3; // 奖励信息
    repeated RemoveItem removeitems = 4; // 消耗物品
}

// 时装合成请求
message AvatarComposeRequest {
    uint32 transId = 1;       // 事务ID
    repeated uint64 guids = 2; // 时装GUID列表
}

// 时装合成响应
message AvatarComposeResponse {
    uint32 transId = 1;       // 事务ID
    repeated RewardItem rewards = 2; // 奖励信息
    repeated RemoveItem removeitems = 3; // 消耗物品
}

// 物品制作信息请求
message ItemProductionInfoRequest {
    uint32 transId = 1;       // 事务ID
    int32 slottype = 2;       // 槽位类型
}

// 物品制作信息响应
message ItemProductionInfoResponse {
    uint32 transId = 1;       // 事务ID
    repeated ProductionSlotInfo infos = 2; // 槽位信息列表
}

// 物品制作注册请求
message ItemProductionRegisterRequest {
    uint32 transId = 1;       // 事务ID
    int32 slotindex = 2;      // 槽位索引
    int32 recipeindex = 3;    // 配方索引
    int32 count = 4;          // 制作数量
}

// 物品制作注册响应
message ItemProductionRegisterResponse {
    uint32 transId = 1;       // 事务ID
    repeated RewardItem rewards = 2; // 奖励信息
    repeated RemoveItem removeitems = 3; // 消耗物品
    repeated MaterialItem materialitems = 4; // 材料消耗列表
}

// 物品合成请求
message ItemCombineRequest {
    uint32 transId = 1;       // 事务ID
    int32 index = 2;          // 目标物品索引
    repeated MaterialItem materialitems = 3; // 材料物品列表
    int32 count = 4;          // 合成数量
}

// 物品合成响应
message ItemCombineResponse {
    uint32 transId = 1;       // 事务ID
    optional Equipment equip = 2; // 装备信息
    optional Avatar avatar = 3;  // 时装信息
    repeated RewardItem rewards = 4; // 奖励信息
    repeated RemoveItem removeitems = 5; // 消耗物品
}

// 物品分解请求
message ItemDisjointRequest {
    uint32 transId = 1;       // 事务ID
    repeated uint64 list = 2;  // 装备GUID列表
}

// 物品分解响应
message ItemDisjointResponse {
    uint32 transId = 1;       // 事务ID
    repeated RewardItem rewards = 2; // 奖励信息
    repeated RemoveItem removeitems = 3; // 消耗物品
}

// 卡片合成请求
message CardComposeRequest {
    uint32 transId = 1;       // 事务ID
    repeated CardItem usercardlist = 2; // 卡片列表
}

// 卡片合成响应
message CardComposeResponse {
    uint32 transId = 1;       // 事务ID
    optional Card card = 2;    // 合成结果卡片
    optional Currency currency = 3; // 金币信息
    repeated CardItem usercardlist = 4; // 消耗的卡片列表
}

// 奖励物品
message RewardItem {
    int32 index = 1;           // 物品索引
    uint64 guid = 2;           // 物品GUID
    int32 count = 3;           // 物品数量
}

// 消耗物品
message RemoveItem {
    uint64 guid = 1;           // 物品GUID
    int32 count = 2;           // 消耗数量
}

// 材料物品
message MaterialItem {
    int32 index = 1;           // 物品索引
    int32 count = 2;           // 物品数量
}

// 制作槽位信息
message ProductionSlotInfo {
    int32 slotindex = 1;       // 槽位索引
    int32 usablecount = 2;     // 可用次数
}

// 装备信息
message Equipment {
    int32 index = 1;           // 装备索引
    uint64 guid = 2;           // 装备GUID
    int32 level = 3;           // 装备等级
    int32 rare = 4;            // 装备稀有度
}

// 时装信息
message Avatar {
    int32 index = 1;           // 时装索引
    uint64 guid = 2;           // 时装GUID
    int32 rare = 4;            // 时装稀有度
}

// 卡片信息
message Card {
    int32 index = 1;           // 卡片索引
    int32 level = 2;           // 卡片等级
    int32 rare = 3;            // 卡片稀有度
}

// 金币信息
message Currency {
    int32 money = 1;           // 金币数量
}

// 卡片物品
message CardItem {
    int32 index = 1;           // 卡片索引
    int32 count = 2;           // 卡片数量
}

// 制作系统服务
service MakeService {
    // 徽章升级
    rpc EmblemUpgrade(EmblemUpgradeRequest) returns (EmblemUpgradeResponse);
    
    // 时装合成
    rpc AvatarCompose(AvatarComposeRequest) returns (AvatarComposeResponse);
    
    // 物品制作信息
    rpc ItemProductionInfo(ItemProductionInfoRequest) returns (ItemProductionInfoResponse);
    
    // 物品制作注册
    rpc ItemProductionRegister(ItemProductionRegisterRequest) returns (ItemProductionRegisterResponse);
    
    // 物品合成
    rpc ItemCombine(ItemCombineRequest) returns (ItemCombineResponse);
    
    // 物品分解
    rpc ItemDisjoint(ItemDisjointRequest) returns (ItemDisjointResponse);
    
    // 卡片合成
    rpc CardCompose(CardComposeRequest) returns (CardComposeResponse);
}
```

### 3.3 核心 Handler 实现

#### 3.3.1 徽章升级 Handler

```go
func (h *MakeHandler) EmblemUpgrade(ctx context.Context, req *make.EmblemUpgradeRequest) (*make.EmblemUpgradeResponse, error) {
    // 1. 验证请求参数
    if req.Index <= 0 || req.Trycount <= 0 {
        return nil, errors.New("invalid request parameters")
    }
    
    // 2. 获取角色ID
    roleID, err := getRoleIDFromContext(ctx)
    if err != nil {
        return nil, err
    }
    
    // 3. 执行徽章升级
    result, err := h.makeService.UpgradeEmblem(ctx, roleID, req.Index, req.Trycount, req.Talisman)
    if err != nil {
        return nil, err
    }
    
    // 4. 构建响应
    resp := &make.EmblemUpgradeResponse{
        TransId: req.TransId,
        Success: int32(result.SuccessCount),
        Rewards: convertToRewardItems(result.Rewards),
        Removeitems: convertToRemoveItems(result.ConsumedItems),
    }
    
    return resp, nil
}
```

#### 3.3.2 时装合成 Handler

```go
func (h *MakeHandler) AvatarCompose(ctx context.Context, req *make.AvatarComposeRequest) (*make.AvatarComposeResponse, error) {
    // 1. 验证请求参数
    if len(req.Guids) == 0 {
        return nil, errors.New("invalid avatar guids")
    }
    
    // 2. 获取角色ID
    roleID, err := getRoleIDFromContext(ctx)
    if err != nil {
        return nil, err
    }
    
    // 3. 执行时装合成
    result, err := h.makeService.ComposeAvatar(ctx, roleID, req.Guids)
    if err != nil {
        return nil, err
    }
    
    // 4. 构建响应
    resp := &make.AvatarComposeResponse{
        TransId: req.TransId,
        Rewards: convertToRewardItems(result.Rewards),
        Removeitems: convertToRemoveItems(result.ConsumedItems),
    }
    
    return resp, nil
}
```

#### 3.3.3 物品分解 Handler

```go
func (h *MakeHandler) ItemDisjoint(ctx context.Context, req *make.ItemDisjointRequest) (*make.ItemDisjointResponse, error) {
    // 1. 验证请求参数
    if len(req.List) == 0 {
        return nil, errors.New("invalid equipment guids")
    }
    
    // 2. 获取角色ID
    roleID, err := getRoleIDFromContext(ctx)
    if err != nil {
        return nil, err
    }
    
    // 3. 执行物品分解
    result, err := h.makeService.DisjointItems(ctx, roleID, req.List)
    if err != nil {
        return nil, err
    }
    
    // 4. 构建响应
    resp := &make.ItemDisjointResponse{
        TransId: req.TransId,
        Rewards: convertToRewardItems(result.Rewards),
        Removeitems: convertToRemoveItems(result.ConsumedItems),
    }
    
    return resp, nil
}
```

### 3.4 业务逻辑服务

```go
type MakeService struct {
    db          *gorm.DB
    bagService  *BagService
    itemService *ItemService
}

// 徽章升级
func (s *MakeService) UpgradeEmblem(ctx context.Context, roleID uint64, emblemIndex, tryCount, talismanCount int) (*EmblemUpgradeResult, error) {
    // 实现徽章升级逻辑
}

// 时装合成
func (s *MakeService) ComposeAvatar(ctx context.Context, roleID uint64, avatarGUIDs []uint64) (*AvatarComposeResult, error) {
    // 实现时装合成逻辑
}

// 物品制作
func (s *MakeService) ProduceItem(ctx context.Context, roleID uint64, slotIndex, recipeIndex, count int) (*ItemProductionResult, error) {
    // 实现物品制作逻辑
}

// 物品合成
func (s *MakeService) CombineItems(ctx context.Context, roleID uint64, targetIndex int, materials []MaterialItem, count int) (*ItemCombineResult, error) {
    // 实现物品合成逻辑
}

// 物品分解
func (s *MakeService) DisjointItems(ctx context.Context, roleID uint64, equipGUIDs []uint64) (*ItemDisjointResult, error) {
    // 实现物品分解逻辑
}

// 卡片合成
func (s *MakeService) ComposeCards(ctx context.Context, roleID uint64, cards []CardItem) (*CardComposeResult, error) {
    // 实现卡片合成逻辑
}
```

## 4. API 文档

### 4.1 HTTP 接口

| API路径 | 方法 | 模块/文件 | 类型 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| `/api/v1/make/emblem/upgrade` | `POST` | `handler/make_handler.go` | `Router` | 徽章升级 | `{"transId": 1, "index": 1, "trycount": 1, "talisman": 0}` | `{"transId": 1, "success": 1, "rewards": [...], "removeitems": [...]}` |
| `/api/v1/make/emblem/upgrade_quick` | `POST` | `handler/make_handler.go` | `Router` | 徽章快速升级 | `{"transId": 1, "source": [{"index": 1, "count": 2}], "target": 2}` | `{"transId": 1, "rewards": [...], "removeitems": [...]}` |
| `/api/v1/make/avatar/compose` | `POST` | `handler/make_handler.go` | `Router` | 时装合成 | `{"transId": 1, "guids": [123456, 789012]}` | `{"transId": 1, "rewards": [...], "removeitems": [...]}` |
| `/api/v1/make/production/info` | `GET` | `handler/make_handler.go` | `Router` | 物品制作信息 | `{"transId": 1, "slottype": 1}` | `{"transId": 1, "infos": [{"slotindex": 1, "usablecount": 100}]}` |
| `/api/v1/make/production/register` | `POST` | `handler/make_handler.go` | `Router` | 物品制作注册 | `{"transId": 1, "slotindex": 1, "recipeindex": 1, "count": 1}` | `{"transId": 1, "rewards": [...], "removeitems": [...], "materialitems": [...]}` |
| `/api/v1/make/item/combine` | `POST` | `handler/make_handler.go` | `Router` | 物品合成 | `{"transId": 1, "index": 1, "materialitems": [{"index": 2, "count": 1}], "count": 1}` | `{"transId": 1, "equip": {...}, "rewards": [...], "removeitems": [...]}` |
| `/api/v1/make/item/disjoint` | `POST` | `handler/make_handler.go` | `Router` | 物品分解 | `{"transId": 1, "list": [123456, 789012]}` | `{"transId": 1, "rewards": [...], "removeitems": [...]}` |
| `/api/v1/make/card/compose` | `POST` | `handler/make_handler.go` | `Router` | 卡片合成 | `{"transId": 1, "usercardlist": [{"index": 1, "count": 2}]}` | `{"transId": 1, "card": {...}, "currency": {...}, "usercardlist": [...]}` |

### 4.2 gRPC 接口

| 方法 | 服务 | 模块/文件 | 功能描述 | 请求 | 响应 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `EmblemUpgrade` | `MakeService` | `proto/dnf/v1/make/make.proto` | 徽章升级 | `EmblemUpgradeRequest` | `EmblemUpgradeResponse` |
| `AvatarCompose` | `MakeService` | `proto/dnf/v1/make/make.proto` | 时装合成 | `AvatarComposeRequest` | `AvatarComposeResponse` |
| `ItemProductionInfo` | `MakeService` | `proto/dnf/v1/make/make.proto` | 物品制作信息 | `ItemProductionInfoRequest` | `ItemProductionInfoResponse` |
| `ItemProductionRegister` | `MakeService` | `proto/dnf/v1/make/make.proto` | 物品制作注册 | `ItemProductionRegisterRequest` | `ItemProductionRegisterResponse` |
| `ItemCombine` | `MakeService` | `proto/dnf/v1/make/make.proto` | 物品合成 | `ItemCombineRequest` | `ItemCombineResponse` |
| `ItemDisjoint` | `MakeService` | `proto/dnf/v1/make/make.proto` | 物品分解 | `ItemDisjointRequest` | `ItemDisjointResponse` |
| `CardCompose` | `MakeService` | `proto/dnf/v1/make/make.proto` | 卡片合成 | `CardComposeRequest` | `CardComposeResponse` |

## 5. 数据库设计文档

### 5.1 表结构

#### 5.1.1 徽章升级记录表 (`t_emblem_upgrade`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `role_id` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 角色ID |
| `emblem_index` | `INT` | `NOT NULL` | 徽章索引 |
| `level` | `INT` | `NOT NULL` | 徽章等级 |
| `try_count` | `INT` | `NOT NULL` | 尝试次数 |
| `success_count` | `INT` | `NOT NULL` | 成功次数 |
| `cost_money` | `INT` | `NOT NULL` | 消耗金币 |
| `cost_talisman` | `INT` | `NOT NULL` | 消耗护身符 |
| `create_time` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 5.1.2 时装合成记录表 (`t_avatar_compose`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `role_id` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 角色ID |
| `avatar_guids` | `TEXT` | `NOT NULL` | 时装GUID列表（JSON格式） |
| `result_index` | `INT` | `NOT NULL` | 结果时装索引 |
| `result_guid` | `BIGINT UNSIGNED` | `NOT NULL` | 结果时装GUID |
| `cost_money` | `INT` | `NOT NULL` | 消耗金币 |
| `create_time` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 5.1.3 物品制作记录表 (`t_item_production`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `role_id` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 角色ID |
| `slot_index` | `INT` | `NOT NULL` | 槽位索引 |
| `recipe_index` | `INT` | `NOT NULL` | 配方索引 |
| `count` | `INT` | `NOT NULL` | 制作数量 |
| `result_index` | `INT` | `NOT NULL` | 结果物品索引 |
| `result_count` | `INT` | `NOT NULL` | 结果物品数量 |
| `cost_money` | `INT` | `NOT NULL` | 消耗金币 |
| `create_time` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 5.1.4 物品合成记录表 (`t_item_combine`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `role_id` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 角色ID |
| `target_index` | `INT` | `NOT NULL` | 目标物品索引 |
| `material_list` | `TEXT` | `NOT NULL` | 材料列表（JSON格式） |
| `count` | `INT` | `NOT NULL` | 合成数量 |
| `result_guid` | `BIGINT UNSIGNED` | `NOT NULL` | 结果物品GUID |
| `cost_money` | `INT` | `NOT NULL` | 消耗金币 |
| `create_time` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 5.1.5 物品分解记录表 (`t_item_disjoint`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `role_id` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 角色ID |
| `equip_guids` | `TEXT` | `NOT NULL` | 装备GUID列表（JSON格式） |
| `material_list` | `TEXT` | `NOT NULL` | 材料列表（JSON格式） |
| `create_time` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 5.1.6 卡片合成记录表 (`t_card_compose`)

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT UNSIGNED` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `role_id` | `BIGINT UNSIGNED` | `NOT NULL INDEX` | 角色ID |
| `card_list` | `TEXT` | `NOT NULL` | 卡片列表（JSON格式） |
| `result_index` | `INT` | `NOT NULL` | 结果卡片索引 |
| `result_count` | `INT` | `NOT NULL` | 结果卡片数量 |
| `cost_money` | `INT` | `NOT NULL` | 消耗金币 |
| `create_time` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 5.2 索引设计

| 表名 | 索引名 | 索引类型 | 索引字段 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| `t_emblem_upgrade` | `idx_role_id` | `BTREE` | `role_id` | 加速角色徽章升级记录查询 |
| `t_avatar_compose` | `idx_role_id` | `BTREE` | `role_id` | 加速角色时装合成记录查询 |
| `t_item_production` | `idx_role_id` | `BTREE` | `role_id` | 加速角色物品制作记录查询 |
| `t_item_combine` | `idx_role_id` | `BTREE` | `role_id` | 加速角色物品合成记录查询 |
| `t_item_disjoint` | `idx_role_id` | `BTREE` | `role_id` | 加速角色物品分解记录查询 |
| `t_card_compose` | `idx_role_id` | `BTREE` | `role_id` | 加速角色卡片合成记录查询 |

### 5.3 数据传输对象 (DTOs)

| 数据结构 | 字段 | 类型 | 说明 | 所属文件/模块 |
| :--- | :--- | :--- | :--- | :--- |
| `EmblemUpgradeDTO` | `roleId` | `uint64` | 角色ID | `dto/make_dto.go` |
|  | `emblemIndex` | `int` | 徽章索引 | `dto/make_dto.go` |
|  | `level` | `int` | 徽章等级 | `dto/make_dto.go` |
|  | `tryCount` | `int` | 尝试次数 | `dto/make_dto.go` |
|  | `successCount` | `int` | 成功次数 | `dto/make_dto.go` |
| `AvatarComposeDTO` | `roleId` | `uint64` | 角色ID | `dto/make_dto.go` |
|  | `avatarGuids` | `[]uint64` | 时装GUID列表 | `dto/make_dto.go` |
|  | `resultIndex` | `int` | 结果时装索引 | `dto/make_dto.go` |
|  | `resultGuid` | `uint64` | 结果时装GUID | `dto/make_dto.go` |

## 6. 业务流程文档

### 6.1 徽章升级流程

1. **验证请求**
   - 检查角色是否登录
   - 验证徽章是否存在
   - 验证徽章数量是否足够
   - 验证金币是否足够

2. **执行升级**
   - 计算升级成功率
   - 执行多次升级尝试
   - 处理成功/失败情况

3. **更新状态**
   - 消耗物品和金币
   - 发放升级结果
   - 记录升级历史

4. **返回响应**
   - 返回成功次数
   - 返回奖励信息
   - 返回消耗物品信息

### 6.2 时装合成流程

1. **验证请求**
   - 检查角色是否登录
   - 验证时装是否存在
   - 验证合成材料是否足够
   - 验证合成券是否足够
   - 验证金币是否足够

2. **执行合成**
   - 消耗时装和材料
   - 随机生成新时装
   - 计算稀有度

3. **更新状态**
   - 发放合成结果
   - 记录合成历史

4. **返回响应**
   - 返回奖励信息
   - 返回消耗物品信息

### 6.3 物品分解流程

1. **验证请求**
   - 检查角色是否登录
   - 验证装备是否存在

2. **执行分解**
   - 计算分解材料
   - 消耗装备
   - 发放分解材料

3. **更新状态**
   - 记录分解历史

4. **返回响应**
   - 返回奖励信息
   - 返回消耗物品信息

### 6.4 卡片合成流程

1. **验证请求**
   - 检查角色是否登录
   - 验证卡片是否存在
   - 验证卡片数量是否足够
   - 验证金币是否足够

2. **执行合成**
   - 计算合成成功率
   - 执行合成操作
   - 处理成功/失败情况

3. **更新状态**
   - 消耗卡片和金币
   - 发放合成结果
   - 记录合成历史

4. **返回响应**
   - 返回合成结果
   - 返回金币信息
   - 返回消耗卡片信息

### 6.5 状态转换

| 状态 | 触发条件 | 转换动作 | 目标状态 |
| :--- | :--- | :--- | :--- |
| 初始状态 | 徽章升级请求 | 执行升级 | 升级中 |
| 升级中 | 升级完成 | 处理结果 | 升级完成 |
| 初始状态 | 时装合成请求 | 执行合成 | 合成中 |
| 合成中 | 合成完成 | 处理结果 | 合成完成 |
| 初始状态 | 物品分解请求 | 执行分解 | 分解中 |
| 分解中 | 分解完成 | 处理结果 | 分解完成 |

## 7. 测试用例文档

### 7.1 测试目标

验证制作系统的核心功能，包括徽章升级、时装合成、物品制作、物品合成、物品分解、卡片合成等功能的正确性和稳定性。

### 7.2 测试场景

#### 7.2.1 徽章升级测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 正常升级 | 1. 发送徽章升级请求<br>2. 接收升级响应 | 成功升级，返回成功响应 | `{"transId": 1, "index": 1, "trycount": 1, "talisman": 0}` |
| 使用护身符升级 | 1. 发送使用护身符的升级请求<br>2. 接收升级响应 | 100%成功升级，返回成功响应 | `{"transId": 1, "index": 1, "trycount": 1, "talisman": 1}` |
| 升级失败 | 1. 发送高等级徽章升级请求<br>2. 接收升级响应 | 升级失败，返回失败响应 | `{"transId": 1, "index": 1, "trycount": 1, "talisman": 0}` |
| 金币不足 | 1. 发送金币不足的升级请求<br>2. 接收升级响应 | 升级失败，返回金币不足错误 | `{"transId": 1, "index": 1, "trycount": 1, "talisman": 0}` |
| 徽章数量不足 | 1. 发送徽章数量不足的升级请求<br>2. 接收升级响应 | 升级失败，返回数量不足错误 | `{"transId": 1, "index": 1, "trycount": 1, "talisman": 0}` |

#### 7.2.2 时装合成测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 正常合成 | 1. 发送时装合成请求<br>2. 接收合成响应 | 成功合成，返回成功响应 | `{"transId": 1, "guids": [123456, 789012]}` |
| 稀有时装合成 | 1. 多次发送时装合成请求<br>2. 接收合成响应 | 有概率合成稀有时装 | `{"transId": 1, "guids": [123456, 789012]}` |
| 材料不足 | 1. 发送材料不足的合成请求<br>2. 接收合成响应 | 合成失败，返回材料不足错误 | `{"transId": 1, "guids": [123456, 789012]}` |
| 合成券不足 | 1. 发送合成券不足的合成请求<br>2. 接收合成响应 | 合成失败，返回合成券不足错误 | `{"transId": 1, "guids": [123456, 789012]}` |

#### 7.2.3 物品分解测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 普通装备分解 | 1. 发送普通装备分解请求<br>2. 接收分解响应 | 成功分解，返回普通材料 | `{"transId": 1, "list": [123456]}` |
| 稀有装备分解 | 1. 发送稀有装备分解请求<br>2. 接收分解响应 | 成功分解，返回稀有材料 | `{"transId": 1, "list": [789012]}` |
| 传说装备分解 | 1. 发送传说装备分解请求<br>2. 接收分解响应 | 成功分解，返回传说材料或时装 | `{"transId": 1, "list": [987654]}` |
| 批量分解 | 1. 发送多个装备分解请求<br>2. 接收分解响应 | 成功分解所有装备，返回所有材料 | `{"transId": 1, "list": [123456, 789012]}` |

#### 7.2.4 卡片合成测试

| 测试场景 | 测试步骤 | 预期结果 | 测试数据 |
| :--- | :--- | :--- | :--- |
| 2张卡片合成 | 1. 发送2张卡片合成请求<br>2. 接收合成响应 | 低概率成功合成 | `{"transId": 1, "usercardlist": [{"index": 1, "count": 2}]}` |
| 3张卡片合成 | 1. 发送3张卡片合成请求<br>2. 接收合成响应 | 中概率成功合成 | `{"transId": 1, "usercardlist": [{"index": 1, "count": 3}]}` |
| 4张卡片合成 | 1. 发送4张卡片合成请求<br>2. 接收合成响应 | 高概率成功合成 | `{"transId": 1, "usercardlist": [{"index": 1, "count": 4}]}` |
| 合成成功 | 1. 发送卡片合成请求<br>2. 接收合成响应 | 成功合成高稀有度卡片 | `{"transId": 1, "usercardlist": [{"index": 1, "count": 4}]}` |
| 合成失败 | 1. 发送卡片合成请求<br>2. 接收合成响应 | 失败返回相同稀有度卡片 | `{"transId": 1, "usercardlist": [{"index": 1, "count": 2}]}` |

### 7.3 测试用例

| 测试用例ID | 测试用例名称 | 测试类型 | 优先级 | 关联API |
| :--- | :--- | :--- | :--- | :--- |
| TC001 | 徽章升级 | 功能测试 | 高 | `/api/v1/make/emblem/upgrade` |
| TC002 | 徽章快速升级 | 功能测试 | 高 | `/api/v1/make/emblem/upgrade_quick` |
| TC003 | 时装合成 | 功能测试 | 高 | `/api/v1/make/avatar/compose` |
| TC004 | 物品制作信息 | 功能测试 | 中 | `/api/v1/make/production/info` |
| TC005 | 物品制作注册 | 功能测试 | 高 | `/api/v1/make/production/register` |
| TC006 | 物品合成 | 功能测试 | 高 | `/api/v1/make/item/combine` |
| TC007 | 物品分解 | 功能测试 | 高 | `/api/v1/make/item/disjoint` |
| TC008 | 卡片合成 | 功能测试 | 高 | `/api/v1/make/card/compose` |
| TC009 | 徽章升级金币不足 | 异常测试 | 中 | `/api/v1/make/emblem/upgrade` |
| TC010 | 时装合成材料不足 | 异常测试 | 中 | `/api/v1/make/avatar/compose` |
| TC011 | 物品分解装备不存在 | 异常测试 | 中 | `/api/v1/make/item/disjoint` |

## 8. 部署文档

### 8.1 环境要求

| 依赖 | 版本/范围 | 用途 | 安装命令 |
| :--- | :--- | :--- | :--- |
| `Go` | `1.20+` | 开发和运行环境 | `apt install golang-go` |
| `MySQL` | `5.7+` | 数据库 | `apt install mysql-server` |
| `Redis` | `6.0+` | 缓存 | `apt install redis-server` |
| `buf` | `1.0+` | ProtoBuf 代码生成 | `npm install -g @bufbuild/buf` |

### 8.2 安装步骤

1. **安装依赖**

   ```bash
   # 安装 Go
   apt install golang-go

   # 安装 MySQL
   apt install mysql-server

   # 安装 Redis
   apt install redis-server

   # 安装 buf
   npm install -g @bufbuild/buf
   ```

2. **配置数据库**

   ```bash
   # 登录 MySQL
   mysql -u root -p

   # 创建数据库
   CREATE DATABASE dnf_game_server;

   # 创建用户并授权
   CREATE USER 'dnf'@'localhost' IDENTIFIED BY 'password';
   GRANT ALL PRIVILEGES ON dnf_game_server.* TO 'dnf'@'localhost';
   FLUSH PRIVILEGES;

   # 创建制作系统表
   source sql/make_system.sql;
   ```

3. **部署服务**

   ```bash
   # 克隆代码
   git clone https://github.com/pixb/DnfGameServer.git
   cd DnfGameServer/dnf-go-server

   # 生成 ProtoBuf 代码
   make generate

   # 编译服务
   make build

   # 启动服务
   make start
   ```

### 8.3 配置说明

| 配置项 | 类型 | 默认值 | 说明 | 所属文件/模块 |
| :--- | :--- | :--- | :--- | :--- |
| `ServerPort` | `int` | `8081` | 服务器端口 | `config/config.go` |
| `MySQLDSN` | `string` | `dnf:password@tcp(localhost:3306)/dnf_game_server?charset=utf8mb4&parseTime=True&loc=Local` | MySQL 连接字符串 | `config/config.go` |
| `RedisAddr` | `string` | `localhost:6379` | Redis 地址 | `config/config.go` |
| `LogLevel` | `string` | `info` | 日志级别 | `config/config.go` |
| `MakeCacheTTL` | `time.Duration` | `5m` | 制作系统缓存时间 | `config/config.go` |

## 9. 监控与维护

### 9.1 监控指标

| 指标名称 | 类型 | 说明 | 监控方式 |
| :--- | :--- | :--- | :--- |
| 徽章升级次数 | `Counter` | 徽章升级的总次数 | Prometheus |
| 徽章升级成功率 | `Gauge` | 徽章升级的成功率 | Prometheus |
| 时装合成次数 | `Counter` | 时装合成的总次数 | Prometheus |
| 稀有时装合成率 | `Gauge` | 稀有时装的合成概率 | Prometheus |
| 物品分解次数 | `Counter` | 物品分解的总次数 | Prometheus |
| 卡片合成次数 | `Counter` | 卡片合成的总次数 | Prometheus |
| 卡片合成成功率 | `Gauge` | 卡片合成的成功率 | Prometheus |
| 错误率 | `Counter` | 错误次数 / 总请求次数 | Prometheus |
| 响应时间 | `Histogram` | API 响应时间分布 | Prometheus |

### 9.2 日志管理

| 日志级别 | 说明 | 存储位置 |
| :--- | :--- | :--- |
| `debug` | 调试信息 | `logs/debug.log` |
| `info` | 普通信息 | `logs/info.log` |
| `warn` | 警告信息 | `logs/warn.log` |
| `error` | 错误信息 | `logs/error.log` |

### 9.3 常见问题

| 问题 | 原因 | 解决方案 |
| :--- | :--- | :--- |
| 徽章升级失败率高 | 等级过高或未使用护身符 | 建议使用护身符或降低升级等级 |
| 时装合成不出稀有 | 概率问题 | 多次尝试或等待活动提升概率 |
| 物品分解材料少 | 装备等级或稀有度低 | 分解高等级高稀有度装备 |
| 卡片合成失败 | 卡片数量不足或稀有度过高 | 增加卡片数量或降低目标稀有度 |
| 制作系统响应慢 | 并发请求过多 | 优化数据库查询或增加缓存 |

## 10. 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
| :--- | :--- | :--- | :--- |
| 1.0 | 2026-02-17 | 系统自动生成 | 初始版本 |
| 1.1 | 2026-02-24 | 人工编辑 | 按照模板完善文档，添加系统概述、Java代码分析、Go实现方案、API文档、数据库设计文档、业务流程文档、测试用例文档、部署文档、监控与维护和变更记录等章节 |