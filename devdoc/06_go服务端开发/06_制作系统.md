# 制作系统设计文档

## 概述

制作系统提供玩家合成、分解、升级装备和物品的功能，包括徽章升级、时装合成、卡片合成、装备分解等。

## 功能模块

### 1. 徽章升级系统

#### 1.1 徽章升级 (REQ_ITEM_EMBLEM_UPGRADE_INVEN)

**功能描述**: 升级徽章等级，支持使用护身符增加成功率

**请求参数**:
- `index`: 徽章索引
- `trycount`: 尝试次数
- `talisman`: 护身符数量（可选）

**响应参数**:
- `success`: 成功次数
- `rewards`: 奖励信息
- `removeitems`: 消耗物品

**升级成功率**:
| 等级 | 成功率 |
|------|--------|
| 1-4  | 100%   |
| 5     | 70%    |
| 6     | 60%    |
| 7     | 50%    |
| 8     | 40%    |
| 9     | 30%    |

**金币消耗**:
| 等级 | 消耗金币 |
|------|----------|
| 1     | 1000     |
| 2     | 1500     |
| 3     | 2000     |
| 4     | 3000     |
| 5     | 4000     |
| 6     | 5000     |
| 7     | 10000    |
| 8     | 15000    |
| 9     | 30000    |

**护身符消耗**:
| 等级 | 护身符消耗 |
|------|------------|
| 6     | 1          |
| 7     | 3          |
| 8     | 8          |
| 9     | 19         |
| 10    | 46         |

#### 1.2 徽章快速升级 (REQ_ITEM_EMBLEM_UPGRADE_QUICK)

**功能描述**: 使用多个低级徽章快速合成高级徽章

**请求参数**:
- `source`: 源徽章列表（索引和数量）
- `target`: 目标徽章索引

**响应参数**:
- `rewards`: 奖励信息
- `removeitems`: 消耗物品

**消耗**:
- 金币: 1000
- 源徽章: 根据数量消耗
- 护身符: 根据目标等级消耗

### 2. 时装合成系统

#### 2.1 时装合成 (REQ_ITEM_AVATAR_COMPOSE)

**功能描述**: 合成时装，根据职业和装备类型随机生成新时装

**请求参数**:
- `guids`: 时装GUID列表

**响应参数**:
- `rewards`: 奖励信息（新时装）
- `removeitems`: 消耗物品

**合成规则**:
- 需要消耗合成材料（5种）
- 需要消耗合成券
- 根据职业和装备类型随机生成
- 15%概率生成稀有时装

**消耗**:
- 金币: 4000
- 合成材料: 5种各1个
- 合成券: 1个

### 3. 物品制作系统

#### 3.1 物品制作信息 (REQ_ITEM_PRODUCTION_INFO)

**功能描述**: 获取制作槽位信息

**请求参数**:
- `slottype`: 槽位类型（1=普通槽位）

**响应参数**:
- `infos`: 槽位信息列表
  - `slotindex`: 槽位索引
  - `usablecount`: 可用次数

**槽位配置**:
- 槽位1: 可用100次
- 槽位2: 可用100次
- 槽位3: 可用100次
- 槽位-1: 可用100次

#### 3.2 物品制作注册 (REQ_ITEM_PRODUCTION_REGISTER)

**功能描述**: 注册物品制作任务

**请求参数**:
- `slotindex`: 槽位索引
- `recipeindex`: 配方索引
- `count`: 制作数量

**响应参数**:
- `rewards`: 奖励信息
- `removeitems`: 消耗物品
- `materialitems`: 材料消耗列表

### 4. 物品合成系统

#### 4.1 物品合成 (REQ_ITEM_COMBINE)

**功能描述**: 合成装备或时装

**请求参数**:
- `index`: 目标物品索引
- `materialitems`: 材料物品列表
- `count`: 合成数量

**响应参数**:
- `equip`: 装备信息（如果是装备）
- `avatar`: 时装信息（如果是时装）
- `rewards`: 奖励信息
- `removeitems`: 消耗物品

### 5. 物品分解系统

#### 5.1 物品分解 (REQ_ITEM_DISJOINT)

**功能描述**: 分解装备获取材料

**请求参数**:
- `list`: 装备GUID列表

**响应参数**:
- `rewards`: 奖励信息（材料）
- `removeitems`: 消耗物品

**分解规则**:
| 稀有度 | 等级<50 | 等级>=50 | 材料权重 |
|--------|---------|----------|----------|
| 普通   | 1       | 5        | 10       |
| 优秀   | 1       | 5        | 20       |
| 稀有   | 1       | 5        | 30       |
| 史诗   | 1       | 5        | 40       |
| 传说   | 1       | 5        | 50       |
| 传说+  | -       | -        | 50       |

**材料索引**:
- 无尽之剑: 2013000000
- 普通材料: 2013000001
- 优秀材料: 2013000002
- 稀有材料: 2013000003
- 史诗材料: 2013000004
- 传说时装: 2013103571
- 传说武器: 1990000349

### 6. 卡片合成系统

#### 6.1 卡片合成 (REQ_CARD_COMPOSE)

**功能描述**: 合成卡片提升稀有度

**请求参数**:
- `usercardlist`: 卡片列表（索引和数量）

**响应参数**:
- `card`: 合成结果卡片
- `currency`: 金币信息
- `usercardlist`: 消耗的卡片列表

**合成成功率**:
| 稀有度 | 2张 | 3张 | 4张 |
|--------|------|------|------|
| 普通   | 20%  | 40%  | 80%  |
| 优秀   | 4%   | 8%   | 16%  |
| 稀有   | 2%   | 3%   | 4%   |
| 史诗   | 0%   | 0%   | 0%   |

**金币消耗**:
| 稀有度 | 权重 | 消耗公式 |
|--------|------|----------|
| 普通   | 1    | base * cnt * 1 * 0.1 |
| 优秀   | 2    | base * cnt * 2 * 0.1 |
| 稀有   | 4    | base * cnt * 4 * 0.1 |
| 史诗   | 10   | base * cnt * 10 * 0.1 |

基础值: 10000

### 7. 衣柜系统

#### 7.1 衣柜槽位设置 (REQ_WARDROBE_SET_SLOT)

**功能描述**: 设置衣柜槽位（预留功能）

**请求参数**: 无

**响应参数**: 无

## 数据模型

### 徽章升级记录
```go
type EmblemUpgrade struct {
    RoleID       uint64
    EmblemIndex  int
    Level        int
    TryCount     int
    SuccessCount int
    CostMoney    int
    CostTalisman int
    CreateTime   time.Time
}
```

### 时装合成记录
```go
type AvatarCompose struct {
    RoleID       uint64
    AvatarGUIDs  []uint64
    ResultIndex  int
    ResultGUID   uint64
    CostMoney    int
    CreateTime   time.Time
}
```

### 物品制作记录
```go
type ItemProduction struct {
    RoleID       uint64
    SlotIndex    int
    RecipeIndex  int
    Count        int
    ResultIndex  int
    ResultCount  int
    CostMoney    int
    CreateTime   time.Time
}
```

### 物品合成记录
```go
type ItemCombine struct {
    RoleID       uint64
    TargetIndex  int
    MaterialList []MaterialItem
    Count        int
    ResultGUID   uint64
    CostMoney    int
    CreateTime   time.Time
}
```

### 物品分解记录
```go
type ItemDisjoint struct {
    RoleID       uint64
    EquipGUIDs   []uint64
    MaterialList []MaterialItem
    CreateTime   time.Time
}
```

### 卡片合成记录
```go
type CardCompose struct {
    RoleID       uint64
    CardList     []CardItem
    ResultIndex  int
    ResultCount  int
    CostMoney    int
    CreateTime   time.Time
}
```

## API 端点

### REST API

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/v1/make/emblem/upgrade | 徽章升级 |
| POST | /api/v1/make/emblem/upgrade_quick | 徽章快速升级 |
| POST | /api/v1/make/avatar/compose | 时装合成 |
| GET  | /api/v1/make/production/info | 物品制作信息 |
| POST | /api/v1/make/production/register | 物品制作注册 |
| POST | /api/v1/make/item/combine | 物品合成 |
| POST | /api/v1/make/item/disjoint | 物品分解 |
| POST | /api/v1/make/card/compose | 卡片合成 |
| POST | /api/v1/make/wardrobe/slot | 衣柜槽位设置 |

## 错误码

| 错误码 | 描述 |
|--------|------|
| 0      | 成功 |
| 1      | 参数错误 |
| 2      | 物品不存在 |
| 3      | 物品数量不足 |
| 4      | 金币不足 |
| 5      | 配方不存在 |
| 6      | 槽位不可用 |
| 7      | 装备类型错误 |
| 8      | 合成失败 |
| 9      | 分解失败 |

## 业务规则

### 徽章升级
1. 升级需要消耗2个当前等级徽章
2. 成功则消耗2个，获得1个下一等级徽章
3. 失败则消耗1个，获得1个当前等级徽章
4. 使用护身符可以保证100%成功
5. 护身符优先使用2013104426，不足时使用2013000026

### 时装合成
1. 需要消耗5种合成材料各1个
2. 需要消耗1个合成券
3. 根据职业和装备类型随机生成
4. 15%概率生成稀有时装

### 物品制作
1. 根据配方消耗材料
2. 根据配方消耗金币
3. 制作结果根据配方确定

### 物品分解
1. 根据装备稀有度和等级计算材料数量
2. 传说装备（等级>=55）分解为传说时装或武器
3. 分解后装备被删除

### 卡片合成
1. 需要2-4张相同稀有度的卡片
2. 合成成功率根据卡片数量和稀有度计算
3. 成功则获得高一级稀有度的卡片
4. 失败则获得相同稀有度的卡片
5. 史诗卡片无法合成更高级别

## 性能考虑

1. **批量操作**: 支持批量合成和分解
2. **缓存**: 配方和材料信息使用缓存
3. **事务**: 涉及多个物品操作时使用事务
4. **并发**: 使用锁保证并发安全

## 测试用例

### 徽章升级测试
- 测试正常升级
- 测试使用护身符升级
- 测试升级失败
- 测试金币不足
- 测试徽章数量不足

### 时装合成测试
- 测试正常合成
- 测试稀有时装合成
- 测试材料不足
- 测试合成券不足

### 物品制作测试
- 测试获取制作信息
- 测试注册制作任务
- 测试制作完成
- 测试材料不足

### 物品合成测试
- 测试装备合成
- 测试时装合成
- 测试材料不足

### 物品分解测试
- 测试普通装备分解
- 测试稀有装备分解
- 测试传说装备分解
- 测试批量分解

### 卡片合成测试
- 测试2张卡片合成
- 测试3张卡片合成
- 测试4张卡片合成
- 测试合成成功
- 测试合成失败

## 参考资料

- Java Controller: `src/main/java/com/dnfm/game/make/MakeController.java`
- Protobuf 定义: `src/main/java/com/dnfm/mina/protobuf/`
- 物品数据: `ItemDataPool`
- 配方数据: `DataCache.RECIPE_INDEX`
