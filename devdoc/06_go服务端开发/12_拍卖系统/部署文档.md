# 拍卖系统 - 部署文档

## 1. 概述
本文档描述了拍卖系统的部署流程，包括环境准备、依赖安装、配置管理、部署方式和回滚策略等。通过标准化的部署流程，确保拍卖系统能够在不同环境中稳定运行。

## 2. 环境准备

### 2.1 硬件环境

| 环境类型 | CPU | 内存 | 存储 | 网络 |
|---------|------|------|------|------|
| 开发环境 | 4核 | 8GB | 100GB SSD | 局域网 |
| 测试环境 | 8核 | 16GB | 200GB SSD | 局域网 |
| 预生产环境 | 16核 | 32GB | 500GB SSD | 公网 |
| 生产环境 | 32核 | 64GB | 1TB SSD | 公网 |

### 2.2 软件环境

| 软件 | 版本 | 用途 | 安装命令 |
|------|------|------|----------|
| Go | 1.20+ | 开发和运行环境 | `wget https://go.dev/dl/go1.20.0.linux-amd64.tar.gz && tar -C /usr/local -xzf go1.20.0.linux-amd64.tar.gz && export PATH=$PATH:/usr/local/go/bin` |
| MySQL | 8.0+ | 数据库 | `apt install mysql-server-8.0` (Ubuntu) 或 `yum install mysql-server-8.0` (CentOS) |
| Redis | 7.0+ | 缓存 | `apt install redis-server` (Ubuntu) 或 `yum install redis` (CentOS) |
| Nginx | 1.20+ | 反向代理 | `apt install nginx` (Ubuntu) 或 `yum install nginx` (CentOS) |
| Docker | 20.10+ | 容器化部署 | `curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh` |
| Docker Compose | 1.29+ | 容器编排 | `curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose` |
| Git | 2.30+ | 版本控制 | `apt install git` (Ubuntu) 或 `yum install git` (CentOS) |

### 2.3 网络环境

| 环境类型 | 端口 | 用途 | 防火墙规则 |
|---------|------|------|------------|
| 开发环境 | 8080 | HTTP服务 | 开放 |
| 测试环境 | 8080 | HTTP服务 | 开放 |
| 预生产环境 | 80/443 | HTTP/HTTPS服务 | 开放 |
| 生产环境 | 80/443 | HTTP/HTTPS服务 | 开放 |
| 生产环境 | 3306 | MySQL | 仅允许内部访问 |
| 生产环境 | 6379 | Redis | 仅允许内部访问 |
| 生产环境 | 50051 | gRPC服务 | 仅允许内部访问 |

## 3. 依赖管理

### 3.1 Go依赖

**go.mod**
```go
module github.com/pixb/DnfGameServer/dnf-go-server

go 1.20

require (
	github.com/gin-gonic/gin v1.9.1
	github.com/go-redis/redis/v8 v8.11.5
	github.com/golang-jwt/jwt/v5 v5.0.0
	github.com/google/uuid v1.3.0
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.16.0
	github.com/joho/godotenv v1.5.1
	github.com/lib/pq v1.10.9
	github.com/spf13/viper v1.18.2
	golang.org/x/crypto v0.14.0
	google.golang.org/grpc v1.59.0
	google.golang.org/protobuf v1.31.0
	gorm.io/driver/mysql v1.5.2
	gorm.io/gorm v1.25.4
)
```

### 3.2 外部服务依赖

| 服务 | 版本 | 用途 | 连接方式 |
|------|------|------|----------|
| MySQL | 8.0+ | 数据库 | `mysql://username:password@hostname:3306/database` |
| Redis | 7.0+ | 缓存 | `redis://hostname:6379/0` |
| RabbitMQ | 3.10+ | 消息队列 | `amqp://username:password@hostname:5672/` |
| Elasticsearch | 7.17+ | 日志存储 | `http://hostname:9200` |
| Prometheus | 2.40+ | 监控 | `http://hostname:9090` |
| Grafana | 9.0+ | 监控面板 | `http://hostname:3000` |

## 4. 配置管理

### 4.1 配置文件结构

```
config/
├── dev/
│   ├── app.yaml        # 应用配置
│   ├── database.yaml   # 数据库配置
│   ├── redis.yaml      # Redis配置
│   ├── rabbitmq.yaml   # 消息队列配置
│   └── monitoring.yaml # 监控配置
├── test/
│   └── ...
├── pre/
│   └── ...
└── prod/
    └── ...
```

### 4.2 应用配置 (app.yaml)

```yaml
# 应用配置
app:
  name: "auction-service"
  version: "1.0.0"
  env: "prod"
  port: 8080
  grpc_port: 50051
  read_timeout: 10s
  write_timeout: 10s
  shutdown_timeout: 30s

# 拍卖配置
auction:
  max_auction_items_per_user: 10
  min_bid_increment: 100
  auction_duration_options: [1, 6, 12, 24]
  expired_check_interval: 60s
  cache_ttl: 300s
  max_concurrent_bids: 100

# 日志配置
log:
  level: "info"
  format: "json"
  output: "stdout"
  file: "/var/log/auction-service.log"
  max_size: 100
  max_backups: 10
  max_age: 7

# 安全配置
security:
  jwt_secret: "your-secret-key"
  jwt_expiration: 24h
  cors: true
  allowed_origins: ["*"]
  rate_limit: true
  max_requests_per_second: 100
```

### 4.3 数据库配置 (database.yaml)

```yaml
# 数据库配置
mysql:
  host: "localhost"
  port: 3306
  username: "auction_user"
  password: "your-password"
  database: "auction_db"
  charset: "utf8mb4"
  parse_time: true
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_lifetime: 1h
```

### 4.4 Redis配置 (redis.yaml)

```yaml
# Redis配置
redis:
  host: "localhost"
  port: 6379
  password: ""
  db: 0
  pool_size: 10
  min_idle_conns: 5
  max_retries: 3
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s
  idle_timeout: 5m
```

### 4.5 环境变量配置

| 环境变量 | 描述 | 默认值 | 示例 |
|---------|------|--------|------|
| `APP_ENV` | 应用环境 | `dev` | `prod` |
| `APP_PORT` | HTTP服务端口 | `8080` | `80` |
| `GRPC_PORT` | gRPC服务端口 | `50051` | `50051` |
| `DB_HOST` | 数据库主机 | `localhost` | `db.example.com` |
| `DB_PORT` | 数据库端口 | `3306` | `3306` |
| `DB_USER` | 数据库用户 | `auction_user` | `auction_user` |
| `DB_PASSWORD` | 数据库密码 | `your-password` | `your-secure-password` |
| `DB_NAME` | 数据库名称 | `auction_db` | `auction_db` |
| `REDIS_HOST` | Redis主机 | `localhost` | `redis.example.com` |
| `REDIS_PORT` | Redis端口 | `6379` | `6379` |
| `REDIS_PASSWORD` | Redis密码 | `` | `your-redis-password` |
| `JWT_SECRET` | JWT密钥 | `your-secret-key` | `your-secure-jwt-secret` |
| `LOG_LEVEL` | 日志级别 | `info` | `debug` |

## 5. 部署方式

### 5.1 本地部署

**步骤1: 克隆代码**
```bash
git clone https://github.com/pixb/DnfGameServer.git
cd DnfGameServer/dnf-go-server
```

**步骤2: 安装依赖**
```bash
go mod download
```

**步骤3: 配置环境**
```bash
cp .env.example .env
# 编辑.env文件，配置数据库、Redis等连接信息
```

**步骤4: 构建应用**
```bash
go build -o auction-service ./cmd/server
```

**步骤5: 运行应用**
```bash
./auction-service
```

### 5.2 Docker部署

**步骤1: 创建Dockerfile**

```dockerfile
FROM golang:1.20-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN go build -o auction-service ./cmd/server

FROM alpine:latest

WORKDIR /app

COPY --from=builder /app/auction-service .
COPY --from=builder /app/config ./config
COPY --from=builder /app/.env.example .env

RUN apk add --no-cache tzdata
ENV TZ=Asia/Shanghai

EXPOSE 8080 50051

CMD ["./auction-service"]
```

**步骤2: 创建docker-compose.yml**

```yaml
version: '3.8'

services:
  auction-service:
    build: .
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - APP_ENV=prod
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=auction_user
      - DB_PASSWORD=your-password
      - DB_NAME=auction_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root-password
      - MYSQL_USER=auction_user
      - MYSQL_PASSWORD=your-password
      - MYSQL_DATABASE=auction_db
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql

  redis:
    image: redis:7.0
    volumes:
      - redis-data:/data

volumes:
  mysql-data:
  redis-data:
```

**步骤3: 构建和运行**
```bash
docker-compose up -d --build
```

### 5.3  Kubernetes部署

**步骤1: 创建命名空间**
```bash
kubectl create namespace auction-system
```

**步骤2: 创建配置文件 (configmap.yaml)**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: auction-service-config
  namespace: auction-system
data:
  app.yaml: |
    app:
      name: "auction-service"
      version: "1.0.0"
      env: "prod"
      port: 8080
      grpc_port: 50051
    auction:
      max_auction_items_per_user: 10
      min_bid_increment: 100
  database.yaml: |
    mysql:
      host: "mysql.auction-system.svc.cluster.local"
      port: 3306
      username: "auction_user"
      password: "your-password"
      database: "auction_db"
  redis.yaml: |
    redis:
      host: "redis.auction-system.svc.cluster.local"
      port: 6379
      password: ""
      db: 0
```

**步骤3: 创建密钥文件 (secret.yaml)**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: auction-service-secret
  namespace: auction-system
type: Opaque
data:
  jwt_secret: <base64-encoded-jwt-secret>
  db_password: <base64-encoded-db-password>
  redis_password: <base64-encoded-redis-password>
```

**步骤4: 创建部署文件 (deployment.yaml)**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auction-service
  namespace: auction-system
  labels:
    app: auction-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auction-service
  template:
    metadata:
      labels:
        app: auction-service
    spec:
      containers:
      - name: auction-service
        image: ghcr.io/pixb/auction-service:v1.0.0
        ports:
        - containerPort: 8080
        - containerPort: 50051
        env:
        - name: APP_ENV
          value: "prod"
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: auction-service-secret
              key: jwt_secret
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
      volumes:
      - name: config-volume
        configMap:
          name: auction-service-config
```

**步骤5: 创建服务文件 (service.yaml)**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: auction-service
  namespace: auction-system
spec:
  selector:
    app: auction-service
  ports:
  - port: 80
    targetPort: 8080
    name: http
  - port: 50051
    targetPort: 50051
    name: grpc
  type: ClusterIP
```

**步骤6: 创建Ingress文件 (ingress.yaml)**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auction-service-ingress
  namespace: auction-system
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/"
spec:
  tls:
  - hosts:
    - auction.example.com
    secretName: auction-tls
  rules:
  - host: auction.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: auction-service
            port:
              name: http
```

**步骤7: 应用配置**
```bash
kubectl apply -f configmap.yaml
kubectl apply -f secret.yaml
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f ingress.yaml
```

### 5.4 持续集成/持续部署 (CI/CD)

**步骤1: 创建CI/CD配置文件 (.github/workflows/ci-cd.yml)**

```yaml
name: CI/CD for Auction Service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
    
    - name: Build
      run: go build -v ./...
    
    - name: Test
      run: go test -v ./...
    
    - name: Build Docker image
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        docker build -t ghcr.io/pixb/auction-service:${{ github.sha }} .
        docker tag ghcr.io/pixb/auction-service:${{ github.sha }} ghcr.io/pixb/auction-service:latest
    
    - name: Login to GitHub Container Registry
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Push Docker image
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        docker push ghcr.io/pixb/auction-service:${{ github.sha }}
        docker push ghcr.io/pixb/auction-service:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to Kubernetes
      uses: azure/k8s-deploy@v4
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
        namespace: auction-system
        manifests: |
          k8s/deployment.yaml
        images: |
          ghcr.io/pixb/auction-service:${{ github.sha }}
        imagepullsecrets: |
          regcred
```

**步骤2: 配置GitHub Secrets**
- `KUBE_CONFIG`: Kubernetes配置文件
- `GITHUB_TOKEN`: GitHub访问令牌

## 6. 数据库部署

### 6.1 数据库初始化

**步骤1: 创建数据库**
```sql
CREATE DATABASE auction_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE USER 'auction_user'@'%' IDENTIFIED BY 'your-password';
GRANT ALL PRIVILEGES ON auction_db.* TO 'auction_user'@'%';
FLUSH PRIVILEGES;
```

**步骤2: 执行初始化脚本**

```sql
-- 创建拍卖物品表
CREATE TABLE IF NOT EXISTS auction_items (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    seller_id BIGINT UNSIGNED NOT NULL,
    item_id BIGINT UNSIGNED NOT NULL,
    item_name VARCHAR(100) NOT NULL,
    item_count INT NOT NULL,
    item_quality INT NOT NULL,
    start_price BIGINT UNSIGNED NOT NULL,
    buyout_price BIGINT UNSIGNED,
    current_price BIGINT UNSIGNED NOT NULL,
    highest_bidder_id BIGINT UNSIGNED,
    start_time DATETIME NOT NULL,
    end_time DATETIME NOT NULL,
    status TINYINT NOT NULL DEFAULT 0,
    category INT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_seller_id (seller_id),
    INDEX idx_status (status),
    INDEX idx_end_time (end_time),
    INDEX idx_category (category),
    INDEX idx_highest_bidder_id (highest_bidder_id),
    INDEX idx_status_end_time (status, end_time)
);

-- 创建竞拍记录表
CREATE TABLE IF NOT EXISTS auction_bids (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    auction_id BIGINT UNSIGNED NOT NULL,
    bidder_id BIGINT UNSIGNED NOT NULL,
    bid_price BIGINT UNSIGNED NOT NULL,
    bid_time DATETIME NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_auction_id (auction_id),
    INDEX idx_bidder_id (bidder_id),
    INDEX idx_auction_bid_time (auction_id, bid_time),
    FOREIGN KEY (auction_id) REFERENCES auction_items(id) ON DELETE CASCADE
);

-- 创建拍卖交易表
CREATE TABLE IF NOT EXISTS auction_transactions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    auction_id BIGINT UNSIGNED NOT NULL,
    seller_id BIGINT UNSIGNED NOT NULL,
    buyer_id BIGINT UNSIGNED NOT NULL,
    item_id BIGINT UNSIGNED NOT NULL,
    item_count INT NOT NULL,
    transaction_price BIGINT UNSIGNED NOT NULL,
    transaction_time DATETIME NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_auction_id (auction_id),
    INDEX idx_seller_id (seller_id),
    INDEX idx_buyer_id (buyer_id),
    INDEX idx_transaction_time (transaction_time),
    FOREIGN KEY (auction_id) REFERENCES auction_items(id) ON DELETE CASCADE
);

-- 创建资金冻结表
CREATE TABLE IF NOT EXISTS fund_freezes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    auction_id BIGINT UNSIGNED NOT NULL,
    amount BIGINT UNSIGNED NOT NULL,
    status TINYINT NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_auction_id (auction_id),
    INDEX idx_status (status),
    INDEX idx_user_auction (user_id, auction_id),
    FOREIGN KEY (auction_id) REFERENCES auction_items(id) ON DELETE CASCADE
);

-- 创建拍卖分类表
CREATE TABLE IF NOT EXISTS auction_categories (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    description VARCHAR(255),
    sort_order INT UNSIGNED NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_sort_order (sort_order)
);

-- 创建拍卖配置表
CREATE TABLE IF NOT EXISTS auction_configs (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `key` VARCHAR(50) NOT NULL UNIQUE,
    `value` VARCHAR(255) NOT NULL,
    description VARCHAR(255),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_key (`key`)
);

-- 插入默认分类
INSERT INTO auction_categories (name, description, sort_order) VALUES
('武器', '武器类物品', 1),
('防具', '防具类物品', 2),
('饰品', '饰品类物品', 3),
('消耗品', '消耗品类物品', 4),
('材料', '材料类物品', 5),
('其他', '其他类物品', 6);

-- 插入默认配置
INSERT INTO auction_configs (`key`, `value`, description) VALUES
('max_auction_items_per_user', '10', '每个用户最大拍卖物品数'),
('min_bid_increment', '100', '最小加价幅度'),
('auction_duration_options', '1,6,12,24', '拍卖时长选项（小时）'),
('expired_check_interval', '60', '过期检查间隔（秒）'),
('cache_ttl', '300', '缓存过期时间（秒）'),
('max_concurrent_bids', '100', '最大并发竞拍数');
```

### 6.2 数据库迁移

**使用GORM AutoMigrate**
```go
func initDatabase() error {
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
    if err != nil {
        return err
    }
    
    // 自动迁移
    return db.AutoMigrate(
        &AuctionItem{},
        &AuctionBid{},
        &AuctionTransaction{},
        &FundFreeze{},
        &AuctionCategory{},
        &AuctionConfig{},
    )
}
```

**使用Flyway**

```bash
# 安装Flyway
wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.22.3/flyway-commandline-9.22.3-linux-x64.tar.gz | tar -xvz

# 配置Flyway
cat > flyway.conf << EOF
flyway.url=jdbc:mysql://localhost:3306/auction_db
flyway.user=auction_user
flyway.password=your-password
flyway.locations=filesystem:scripts/migrations
EOF

# 执行迁移
./flyway-9.22.3/flyway migrate
```

## 7. 监控与告警部署

### 7.1 Prometheus配置

**prometheus.yaml**
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'auction-service'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['auction-service:8080']

  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql:9104']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']
```

### 7.2 Grafana配置

**Dashboard JSON**
```json
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "id": 1,
  "links": [],
  "panels": [
    {
      "aliasColors": {},
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "custom": {}
        },
        "overrides": []
      },
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 0
      },
      "hiddenSeries": false,
      "id": 2,
      "legend": {
        "avg": false,
        "current": false,
        "max": false,
        "min": false,
        "show": true,
        "total": false,
        "values": false
      },
      "lines": true,
      "linewidth": 1,
      "nullPointMode": "null",
      "options": {
        "alertThreshold": true
      },
      "percentage": false,
      "pluginVersion": "8.2.0",
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "expr": "rate(auction_service_requests_total[5m])",
          "interval": "",
          "legendFormat": "{{endpoint}}",
          "refId": "A"
        }
      ],
      "thresholds": [],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "API请求率",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    }
  ],
  "refresh": "5s",
  "schemaVersion": 27,
  "style": "dark",
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "拍卖服务监控",
  "uid": "auction-service-dashboard",
  "version": 1
}
```

### 7.3 告警配置

**alertmanager.yaml**
```yaml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 1h
  receiver: 'email'
  routes:
  - match:
      severity: critical
    receiver: 'email'

receivers:
- name: 'email'
  email_configs:
  - to: 'admin@example.com'
    from: 'alertmanager@example.com'
    smarthost: 'smtp.example.com:587'
    auth_username: 'alertmanager'
    auth_password: 'your-password'
    require_tls: true

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
```

**告警规则**
```yaml
groups:
- name: auction-service-alerts
  rules:
  - alert: AuctionServiceDown
    expr: up{job="auction-service"} == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "拍卖服务宕机"
      description: "拍卖服务 {{ $labels.instance }} 已宕机超过5分钟"

  - alert: HighErrorRate
    expr: rate(auction_service_errors_total[5m]) / rate(auction_service_requests_total[5m]) > 0.05
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "错误率过高"
      description: "拍卖服务错误率超过5%"

  - alert: HighLatency
    expr: histogram_quantile(0.95, rate(auction_service_request_duration_seconds_bucket[5m])) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "响应时间过长"
      description: "拍卖服务95%请求响应时间超过1秒"

  - alert: DatabaseDown
    expr: up{job="mysql"} == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "数据库宕机"
      description: "MySQL数据库已宕机超过5分钟"

  - alert: RedisDown
    expr: up{job="redis"} == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Redis宕机"
      description: "Redis缓存已宕机超过5分钟"
```

## 8. 部署验证

### 8.1 健康检查

**HTTP健康检查**
```bash
curl -X GET http://localhost:8080/health
# 预期响应: {"status": "ok", "version": "1.0.0"}
```

**gRPC健康检查**
```bash
grpc_health_probe -addr=localhost:50051
# 预期响应: service Healthy
```

### 8.2 功能验证

**创建拍卖测试**
```bash
curl -X POST http://localhost:8080/api/auction/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"item_id": 1, "item_count": 1, "start_price": 10000, "buyout_price": 50000, "duration": 24, "category": 1}'
```

**获取拍卖列表测试**
```bash
curl -X GET http://localhost:8080/api/auction/list?page=1&page_size=20&category=1&sort=time
```

### 8.3 性能验证

**使用JMeter进行负载测试**
1. 创建测试计划
2. 添加线程组（100并发用户）
3. 添加HTTP请求（获取拍卖列表）
4. 添加监听器（查看结果树、聚合报告）
5. 运行测试，验证响应时间和成功率

## 9. 回滚策略

### 9.1 版本回滚

**Docker回滚**
```bash
# 停止当前版本
docker-compose down

# 启动之前的版本
docker-compose -f docker-compose.old.yml up -d
```

**Kubernetes回滚**
```bash
# 查看部署历史
kubectl rollout history deployment auction-service -n auction-system

# 回滚到之前的版本
kubectl rollout undo deployment auction-service -n auction-system --to-revision=1

# 验证回滚状态
kubectl rollout status deployment auction-service -n auction-system
```

### 9.2 数据库回滚

**使用备份回滚**
```bash
# 停止服务
kubectl scale deployment auction-service -n auction-system --replicas=0

# 恢复数据库
mysql -u auction_user -p auction_db < backup.sql

# 启动服务
kubectl scale deployment auction-service -n auction-system --replicas=3
```

### 9.3 应急响应

**步骤1: 识别问题**
- 监控告警触发
- 日志分析
- 用户反馈

**步骤2: 隔离问题**
- 停止有问题的实例
- 流量切换到健康实例

**步骤3: 解决问题**
- 回滚到稳定版本
- 修复代码
- 重新部署

**步骤4: 验证修复**
- 健康检查
- 功能测试
- 性能测试

**步骤5: 恢复服务**
- 启动所有实例
- 恢复流量
- 监控服务状态

## 10. 总结

本文档详细描述了拍卖系统的部署流程，包括环境准备、依赖安装、配置管理、部署方式、数据库部署、监控与告警部署、部署验证和回滚策略等。通过标准化的部署流程和最佳实践，可以确保拍卖系统在不同环境中稳定运行，提高系统的可靠性和可维护性。

在实际部署过程中，应根据具体的环境和需求，对部署方案进行适当的调整和优化。同时，应建立完善的部署文档和操作手册，确保部署过程的可重复性和一致性。