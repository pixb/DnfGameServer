# 拍卖系统 - 测试用例文档

## 1. 概述
本文档描述了拍卖系统的测试用例，包括单元测试、集成测试和端到端测试。测试用例覆盖了拍卖系统的核心功能，确保系统的正确性、可靠性和性能。

## 2. 测试环境

### 2.1 硬件环境

| 设备 | 配置 | 用途 |
|------|------|------|
| 服务器 | 8核16G | 运行拍卖系统服务 |
| 数据库服务器 | 4核8G | 运行MySQL数据库 |
| 缓存服务器 | 2核4G | 运行Redis缓存 |
| 测试客户端 | 4核8G | 运行测试脚本和工具 |

### 2.2 软件环境

| 软件 | 版本 | 用途 |
|------|------|------|
| Go | 1.20+ | 开发和运行拍卖系统 |
| MySQL | 8.0+ | 存储拍卖数据 |
| Redis | 7.0+ | 缓存热点数据 |
| Gin | v1.9.0+ | Web框架 |
| GORM | v1.25.0+ | ORM框架 |
| gRPC | v1.50.0+ | RPC框架 |
| JUnit | 5.0+ | Java单元测试 |
| TestNG | 7.0+ | Java集成测试 |
| Postman | 9.0+ | API测试 |
| JMeter | 5.0+ | 性能测试 |

### 2.3 网络环境

| 网络类型 | 带宽 | 延迟 | 用途 |
|---------|------|------|------|
| 局域网 | 1Gbps | <1ms | 开发和测试 |
| 公网 | 100Mbps | <50ms | 外部访问测试 |

## 3. 测试用例

### 3.1 单元测试

#### 3.1.1 拍卖服务测试

**测试类**：`AuctionServiceTest`

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 创建拍卖成功 | `testCreateAuctionSuccess` | 物品ID: 1, 数量: 1, 起拍价: 10000, 一口价: 50000, 时长: 24, 分类: 1 | 返回成功，拍卖状态为"拍卖中" |
| 创建拍卖失败 - 物品不存在 | `testCreateAuctionItemNotFound` | 物品ID: 999, 数量: 1, 起拍价: 10000, 一口价: 50000, 时长: 24, 分类: 1 | 返回错误，提示"物品不存在" |
| 创建拍卖失败 - 物品数量不足 | `testCreateAuctionInsufficientItem` | 物品ID: 1, 数量: 10, 起拍价: 10000, 一口价: 50000, 时长: 24, 分类: 1 | 返回错误，提示"物品数量不足" |
| 创建拍卖失败 - 达到限制 | `testCreateAuctionLimitReached` | 物品ID: 1, 数量: 1, 起拍价: 10000, 一口价: 50000, 时长: 24, 分类: 1 | 返回错误，提示"拍卖数量达到上限" |
| 竞拍成功 | `testBidSuccess` | 拍卖ID: 1, 出价: 15000 | 返回成功，当前价格更新为15000 |
| 竞拍失败 - 拍卖不存在 | `testBidAuctionNotFound` | 拍卖ID: 999, 出价: 15000 | 返回错误，提示"拍卖不存在" |
| 竞拍失败 - 拍卖未激活 | `testBidAuctionNotActive` | 拍卖ID: 1, 出价: 15000 | 返回错误，提示"拍卖未激活" |
| 竞拍失败 - 出价过低 | `testBidPriceTooLow` | 拍卖ID: 1, 出价: 5000 | 返回错误，提示"出价过低" |
| 竞拍失败 - 货币不足 | `testBidInsufficientCurrency` | 拍卖ID: 1, 出价: 1000000 | 返回错误，提示"货币不足" |
| 一口价购买成功 | `testBuyoutSuccess` | 拍卖ID: 1 | 返回成功，拍卖状态为"已成交" |
| 一口价购买失败 - 拍卖不存在 | `testBuyoutAuctionNotFound` | 拍卖ID: 999 | 返回错误，提示"拍卖不存在" |
| 一口价购买失败 - 一口价不可用 | `testBuyoutNotAvailable` | 拍卖ID: 1 | 返回错误，提示"一口价不可用" |
| 一口价购买失败 - 货币不足 | `testBuyoutInsufficientCurrency` | 拍卖ID: 1 | 返回错误，提示"货币不足" |
| 取消拍卖成功 | `testCancelSuccess` | 拍卖ID: 1 | 返回成功，拍卖状态为"已取消" |
| 取消拍卖失败 - 拍卖不存在 | `testCancelAuctionNotFound` | 拍卖ID: 999 | 返回错误，提示"拍卖不存在" |
| 取消拍卖失败 - 权限不足 | `testCancelPermissionDenied` | 拍卖ID: 1 | 返回错误，提示"权限不足" |
| 获取拍卖列表 | `testGetAuctionList` | 页码: 1, 每页数量: 20, 分类: 1, 排序: "time" | 返回拍卖列表，按结束时间排序 |
| 获取我的拍卖 | `testGetMyAuctions` | 页码: 1, 每页数量: 20 | 返回用户的拍卖列表，包括上架、竞拍和完成的拍卖 |
| 处理过期拍卖 - 成交 | `testProcessExpiredAuctionSold` | 拍卖ID: 1 (有最高出价者) | 拍卖状态更新为"已成交"，物品转移给最高出价者 |
| 处理过期拍卖 - 流拍 | `testProcessExpiredAuctionExpired` | 拍卖ID: 1 (无最高出价者) | 拍卖状态更新为"流拍"，物品返回给卖家 |

#### 3.1.2 处理器测试

**测试类**：`AuctionHandlerTest`

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 创建拍卖API | `testCreateAuctionAPI` | POST /api/auction/create, 物品ID: 1, 数量: 1, 起拍价: 10000, 一口价: 50000, 时长: 24, 分类: 1 | 返回200 OK，拍卖创建成功 |
| 竞拍API | `testBidAPI` | POST /api/auction/bid, 拍卖ID: 1, 出价: 15000 | 返回200 OK，竞拍成功 |
| 一口价购买API | `testBuyoutAPI` | POST /api/auction/buyout, 拍卖ID: 1 | 返回200 OK，购买成功 |
| 取消拍卖API | `testCancelAPI` | POST /api/auction/cancel, 拍卖ID: 1 | 返回200 OK，取消成功 |
| 获取拍卖列表API | `testGetAuctionListAPI` | GET /api/auction/list?page=1&page_size=20&category=1&sort=time | 返回200 OK，拍卖列表按结束时间排序 |
| 获取我的拍卖API | `testGetMyAuctionsAPI` | GET /api/auction/my?page=1&page_size=20 | 返回200 OK，返回用户的拍卖列表 |

#### 3.1.3 辅助方法测试

**测试类**：`AuctionUtilTest`

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 计算剩余时间 | `testCalculateTimeLeft` | 结束时间: 当前时间+1小时 | 返回3600秒 |
| 验证竞拍价格 | `testValidateBidPrice` | 当前价格: 10000, 出价: 15000, 最小加价: 100 | 返回true |
| 验证竞拍价格 - 过低 | `testValidateBidPriceTooLow` | 当前价格: 10000, 出价: 9000, 最小加价: 100 | 返回false |
| 格式化拍卖状态 | `testFormatAuctionStatus` | 状态: 0 | 返回"拍卖中" |
| 构建拍卖响应 | `testBuildAuctionResponse` | 拍卖物品对象 | 返回格式化的拍卖响应对象 |

### 3.2 集成测试

#### 3.2.1 拍卖流程集成测试

**测试类**：`AuctionFlowIntegrationTest`

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 完整拍卖流程 | `testCompleteAuctionFlow` | 物品ID: 1, 起拍价: 10000, 一口价: 50000, 时长: 1, 竞拍价格: 15000, 20000 | 拍卖创建→竞拍→成交→物品转移→货币转移→通知发送，全流程成功 |
| 一口价购买流程 | `testBuyoutFlow` | 物品ID: 1, 起拍价: 10000, 一口价: 50000, 时长: 1 | 拍卖创建→一口价购买→成交→物品转移→货币转移→通知发送，全流程成功 |
| 取消拍卖流程 | `testCancelFlow` | 物品ID: 1, 起拍价: 10000, 时长: 1 | 拍卖创建→取消→物品返还→通知发送，全流程成功 |
| 流拍流程 | `testExpiredFlow` | 物品ID: 1, 起拍价: 10000, 时长: 1 | 拍卖创建→过期→物品返还→通知发送，全流程成功 |

#### 3.2.2 服务集成测试

**测试类**：`AuctionServiceIntegrationTest`

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 拍卖服务与用户服务集成 | `testAuctionUserIntegration` | 拍卖ID: 1, 用户ID: 1 | 拍卖服务能正确获取用户信息 |
| 拍卖服务与物品服务集成 | `testAuctionItemIntegration` | 拍卖ID: 1, 物品ID: 1 | 拍卖服务能正确获取和转移物品 |
| 拍卖服务与货币服务集成 | `testAuctionCurrencyIntegration` | 拍卖ID: 1, 用户ID: 1, 金额: 10000 | 拍卖服务能正确操作货币 |
| 拍卖服务与通知服务集成 | `testAuctionNotificationIntegration` | 拍卖ID: 1, 用户ID: 1 | 拍卖服务能正确发送通知 |
| 拍卖服务与缓存集成 | `testAuctionCacheIntegration` | 拍卖ID: 1 | 拍卖服务能正确使用缓存 |

#### 3.2.3 数据库集成测试

**测试类**：`AuctionDatabaseIntegrationTest`

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 拍卖物品CRUD | `testAuctionItemCRUD` | 拍卖物品数据 | 能正确创建、读取、更新、删除拍卖物品 |
| 竞拍记录CRUD | `testAuctionBidCRUD` | 竞拍记录数据 | 能正确创建、读取、更新、删除竞拍记录 |
| 交易记录CRUD | `testAuctionTransactionCRUD` | 交易记录数据 | 能正确创建、读取、更新、删除交易记录 |
| 资金冻结CRUD | `testFundFreezeCRUD` | 资金冻结数据 | 能正确创建、读取、更新、删除资金冻结记录 |
| 索引性能测试 | `testIndexPerformance` | 大量拍卖数据 | 带索引的查询性能优于无索引的查询 |

### 3.3 端到端测试

#### 3.3.1 API端到端测试

**测试工具**：Postman

| 测试用例 | 请求方法 | 请求路径 | 测试数据 | 预期结果 |
|---------|---------|---------|---------|----------|
| 创建拍卖 | POST | /api/auction/create | {"item_id": 1, "item_count": 1, "start_price": 10000, "buyout_price": 50000, "duration": 24, "category": 1} | 200 OK, {"code": 0, "message": "Auction created successfully", "auction_id": 1} |
| 竞拍 | POST | /api/auction/bid | {"auction_id": 1, "bid_price": 15000} | 200 OK, {"code": 0, "message": "Bid placed successfully", "auction_id": 1} |
| 一口价购买 | POST | /api/auction/buyout | {"auction_id": 1} | 200 OK, {"code": 0, "message": "Auction bought out successfully", "auction_id": 1} |
| 取消拍卖 | POST | /api/auction/cancel | {"auction_id": 1} | 200 OK, {"code": 0, "message": "Auction cancelled successfully", "auction_id": 1} |
| 获取拍卖列表 | GET | /api/auction/list?page=1&page_size=20&category=1&sort=time | N/A | 200 OK, 返回拍卖列表，按结束时间排序 |
| 获取我的拍卖 | GET | /api/auction/my?page=1&page_size=20 | N/A | 200 OK, 返回用户的拍卖列表 |

#### 3.3.2 gRPC端到端测试

**测试工具**：gRPC客户端

| 测试用例 | 方法 | 测试数据 | 预期结果 |
|---------|------|---------|----------|
| CreateAuction | CreateAuction | item_id: 1, item_count: 1, start_price: 10000, buyout_price: 50000, duration: 24, category: 1 | 返回成功，auction_id: 1 |
| Bid | Bid | auction_id: 1, bid_price: 15000 | 返回成功，auction_id: 1 |
| Buyout | Buyout | auction_id: 1 | 返回成功，auction_id: 1 |
| Cancel | Cancel | auction_id: 1 | 返回成功，auction_id: 1 |
| GetAuctionList | GetAuctionList | page: 1, page_size: 20, category: 1, sort: "time" | 返回拍卖列表，按结束时间排序 |
| GetMyAuctions | GetMyAuctions | page: 1, page_size: 20 | 返回用户的拍卖列表 |

#### 3.3.3 性能测试

**测试工具**：JMeter

| 测试用例 | 并发用户数 | 请求数 | 测试数据 | 预期结果 |
|---------|------------|--------|---------|----------|
| 创建拍卖性能 | 100 | 1000 | 物品ID: 1, 起拍价: 10000, 时长: 24 | 平均响应时间<500ms，成功率>99% |
| 竞拍性能 | 200 | 2000 | 拍卖ID: 1, 出价: 15000 | 平均响应时间<300ms，成功率>99% |
| 一口价购买性能 | 50 | 500 | 拍卖ID: 1 | 平均响应时间<400ms，成功率>99% |
| 获取拍卖列表性能 | 500 | 5000 | 页码: 1, 每页数量: 20 | 平均响应时间<200ms，成功率>99% |
| 混合负载测试 | 300 | 3000 | 各种请求混合 | 系统稳定运行，无错误 |

### 3.4 安全测试

#### 3.4.1 认证授权测试

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 未认证访问需要认证的接口 | `testUnauthorizedAccess` | POST /api/auction/create | 返回401 Unauthorized |
| 认证失败访问 | `testAuthenticationFailed` | 无效的Token | 返回401 Unauthorized |
| 权限不足访问 | `testPermissionDenied` | 非卖家取消拍卖 | 返回403 Forbidden |
| 认证成功访问 | `testAuthorizedAccess` | 有效的Token | 返回200 OK |

#### 3.4.2 输入验证测试

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 空参数测试 | `testEmptyParameters` | 空请求体 | 返回400 Bad Request |
| 无效参数测试 | `testInvalidParameters` | 负数价格 | 返回400 Bad Request |
| SQL注入测试 | `testSQLInjection` | SQL注入攻击字符串 | 返回400 Bad Request，无SQL注入 |
| XSS测试 | `testXSS` | XSS攻击字符串 | 返回400 Bad Request，无XSS注入 |
| 边界值测试 | `testBoundaryValues` | 最大价格，最小价格 | 正确处理边界值 |

#### 3.4.3 数据安全测试

| 测试用例 | 测试方法 | 测试数据 | 预期结果 |
|---------|---------|---------|----------|
| 敏感数据加密 | `testSensitiveDataEncryption` | 用户密码，货币金额 | 敏感数据加密存储 |
| 数据传输加密 | `testDataTransferEncryption` | HTTP请求 | 数据通过HTTPS加密传输 |
| 数据访问控制 | `testDataAccessControl` | 不同权限用户访问 | 严格控制数据访问权限 |
| 审计日志 | `testAuditLog` | 拍卖操作 | 所有操作记录到审计日志 |

## 4. 测试执行计划

### 4.1 测试阶段

| 阶段 | 时间 | 测试类型 | 测试重点 |
|------|------|---------|----------|
| 单元测试 | 开发阶段 | 单元测试 | 核心功能的正确性 |
| 集成测试 | 开发完成后 | 集成测试 | 模块间的交互 |
| 端到端测试 | 集成测试后 | 端到端测试 | 完整业务流程 |
| 性能测试 | 端到端测试后 | 性能测试 | 系统性能和稳定性 |
| 安全测试 | 性能测试后 | 安全测试 | 系统安全性 |
| 回归测试 | 修复问题后 | 回归测试 | 确保修复不引入新问题 |

### 4.2 测试执行流程

1. **测试准备**：
   - 搭建测试环境
   - 准备测试数据
   - 编写测试脚本

2. **测试执行**：
   - 运行单元测试
   - 运行集成测试
   - 运行端到端测试
   - 运行性能测试
   - 运行安全测试

3. **测试结果分析**：
   - 收集测试结果
   - 分析测试数据
   - 生成测试报告

4. **问题修复**：
   - 记录问题
   - 修复问题
   - 验证修复

5. **回归测试**：
   - 运行回归测试
   - 确保问题已修复
   - 确保无新问题引入

### 4.3 测试资源分配

| 角色 | 职责 | 人数 |
|------|------|------|
| 测试负责人 | 制定测试计划，协调测试资源 | 1 |
| 单元测试工程师 | 编写和执行单元测试 | 2 |
| 集成测试工程师 | 编写和执行集成测试 | 2 |
| 端到端测试工程师 | 编写和执行端到端测试 | 2 |
| 性能测试工程师 | 编写和执行性能测试 | 1 |
| 安全测试工程师 | 编写和执行安全测试 | 1 |
| 测试数据工程师 | 准备和管理测试数据 | 1 |

## 5. 测试报告模板

### 5.1 测试摘要

| 项目 | 内容 |
|------|------|
| 测试名称 | 拍卖系统测试 |
| 测试时间 | 2023-06-01 至 2023-06-10 |
| 测试环境 | 开发环境 / 测试环境 / 生产环境 |
| 测试类型 | 单元测试 / 集成测试 / 端到端测试 / 性能测试 / 安全测试 |
| 测试用例数 | 总测试用例数 / 通过测试用例数 / 失败测试用例数 |
| 测试覆盖率 | 代码覆盖率 / 功能覆盖率 |
| 测试状态 | 成功 / 失败 / 部分成功 |

### 5.2 测试详情

| 测试用例 | 测试结果 | 执行时间 | 错误信息 | 修复状态 |
|---------|----------|----------|----------|----------|
| 创建拍卖成功 | 通过 | 2023-06-01 10:00 | N/A | N/A |
| 创建拍卖失败 - 物品不存在 | 通过 | 2023-06-01 10:05 | N/A | N/A |
| 竞拍成功 | 通过 | 2023-06-01 10:10 | N/A | N/A |
| 竞拍失败 - 出价过低 | 失败 | 2023-06-01 10:15 | 验证逻辑错误 | 已修复 |
| 一口价购买成功 | 通过 | 2023-06-01 10:20 | N/A | N/A |

### 5.3 性能测试报告

| 测试项 | 并发用户数 | 平均响应时间 | 最大响应时间 | 成功率 | 吞吐量 |
|--------|------------|--------------|--------------|--------|--------|
| 创建拍卖 | 100 | 450ms | 1200ms | 99.5% | 200/s |
| 竞拍 | 200 | 280ms | 800ms | 99.8% | 400/s |
| 一口价购买 | 50 | 350ms | 900ms | 100% | 125/s |
| 获取拍卖列表 | 500 | 180ms | 500ms | 100% | 1000/s |

### 5.4 安全测试报告

| 测试项 | 测试结果 | 风险等级 | 修复状态 |
|--------|----------|----------|----------|
| 认证授权 | 通过 | 低 | N/A |
| 输入验证 | 通过 | 低 | N/A |
| SQL注入 | 通过 | 低 | N/A |
| XSS攻击 | 通过 | 低 | N/A |
| 敏感数据加密 | 通过 | 低 | N/A |

### 5.5 问题分析

| 问题ID | 问题描述 | 严重程度 | 影响范围 | 根因分析 | 修复方案 | 修复状态 |
|--------|----------|----------|----------|----------|----------|----------|
| BUG-001 | 竞拍价格验证逻辑错误 | 高 | 竞拍功能 | 验证逻辑未考虑最小加价幅度 | 修复验证逻辑，确保出价大于当前价格+最小加价幅度 | 已修复 |
| BUG-002 | 过期拍卖处理时间过长 | 中 | 过期处理 | 未使用索引，查询效率低 | 为end_time和status字段添加联合索引 | 已修复 |
| BUG-003 | 并发竞拍导致数据不一致 | 高 | 竞拍功能 | 未使用锁机制，存在竞态条件 | 添加分布式锁，确保并发安全 | 已修复 |

### 5.6 测试结论

- **测试结果**：本次测试共执行了X个测试用例，其中X个通过，X个失败，成功率X%。
- **系统状态**：系统功能基本正常，存在X个严重问题，X个一般问题。
- **性能表现**：系统性能满足要求，在X并发用户下响应时间<Xms。
- **安全状况**：系统安全性良好，未发现严重安全漏洞。
- **建议**：
  1. 修复测试中发现的问题
  2. 加强系统监控，及时发现和处理问题
  3. 定期进行回归测试，确保系统稳定性
  4. 优化数据库索引，提高查询性能

## 6. 总结

本文档详细描述了拍卖系统的测试用例，包括单元测试、集成测试、端到端测试、性能测试和安全测试。通过全面的测试，可以确保拍卖系统的功能正确性、性能稳定性和安全性，为系统的上线和运行提供保障。

测试过程中，应严格按照测试计划执行，记录测试结果，分析测试数据，及时发现和修复问题。同时，应建立完善的测试文档和测试报告，为系统的维护和升级提供参考。

在实际应用中，还需要根据系统的具体情况和业务需求，对测试用例进行适当的调整和补充，以确保测试的全面性和有效性。