# 冒险系统数据库设计文档

## 1. 数据库表结构

### 1.1 t_dungeon（副本表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 副本ID |
| `name` | `VARCHAR(100)` | `NOT NULL` | 副本名称 |
| `level` | `INT` | `NOT NULL` | 推荐等级 |
| `difficulty` | `INT` | `NOT NULL` | 难度（1-5） |
| `entry_requirement` | `JSON` | `NOT NULL` | 进入要求（JSON格式） |
| `reward_id` | `INT` | `NOT NULL` | 奖励配置ID |
| `map_id` | `INT` | `NOT NULL` | 地图ID |
| `monster_ids` | `JSON` | `NOT NULL` | 怪物ID列表（JSON格式） |
| `boss_ids` | `JSON` | `NOT NULL` | BOSS ID列表（JSON格式） |
| `create_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 1.2 t_dungeon_instance（副本实例表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 副本实例ID |
| `dungeon_id` | `INT` | `NOT NULL INDEX` | 副本ID |
| `creator_guid` | `BIGINT` | `NOT NULL INDEX` | 创建者GUID |
| `start_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 开始时间 |
| `end_time` | `TIMESTAMP` | `NULL` | 结束时间 |
| `status` | `TINYINT` | `NOT NULL` | 状态（0: 进行中, 1: 完成, 2: 失败） |
| `participants` | `JSON` | `NOT NULL` | 参与者列表（JSON格式） |
| `clear_time` | `INT` | `NULL` | 通关时间（秒） |

### 1.3 t_quest（任务表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 任务ID |
| `name` | `VARCHAR(100)` | `NOT NULL` | 任务名称 |
| `description` | `TEXT` | `NOT NULL` | 任务描述 |
| `accept_condition` | `JSON` | `NOT NULL` | 接受条件（JSON格式） |
| `complete_condition` | `JSON` | `NOT NULL` | 完成条件（JSON格式） |
| `reward_id` | `INT` | `NOT NULL` | 奖励配置ID |
| `type` | `TINYINT` | `NOT NULL` | 任务类型（1: 主线, 2: 支线, 3: 日常, 4: 活动） |
| `level_requirement` | `INT` | `NOT NULL` | 等级要求 |
| `prev_quest_id` | `INT` | `NULL` | 前置任务ID |
| `create_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 1.4 t_player_quest（玩家任务表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `player_guid` | `BIGINT` | `NOT NULL INDEX` | 玩家GUID |
| `quest_id` | `INT` | `NOT NULL INDEX` | 任务ID |
| `status` | `TINYINT` | `NOT NULL` | 状态（0: 接受, 1: 进行中, 2: 完成, 3: 已交） |
| `progress` | `JSON` | `NOT NULL` | 任务进度（JSON格式） |
| `accept_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 接受时间 |
| `complete_time` | `TIMESTAMP` | `NULL` | 完成时间 |
| `submit_time` | `TIMESTAMP` | `NULL` | 提交时间 |

### 1.5 t_map（地图表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 地图ID |
| `name` | `VARCHAR(100)` | `NOT NULL` | 地图名称 |
| `type` | `TINYINT` | `NOT NULL` | 地图类型（1: 城镇, 2: 野外, 3: 副本） |
| `level` | `INT` | `NOT NULL` | 推荐等级 |
| `area_count` | `INT` | `NOT NULL` | 区域数量 |
| `description` | `TEXT` | `NULL` | 地图描述 |
| `create_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 1.6 t_map_area（地图区域表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 区域ID |
| `map_id` | `INT` | `NOT NULL INDEX` | 地图ID |
| `area_id` | `INT` | `NOT NULL` | 区域编号 |
| `name` | `VARCHAR(100)` | `NOT NULL` | 区域名称 |
| `description` | `TEXT` | `NULL` | 区域描述 |
| `monster_ids` | `JSON` | `NULL` | 怪物ID列表（JSON格式） |
| `resource_ids` | `JSON` | `NULL` | 资源ID列表（JSON格式） |

### 1.7 t_map_exploration（地图探索表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 记录ID |
| `player_guid` | `BIGINT` | `NOT NULL INDEX` | 玩家GUID |
| `map_id` | `INT` | `NOT NULL INDEX` | 地图ID |
| `explored_areas` | `JSON` | `NOT NULL` | 已探索区域（JSON格式） |
| `progress` | `FLOAT` | `NOT NULL` | 探索进度（百分比） |
| `last_explore_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 最后探索时间 |

### 1.8 t_reward（奖励表）
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 奖励ID |
| `name` | `VARCHAR(100)` | `NOT NULL` | 奖励名称 |
| `reward_data` | `JSON` | `NOT NULL` | 奖励数据（JSON格式） |
| `create_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

## 2. 索引设计

### 2.1 副本相关索引
- `t_dungeon_instance`: `dungeon_id` (INDEX), `creator_guid` (INDEX)
- 目的：加速副本实例查询和玩家相关副本实例查询

### 2.2 任务相关索引
- `t_player_quest`: `player_guid` (INDEX), `quest_id` (INDEX), `status` (INDEX)
- 目的：加速玩家任务查询和任务状态查询

### 2.3 地图相关索引
- `t_map_area`: `map_id` (INDEX)
- `t_map_exploration`: `player_guid` (INDEX), `map_id` (INDEX)
- 目的：加速地图区域查询和玩家探索进度查询

## 3. 外键关系

### 3.1 副本相关外键
- `t_dungeon_instance.dungeon_id` -> `t_dungeon.id`

### 3.2 任务相关外键
- `t_player_quest.quest_id` -> `t_quest.id`
- `t_quest.prev_quest_id` -> `t_quest.id` (自引用)

### 3.3 地图相关外键
- `t_map_area.map_id` -> `t_map.id`
- `t_map_exploration.map_id` -> `t_map.id`

### 3.4 奖励相关外键
- `t_dungeon.reward_id` -> `t_reward.id`
- `t_quest.reward_id` -> `t_reward.id`

## 4. 数据传输对象（DTOs）

### 4.1 DungeonDTO
```go
type DungeonDTO struct {
	ID               uint32          `json:"id"`
	Name             string          `json:"name"`
	Level            uint32          `json:"level"`
	Difficulty       uint32          `json:"difficulty"`
	EntryRequirement json.RawMessage `json:"entryRequirement"`
	RewardID         uint32          `json:"rewardId"`
	MapID            uint32          `json:"mapId"`
	MonsterIDs       json.RawMessage `json:"monsterIds"`
	BossIDs          json.RawMessage `json:"bossIds"`
}
```

### 4.2 DungeonInstanceDTO
```go
type DungeonInstanceDTO struct {
	ID           uint64          `json:"id"`
	DungeonID    uint32          `json:"dungeonId"`
	CreatorGUID  uint64          `json:"creatorGuid"`
	StartTime    time.Time       `json:"startTime"`
	EndTime      *time.Time      `json:"endTime"`
	Status       uint32          `json:"status"`
	Participants json.RawMessage `json:"participants"`
	ClearTime    *uint32         `json:"clearTime"`
}
```

### 4.3 QuestDTO
```go
type QuestDTO struct {
	ID                uint32          `json:"id"`
	Name              string          `json:"name"`
	Description       string          `json:"description"`
	AcceptCondition   json.RawMessage `json:"acceptCondition"`
	CompleteCondition json.RawMessage `json:"completeCondition"`
	RewardID          uint32          `json:"rewardId"`
	Type              uint32          `json:"type"`
	LevelRequirement  uint32          `json:"levelRequirement"`
	PrevQuestID       *uint32         `json:"prevQuestId"`
}
```

### 4.4 PlayerQuestDTO
```go
type PlayerQuestDTO struct {
	ID           uint64          `json:"id"`
	PlayerGUID   uint64          `json:"playerGuid"`
	QuestID      uint32          `json:"questId"`
	Status       uint32          `json:"status"`
	Progress     json.RawMessage `json:"progress"`
	AcceptTime   time.Time       `json:"acceptTime"`
	CompleteTime *time.Time      `json:"completeTime"`
	SubmitTime   *time.Time      `json:"submitTime"`
}
```

### 4.5 MapDTO
```go
type MapDTO struct {
	ID          uint32 `json:"id"`
	Name        string `json:"name"`
	Type        uint32 `json:"type"`
	Level       uint32 `json:"level"`
	AreaCount   uint32 `json:"areaCount"`
	Description string `json:"description"`
}
```

### 4.6 MapAreaDTO
```go
type MapAreaDTO struct {
	ID          uint32          `json:"id"`
	MapID       uint32          `json:"mapId"`
	AreaID      uint32          `json:"areaId"`
	Name        string          `json:"name"`
	Description string          `json:"description"`
	MonsterIDs  json.RawMessage `json:"monsterIds"`
	ResourceIDs json.RawMessage `json:"resourceIds"`
}
```

### 4.7 MapExplorationDTO
```go
type MapExplorationDTO struct {
	ID             uint64          `json:"id"`
	PlayerGUID     uint64          `json:"playerGuid"`
	MapID          uint32          `json:"mapId"`
	ExploredAreas  json.RawMessage `json:"exploredAreas"`
	Progress       float64         `json:"progress"`
	LastExploreTime time.Time      `json:"lastExploreTime"`
}
```

### 4.8 RewardDTO
```go
type RewardDTO struct {
	ID         uint32          `json:"id"`
	Name       string          `json:"name"`
	RewardData json.RawMessage `json:"rewardData"`
}
```

## 5. 数据库迁移脚本

### 5.1 创建表结构
```sql
-- 创建副本表
CREATE TABLE IF NOT EXISTS `t_dungeon` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL,
  `level` INT NOT NULL,
  `difficulty` INT NOT NULL,
  `entry_requirement` JSON NOT NULL,
  `reward_id` INT NOT NULL,
  `map_id` INT NOT NULL,
  `monster_ids` JSON NOT NULL,
  `boss_ids` JSON NOT NULL,
  `create_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `update_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建副本实例表
CREATE TABLE IF NOT EXISTS `t_dungeon_instance` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `dungeon_id` INT NOT NULL,
  `creator_guid` BIGINT NOT NULL,
  `start_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `end_time` TIMESTAMP NULL,
  `status` TINYINT NOT NULL,
  `participants` JSON NOT NULL,
  `clear_time` INT NULL,
  INDEX `idx_dungeon_id` (`dungeon_id`),
  INDEX `idx_creator_guid` (`creator_guid`)
);

-- 创建任务表
CREATE TABLE IF NOT EXISTS `t_quest` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL,
  `description` TEXT NOT NULL,
  `accept_condition` JSON NOT NULL,
  `complete_condition` JSON NOT NULL,
  `reward_id` INT NOT NULL,
  `type` TINYINT NOT NULL,
  `level_requirement` INT NOT NULL,
  `prev_quest_id` INT NULL,
  `create_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `update_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建玩家任务表
CREATE TABLE IF NOT EXISTS `t_player_quest` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `player_guid` BIGINT NOT NULL,
  `quest_id` INT NOT NULL,
  `status` TINYINT NOT NULL,
  `progress` JSON NOT NULL,
  `accept_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `complete_time` TIMESTAMP NULL,
  `submit_time` TIMESTAMP NULL,
  INDEX `idx_player_guid` (`player_guid`),
  INDEX `idx_quest_id` (`quest_id`),
  INDEX `idx_status` (`status`)
);

-- 创建地图表
CREATE TABLE IF NOT EXISTS `t_map` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL,
  `type` TINYINT NOT NULL,
  `level` INT NOT NULL,
  `area_count` INT NOT NULL,
  `description` TEXT NULL,
  `create_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `update_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建地图区域表
CREATE TABLE IF NOT EXISTS `t_map_area` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `map_id` INT NOT NULL,
  `area_id` INT NOT NULL,
  `name` VARCHAR(100) NOT NULL,
  `description` TEXT NULL,
  `monster_ids` JSON NULL,
  `resource_ids` JSON NULL,
  INDEX `idx_map_id` (`map_id`)
);

-- 创建地图探索表
CREATE TABLE IF NOT EXISTS `t_map_exploration` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `player_guid` BIGINT NOT NULL,
  `map_id` INT NOT NULL,
  `explored_areas` JSON NOT NULL,
  `progress` FLOAT NOT NULL,
  `last_explore_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_player_guid` (`player_guid`),
  INDEX `idx_map_id` (`map_id`)
);

-- 创建奖励表
CREATE TABLE IF NOT EXISTS `t_reward` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL,
  `reward_data` JSON NOT NULL,
  `create_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `update_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 5.2 添加外键约束
```sql
-- 添加副本实例表外键
ALTER TABLE `t_dungeon_instance` ADD CONSTRAINT `fk_dungeon_instance_dungeon` FOREIGN KEY (`dungeon_id`) REFERENCES `t_dungeon` (`id`);

-- 添加玩家任务表外键
ALTER TABLE `t_player_quest` ADD CONSTRAINT `fk_player_quest_quest` FOREIGN KEY (`quest_id`) REFERENCES `t_quest` (`id`);

-- 添加任务表自引用外键
ALTER TABLE `t_quest` ADD CONSTRAINT `fk_quest_prev_quest` FOREIGN KEY (`prev_quest_id`) REFERENCES `t_quest` (`id`);

-- 添加地图区域表外键
ALTER TABLE `t_map_area` ADD CONSTRAINT `fk_map_area_map` FOREIGN KEY (`map_id`) REFERENCES `t_map` (`id`);

-- 添加地图探索表外键
ALTER TABLE `t_map_exploration` ADD CONSTRAINT `fk_map_exploration_map` FOREIGN KEY (`map_id`) REFERENCES `t_map` (`id`);

-- 添加副本表外键
ALTER TABLE `t_dungeon` ADD CONSTRAINT `fk_dungeon_reward` FOREIGN KEY (`reward_id`) REFERENCES `t_reward` (`id`);

-- 添加任务表外键
ALTER TABLE `t_quest` ADD CONSTRAINT `fk_quest_reward` FOREIGN KEY (`reward_id`) REFERENCES `t_reward` (`id`);
```

## 6. 性能优化策略

### 6.1 索引优化
- 为频繁查询的字段添加索引
- 优化复合索引的顺序，将选择性高的字段放在前面
- 定期分析索引使用情况，移除未使用的索引

### 6.2 查询优化
- 使用分页查询减少单次查询的数据量
- 避免使用 SELECT *，只查询需要的字段
- 使用 JOIN 时注意表的顺序，将小表放在前面
- 避免在 WHERE 子句中使用函数，影响索引使用

### 6.3 缓存策略
- 使用 Redis 缓存热点数据，如副本配置、任务配置等
- 缓存玩家任务进度和地图探索进度
- 实现缓存过期策略，确保数据一致性

### 6.4 写入优化
- 使用批量插入减少数据库操作次数
- 实现异步写入，将非关键操作放入消息队列
- 合理设置事务隔离级别，减少锁竞争

### 6.5 分区策略
- 对于大表，如 t_dungeon_instance 和 t_player_quest，可以考虑按时间分区
- 对于 t_map_exploration，可以考虑按玩家GUID分区

## 7. 数据安全

### 7.1 访问控制
- 实现基于角色的访问控制（RBAC）
- 限制数据库用户的权限，遵循最小权限原则
- 避免使用 root 账户直接连接数据库

### 7.2 数据加密
- 对敏感数据进行加密存储
- 使用 SSL/TLS 加密数据库连接
- 定期更换加密密钥

### 7.3 备份策略
- 实现定期全量备份
- 实现增量备份，减少备份时间和空间
- 定期测试备份恢复，确保备份有效性

### 7.4 审计日志
- 记录数据库操作日志
- 监控异常访问和操作
- 定期分析审计日志，发现潜在安全问题

## 8. 总结

本数据库设计文档详细描述了冒险系统的数据库表结构、索引设计、外键关系、数据传输对象、迁移脚本、性能优化策略和数据安全措施。通过合理的数据库设计，可以确保冒险系统的高效运行和数据安全，为玩家提供流畅的游戏体验。