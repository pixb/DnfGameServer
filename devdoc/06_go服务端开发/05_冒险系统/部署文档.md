# 冒险系统部署文档

## 1. 部署环境准备

### 1.1 硬件要求
- **服务器**：
  - CPU：至少4核
  - 内存：至少8GB
  - 磁盘：至少100GB SSD
  - 网络：至少100Mbps带宽

### 1.2 软件要求
- **操作系统**：
  - Linux：Ubuntu 20.04 LTS 或 CentOS 7+
  - Windows：Windows Server 2016 或更高版本

- **数据库**：
  - MySQL 8.0 或更高版本
  - Redis 6.0 或更高版本

- **消息队列**：
  - NATS 2.9 或更高版本

- **Go环境**：
  - Go 1.20 或更高版本

## 2. 部署前准备

### 2.1 代码获取
1. **克隆代码仓库**
   ```bash
   git clone https://github.com/yourusername/dnf-go-server.git
   cd dnf-go-server
   ```

2. **切换到冒险系统分支**
   ```bash
   git checkout feature/adventure-system
   ```

### 2.2 依赖安装
1. **安装Go依赖**
   ```bash
   go mod download
   ```

2. **安装系统依赖**
   - Ubuntu/Debian
     ```bash
     sudo apt update
     sudo apt install mysql-server redis-server
     ```
   - CentOS/RHEL
     ```bash
     sudo yum update
     sudo yum install mysql-server redis
     ```

### 2.3 配置文件准备
1. **创建配置目录**
   ```bash
   mkdir -p config
   ```

2. **创建主配置文件**
   ```yaml
   # config/config.yaml
   server:
     port: 8080
     host: 0.0.0.0
     mode: release

   database:
     dsn: "root:password@tcp(localhost:3306)/dnf_game?charset=utf8mb4&parseTime=True&loc=Local"
     max_idle_conns: 10
     max_open_conns: 100

   redis:
     addr: "localhost:6379"
     password: ""
     db: 0

   nats:
     url: "nats://localhost:4222"

   adventure:
     dungeon_timeout: 3600 # 副本超时时间（秒）
     quest_expire_time: 86400 # 任务过期时间（秒）
     exploration_reward_interval: 10 # 探索奖励间隔（%）
   ```

3. **创建副本配置文件**
   ```yaml
   # config/dungeons.yaml
   dungeons:
     - id: 1
       name: "哥布林王国"
       level: 10
       difficulty: 1
       entry_requirement:
         level: 8
       rewards:
         - type: "item"
           id: 1001
           count: 1
         - type: "exp"
           value: 1000
   ```

4. **创建任务配置文件**
   ```yaml
   # config/quests.yaml
   quests:
     - id: 1
       name: "消灭哥布林"
       description: "消灭10只哥布林"
       accept_condition:
         level: 8
       complete_condition:
         monster_kill:
           id: 101
           count: 10
       rewards:
         - type: "item"
           id: 1002
           count: 1
         - type: "gold"
           value: 500
   ```

## 3. 数据库部署

### 3.1 数据库初始化
1. **创建数据库**
   ```sql
   CREATE DATABASE IF NOT EXISTS dnf_game CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

2. **执行数据库迁移**
   ```bash
   go run cmd/migrate/main.go
   ```

3. **导入初始数据**
   ```bash
   mysql -u root -p dnf_game < sql/init_data.sql
   ```

### 3.2 数据库配置优化
1. **修改MySQL配置**
   ```bash
   sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
   ```

   添加以下配置：
   ```ini
   [mysqld]
   max_connections = 1000
   innodb_buffer_pool_size = 2G
   innodb_log_file_size = 256M
   innodb_flush_log_at_trx_commit = 2
   ```

2. **重启MySQL服务**
   ```bash
   sudo systemctl restart mysql
   ```

## 4. 服务部署

### 4.1 编译构建
1. **编译Go代码**
   ```bash
   go build -o bin/adventure-server cmd/server/main.go
   ```

2. **构建Docker镜像（可选）**
   ```bash
   docker build -t dnf-adventure-server:latest .
   ```

### 4.2 启动服务
1. **直接启动**
   ```bash
   ./bin/adventure-server
   ```

2. **使用systemd启动**
   ```bash
   sudo nano /etc/systemd/system/adventure-server.service
   ```

   添加以下配置：
   ```ini
   [Unit]
   Description=DNF Adventure Server
   After=network.target mysql.service redis.service

   [Service]
   Type=simple
   User=ubuntu
   WorkingDirectory=/path/to/dnf-go-server
   ExecStart=/path/to/dnf-go-server/bin/adventure-server
   Restart=on-failure
   RestartSec=5s

   [Install]
   WantedBy=multi-user.target
   ```

   启动服务：
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable adventure-server
   sudo systemctl start adventure-server
   ```

3. **使用Docker启动**
   ```bash
   docker run -d --name adventure-server \
     -p 8080:8080 \
     --link mysql:mysql \
     --link redis:redis \
     --link nats:nats \
     -v /path/to/config:/app/config \
     dnf-adventure-server:latest
   ```

### 4.3 服务验证
1. **检查服务状态**
   ```bash
   sudo systemctl status adventure-server
   ```

2. **测试API接口**
   ```bash
   curl -X GET http://localhost:8080/api/dungeon/list
   ```

   预期返回：
   ```json
   {
     "code": 200,
     "message": "success",
     "data": {
       "dungeons": [
         {
           "id": 1,
           "name": "哥布林王国",
           "level": 10,
           "difficulty": 1,
           "description": "初级副本，适合新手玩家",
           "entry_requirement": {
             "level": 8,
             "items": []
           }
         }
       ]
     }
   }
   ```

## 5. 负载均衡与高可用

### 5.1 负载均衡配置
1. **使用Nginx作为负载均衡器**
   ```bash
   sudo nano /etc/nginx/sites-available/adventure-server
   ```

   添加以下配置：
   ```nginx
   upstream adventure_servers {
     server localhost:8080;
     server localhost:8081;
     server localhost:8082;
   }

   server {
     listen 80;
     server_name adventure.example.com;

     location / {
       proxy_pass http://adventure_servers;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     }
   }
   ```

2. **启用配置**
   ```bash
   sudo ln -s /etc/nginx/sites-available/adventure-server /etc/nginx/sites-enabled/
   sudo systemctl restart nginx
   ```

### 5.2 高可用配置
1. **数据库主从复制**
   - 配置MySQL主从复制
   - 实现数据库读写分离

2. **Redis哨兵模式**
   - 配置Redis哨兵模式
   - 实现Redis高可用

3. **服务多实例部署**
   - 在多个服务器上部署服务实例
   - 使用负载均衡器分发请求

## 6. 监控与日志

### 6.1 日志配置
1. **配置日志文件**
   ```yaml
   # config/config.yaml
   logger:
     level: info
     file: logs/adventure-server.log
     max_size: 100 # MB
     max_backups: 10
     max_age: 30 # 天
   ```

2. **查看日志**
   ```bash
   tail -f logs/adventure-server.log
   ```

### 6.2 监控配置
1. **使用Prometheus监控**
   - 安装Prometheus
   - 配置Prometheus采集服务指标

2. **使用Grafana可视化**
   - 安装Grafana
   - 创建监控面板

3. **关键监控指标**
   - 请求量和响应时间
   - 副本创建和完成率
   - 任务接受和完成率
   - 地图探索进度
   - 系统资源使用率

## 7. 备份与恢复

### 7.1 数据备份
1. **数据库备份**
   ```bash
   mysqldump -u root -p dnf_game > dnf_game_backup.sql
   ```

2. **配置文件备份**
   ```bash
   tar -czf config_backup.tar.gz config/
   ```

3. **自动备份脚本**
   ```bash
   #!/bin/bash
   
   BACKUP_DIR="/path/to/backup"
   DATE=$(date +%Y%m%d_%H%M%S)
   
   mkdir -p $BACKUP_DIR
   
   # 备份数据库
   mysqldump -u root -p dnf_game > $BACKUP_DIR/dnf_game_$DATE.sql
   
   # 备份配置文件
   tar -czf $BACKUP_DIR/config_$DATE.tar.gz config/
   
   # 删除7天前的备份
   find $BACKUP_DIR -name "*.sql" -o -name "*.tar.gz" | grep -v "$(date +%Y%m%d)" | xargs rm -f
   ```

### 7.2 数据恢复
1. **数据库恢复**
   ```bash
   mysql -u root -p dnf_game < dnf_game_backup.sql
   ```

2. **配置文件恢复**
   ```bash
   tar -xzf config_backup.tar.gz -C /
   ```

## 8. 常见问题与解决方案

### 8.1 服务启动失败
- **问题**：服务无法启动，日志显示数据库连接失败
  **解决方案**：检查数据库配置是否正确，确保MySQL服务正在运行

- **问题**：服务无法启动，日志显示Redis连接失败
  **解决方案**：检查Redis配置是否正确，确保Redis服务正在运行

### 8.2 API接口返回错误
- **问题**：API接口返回500错误
  **解决方案**：查看服务日志，定位错误原因

- **问题**：API接口返回404错误
  **解决方案**：检查请求路径是否正确，确保服务已正确部署

### 8.3 数据库性能问题
- **问题**：数据库查询缓慢
  **解决方案**：优化数据库索引，调整MySQL配置参数

- **问题**：数据库连接数不足
  **解决方案**：增加MySQL最大连接数，调整应用程序连接池配置

### 8.4 服务性能问题
- **问题**：服务响应缓慢
  **解决方案**：检查系统资源使用情况，增加服务器资源或优化代码

- **问题**：服务内存使用过高
  **解决方案**：检查内存泄漏问题，优化缓存策略

## 9. 部署流程总结

1. **环境准备**：安装必要的软件和依赖
2. **代码获取**：克隆代码仓库并切换到相应分支
3. **配置文件准备**：创建和修改配置文件
4. **数据库部署**：初始化数据库并导入初始数据
5. **服务部署**：编译构建并启动服务
6. **服务验证**：测试API接口确保服务正常运行
7. **负载均衡与高可用**：配置负载均衡和高可用方案
8. **监控与日志**：配置监控和日志系统
9. **备份与恢复**：设置数据备份和恢复策略

## 10. 版本更新

### 10.1 代码更新
1. **拉取最新代码**
   ```bash
   git pull origin feature/adventure-system
   ```

2. **重新编译**
   ```bash
   go build -o bin/adventure-server cmd/server/main.go
   ```

3. **重启服务**
   ```bash
   sudo systemctl restart adventure-server
   ```

### 10.2 数据库更新
1. **执行数据库迁移**
   ```bash
   go run cmd/migrate/main.go
   ```

2. **更新初始数据**
   ```bash
   mysql -u root -p dnf_game < sql/update_data.sql
   ```

### 10.3 配置更新
1. **修改配置文件**
   ```bash
   nano config/config.yaml
   ```

2. **重启服务**
   ```bash
   sudo systemctl restart adventure-server
   ```

## 11. 部署清单

### 11.1 必需项
- [ ] 服务器硬件满足要求
- [ ] 操作系统已安装并更新
- [ ] MySQL和Redis已安装并配置
- [ ] 代码仓库已克隆
- [ ] 依赖已安装
- [ ] 配置文件已创建
- [ ] 数据库已初始化
- [ ] 服务已编译并启动
- [ ] API接口已验证

### 11.2 可选项
- [ ] Docker镜像已构建
- [ ] 负载均衡已配置
- [ ] 高可用方案已实施
- [ ] 监控系统已配置
- [ ] 备份策略已设置
- [ ] 自动部署脚本已创建