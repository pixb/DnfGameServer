# 迁移完整流程规划

## 📋 概述

本文档描述从 JProtobuf 到标准 Protobuf 的完整迁移流程，包括规划、执行、记录和验证。

## 🎯 迁移目标

将 JProtobuf 协议文件转换为标准 Protobuf 格式，并建立完整的映射关系记录。

## 📂 目录结构

```
/home/pix/dev/code/java/DnfGameServer/
├── src/main/java/com/dnfm/mina/
│   ├── protobuf/              # JProtobuf 消息（源）
│   └── stdproto/             # 标准 Protobuf Java（目标）
├── proto/dnf/v1/              # 标准 .proto 文件（源）
└── devdoc/
    ├── 03_迁移/              # 迁移文档
    └── protobuf/
        └── reports/        # 报告系统
            ├── data/         # 数据库
            ├── docs/         # 文档
            └── scripts/      # 工具脚本
```

## 🔄 迁移流程

### 阶段 1：准备和扫描

#### 1.1 扫描 JProtobuf 消息

使用 `jprotobuf_scanner.py` 扫描所有 JProtobuf 消息：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python jprotobuf_scanner.py --scan
```

**输出**：
- JProtobuf 消息总数
- 按类型分类（REQ, RES, PT, OTHER, ENUM）
- 按模块分类
- 消息字段信息

#### 1.2 扫描标准 Protobuf 消息

使用 `proto_scanner.py` 扫描所有标准 Protobuf 消息：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python proto_scanner.py --scan
```

**输出**：
- 标准 Protobuf 消息总数
- 按文件分类
- 消息字段信息

#### 1.3 分析映射关系

使用 `mapping_analyzer.py` 分析 JProtobuf 和标准 Protobuf 之间的映射关系：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python mapping_analyzer.py --analyze
```

**输出**：
- 消息映射关系
- 映射类型（直接映射、新增、待迁移）
- 映射置信度

### 阶段 2：批次规划

#### 2.1 确定迁移优先级

根据消息类型和模块重要性确定迁移优先级：

| 优先级 | 消息类型 | 模块 | 原因 |
|---------|---------|------|--------|
| P0 | REQ/RES | AUTH_LOGIN, AUTH, SESSION, USER_INFO | 核心认证模块 |
| P1 | REQ/RES | CHARACTER, ITEM, EQUIP, INVENTORY | 核心游戏模块 |
| P2 | REQ/RES | DUNGEON, TASK, GUILD | 游戏系统模块 |
| P3 | PT | 所有 PT 消息 | 数据传输消息 |
| P4 | OTHER | 其他消息 | 辅助消息 |
| P5 | ENUM | 枚举类型 | 枚举定义 |

#### 2.2 创建批次计划

根据优先级创建批次计划，每个批次包含相关模块的消息：

**第一批（Batch 01）**：AUTH_LOGIN 模块
- 消息数：~30
- 优先级：P0
- 预计时间：2-3 小时

**第二批（Batch 02）**：AUTH 模块
- 消息数：~30
- 优先级：P0
- 预计时间：2-3 小时

### 阶段 3：执行迁移

#### 3.1 创建批次目录

为每个批次创建目录结构：

```
/home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/03_迁移/batch_01/
├── 01_迁移计划.md
├── 02_迁移结果.md
└── 03_验证报告.md
```

#### 3.2 编写迁移计划

在 `01_迁移计划.md` 中记录：
- 批次信息（ID、名称、优先级）
- 消息列表（JProtobuf 名称、字段）
- 迁移目标（标准 Protobuf 名称、文件）
- 依赖关系
- 注意事项

#### 3.3 创建标准 Proto 文件

根据 JProtobuf 消息定义创建标准 .proto 文件：

**命名规则**：
- REQ_* → *Request
- RES_* → *Response
- PT_* → *（保持原名或改为 PascalCase）
- ENUM_* → *Enum

**字段规则**：
- 字段名：lower_snake_case
- 字段号：从 1 开始递增
- 字段类型：使用标准 Protobuf 类型

**文件规则**：
- 语法：`syntax = "proto3";`
- 包名：`package dnf.v1;`
- 选项：Java 和 Go 生成选项

#### 3.4 生成 Java 代码

使用 protoc 生成 Java 代码：

```bash
cd /home/pix/dev/code/java/DnfGameServer
protoc --proto_path=proto \
         --java_out=src/main/java/com/dnfm/mina/stdproto \
         proto/dnf/v1/*.proto
```

#### 3.5 记录迁移结果

在 `02_迁移结果.md` 中记录：
- 成功迁移的消息
- 失败的消息及原因
- 新增的消息
- 修改的消息
- 生成的文件列表

#### 3.6 验证迁移

在 `03_验证报告.md` 中记录：
- 编译验证
- 字段完整性检查
- 类型兼容性检查
- 测试验证

### 阶段 4：更新记录

#### 4.1 更新迁移状态

使用 `migration_system.py` 更新迁移状态：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python migration_system.py --update-status --batch 01 --status completed
```

#### 4.2 生成迁移报告

使用 `migration_report_generator.py` 生成迁移报告：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python migration_report_generator.py --batch 01
```

#### 4.3 更新映射关系

使用 `mapping_analyzer.py` 更新映射关系：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python mapping_analyzer.py --update-mapping --batch 01
```

### 阶段 5：进度跟踪

#### 5.1 查看整体进度

使用 `migration_system.py` 查看整体进度：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python migration_system.py --status
```

#### 5.2 查看批次详情

使用 `migration_system.py` 查看批次详情：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python migration_system.py --batch 01
```

#### 5.3 查看映射关系

使用 `migration_system.py` 查看映射关系：

```bash
cd /home/pix/dev/code/java/DnfGameServer/devdoc/protobuf/reports/scripts
python migration_system.py --mappings
```

## 📊 迁移统计

### 整体统计

| 指标 | 数值 | 进度 |
|------|------|--------|
| JProtobuf 消息总数 | 2202 | 100% |
| 标准 Protobuf 消息总数 | 0 | 0% |
| 已映射消息数 | 0 | 0% |
| 已迁移消息数 | 0 | 0% |
| 批次总数 | 0 | 0% |
| 已完成批次 | 0 | 0% |

### 按类型统计

| 类型 | JProtobuf | 标准 Protobuf | 已迁移 | 进度 |
|------|-----------|---------------|--------|--------|
| REQ | 693 | 0 | 0 | 0% |
| RES | 733 | 0 | 0 | 0% |
| PT | 555 | 0 | 0 | 0% |
| OTHER | 170 | 0 | 0 | 0% |
| ENUM | 51 | 0 | 0 | 0% |

## 🎯 下一步

1. 扫描 JProtobuf 和标准 Protobuf
2. 分析映射关系
3. 创建第一批迁移计划（Batch 01: AUTH_LOGIN）
4. 执行第一批迁移
5. 更新迁移状态和记录
6. 继续后续批次迁移

## 📝 注意事项

1. **保持一致性**：确保命名规则在整个迁移过程中保持一致
2. **记录完整**：详细记录每个迁移步骤和结果
3. **验证充分**：每个批次完成后进行充分验证
4. **及时更新**：及时更新迁移状态和映射关系
5. **备份重要**：重要文件在修改前进行备份
