# 数据库模拟创建

## 概述

本文档记录 DnfGameServer 项目的数据库模拟环境，包括数据库结构、表定义、字段说明和测试用例。

## 数据库架构

项目使用三个独立的数据库：

1. **game** - 主游戏数据库
2. **login** - 登录数据库
3. **game_kuafu** - 跨服数据库

## 数据库连接配置

- 主机: 127.0.0.1
- 端口: 3306
- 用户: root
- 密码: 123456

## 数据表详细说明

### 1. t_account (账户表)

**数据库**: game

**用途**: 存储用户账户信息

**表结构**:

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | VARCHAR(255) | PRIMARY KEY | - | openid |
| accountkey | VARCHAR(255) | NULL | NULL | accountkey |
| accumulatecera | BIGINT | NULL | 0 | 累计充值 |
| userID | VARCHAR(255) | INDEX | NULL | 用户ID |
| passwd | VARCHAR(255) | NULL | NULL | 密码 |
| roleMaxCount | INT | NULL | 3 | 最大角色数量 |
| isStop | TINYINT(1) | NULL | 0 | 是否停用 |
| privilege | SMALLINT | NULL | 0 | 权限等级 |
| score | INT | NULL | 0 | 积分 |
| channelNo | VARCHAR(255) | NULL | NULL | 渠道号 |
| createTime | DATETIME | NULL | CURRENT_TIMESTAMP | 创建时间 |
| zhanlingexp | INT | NULL | 0 | 战令经验 |
| moneyBox | JSON | NULL | NULL | 账户名下的各种货币 |
| epicPieceBox | JSON | NULL | NULL | 装备碎片 |
| mailBox | JSON | NULL | NULL | 账户邮箱 |
| storageline | INT | NULL | 1 | 仓库行数 |
| accShopInfoBox | JSON | NULL | NULL | 角色购买记录 |
| adventureReapInfo | JSON | NULL | NULL | 冒险收获信息 |
| adventureUnionInfo | JSON | NULL | NULL | 冒险联盟信息 |
| adStorageBox | JSON | NULL | NULL | 账号金库 |
| advBookBox | JSON | NULL | NULL | 冒险图鉴 |
| advUnionSubInfoBox | JSON | NULL | NULL | 冒险联盟子信息 |
| activityBox | JSON | NULL | NULL | 账号活动 |
| lastLoginTime | BIGINT | NULL | 0 | 最后登录时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_userID` (`userID`)
- INDEX: `idx_id` (`id`)

**引擎**: InnoDB
**字符集**: utf8mb4_unicode_ci

---

### 2. t_role (角色表)

**数据库**: game

**用途**: 存储游戏角色信息

**表结构**:

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| roleId | INT | - | - | 角色ID |
| uid | BIGINT | PRIMARY KEY | - | 角色唯一ID |
| lastlogout | BIGINT | NULL | 0 | 最后登出时间 |
| growtype | INT | NULL | 0 | 成长类型 |
| secgrowtype | INT | NULL | 0 | 第二成长类型 |
| job | INT | NULL | 0 | 职业 |
| level | INT | NULL | 1 | 等级 |
| name | VARCHAR(255) | INDEX | NULL | 角色名 |
| fatigue | INT | NULL | 0 | 疲劳值 |
| equipscore | INT | NULL | 229 | 装备评分 |
| characterframe | INT | NULL | 0 | 角色边框 |
| money | INT | NULL | 0 | 金币 |
| rescoin | INT | NULL | 0 | 复活币 |
| contributioncoin | INT | NULL | 0 | 贡献币 |
| magiccrystal | INT | NULL | 0 | 魔晶 |
| highmagiccrystal | INT | NULL | 0 | 高级魔晶 |
| cerascore | INT | NULL | 0 | 点券 |
| pkcoin | INT | NULL | 0 | PK币 |
| friendpoint | INT | NULL | 0 | 好友点 |
| smallcoin | INT | NULL | 0 | 小币 |
| avatarVisibleFlags | INT | NULL | 0 | 头像可见标志 |
| deletionstatus | INT | NULL | 0 | 删除状态 |
| deletiontime | BIGINT | NULL | 0 | 删除时间 |
| createtime | BIGINT | NULL | 0 | 创建时间 |
| changename | TINYINT(1) | NULL | 0 | 是否改名 |
| openid | VARCHAR(255) | INDEX | NULL | openid |
| exp | INT | NULL | 200 | 经验值 |
| sp | INT | NULL | 40 | SP点 |
| tp | INT | NULL | 0 | TP点 |
| addsp | INT | NULL | 0 | 附加SP |
| addtp | INT | NULL | 0 | 附加TP |
| day | INT | NULL | 0 | 天数 |
| score | INT | NULL | 0 | 分数 |
| qindex | INT | NULL | 100110 | 任务索引 |
| distName | VARCHAR(255) | NULL | NULL | 区服名 |
| servername | VARCHAR(255) | NULL | NULL | 服务器名 |
| updateTime | DATETIME | NULL | NULL | 更新时间 |
| lockTime | BIGINT | NULL | 0 | 封号时间 |
| pos | JSON | NULL | NULL | 坐标数据 |
| storageline | INT | NULL | 1 | 仓库行数 |
| wordTime | BIGINT | NULL | 0 | 禁言时间 |
| weaponIndex | INT | NULL | 0 | 武器index |
| expratio | INT | NULL | 100 | 经验比例 |
| fatigueratio | INT | NULL | 100 | 疲劳比例 |
| adventurename | VARCHAR(255) | NULL | '' | 冒险名称 |
| serverSimpleDataBox | JSON | NULL | NULL | 服务器简单数据 |
| friendBox | JSON | NULL | NULL | 好友箱 |
| titleBox | JSON | NULL | NULL | 称号箱 |
| avatarBox | JSON | NULL | NULL | 装扮背包 |
| emblemBox | JSON | NULL | NULL | 徽章背包 |
| cardBox | JSON | NULL | NULL | 卡片背包 |
| creatureBox | JSON | NULL | NULL | 宠物背包 |
| artifactBox | JSON | NULL | NULL | 宠物装备 |
| equipBox | JSON | NULL | NULL | 装备背包 |
| equippedBox | JSON | NULL | NULL | 已装备 |
| materialBox | JSON | NULL | NULL | 材料背包 |
| consumableBox | JSON | NULL | NULL | 消耗品背包 |
| roleShopInfoBox | JSON | NULL | NULL | 角色购买记录 |
| crackEquipBox | JSON | NULL | NULL | 强化装备箱 |
| crackBox | JSON | NULL | NULL | 强化箱 |
| damageBox | JSON | NULL | NULL | 伤害字体 |
| chatFrameBox | JSON | NULL | NULL | 聊天边框 |
| charFrameBox | JSON | NULL | NULL | 人物边框 |
| sdAvatarBox | JSON | NULL | NULL | SD装扮箱 |
| bookmarkBox | JSON | NULL | NULL | 书签箱 |
| scrollBox | JSON | NULL | NULL | 卷轴箱 |
| moneyBox | JSON | NULL | NULL | 金钱箱 |
| ceraShopBuyInfo | JSON | NULL | NULL | 点券商店购买信息 |
| tutoBox | JSON | NULL | NULL | 教程箱 |
| skillBox | JSON | NULL | NULL | 技能箱 |
| skillslotBox | JSON | NULL | NULL | 技能槽箱 |
| dungeonTicketsBox | JSON | NULL | NULL | 副本门票箱 |
| tonicBox | JSON | NULL | NULL | 魔力强化信息 |
| mailBox | JSON | NULL | NULL | 邮箱 |
| sysMailBox | JSON | NULL | NULL | 系统邮箱 |
| charStorageBox | JSON | NULL | NULL | 角色金库 |
| rePurStoItem | JSON | NULL | NULL | 回收仓库物品 |
| towerInfoBox | JSON | NULL | NULL | 塔信息箱 |
| creatureErrandBox | JSON | NULL | NULL | 宠物差事箱 |
| localRewardBox | JSON | NULL | NULL | 本地奖励箱 |
| questInfoBox | JSON | NULL | NULL | 任务信息箱 |
| sysBuffBox | JSON | NULL | NULL | 系统Buff箱 |
| clearDungeonBox | JSON | NULL | NULL | 通关副本箱 |
| achievementBox | JSON | NULL | NULL | 成就箱 |
| collectionBox | JSON | NULL | NULL | 收集箱 |
| noteMsgBox | JSON | NULL | NULL | 便签消息箱 |
| essenceBox | JSON | NULL | NULL | 精华箱 |
| auctionBox | JSON | NULL | NULL | 拍卖箱 |

**索引**:
- PRIMARY KEY: `uid`
- INDEX: `idx_roleId` (`roleId`)
- INDEX: `idx_uid` (`uid`)
- INDEX: `idx_openid` (`openid`)
- INDEX: `idx_name` (`name`)

**引擎**: InnoDB
**字符集**: utf8mb4_unicode_ci

---

### 3. t_paydata (支付数据表)

**数据库**: game

**用途**: 存储支付数据

**表结构**:

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 自增ID |
| userid | VARCHAR(255) | NULL | NULL | 用户ID |
| orderid | VARCHAR(255) | NULL | NULL | 订单号 |
| pkg | VARCHAR(255) | NULL | NULL | 包名 |
| money | VARCHAR(255) | NULL | NULL | 金额 |
| gamename | VARCHAR(255) | NULL | NULL | 游戏名称 |
| createtime | DATETIME | NULL | CURRENT_TIMESTAMP | 时间 |
| app_channel | VARCHAR(255) | NULL | NULL | 游戏渠道码 |
| userchannel | VARCHAR(255) | NULL | NULL | 用户渠道 |
| status | VARCHAR(255) | NULL | NULL | 支付状态 |

**索引**:
- PRIMARY KEY: `id`

**引擎**: InnoDB
**字符集**: utf8mb4_unicode_ci

---

### 4. t_charge (充值表)

**数据库**: game

**用途**: 存储充值记录

**表结构**:

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 自增ID |
| tradeNo | VARCHAR(255) | UNIQUE | - | 交易号 |
| gold | INT | NULL | 0 | 金币 |
| rmb | INT | NULL | 0 | 人民币 |
| time | DATETIME | NULL | NULL | 时间 |
| userName | VARCHAR(255) | INDEX | NULL | 用户名 |
| status | INT | NULL | 0 | 状态 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_tradeNo` (`tradeNo`)
- INDEX: `idx_userName` (`userName`)

**引擎**: InnoDB
**字符集**: utf8mb4_unicode_ci

---

### 5. t_notice (公告表)

**数据库**: game

**用途**: 存储游戏公告

**表结构**:

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 自增ID |
| content | VARCHAR(1024) | NULL | NULL | 公告内容 |

**索引**:
- PRIMARY KEY: `id`

**引擎**: InnoDB
**字符集**: utf8mb4_unicode_ci

---

## 初始化数据

### 测试公告

```sql
INSERT INTO `t_notice` (`id`, `content`) VALUES (1, '欢迎来到 DNF 游戏服务器！');
```

## 数据库管理

### 启动数据库

```bash
cd /Users/pix/dev/code/java/DnfGameServer/mysql-db
docker-compose up -d
```

### 停止数据库

```bash
cd /Users/pix/dev/code/java/DnfGameServer/mysql-db
docker-compose down
```

### 查看数据库状态

```bash
docker exec -it dnf-mariadb mysql -uroot -p123456 -e "SHOW DATABASES;"
```

### 重建表结构

```bash
docker exec -i dnf-mariadb mysql -uroot -p123456 < /Users/pix/dev/code/java/DnfGameServer/mysql-db/schema.sql
```

## 测试

使用 pytest 框架编写测试用例，验证数据库模拟环境的正确性。详见 `tests/test_database.py`。