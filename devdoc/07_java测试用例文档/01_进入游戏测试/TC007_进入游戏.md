# TC007_进入游戏

## 测试用例概述

| 项目 | 内容 |
|------|------|
| 测试用例ID | TC007 |
| 测试用例名称 | 进入游戏 |
| 所属模块 | 进入游戏系统 |
| 测试类型 | 功能测试 |
| 优先级 | 高 |
| 预计执行时间 | 4分钟 |

## 测试目的

验证玩家能成功进入游戏，并加载完整的玩家数据。

## 前置条件

### 测试环境要求
1. Java服务端已启动
2. MySQL数据库已连接
3. 测试数据库已初始化
4. 日志记录已开启

### 测试数据准备
1. 测试账号已注册
   - openid: `test_openid_007`
   - 账号状态: 正常
   - 账号类型: 普通账号

2. 测试角色已创建
   - 角色GUID: 1001
   - 角色名称: TestPlayer1
   - 角色职业: 战士
   - 角色等级: 10
   - 角色状态: 正常

3. 角色数据已配置
   - 背包数据: 至少5个物品
   - 装备数据: 至少1件装备
   - 技能数据: 至少3个技能
   - 任务数据: 至少2个任务
   - 成就数据: 至少1个成就

4. 角色已选择
   - 角色状态: 已选择
   - 玩家已登录获取authKey

### 依赖服务状态
1. 认证服务正常
2. 数据库服务正常
3. 网络连接正常

## 测试步骤

### 步骤1: 准备测试环境
**操作内容**:
1. 检查Java服务端是否启动
   - 命令: `ps aux | grep java`
   - 预期: Java进程存在

2. 检查数据库连接
   - 命令: `mysql -u root -p -e "SHOW DATABASES;"`
   - 预期: 数据库列表正常

3. 准备测试账号和角色
   - 创建测试账号（如果不存在）
   - 创建测试角色（如果不存在）
   - 配置角色数据（背包、装备、技能、任务、成就）
   - 选择角色

**输入参数**:
```sql
-- 创建测试账号
INSERT INTO t_account (openid, accountID, createTime, status) VALUES ('test_openid_007', 10007, NOW(), 1);

-- 创建测试角色
INSERT INTO t_character (charguid, accountID, name, job, level, createTime, status) 
VALUES (1001, 10007, 'TestPlayer1', 1, 10, NOW(), 1);

-- 配置角色背包数据
INSERT INTO t_character_bag (charguid, index, itemID, count) VALUES
(1001, 1, 1001, 10),
(1001, 2, 1002, 5),
(1001, 3, 1003, 3),
(1001, 4, 1004, 2),
(1001, 5, 1005, 1);

-- 配置角色装备数据
INSERT INTO t_character_equipment (charguid, guid, index, itemID) VALUES
(1001, 2001, 1, 2001);

-- 配置角色技能数据
INSERT INTO t_character_skill (charguid, skillID, level) VALUES
(1001, 101, 1),
(1001, 102, 1),
(1001, 103, 1);

-- 配置角色任务数据
INSERT INTO t_character_quest (charguid, questID, status) VALUES
(1001, 1001, 1),
(1001, 1002, 0);

-- 配置角色成就数据
INSERT INTO t_character_achievement (charguid, achievementID, status) VALUES
(1001, 1001, 1);
```

**预期输出**:
- 服务端状态: 运行中
- 数据库状态: 连接正常
- 测试账号: 已创建
- 测试角色: 已创建
- 角色数据: 已配置

**实际输出**:
- 待测试

### 步骤2: 玩家登录获取authKey
**操作内容**:
1. 构造登录请求
   - openid: `test_openid_007`
   - 设备ID: `device_test_007`
   - 设备类型: Android
   - 客户端版本: 1.0.0

2. 发送登录请求
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

3. 接收登录响应
   - 验证错误码为0
   - 获取authKey
   - 获取accountID

**输入参数**:
```java
REQ_LOGIN req = new REQ_LOGIN();
req.setOpenid("test_openid_007");
req.setDeviceId("device_test_007");
req.setDeviceType(1);
req.setClientVersion("1.0.0");
```

**预期输出**:
- 错误码: 0
- authKey: 非空
- accountID: 10007

**实际输出**:
- 待测试

### 步骤3: 选择角色
**操作内容**:
1. 构造选择角色请求
   - authKey: 从登录响应获取
   - accountID: 从登录响应获取
   - charguid: 1001

2. 发送选择角色请求
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080

3. 接收选择角色响应
   - 验证错误码为0
   - 验证角色信息

**输入参数**:
```java
REQ_SELECT_CHARACTER req = new REQ_SELECT_CHARACTER();
req.setAuthKey(authKey);
req.setAccountID(accountID);
req.setCharguid(1001);
```

**预期输出**:
- 错误码: 0
- 角色信息: 非空

**实际输出**:
- 待测试

### 步骤4: 构造进入游戏请求
**操作内容**:
1. 创建进入游戏请求对象
   - 请求类型: REQ_ENTER_GAME
   - 协议版本: 1.0

2. 设置请求参数
   - authKey: 从登录响应获取
   - accountID: 从登录响应获取
   - charguid: 1001

3. 序列化请求
   - 使用jprotobuf序列化
   - 编码格式: UTF-8
   - 压缩: 不压缩

**输入参数**:
```java
REQ_ENTER_GAME req = new REQ_ENTER_GAME();
req.setAuthKey(authKey);
req.setAccountID(accountID);
req.setCharguid(1001);
```

**预期输出**:
- 请求对象: 创建成功
- 序列化结果: 字节数组
- 序列化长度: > 0

**实际输出**:
- 待测试

### 步骤5: 发送进入游戏请求
**操作内容**:
1. 建立TCP连接
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

2. 发送序列化后的请求
   - 发送方式: 同步发送
   - 发送超时: 10000ms
   - 重试次数: 3

3. 等待响应
   - 等待超时: 20000ms（进入游戏可能需要更长时间）
   - 响应缓冲区大小: 8192

**输入参数**:
```java
Socket socket = new Socket("127.0.0.1", 8080);
OutputStream out = socket.getOutputStream();
out.write(reqBytes);
out.flush();
```

**预期输出**:
- 连接状态: 已连接
- 发送状态: 发送成功
- 接收状态: 收到响应

**实际输出**:
- 待测试

### 步骤6: 接收并解析响应
**操作内容**:
1. 接收响应数据
   - 读取方式: 循环读取
   - 每次读取大小: 1024字节
   - 总读取超时: 20000ms

2. 解析响应类型
   - 读取响应头: 4字节
   - 解析响应类型: RES_ENTER_GAME
   - 验证响应类型正确

3. 反序列化响应
   - 使用jprotobuf反序列化
   - 解码格式: UTF-8
   - 验证数据完整性

**输入参数**:
```java
InputStream in = socket.getInputStream();
byte[] responseBytes = readFully(in);
RES_ENTER_GAME res = RES_ENTER_GAME.parseFrom(responseBytes);
```

**预期输出**:
- 响应类型: RES_ENTER_GAME
- 反序列化结果: 对象创建成功
- 数据完整性: 无损坏

**实际输出**:
- 待测试

### 步骤7: 验证进入游戏成功
**操作内容**:
1. 验证错误码
   - 检查字段: error
   - 预期值: 0
   - 说明: 0表示成功

2. 验证角色信息
   - 检查字段: character
   - 预期值: 非空
   - 验证角色GUID: 1001

3. 验证游戏数据
   - 检查字段: gameData
   - 预期值: 非空
   - 说明: 游戏数据应该完整

**输入参数**:
```java
assertEquals(0, res.getError());
assertNotNull(res.getCharacter());
assertEquals(1001, res.getCharacter().getCharguid());
assertNotNull(res.getGameData());
```

**预期输出**:
- 错误码: 0
- 角色信息: 非空
- 角色GUID: 1001
- 游戏数据: 非空

**实际输出**:
- 待测试

### 步骤8: 验证角色基本信息
**操作内容**:
1. 验证角色基本信息
   - charguid: 1001
   - name: TestPlayer1
   - job: 1 (战士)
   - level: 10

2. 验证角色属性
   - hp: 非空且大于0
   - mp: 非空且大于0
   - exp: 非空
   - gold: 非空且大于等于0

3. 验证角色位置
   - mapID: 非空
   - x: 非空
   - y: 非空

**输入参数**:
```java
assertEquals(1001, res.getCharacter().getCharguid());
assertEquals("TestPlayer1", res.getCharacter().getName());
assertEquals(1, res.getCharacter().getJob());
assertEquals(10, res.getCharacter().getLevel());
assertNotNull(res.getCharacter().getHp());
assertTrue(res.getCharacter().getHp() > 0);
assertNotNull(res.getCharacter().getMp());
assertTrue(res.getCharacter().getMp() > 0);
```

**预期输出**:
- charguid: 1001
- name: TestPlayer1
- job: 1
- level: 10
- hp: 非空且大于0
- mp: 非空且大于0
- exp: 非空
- gold: 非空且大于等于0
- mapID: 非空
- x: 非空
- y: 非空

**实际输出**:
- 待测试

### 步骤9: 验证背包数据
**操作内容**:
1. 验证背包对象
   - 检查字段: bag
   - 预期值: 非空
   - 说明: 背包数据应该存在

2. 验证背包物品
   - 检查字段: items
   - 预期值: 非空数组
   - 数组长度: >= 5

3. 验证物品数据完整性
   - 每个物品都有guid
   - 每个物品都有index
   - 每个物品都有itemID
   - 每个物品都有count

**输入参数**:
```java
assertNotNull(res.getGameData().getBag());
assertNotNull(res.getGameData().getBag().getItems());
assertTrue(res.getGameData().getBag().getItems().size() >= 5);
```

**预期输出**:
- 背包对象: 非空
- 背包物品: 非空
- 物品数量: >= 5
- 物品数据: 完整

**实际输出**:
- 待测试

### 步骤10: 验证装备数据
**操作内容**:
1. 验证装备对象
   - 检查字段: equipments
   - 预期值: 非空数组
   - 数组长度: >= 1

2. 验证装备数据完整性
   - 每个装备都有guid
   - 每个装备都有index
   - 每个装备都有itemID
   - 每个装备都有属性

**输入参数**:
```java
assertNotNull(res.getGameData().getEquipments());
assertTrue(res.getGameData().getEquipments().size() >= 1);
```

**预期输出**:
- 装备对象: 非空
- 装备数量: >= 1
- 装备数据: 完整

**实际输出**:
- 待测试

### 步骤11: 验证技能数据
**操作内容**:
1. 验证技能对象
   - 检查字段: skills
   - 预期值: 非空数组
   - 数组长度: >= 3

2. 验证技能数据完整性
   - 每个技能都有skillID
   - 每个技能都有level
   - 每个技能都有冷却时间

**输入参数**:
```java
assertNotNull(res.getGameData().getSkills());
assertTrue(res.getGameData().getSkills().size() >= 3);
```

**预期输出**:
- 技能对象: 非空
- 技能数量: >= 3
- 技能数据: 完整

**实际输出**:
- 待测试

### 步骤12: 验证任务数据
**操作内容**:
1. 验证任务对象
   - 检查字段: quests
   - 预期值: 非空数组
   - 数组长度: >= 2

2. 验证任务数据完整性
   - 每个任务都有questID
   - 每个任务都有status
   - 每个任务都有progress

**输入参数**:
```java
assertNotNull(res.getGameData().getQuests());
assertTrue(res.getGameData().getQuests().size() >= 2);
```

**预期输出**:
- 任务对象: 非空
- 任务数量: >= 2
- 任务数据: 完整

**实际输出**:
- 待测试

### 步骤13: 验证成就数据
**操作内容**:
1. 验证成就对象
   - 检查字段: achievements
   - 预期值: 非空数组
   - 数组长度: >= 1

2. 验证成就数据完整性
   - 每个成就都有achievementID
   - 每个成就都有status
   - 每个成就都有progress

**输入参数**:
```java
assertNotNull(res.getGameData().getAchievements());
assertTrue(res.getGameData().getAchievements().size() >= 1);
```

**预期输出**:
- 成就对象: 非空
- 成就数量: >= 1
- 成就数据: 完整

**实际输出**:
- 待测试

### 步骤14: 验证数据库记录
**操作内容**:
1. 查询角色记录
   - 表名: t_character
   - 查询条件: charguid = 1001

2. 验证角色状态
   - 检查字段: status
   - 预期值: 2（游戏中）
   - 说明: 进入游戏后角色状态应该为游戏中

3. 验证最后登录时间
   - 检查字段: lastLoginTime
   - 预期值: 最近1分钟内
   - 说明: 进入游戏时应该更新最后登录时间

**输入参数**:
```sql
SELECT status, lastLoginTime FROM t_character WHERE charguid = 1001;
```

**预期输出**:
- 角色状态: 2（游戏中）
- 最后登录时间: 最近1分钟内

**实际输出**:
- 待测试

### 步骤15: 验证日志记录
**操作内容**:
1. 检查服务器日志
   - 日志文件: logs/game.log
   - 搜索关键字: test_openid_007
   - 验证日志级别: INFO

2. 验证日志内容
   - 应该记录进入游戏事件
   - 应该记录角色GUID
   - 应该记录角色名称

**输入参数**:
```bash
grep "test_openid_007" logs/game.log | grep "enter game"
```

**预期输出**:
- 日志记录: 存在
- 日志级别: INFO
- 日志内容: 包含进入游戏信息
- 角色GUID: 1001
- 角色名称: TestPlayer1

**实际输出**:
- 待测试

### 步骤16: 清理测试数据
**操作内容**:
1. 删除角色数据
   - 表名: t_character_bag
   - 删除条件: charguid = 1001

2. 删除角色数据
   - 表名: t_character_equipment
   - 删除条件: charguid = 1001

3. 删除角色数据
   - 表名: t_character_skill
   - 删除条件: charguid = 1001

4. 删除角色数据
   - 表名: t_character_quest
   - 删除条件: charguid = 1001

5. 删除角色数据
   - 表名: t_character_achievement
   - 删除条件: charguid = 1001

6. 删除角色记录
   - 表名: t_character
   - 删除条件: accountID = 10007

7. 删除账号记录
   - 表名: t_account
   - 删除条件: accountID = 10007

8. 关闭连接
   - 关闭Socket连接
   - 释放资源
   - 记录日志

**输入参数**:
```sql
DELETE FROM t_character_achievement WHERE charguid = 1001;
DELETE FROM t_character_quest WHERE charguid = 1001;
DELETE FROM t_character_skill WHERE charguid = 1001;
DELETE FROM t_character_equipment WHERE charguid = 1001;
DELETE FROM t_character_bag WHERE charguid = 1001;
DELETE FROM t_character WHERE accountID = 10007;
DELETE FROM t_account WHERE accountID = 10007;
```

**预期输出**:
- 角色数据: 已删除
- 角色记录: 已删除
- 账号记录: 已删除
- 连接状态: 已关闭
- 日志记录: 已记录

**实际输出**:
- 待测试

## 预期结果

### 成功情况
1. 登录请求发送成功
2. 收到登录响应，获取到authKey
3. 选择角色请求发送成功
4. 收到选择角色响应
5. 进入游戏请求发送成功
6. 收到进入游戏响应
7. 错误码为0（成功）
8. 角色信息完整且正确
9. 背包数据完整
10. 装备数据完整
11. 技能数据完整
12. 任务数据完整
13. 成就数据完整
14. 角色状态更新为游戏中
15. 日志记录了进入游戏事件

### 失败情况
1. 连接失败
2. 请求超时
3. 响应解析失败
4. 错误码非0
5. 角色信息不完整
6. 背包数据缺失
7. 装备数据缺失
8. 技能数据缺失
9. 任务数据缺失
10. 成就数据缺失

### 边界情况
1. 角色数据为空
2. 背包物品数量为0
3. 装备数量为0
4. 技能数量为0
5. 任务数量为0
6. 成就数量为0
7. 网络延迟
8. 网络中断
9. 数据库连接异常

## 实际结果

### 测试执行记录

| 项目 | 内容 |
|------|------|
| 测试日期 | 待测试 |
| 测试人员 | 待测试 |
| 测试环境 | 待测试 |
| 执行时间 | 待测试 |

### 测试步骤执行情况

| 步骤 | 状态 | 执行时间 | 备注 |
|------|------|---------|------|
| 步骤1: 准备测试环境 | ⏳ 待执行 | - | - |
| 步骤2: 玩家登录获取authKey | ⏳ 待执行 | - | - |
| 步骤3: 选择角色 | ⏳ 待执行 | - | - |
| 步骤4: 构造进入游戏请求 | ⏳ 待执行 | - | - |
| 步骤5: 发送进入游戏请求 | ⏳ 待执行 | - | - |
| 步骤6: 接收并解析响应 | ⏳ 待执行 | - | - |
| 步骤7: 验证进入游戏成功 | ⏳ 待执行 | - | - |
| 步骤8: 验证角色基本信息 | ⏳ 待执行 | - | - |
| 步骤9: 验证背包数据 | ⏳ 待执行 | - | - |
| 步骤10: 验证装备数据 | ⏳ 待执行 | - | - |
| 步骤11: 验证技能数据 | ⏳ 待执行 | - | - |
| 步骤12: 验证任务数据 | ⏳ 待执行 | - | - |
| 步骤13: 验证成就数据 | ⏳ 待执行 | - | - |
| 步骤14: 验证数据库记录 | ⏳ 待执行 | - | - |
| 步骤15: 验证日志记录 | ⏳ 待执行 | - | - |
| 步骤16: 清理测试数据 | ⏳ 待执行 | - | - |

### 测试结果验证

| 验证项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 错误码为0 | 0 | 待测试 | ⏳ |
| 角色信息非空 | 非空 | 待测试 | ⏳ |
| 角色GUID为1001 | 1001 | 待测试 | ⏳ |
| 角色名称为TestPlayer1 | TestPlayer1 | 待测试 | ⏳ |
| 角色职业为1 | 1 | 待测试 | ⏳ |
| 角色等级为10 | 10 | 待测试 | ⏳ |
| 背包数据完整 | 完整 | 待测试 | ⏳ |
| 装备数据完整 | 完整 | 待测试 | ⏳ |
| 技能数据完整 | 完整 | 待测试 | ⏳ |
| 任务数据完整 | 完整 | 待测试 | ⏳ |
| 成就数据完整 | 完整 | 待测试 | ⏳ |
| 角色状态为2 | 2 | 待测试 | ⏳ |
| 日志记录存在 | 存在 | 待测试 | ⏳ |

### 测试状态
- 总体状态: ⏳ 待测试
- 通过步骤: 0/16
- 失败步骤: 0/16
- 测试结论: 待测试

## 问题记录

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 状态 | 修复建议 |
|--------|----------|----------|------|----------|
| - | - | - | - | - |

### 已知问题

| 问题ID | 问题描述 | 影响 | 临时方案 |
|--------|----------|------|----------|
| - | - | - | - |

## 注意事项

1. **测试数据隔离**: 每次测试前必须准备独立的测试数据
2. **角色数据**: 确保角色数据完整（背包、装备、技能、任务、成就）
3. **数据验证**: 要验证数据库中的实际数据
4. **日志记录**: 详细记录测试过程和结果
5. **性能监控**: 记录每个步骤的执行时间
6. **资源清理**: 测试完成后必须清理所有测试数据
7. **异常处理**: 测试过程中要注意异常情况
8. **数据完整性**: 确保所有游戏数据都加载完整
9. **状态验证**: 验证角色状态是否正确更新
10. **边界测试**: 注意各种数据为空的边界情况

## 参考资源

### Java代码
- Controller: `src/main/java/com/dnfm/game/entergame/EnterGameController.java`
- Service: `src/main/java/com/dnfm/game/entergame/service/EnterGameService.java`
- Model: `src/main/java/com/dnfm/game/entergame/model/EnterGameData.java`

### Protobuf定义
- 请求: `REQ_ENTER_GAME`
- 响应: `RES_ENTER_GAME`

### 数据库表
- t_account: 账号表
- t_character: 角色表
- t_character_bag: 角色背包表
- t_character_equipment: 角色装备表
- t_character_skill: 角色技能表
- t_character_quest: 角色任务表
- t_character_achievement: 角色成就表

### 测试工具
- JUnit: https://junit.org/junit4/
- Mockito: https://site.mockito.org/
