# TC001_玩家登录验证

## 测试用例概述

| 项目 | 内容 |
|------|------|
| 测试用例ID | TC001 |
| 测试用例名称 | 玩家登录验证 |
| 所属模块 | 进入游戏系统 |
| 测试类型 | 功能测试 |
| 优先级 | 高 |
| 预计执行时间 | 5分钟 |

## 测试目的

验证玩家使用正确的openid能否成功登录，并返回正确的authKey和玩家信息。

## 前置条件

### 测试环境要求
1. Java服务端已启动
2. MySQL数据库已连接
3. 测试数据库已初始化
4. 日志记录已开启

### 测试数据准备
1. 测试账号已注册
   - openid: `test_openid_001`
   - 账号状态: 正常
   - 账号类型: 普通账号

2. 测试角色已创建（可选）
   - 角色GUID: 1001
   - 角色名称: TestPlayer1
   - 角色职业: 战士
   - 角色等级: 10

### 依赖服务状态
1. 认证服务正常
2. 数据库服务正常
3. 网络连接正常

## 测试步骤

### 步骤1: 准备测试环境
**操作内容**:
1. 检查Java服务端是否启动
   - 命令: `ps aux | grep java`
   - 预期: Java进程存在

2. 检查数据库连接
   - 命令: `mysql -u root -p -e "SHOW DATABASES;"`
   - 预期: 数据库列表正常

3. 清理测试数据
   - 删除测试账号的历史登录记录
   - 重置测试账号的登录状态
   - 清理测试账号的token

**输入参数**:
- 无

**预期输出**:
- 服务端状态: 运行中
- 数据库状态: 连接正常
- 测试数据: 已清理

**实际输出**:
- 待测试

### 步骤2: 构造登录请求
**操作内容**:
1. 创建登录请求对象
   - 请求类型: REQ_LOGIN
   - 协议版本: 1.0
   - 设备信息: 测试设备

2. 设置登录参数
   - openid: `test_openid_001`
   - 设备ID: `device_test_001`
   - 设备类型: Android
   - 客户端版本: 1.0.0

3. 序列化请求
   - 使用jprotobuf序列化
   - 编码格式: UTF-8
   - 压缩: 不压缩

**输入参数**:
```java
REQ_LOGIN req = new REQ_LOGIN();
req.setOpenid("test_openid_001");
req.setDeviceId("device_test_001");
req.setDeviceType(1); // Android
req.setClientVersion("1.0.0");
```

**预期输出**:
- 请求对象: 创建成功
- 序列化结果: 字节数组
- 序列化长度: > 0

**实际输出**:
- 待测试

### 步骤3: 发送登录请求
**操作内容**:
1. 建立TCP连接
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

2. 发送序列化后的请求
   - 发送方式: 同步发送
   - 发送超时: 10000ms
   - 重试次数: 3

3. 等待响应
   - 等待超时: 15000ms
   - 响应缓冲区大小: 4096

**输入参数**:
```java
Socket socket = new Socket("127.0.0.1", 8080);
OutputStream out = socket.getOutputStream();
out.write(reqBytes);
out.flush();
```

**预期输出**:
- 连接状态: 已连接
- 发送状态: 发送成功
- 接收状态: 收到响应

**实际输出**:
- 待测试

### 步骤4: 接收并解析响应
**操作内容**:
1. 接收响应数据
   - 读取方式: 循环读取
   - 每次读取大小: 1024字节
   - 总读取超时: 15000ms

2. 解析响应类型
   - 读取响应头: 4字节
   - 解析响应类型: RES_LOGIN
   - 验证响应类型正确

3. 反序列化响应
   - 使用jprotobuf反序列化
   - 解码格式: UTF-8
   - 验证数据完整性

**输入参数**:
```java
InputStream in = socket.getInputStream();
byte[] responseBytes = readFully(in);
RES_LOGIN res = RES_LOGIN.parseFrom(responseBytes);
```

**预期输出**:
- 响应类型: RES_LOGIN
- 反序列化结果: 对象创建成功
- 数据完整性: 无损坏

**实际输出**:
- 待测试

### 步骤5: 验证登录结果
**操作内容**:
1. 验证错误码
   - 检查字段: error
   - 预期值: 0
   - 说明: 0表示成功

2. 验证authKey
   - 检查字段: authKey
   - 预期值: 非空字符串
   - 长度: 32-64字符

3. 验证账号信息
   - 检查字段: account
   - 预期值: 非空
   - 验证字段: openid, accountID, createTime

4. 验证角色列表
   - 检查字段: characters
   - 预期值: 数组（可能为空）
   - 验证字段: charguid, name, job, level

**输入参数**:
```java
assertEquals(0, res.getError());
assertNotNull(res.getAuthKey());
assertTrue(res.getAuthKey().length() >= 32);
assertNotNull(res.getAccount());
```

**预期输出**:
- 错误码: 0
- authKey: 非空，长度32-64
- 账号信息: 完整
- 角色列表: 数组（可能为空）

**实际输出**:
- 待测试

### 步骤6: 验证数据库记录
**操作内容**:
1. 查询登录记录
   - 表名: t_account_login_log
   - 查询条件: openid = 'test_openid_001'
   - 排序: 按时间倒序

2. 验证登录时间
   - 检查字段: loginTime
   - 预期: 最近5分钟内
   - 精度: 秒级

3. 验证登录IP
   - 检查字段: loginIP
   - 预期: 127.0.0.1
   - 格式: IPv4

4. 验证设备信息
   - 检查字段: deviceId, deviceType
   - 预期: 与请求一致
   - 说明: 记录设备信息

**输入参数**:
```sql
SELECT * FROM t_account_login_log
WHERE openid = 'test_openid_001'
ORDER BY loginTime DESC
LIMIT 1;
```

**预期输出**:
- 登录记录: 存在
- 登录时间: 最近5分钟内
- 登录IP: 127.0.0.1
- 设备信息: 与请求一致

**实际输出**:
- 待测试

### 步骤7: 验证token生成
**操作内容**:
1. 查询token记录
   - 表名: t_account_token
   - 查询条件: accountID = ?
   - 排序: 按创建时间倒序

2. 验证token内容
   - 检查字段: token
   - 预期: 与返回的authKey一致
   - 说明: token已保存

3. 验证token有效期
   - 检查字段: expireTime
   - 预期: 当前时间+7天
   - 说明: token有效期7天

4. 验证token状态
   - 检查字段: status
   - 预期: 1（有效）
   - 说明: token状态有效

**输入参数**:
```sql
SELECT * FROM t_account_token
WHERE accountID = ?
ORDER BY createTime DESC
LIMIT 1;
```

**预期输出**:
- token记录: 存在
- token内容: 与authKey一致
- token有效期: 当前时间+7天
- token状态: 1（有效）

**实际输出**:
- 待测试

### 步骤8: 清理测试数据
**操作内容**:
1. 删除登录记录
   - 表名: t_account_login_log
   - 删除条件: openid = 'test_openid_001'

2. 删除token记录
   - 表名: t_account_token
   - 删除条件: accountID = ?

3. 关闭连接
   - 关闭Socket连接
   - 释放资源
   - 记录日志

**输入参数**:
```sql
DELETE FROM t_account_login_log WHERE openid = 'test_openid_001';
DELETE FROM t_account_token WHERE accountID = ?;
```

**预期输出**:
- 登录记录: 已删除
- token记录: 已删除
- 连接状态: 已关闭
- 日志记录: 已记录

**实际输出**:
- 待测试

## 预期结果

### 成功情况
1. 登录请求发送成功
2. 收到登录响应
3. 错误码为0（成功）
4. authKey非空且长度符合要求
5. 账号信息完整
6. 角色列表正确返回
7. 数据库登录记录正确
8. 数据库token记录正确

### 失败情况
1. 连接失败
2. 请求超时
3. 响应解析失败
4. 错误码非0
5. authKey为空或长度不符合要求
6. 账号信息不完整
7. 数据库记录不正确

### 边界情况
1. openid为空
2. openid超长
3. openid包含特殊字符
4. 网络延迟
5. 网络中断
6. 服务器负载高

## 实际结果

### 测试执行记录

| 项目 | 内容 |
|------|------|
| 测试日期 | 待测试 |
| 测试人员 | 待测试 |
| 测试环境 | 待测试 |
| 执行时间 | 待测试 |

### 测试步骤执行情况

| 步骤 | 状态 | 执行时间 | 备注 |
|------|------|---------|------|
| 步骤1: 准备测试环境 | ⏳ 待执行 | - | - |
| 步骤2: 构造登录请求 | ⏳ 待执行 | - | - |
| 步骤3: 发送登录请求 | ⏳ 待执行 | - | - |
| 步骤4: 接收并解析响应 | ⏳ 待执行 | - | - |
| 步骤5: 验证登录结果 | ⏳ 待执行 | - | - |
| 步骤6: 验证数据库记录 | ⏳ 待执行 | - | - |
| 步骤7: 验证token生成 | ⏳ 待执行 | - | - |
| 步骤8: 清理测试数据 | ⏳ 待执行 | - | - |

### 测试结果验证

| 验证项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 错误码为0 | 0 | 待测试 | ⏳ |
| authKey非空 | 非空 | 待测试 | ⏳ |
| authKey长度32-64 | 32-64 | 待测试 | ⏳ |
| 账号信息完整 | 完整 | 待测试 | ⏳ |
| 角色列表正确 | 正确 | 待测试 | ⏳ |
| 登录记录存在 | 存在 | 待测试 | ⏳ |
| token记录存在 | 存在 | 待测试 | ⏳ |
| token有效期正确 | 正确 | 待测试 | ⏳ |

### 测试状态
- 总体状态: ⏳ 待测试
- 通过步骤: 0/8
- 失败步骤: 0/8
- 测试结论: 待测试

## 问题记录

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 状态 | 修复建议 |
|--------|----------|----------|------|----------|
| - | - | - | - |

### 已知问题

| 问题ID | 问题描述 | 影响 | 临时方案 |
|--------|----------|------|----------|
| - | - | - | - |

## 注意事项

1. **测试数据隔离**: 每次测试前必须清理测试数据
2. **网络环境**: 确保测试网络稳定
3. **时间同步**: 确保服务器时间准确
4. **日志记录**: 详细记录测试过程和结果
5. **异常处理**: 测试过程中要注意异常情况
6. **数据验证**: 要验证数据库中的实际数据
7. **性能监控**: 记录每个步骤的执行时间
8. **资源清理**: 测试完成后必须清理资源

## 参考资源

### Java代码
- Controller: `src/main/java/com/dnfm/game/auth/AuthController.java`
- Service: `src/main/java/com/dnfm/game/auth/service/AuthService.java`
- Model: `src/main/java/com/dnfm/game/auth/model/Account.java`

### Protobuf定义
- 请求: `REQ_LOGIN`
- 响应: `RES_LOGIN`

### 数据库表
- t_account: 账号表
- t_account_login_log: 登录日志表
- t_account_token: token表

### 测试工具
- JUnit: https://junit.org/junit4/
- Mockito: https://site.mockito.org/
