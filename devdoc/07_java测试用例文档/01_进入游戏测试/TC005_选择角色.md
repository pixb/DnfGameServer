# TC005_选择角色

## 测试用例概述

| 项目 | 内容 |
|------|------|
| 测试用例ID | TC005 |
| 测试用例名称 | 选择角色 |
| 所属模块 | 进入游戏系统 |
| 测试类型 | 功能测试 |
| 优先级 | 高 |
| 预计执行时间 | 3分钟 |

## 测试目的

验证玩家能成功选择角色，并更新角色的最后登录时间。

## 前置条件

### 测试环境要求
1. Java服务端已启动
2. MySQL数据库已连接
3. 测试数据库已初始化
4. 日志记录已开启

### 测试数据准备
1. 测试账号已注册
   - openid: `test_openid_005`
   - 账号状态: 正常
   - 账号类型: 普通账号

2. 测试角色已创建
   - 角色GUID: 1001
   - 角色名称: TestPlayer1
   - 角色职业: 战士
   - 角色等级: 10
   - 角色状态: 正常
   - 最后登录时间: 1天前

3. 角色已登录
   - 玩家已登录获取authKey
   - authKey有效

### 依赖服务状态
1. 认证服务正常
2. 数据库服务正常
3. 网络连接正常

## 测试步骤

### 步骤1: 准备测试环境
**操作内容**:
1. 检查Java服务端是否启动
   - 命令: `ps aux | grep java`
   - 预期: Java进程存在

2. 检查数据库连接
   - 命令: `mysql -u root -p -e "SHOW DATABASES;"`
   - 预期: 数据库列表正常

3. 准备测试账号和角色
   - 创建测试账号（如果不存在）
   - 创建测试角色（如果不存在）
   - 设置角色的最后登录时间为1天前

**输入参数**:
```sql
-- 创建测试账号
INSERT INTO t_account (openid, accountID, createTime, status) VALUES ('test_openid_005', 10005, NOW(), 1);

-- 创建测试角色
INSERT INTO t_character (charguid, accountID, name, job, level, createTime, lastLoginTime, status) 
VALUES (1001, 10005, 'TestPlayer1', 1, 10, NOW(), DATE_SUB(NOW(), INTERVAL 1 DAY), 1);
```

**预期输出**:
- 服务端状态: 运行中
- 数据库状态: 连接正常
- 测试账号: 已创建
- 测试角色: 已创建

**实际输出**:
- 待测试

### 步骤2: 玩家登录获取authKey
**操作内容**:
1. 构造登录请求
   - openid: `test_openid_005`
   - 设备ID: `device_test_005`
   - 设备类型: Android
   - 客户端版本: 1.0.0

2. 发送登录请求
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

3. 接收登录响应
   - 验证错误码为0
   - 获取authKey
   - 获取accountID

**输入参数**:
```java
REQ_LOGIN req = new REQ_LOGIN();
req.setOpenid("test_openid_005");
req.setDeviceId("device_test_005");
req.setDeviceType(1);
req.setClientVersion("1.0.0");
```

**预期输出**:
- 错误码: 0
- authKey: 非空
- accountID: 10005

**实际输出**:
- 待测试

### 步骤3: 构造选择角色请求
**操作内容**:
1. 创建选择角色请求对象
   - 请求类型: REQ_SELECT_CHARACTER
   - 协议版本: 1.0

2. 设置请求参数
   - authKey: 从登录响应获取
   - accountID: 从登录响应获取
   - charguid: 1001

3. 序列化请求
   - 使用jprotobuf序列化
   - 编码格式: UTF-8
   - 压缩: 不压缩

**输入参数**:
```java
REQ_SELECT_CHARACTER req = new REQ_SELECT_CHARACTER();
req.setAuthKey(authKey);
req.setAccountID(accountID);
req.setCharguid(1001);
```

**预期输出**:
- 请求对象: 创建成功
- 序列化结果: 字节数组
- 序列化长度: > 0

**实际输出**:
- 待测试

### 步骤4: 发送选择角色请求
**操作内容**:
1. 建立TCP连接
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

2. 发送序列化后的请求
   - 发送方式: 同步发送
   - 发送超时: 10000ms
   - 重试次数: 3

3. 等待响应
   - 等待超时: 15000ms
   - 响应缓冲区大小: 4096

**输入参数**:
```java
Socket socket = new Socket("127.0.0.1", 8080);
OutputStream out = socket.getOutputStream();
out.write(reqBytes);
out.flush();
```

**预期输出**:
- 连接状态: 已连接
- 发送状态: 发送成功
- 接收状态: 收到响应

**实际输出**:
- 待测试

### 步骤5: 接收并解析响应
**操作内容**:
1. 接收响应数据
   - 读取方式: 循环读取
   - 每次读取大小: 1024字节
   - 总读取超时: 15000ms

2. 解析响应类型
   - 读取响应头: 4字节
   - 解析响应类型: RES_SELECT_CHARACTER
   - 验证响应类型正确

3. 反序列化响应
   - 使用jprotobuf反序列化
   - 解码格式: UTF-8
   - 验证数据完整性

**输入参数**:
```java
InputStream in = socket.getInputStream();
byte[] responseBytes = readFully(in);
RES_SELECT_CHARACTER res = RES_SELECT_CHARACTER.parseFrom(responseBytes);
```

**预期输出**:
- 响应类型: RES_SELECT_CHARACTER
- 反序列化结果: 对象创建成功
- 数据完整性: 无损坏

**实际输出**:
- 待测试

### 步骤6: 验证选择角色成功
**操作内容**:
1. 验证错误码
   - 检查字段: error
   - 预期值: 0
   - 说明: 0表示成功

2. 验证角色信息
   - 检查字段: character
   - 预期值: 非空
   - 验证角色GUID: 1001

3. 验证角色状态
   - 检查字段: status
   - 预期值: 1（已选择）
   - 说明: 角色状态已更新

**输入参数**:
```java
assertEquals(0, res.getError());
assertNotNull(res.getCharacter());
assertEquals(1001, res.getCharacter().getCharguid());
assertEquals(1, res.getCharacter().getStatus());
```

**预期输出**:
- 错误码: 0
- 角色信息: 非空
- 角色GUID: 1001
- 角色状态: 1（已选择）

**实际输出**:
- 待测试

### 步骤7: 验证角色基本信息
**操作内容**:
1. 验证角色基本信息
   - charguid: 1001
   - name: TestPlayer1
   - job: 1 (战士)
   - level: 10

2. 验证角色时间信息
   - createTime: 非空
   - lastLoginTime: 非空且为最近时间

3. 验证角色外观信息
   - face: 非空
   - hair: 非空
   - skin: 非空

**输入参数**:
```java
assertEquals(1001, res.getCharacter().getCharguid());
assertEquals("TestPlayer1", res.getCharacter().getName());
assertEquals(1, res.getCharacter().getJob());
assertEquals(10, res.getCharacter().getLevel());
assertNotNull(res.getCharacter().getCreateTime());
assertNotNull(res.getCharacter().getLastLoginTime());
```

**预期输出**:
- charguid: 1001
- name: TestPlayer1
- job: 1
- level: 10
- createTime: 非空
- lastLoginTime: 非空且为最近时间

**实际输出**:
- 待测试

### 步骤8: 验证最后登录时间更新
**操作内容**:
1. 查询角色记录
   - 表名: t_character
   - 查询条件: charguid = 1001

2. 验证最后登录时间
   - 检查字段: lastLoginTime
   - 预期值: 最近1分钟内
   - 说明: 选择角色时应该更新最后登录时间

3. 对比更新前后时间
   - 原始时间: 1天前
   - 更新后时间: 最近1分钟内
   - 时间差: 约1天

**输入参数**:
```sql
SELECT lastLoginTime FROM t_character WHERE charguid = 1001;
```

**预期输出**:
- lastLoginTime: 最近1分钟内
- 时间差: 约1天（与原始时间对比）

**实际输出**:
- 待测试

### 步骤9: 验证角色状态更新
**操作内容**:
1. 查询角色记录
   - 表名: t_character
   - 查询条件: charguid = 1001

2. 验证角色状态
   - 检查字段: status
   - 预期值: 1（已选择）
   - 说明: 角色状态应该为已选择

3. 验证其他角色状态
   - 查询同一账号的其他角色
   - 预期值: 0（未选择）
   - 说明: 同一账号只能有一个角色被选择

**输入参数**:
```sql
SELECT status FROM t_character WHERE charguid = 1001;
SELECT charguid, status FROM t_character WHERE accountID = 10005;
```

**预期输出**:
- 选中角色状态: 1（已选择）
- 其他角色状态: 0（未选择）

**实际输出**:
- 待测试

### 步骤10: 验证日志记录
**操作内容**:
1. 检查服务器日志
   - 日志文件: logs/game.log
   - 搜索关键字: test_openid_005
   - 验证日志级别: INFO

2. 验证日志内容
   - 应该记录选择角色事件
   - 应该记录角色GUID
   - 应该记录角色名称

**输入参数**:
```bash
grep "test_openid_005" logs/game.log | grep "select character"
```

**预期输出**:
- 日志记录: 存在
- 日志级别: INFO
- 日志内容: 包含选择角色信息
- 角色GUID: 1001
- 角色名称: TestPlayer1

**实际输出**:
- 待测试

### 步骤11: 清理测试数据
**操作内容**:
1. 删除角色记录
   - 表名: t_character
   - 删除条件: accountID = 10005

2. 删除账号记录
   - 表名: t_account
   - 删除条件: accountID = 10005

3. 关闭连接
   - 关闭Socket连接
   - 释放资源
   - 记录日志

**输入参数**:
```sql
DELETE FROM t_character WHERE accountID = 10005;
DELETE FROM t_account WHERE accountID = 10005;
```

**预期输出**:
- 角色记录: 已删除
- 账号记录: 已删除
- 连接状态: 已关闭
- 日志记录: 已记录

**实际输出**:
- 待测试

## 预期结果

### 成功情况
1. 登录请求发送成功
2. 收到登录响应，获取到authKey
3. 选择角色请求发送成功
4. 收到选择角色响应
5. 错误码为0（成功）
6. 角色信息非空且正确
7. 角色基本信息完整
8. 最后登录时间已更新
9. 角色状态已更新为已选择
10. 日志记录了选择角色事件

### 失败情况
1. 连接失败
2. 请求超时
3. 响应解析失败
4. 错误码非0
5. 角色信息为空
6. 角色信息不正确
7. 最后登录时间未更新
8. 角色状态未更新

### 边界情况
1. 角色GUID为0
2. 角色GUID不存在
3. 角色GUID属于其他账号
4. 角色状态为已封禁
5. 角色状态为已删除
6. 重复选择同一角色
7. 网络延迟
8. 网络中断

## 实际结果

### 测试执行记录

| 项目 | 内容 |
|------|------|
| 测试日期 | 待测试 |
| 测试人员 | 待测试 |
| 测试环境 | 待测试 |
| 执行时间 | 待测试 |

### 测试步骤执行情况

| 步骤 | 状态 | 执行时间 | 备注 |
|------|------|---------|------|
| 步骤1: 准备测试环境 | ⏳ 待执行 | - | - |
| 步骤2: 玩家登录获取authKey | ⏳ 待执行 | - | - |
| 步骤3: 构造选择角色请求 | ⏳ 待执行 | - | - |
| 步骤4: 发送选择角色请求 | ⏳ 待执行 | - | - |
| 步骤5: 接收并解析响应 | ⏳ 待执行 | - | - |
| 步骤6: 验证选择角色成功 | ⏳ 待执行 | - | - |
| 步骤7: 验证角色基本信息 | ⏳ 待执行 | - | - |
| 步骤8: 验证最后登录时间更新 | ⏳ 待执行 | - | - |
| 步骤9: 验证角色状态更新 | ⏳ 待执行 | - | - |
| 步骤10: 验证日志记录 | ⏳ 待执行 | - | - |
| 步骤11: 清理测试数据 | ⏳ 待执行 | - | - |

### 测试结果验证

| 验证项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 错误码为0 | 0 | 待测试 | ⏳ |
| 角色信息非空 | 非空 | 待测试 | ⏳ |
| 角色GUID为1001 | 1001 | 待测试 | ⏳ |
| 角色名称为TestPlayer1 | TestPlayer1 | 待测试 | ⏳ |
| 角色职业为1 | 1 | 待测试 | ⏳ |
| 角色等级为10 | 10 | 待测试 | ⏳ |
| 最后登录时间已更新 | 最近1分钟内 | 待测试 | ⏳ |
| 角色状态为1 | 1 | 待测试 | ⏳ |
| 日志记录存在 | 存在 | 待测试 | ⏳ |

### 测试状态
- 总体状态: ⏳ 待测试
- 通过步骤: 0/11
- 失败步骤: 0/11
- 测试结论: 待测试

## 问题记录

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 状态 | 修复建议 |
|--------|----------|----------|------|----------|
| - | - | - | - | - |

### 已知问题

| 问题ID | 问题描述 | 影响 | 临时方案 |
|--------|----------|------|----------|
| - | - | - | - |

## 注意事项

1. **测试数据隔离**: 每次测试前必须准备独立的测试数据
2. **角色状态**: 确保角色状态正确，同一账号只能有一个角色被选择
3. **时间更新**: 验证选择角色时是否更新最后登录时间
4. **数据验证**: 要验证数据库中的实际数据
5. **日志记录**: 详细记录测试过程和结果
6. **性能监控**: 记录每个步骤的执行时间
7. **资源清理**: 测试完成后必须清理所有测试数据
8. **异常处理**: 测试过程中要注意异常情况
9. **数据一致性**: 确保返回的数据与数据库数据一致
10. **边界测试**: 注意角色GUID、角色状态等边界情况

## 参考资源

### Java代码
- Controller: `src/main/java/com/dnfm/game/character/CharacterController.java`
- Service: `src/main/java/com/dnfm/game/character/service/CharacterService.java`
- Model: `src/main/java/com/dnfm/game/character/model/CharacterInfo.java`

### Protobuf定义
- 请求: `REQ_SELECT_CHARACTER`
- 响应: `RES_SELECT_CHARACTER`

### 数据库表
- t_account: 账号表
- t_character: 角色表

### 测试工具
- JUnit: https://junit.org/junit4/
- Mockito: https://site.mockito.org/
