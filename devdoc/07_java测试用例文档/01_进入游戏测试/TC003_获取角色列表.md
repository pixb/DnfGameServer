# TC003_获取角色列表

## 测试用例信息

| 项目 | 内容 |
|------|------|
| 测试用例ID | TC003 |
| 测试用例名称 | 获取角色列表 |
| 测试级别 | 3 |
| 测试类型 | 功能测试 |
| 优先级 | 高 |
| 测试人员 | AI Assistant |
| 创建日期 | 2026-02-17 |
| 更新日期 | 2026-02-17 |

## 测试目的

验证已登录玩家能获取到正确的角色列表，包括角色的所有基本信息。

## 测试前置条件

1. 游戏服务器已启动并正常运行
2. 数据库服务已启动并正常运行
3. 测试数据已准备（测试账号和角色已创建）

## 测试数据

### 输入数据
- authkey: 从登录响应中获取
- option: `1`（获取角色列表）

### 预期输出数据
- error: `0`（成功）
- charlist: 非空列表，包含所有角色信息

## 测试步骤

### 步骤1: 建立TCP连接
**操作内容**:
1. 创建TCP Socket连接
   - 服务器地址: 127.0.0.1
   - 服务器端口: 20001（根据application.properties配置）
   - 连接超时: 5000ms

2. 验证连接状态
   - 检查连接是否成功建立
   - 检查Socket是否可用

**预期结果**:
- 连接成功建立
- Socket状态为已连接

### 步骤2: 准备测试数据
**操作内容**:
1. 先执行登录获取authkey
   - 使用openid: `test_openid_003`
   - 获取authkey

2. 创建测试角色
   - 创建至少2个测试角色
   - 角色数据完整

**输入参数**:
```sql
-- 创建测试角色
INSERT INTO t_character (charguid, accountID, name, job, level, createTime, status) VALUES
(1001, 10003, 'TestPlayer1', 1, 10, NOW(), 1),
(1002, 10003, 'TestPlayer2', 2, 20, NOW(), 1);
```

**预期结果**:
- authkey获取成功
- 测试角色创建成功

### 步骤3: 构造角色信息请求
**操作内容**:
1. 创建REQ_CHARACTER_INFO对象
   - 设置authkey: 从登录响应中获取
   - 设置option: `1`
   - 设置charlist: null（获取所有角色）

2. 序列化请求对象
   - 使用jprotobuf的Codec进行序列化
   - 生成字节数组

**输入参数**:
```java
REQ_CHARACTER_INFO req = new REQ_CHARACTER_INFO();
req.setAuthkey(authKey);
req.setOption(1);
req.setCharlist(null);
```

**预期结果**:
- REQ_CHARACTER_INFO对象创建成功
- 序列化成功，生成字节数组

### 步骤4: 发送角色信息请求
**操作内容**:
1. 构造消息包
   - 消息ID: 根据MessageMeta注解（module=10103, cmd=0）
   - 消息长度: 序列化后的字节数组长度
   - 消息体: 序列化后的字节数组

2. 发送消息包
   - 通过Socket输出流发送
   - 确保数据完整发送

**预期结果**:
- 消息包构造成功
- 消息发送成功

### 步骤5: 接收角色信息响应
**操作内容**:
1. 接收响应数据
   - 从Socket输入流读取数据
   - 解析消息包（消息ID、消息长度、消息体）

2. 反序列化响应对象
   - 使用jprotobuf的Codec进行反序列化
   - 转换为RES_CHARACTER_INFO对象

**预期输出**:
- error: `0`（成功）
- charlist: 非空列表，包含所有角色信息

### 步骤6: 验证角色列表
**操作内容**:
1. 验证错误码
   - 检查error字段是否为0

2. 验证角色列表
   - 检查charlist是否非空
   - 检查角色数量是否正确

3. 验证角色信息
   - 检查每个角色的基本信息
   - 检查角色名称、职业、等级等

**预期结果**:
- error = 0
- charlist非空
- 角色数量正确
- 角色信息完整

### 步骤7: 数据库验证
**操作内容**:
1. 查询数据库
   - 查询t_character表
   - 验证角色数据

2. 验证角色数据
   - 检查角色是否存在
   - 检查角色信息是否匹配

**预期结果**:
- 数据库中角色数据正确
- 角色信息匹配

### 步骤8: 清理测试数据
**操作内容**:
1. 关闭Socket连接
2. 清理测试数据（可选）

**预期结果**:
- 连接正常关闭
- 测试数据清理完成

## 验证点

| 验证点 | 验证方法 | 预期结果 |
|--------|----------|----------|
| TCP连接建立 | 检查Socket状态 | 连接成功 |
| 角色信息请求发送 | 检查发送字节数 | 发送成功 |
| 角色信息响应接收 | 检查接收字节数 | 接收成功 |
| 错误码验证 | 检查error字段 | error = 0 |
| 角色列表验证 | 检查charlist非空 | charlist非空 |
| 角色数量验证 | 检查角色数量 | 角色数量正确 |
| 角色信息验证 | 检查角色信息 | 角色信息完整 |
| 数据库验证 | 查询t_character表 | 角色数据正确 |

## 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| TCP连接建立 | ⏳ 待测试 | |
| 角色信息请求发送 | ⏳ 待测试 | |
| 角色信息响应接收 | ⏳ 待测试 | |
| 错误码验证 | ⏳ 待测试 | |
| 角色列表验证 | ⏳ 待测试 | |
| 角色数量验证 | ⏳ 待测试 | |
| 角色信息验证 | ⏳ 待测试 | |
| 数据库验证 | ⏳ 待测试 | |

## 测试结论

| 项目 | 结果 |
|------|------|
| 测试状态 | ⏳ 待测试 |
| 通过/失败 | - |
| 执行时间 | - |
| 测试人员 | AI Assistant |
| 测试日期 | 2026-02-17 |

## 依赖关系

- 依赖: TC001（需要先登录获取authkey）
- 被依赖: TC004, TC005, TC006, TC007, TC008, TC009, TC010

## 备注

1. 本测试用例使用实际的Protobuf消息类：`com.dnfm.mina.protobuf.REQ_CHARACTER_INFO` 和 `com.dnfm.mina.protobuf.RES_CHARACTER_INFO`
2. 使用jprotobuf进行序列化和反序列化
3. 使用Apache MINA框架的客户端进行连接
4. 服务器端口根据application.properties配置为20001
5. 测试数据需要根据实际数据库表结构进行调整
6. 需要先执行TC001获取authkey

## 相关文件

- 测试代码: `TC003_获取角色列表.java`
- Protobuf消息: `com.dnfm.mina.protobuf.REQ_CHARACTER_INFO`, `com.dnfm.mina.protobuf.RES_CHARACTER_INFO`
- 配置文件: `application.properties`
- 数据库表: `t_account`, `t_character`
