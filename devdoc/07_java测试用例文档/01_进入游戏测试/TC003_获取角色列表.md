# TC003_获取角色列表

## 测试用例概述

| 项目 | 内容 |
|------|------|
| 测试用例ID | TC003 |
| 测试用例名称 | 获取角色列表 |
| 所属模块 | 进入游戏系统 |
| 测试类型 | 功能测试 |
| 优先级 | 高 |
| 预计执行时间 | 5分钟 |

## 测试目的

验证已登录玩家能获取到正确的角色列表，包括角色的所有基本信息。

## 前置条件

### 测试环境要求
1. Java服务端已启动
2. MySQL数据库已连接
3. 测试数据库已初始化
4. 日志记录已开启

### 测试数据准备
1. 测试账号已注册
   - openid: `test_openid_003`
   - 账号状态: 正常
   - 账号类型: 普通账号

2. 测试角色已创建（至少2个角色）
   - 角色GUID: 1001
   - 角色名称: TestPlayer1
   - 角色职业: 战士
   - 角色等级: 10
   - 角色状态: 正常

   - 角色GUID: 1002
   - 角色名称: TestPlayer2
   - 角色职业: 法师
   - 角色等级: 20
   - 角色状态: 正常

3. 角色装备已配置
   - 每个角色至少有1件装备
   - 装备数据完整

4. 角色背包已配置
   - 每个角色至少有5个物品
   - 背包数据完整

### 依赖服务状态
1. 认证服务正常
2. 数据库服务正常
3. 网络连接正常

## 测试步骤

### 步骤1: 准备测试环境
**操作内容**:
1. 检查Java服务端是否启动
   - 命令: `ps aux | grep java`
   - 预期: Java进程存在

2. 检查数据库连接
   - 命令: `mysql -u root -p -e "SHOW DATABASES;"`
   - 预期: 数据库列表正常

3. 准备测试账号和角色
   - 创建测试账号（如果不存在）
   - 创建测试角色（如果不存在）
   - 配置角色数据

**输入参数**:
```sql
-- 创建测试账号
INSERT INTO t_account (openid, accountID, createTime, status) VALUES ('test_openid_003', 10003, NOW(), 1);

-- 创建测试角色
INSERT INTO t_character (charguid, accountID, name, job, level, createTime, status) VALUES
(1001, 10003, 'TestPlayer1', 1, 10, NOW(), 1),
(1002, 10003, 'TestPlayer2', 2, 20, NOW(), 1);
```

**预期输出**:
- 服务端状态: 运行中
- 数据库状态: 连接正常
- 测试账号: 已创建
- 测试角色: 已创建（2个）

**实际输出**:
- 待测试

### 步骤2: 玩家登录获取authKey
**操作内容**:
1. 构造登录请求
   - openid: `test_openid_003`
   - 设备ID: `device_test_003`
   - 设备类型: Android
   - 客户端版本: 1.0.0

2. 发送登录请求
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

3. 接收登录响应
   - 验证错误码为0
   - 获取authKey
   - 获取accountID

**输入参数**:
```java
REQ_LOGIN req = new REQ_LOGIN();
req.setOpenid("test_openid_003");
req.setDeviceId("device_test_003");
req.setDeviceType(1);
req.setClientVersion("1.0.0");
```

**预期输出**:
- 错误码: 0
- authKey: 非空
- accountID: 10003

**实际输出**:
- 待测试

### 步骤3: 构造获取角色列表请求
**操作内容**:
1. 创建获取角色列表请求对象
   - 请求类型: REQ_GET_CHARACTER_LIST
   - 协议版本: 1.0

2. 设置请求参数
   - authKey: 从登录响应获取
   - accountID: 从登录响应获取

3. 序列化请求
   - 使用jprotobuf序列化
   - 编码格式: UTF-8
   - 压缩: 不压缩

**输入参数**:
```java
REQ_GET_CHARACTER_LIST req = new REQ_GET_CHARACTER_LIST();
req.setAuthKey(authKey);
req.setAccountID(accountID);
```

**预期输出**:
- 请求对象: 创建成功
- 序列化结果: 字节数组
- 序列化长度: > 0

**实际输出**:
- 待测试

### 步骤4: 发送获取角色列表请求
**操作内容**:
1. 建立TCP连接
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

2. 发送序列化后的请求
   - 发送方式: 同步发送
   - 发送超时: 10000ms
   - 重试次数: 3

3. 等待响应
   - 等待超时: 15000ms
   - 响应缓冲区大小: 4096

**输入参数**:
```java
Socket socket = new Socket("127.0.0.1", 8080);
OutputStream out = socket.getOutputStream();
out.write(reqBytes);
out.flush();
```

**预期输出**:
- 连接状态: 已连接
- 发送状态: 发送成功
- 接收状态: 收到响应

**实际输出**:
- 待测试

### 步骤5: 接收并解析响应
**操作内容**:
1. 接收响应数据
   - 读取方式: 循环读取
   - 每次读取大小: 1024字节
   - 总读取超时: 15000ms

2. 解析响应类型
   - 读取响应头: 4字节
   - 解析响应类型: RES_GET_CHARACTER_LIST
   - 验证响应类型正确

3. 反序列化响应
   - 使用jprotobuf反序列化
   - 解码格式: UTF-8
   - 验证数据完整性

**输入参数**:
```java
InputStream in = socket.getInputStream();
byte[] responseBytes = readFully(in);
RES_GET_CHARACTER_LIST res = RES_GET_CHARACTER_LIST.parseFrom(responseBytes);
```

**预期输出**:
- 响应类型: RES_GET_CHARACTER_LIST
- 反序列化结果: 对象创建成功
- 数据完整性: 无损坏

**实际输出**:
- 待测试

### 步骤6: 验证角色列表基本信息
**操作内容**:
1. 验证错误码
   - 检查字段: error
   - 预期值: 0
   - 说明: 0表示成功

2. 验证角色列表
   - 检查字段: characters
   - 预期值: 非空数组
   - 数组长度: 2

3. 验证角色数量
   - 预期值: 2
   - 说明: 与数据库中的角色数量一致

**输入参数**:
```java
assertEquals(0, res.getError());
assertNotNull(res.getCharacters());
assertEquals(2, res.getCharacters().size());
```

**预期输出**:
- 错误码: 0
- 角色列表: 非空
- 角色数量: 2

**实际输出**:
- 待测试

### 步骤7: 验证角色1信息
**操作内容**:
1. 获取角色1
   - 索引: 0
   - 验证角色不为null

2. 验证角色1基本信息
   - charguid: 1001
   - name: TestPlayer1
   - job: 1 (战士)
   - level: 10
   - status: 1 (正常)

3. 验证角色1时间信息
   - createTime: 非空
   - lastLoginTime: 非空

4. 验证角色1外观信息
   - face: 非空
   - hair: 非空
   - skin: 非空

**输入参数**:
```java
CharacterInfo char1 = res.getCharacters().get(0);
assertEquals(1001, char1.getCharguid());
assertEquals("TestPlayer1", char1.getName());
assertEquals(1, char1.getJob());
assertEquals(10, char1.getLevel());
assertEquals(1, char1.getStatus());
```

**预期输出**:
- charguid: 1001
- name: TestPlayer1
- job: 1
- level: 10
- status: 1
- createTime: 非空
- lastLoginTime: 非空

**实际输出**:
- 待测试

### 步骤8: 验证角色2信息
**操作内容**:
1. 获取角色2
   - 索引: 1
   - 验证角色不为null

2. 验证角色2基本信息
   - charguid: 1002
   - name: TestPlayer2
   - job: 2 (法师)
   - level: 20
   - status: 1 (正常)

3. 验证角色2时间信息
   - createTime: 非空
   - lastLoginTime: 非空

4. 验证角色2外观信息
   - face: 非空
   - hair: 非空
   - skin: 非空

**输入参数**:
```java
CharacterInfo char2 = res.getCharacters().get(1);
assertEquals(1002, char2.getCharguid());
assertEquals("TestPlayer2", char2.getName());
assertEquals(2, char2.getJob());
assertEquals(20, char2.getLevel());
assertEquals(1, char2.getStatus());
```

**预期输出**:
- charguid: 1002
- name: TestPlayer2
- job: 2
- level: 20
- status: 1
- createTime: 非空
- lastLoginTime: 非空

**实际输出**:
- 待测试

### 步骤9: 验证角色装备信息
**操作内容**:
1. 验证角色1装备
   - 检查字段: equipments
   - 预期值: 非空数组
   - 装备数量: >= 1

2. 验证角色2装备
   - 检查字段: equipments
   - 预期值: 非空数组
   - 装备数量: >= 1

3. 验证装备数据完整性
   - 每个装备都有guid
   - 每个装备都有index
   - 每个装备都有type

**输入参数**:
```java
assertNotNull(char1.getEquipments());
assertTrue(char1.getEquipments().size() >= 1);
assertNotNull(char2.getEquipments());
assertTrue(char2.getEquipments().size() >= 1);
```

**预期输出**:
- 角色1装备: 非空，>= 1件
- 角色2装备: 非空，>= 1件
- 装备数据: 完整

**实际输出**:
- 待测试

### 步骤10: 验证角色背包信息
**操作内容**:
1. 验证角色1背包
   - 检查字段: bag
   - 预期值: 非空
   - 物品数量: >= 5

2. 验证角色2背包
   - 检查字段: bag
   - 预期值: 非空
   - 物品数量: >= 5

3. 验证背包数据完整性
   - 每个物品都有guid
   - 每个物品都有index
   - 每个物品都有count

**输入参数**:
```java
assertNotNull(char1.getBag());
assertTrue(char1.getBag().getItems().size() >= 5);
assertNotNull(char2.getBag());
assertTrue(char2.getBag().getItems().size() >= 5);
```

**预期输出**:
- 角色1背包: 非空，>= 5个物品
- 角色2背包: 非空，>= 5个物品
- 背包数据: 完整

**实际输出**:
- 待测试

### 步骤11: 验证数据库记录
**操作内容**:
1. 查询角色记录
   - 表名: t_character
   - 查询条件: accountID = 10003
   - 排序: 按charguid升序

2. 验证角色数量
   - 预期值: 2
   - 说明: 与返回的角色数量一致

3. 验证角色信息
   - 验证charguid: 1001, 1002
   - 验证name: TestPlayer1, TestPlayer2
   - 验证job: 1, 2
   - 验证level: 10, 20

**输入参数**:
```sql
SELECT * FROM t_character WHERE accountID = 10003 ORDER BY charguid;
```

**预期输出**:
- 角色记录: 2条
- 角色信息: 与返回一致

**实际输出**:
- 待测试

### 步骤12: 清理测试数据
**操作内容**:
1. 删除角色记录
   - 表名: t_character
   - 删除条件: accountID = 10003

2. 删除角色装备
   - 表名: t_character_equipment
   - 删除条件: charguid IN (1001, 1002)

3. 删除角色背包
   - 表名: t_character_bag
   - 删除条件: charguid IN (1001, 1002)

4. 删除账号记录
   - 表名: t_account
   - 删除条件: accountID = 10003

5. 关闭连接
   - 关闭Socket连接
   - 释放资源
   - 记录日志

**输入参数**:
```sql
DELETE FROM t_character_bag WHERE charguid IN (1001, 1002);
DELETE FROM t_character_equipment WHERE charguid IN (1001, 1002);
DELETE FROM t_character WHERE accountID = 10003;
DELETE FROM t_account WHERE accountID = 10003;
```

**预期输出**:
- 角色记录: 已删除
- 装备记录: 已删除
- 背包记录: 已删除
- 账号记录: 已删除
- 连接状态: 已关闭
- 日志记录: 已记录

**实际输出**:
- 待测试

## 预期结果

### 成功情况
1. 登录请求发送成功
2. 收到登录响应，获取到authKey
3. 获取角色列表请求发送成功
4. 收到角色列表响应
5. 错误码为0（成功）
6. 角色列表非空，数量为2
7. 角色1信息完整且正确
8. 角色2信息完整且正确
9. 角色装备信息完整
10. 角色背包信息完整
11. 数据库记录与返回一致

### 失败情况
1. 连接失败
2. 请求超时
3. 响应解析失败
4. 错误码非0
5. 角色列表为空
6. 角色数量不正确
7. 角色信息不完整
8. 装备信息缺失
9. 背包信息缺失

### 边界情况
1. 角色数量为0
2. 角色数量达到上限
3. 角色名称为空
4. 角色等级为0
5. 角色等级达到最大值
6. 装备数量为0
7. 背包物品数量为0
8. 背包物品数量达到上限

## 实际结果

### 测试执行记录

| 项目 | 内容 |
|------|------|
| 测试日期 | 待测试 |
| 测试人员 | 待测试 |
| 测试环境 | 待测试 |
| 执行时间 | 待测试 |

### 测试步骤执行情况

| 步骤 | 状态 | 执行时间 | 备注 |
|------|------|---------|------|
| 步骤1: 准备测试环境 | ⏳ 待执行 | - | - |
| 步骤2: 玩家登录获取authKey | ⏳ 待执行 | - | - |
| 步骤3: 构造获取角色列表请求 | ⏳ 待执行 | - | - |
| 步骤4: 发送获取角色列表请求 | ⏳ 待执行 | - | - |
| 步骤5: 接收并解析响应 | ⏳ 待执行 | - | - |
| 步骤6: 验证角色列表基本信息 | ⏳ 待执行 | - | - |
| 步骤7: 验证角色1信息 | ⏳ 待执行 | - | - |
| 步骤8: 验证角色2信息 | ⏳ 待执行 | - | - |
| 步骤9: 验证角色装备信息 | ⏳ 待执行 | - | - |
| 步骤10: 验证角色背包信息 | ⏳ 待执行 | - | - |
| 步骤11: 验证数据库记录 | ⏳ 待执行 | - | - |
| 步骤12: 清理测试数据 | ⏳ 待执行 | - | - |

### 测试结果验证

| 验证项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 错误码为0 | 0 | 待测试 | ⏳ |
| 角色列表非空 | 非空 | 待测试 | ⏳ |
| 角色数量为2 | 2 | 待测试 | ⏳ |
| 角色1charguid | 1001 | 待测试 | ⏳ |
| 角色1name | TestPlayer1 | 待测试 | ⏳ |
| 角色1job | 1 | 待测试 | ⏳ |
| 角色1level | 10 | 待测试 | ⏳ |
| 角色2charguid | 1002 | 待测试 | ⏳ |
| 角色2name | TestPlayer2 | 待测试 | ⏳ |
| 角色2job | 2 | 待测试 | ⏳ |
| 角色2level | 20 | 待测试 | ⏳ |
| 装备信息完整 | 完整 | 待测试 | ⏳ |
| 背包信息完整 | 完整 | 待测试 | ⏳ |

### 测试状态
- 总体状态: ⏳ 待测试
- 通过步骤: 0/12
- 失败步骤: 0/12
- 测试结论: 待测试

## 问题记录

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 状态 | 修复建议 |
|--------|----------|----------|------|----------|
| - | - | - | - | - |

### 已知问题

| 问题ID | 问题描述 | 影响 | 临时方案 |
|--------|----------|------|----------|
| - | - | - | - |

## 注意事项

1. **测试数据隔离**: 每次测试前必须准备独立的测试数据
2. **角色数量**: 确保测试账号有足够的角色（至少2个）
3. **角色数据**: 确保角色数据完整，包括装备和背包
4. **数据验证**: 要验证数据库中的实际数据
5. **日志记录**: 详细记录测试过程和结果
6. **性能监控**: 记录每个步骤的执行时间
7. **资源清理**: 测试完成后必须清理所有测试数据
8. **异常处理**: 测试过程中要注意异常情况
9. **数据一致性**: 确保返回的数据与数据库数据一致
10. **边界测试**: 注意角色数量、装备数量、背包物品数量的边界情况

## 参考资源

### Java代码
- Controller: `src/main/java/com/dnfm/game/character/CharacterController.java`
- Service: `src/main/java/com/dnfm/game/character/service/CharacterService.java`
- Model: `src/main/java/com/dnfm/game/character/model/CharacterInfo.java`

### Protobuf定义
- 请求: `REQ_GET_CHARACTER_LIST`
- 响应: `RES_GET_CHARACTER_LIST`

### 数据库表
- t_account: 账号表
- t_character: 角色表
- t_character_equipment: 角色装备表
- t_character_bag: 角色背包表

### 测试工具
- JUnit: https://junit.org/junit4/
- Mockito: https://site.mockito.org/
