# TC004_获取角色列表_无角色

## 测试用例概述

| 项目 | 内容 |
|------|------|
| 测试用例ID | TC004 |
| 测试用例名称 | 获取角色列表_无角色 |
| 所属模块 | 进入游戏系统 |
| 测试类型 | 边界测试 |
| 优先级 | 高 |
| 预计执行时间 | 3分钟 |

## 测试目的

验证没有角色的玩家获取角色列表时返回空列表，并且不报错。

## 前置条件

### 测试环境要求
1. Java服务端已启动
2. MySQL数据库已连接
3. 测试数据库已初始化
4. 日志记录已开启

### 测试数据准备
1. 测试账号已注册
   - openid: `test_openid_004`
   - 账号状态: 正常
   - 账号类型: 普通账号

2. 确保测试账号没有角色
   - 检查数据库中不存在该账号的角色
   - 如果存在则删除

### 依赖服务状态
1. 认证服务正常
2. 数据库服务正常
3. 网络连接正常

## 测试步骤

### 步骤1: 准备测试环境
**操作内容**:
1. 检查Java服务端是否启动
   - 命令: `ps aux | grep java`
   - 预期: Java进程存在

2. 检查数据库连接
   - 命令: `mysql -u root -p -e "SHOW DATABASES;"`
   - 预期: 数据库列表正常

3. 准备测试账号
   - 创建测试账号（如果不存在）
   - 确保账号没有角色

**输入参数**:
```sql
-- 创建测试账号
INSERT INTO t_account (openid, accountID, createTime, status) VALUES ('test_openid_004', 10004, NOW(), 1);

-- 删除该账号的所有角色
DELETE FROM t_character WHERE accountID = 10004;
```

**预期输出**:
- 服务端状态: 运行中
- 数据库状态: 连接正常
- 测试账号: 已创建
- 测试角色: 无

**实际输出**:
- 待测试

### 步骤2: 玩家登录获取authKey
**操作内容**:
1. 构造登录请求
   - openid: `test_openid_004`
   - 设备ID: `device_test_004`
   - 设备类型: Android
   - 客户端版本: 1.0.0

2. 发送登录请求
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

3. 接收登录响应
   - 验证错误码为0
   - 获取authKey
   - 获取accountID

**输入参数**:
```java
REQ_LOGIN req = new REQ_LOGIN();
req.setOpenid("test_openid_004");
req.setDeviceId("device_test_004");
req.setDeviceType(1);
req.setClientVersion("1.0.0");
```

**预期输出**:
- 错误码: 0
- authKey: 非空
- accountID: 10004

**实际输出**:
- 待测试

### 步骤3: 构造获取角色列表请求
**操作内容**:
1. 创建获取角色列表请求对象
   - 请求类型: REQ_GET_CHARACTER_LIST
   - 协议版本: 1.0

2. 设置请求参数
   - authKey: 从登录响应获取
   - accountID: 从登录响应获取

3. 序列化请求
   - 使用jprotobuf序列化
   - 编码格式: UTF-8
   - 压缩: 不压缩

**输入参数**:
```java
REQ_GET_CHARACTER_LIST req = new REQ_GET_CHARACTER_LIST();
req.setAuthKey(authKey);
req.setAccountID(accountID);
```

**预期输出**:
- 请求对象: 创建成功
- 序列化结果: 字节数组
- 序列化长度: > 0

**实际输出**:
- 待测试

### 步骤4: 发送获取角色列表请求
**操作内容**:
1. 建立TCP连接
   - 服务器地址: 127.0.0.1
   - 服务器端口: 8080
   - 连接超时: 5000ms

2. 发送序列化后的请求
   - 发送方式: 同步发送
   - 发送超时: 10000ms
   - 重试次数: 3

3. 等待响应
   - 等待超时: 15000ms
   - 响应缓冲区大小: 4096

**输入参数**:
```java
Socket socket = new Socket("127.0.0.1", 8080);
OutputStream out = socket.getOutputStream();
out.write(reqBytes);
out.flush();
```

**预期输出**:
- 连接状态: 已连接
- 发送状态: 发送成功
- 接收状态: 收到响应

**实际输出**:
- 待测试

### 步骤5: 接收并解析响应
**操作内容**:
1. 接收响应数据
   - 读取方式: 循环读取
   - 每次读取大小: 1024字节
   - 总读取超时: 15000ms

2. 解析响应类型
   - 读取响应头: 4字节
   - 解析响应类型: RES_GET_CHARACTER_LIST
   - 验证响应类型正确

3. 反序列化响应
   - 使用jprotobuf反序列化
   - 解码格式: UTF-8
   - 验证数据完整性

**输入参数**:
```java
InputStream in = socket.getInputStream();
byte[] responseBytes = readFully(in);
RES_GET_CHARACTER_LIST res = RES_GET_CHARACTER_LIST.parseFrom(responseBytes);
```

**预期输出**:
- 响应类型: RES_GET_CHARACTER_LIST
- 反序列化结果: 对象创建成功
- 数据完整性: 无损坏

**实际输出**:
- 待测试

### 步骤6: 验证角色列表为空
**操作内容**:
1. 验证错误码
   - 检查字段: error
   - 预期值: 0
   - 说明: 0表示成功，即使没有角色也是成功的

2. 验证角色列表
   - 检查字段: characters
   - 预期值: 非空数组
   - 数组长度: 0

3. 验证角色数量
   - 预期值: 0
   - 说明: 与数据库中的角色数量一致

**输入参数**:
```java
assertEquals(0, res.getError());
assertNotNull(res.getCharacters());
assertEquals(0, res.getCharacters().size());
```

**预期输出**:
- 错误码: 0
- 角色列表: 非空
- 角色数量: 0

**实际输出**:
- 待测试

### 步骤7: 验证数据库无角色记录
**操作内容**:
1. 查询角色记录
   - 表名: t_character
   - 查询条件: accountID = 10004
   - 排序: 按charguid升序

2. 验证角色数量
   - 预期值: 0
   - 说明: 与返回的角色数量一致

**输入参数**:
```sql
SELECT COUNT(*) FROM t_character WHERE accountID = 10004;
```

**预期输出**:
- 角色记录: 0条
- 说明: 确认数据库中确实没有角色

**实际输出**:
- 待测试

### 步骤8: 验证响应数据结构
**操作内容**:
1. 验证响应对象不为null
   - 预期值: 不为null
   - 说明: 响应对象应该存在

2. 验证characters字段不为null
   - 预期值: 不为null
   - 说明: 即使没有角色，数组对象也应该存在

3. 验证characters为空数组
   - 预期值: 空数组
   - 说明: 数组长度为0

**输入参数**:
```java
assertNotNull(res);
assertNotNull(res.getCharacters());
assertTrue(res.getCharacters().isEmpty());
```

**预期输出**:
- 响应对象: 不为null
- characters字段: 不为null
- characters数组: 空

**实际输出**:
- 待测试

### 步骤9: 验证日志记录
**操作内容**:
1. 检查服务器日志
   - 日志文件: logs/game.log
   - 搜索关键字: test_openid_004
   - 验证日志级别: INFO

2. 验证日志内容
   - 应该记录获取角色列表事件
   - 应该记录角色数量为0
   - 不应该有错误日志

**输入参数**:
```bash
grep "test_openid_004" logs/game.log | grep "get character list"
```

**预期输出**:
- 日志记录: 存在
- 日志级别: INFO
- 日志内容: 包含角色数量为0的信息
- 错误日志: 不存在

**实际输出**:
- 待测试

### 步骤10: 清理测试数据
**操作内容**:
1. 删除角色记录
   - 表名: t_character
   - 删除条件: accountID = 10004
   - 预期: 0条记录被删除

2. 删除账号记录
   - 表名: t_account
   - 删除条件: accountID = 10004

3. 关闭连接
   - 关闭Socket连接
   - 释放资源
   - 记录日志

**输入参数**:
```sql
DELETE FROM t_character WHERE accountID = 10004;
DELETE FROM t_account WHERE accountID = 10004;
```

**预期输出**:
- 角色记录: 0条被删除
- 账号记录: 已删除
- 连接状态: 已关闭
- 日志记录: 已记录

**实际输出**:
- 待测试

## 预期结果

### 成功情况
1. 登录请求发送成功
2. 收到登录响应，获取到authKey
3. 获取角色列表请求发送成功
4. 收到角色列表响应
5. 错误码为0（成功）
6. 角色列表非空（数组对象存在）
7. 角色数量为0
8. 数据库无角色记录
9. 响应数据结构正确
10. 日志记录了获取角色列表事件

### 失败情况
1. 连接失败
2. 请求超时
3. 响应解析失败
4. 错误码非0
5. 角色列表为null（应该返回空数组）
6. 角色数量不为0
7. 数据库有角色记录

### 边界情况
1. 角色数量为0（当前测试）
2. 角色数量达到上限
3. 角色列表字段为null
4. 角色列表字段不存在
5. 数据库连接异常
6. 网络延迟
7. 网络中断

## 实际结果

### 测试执行记录

| 项目 | 内容 |
|------|------|
| 测试日期 | 待测试 |
| 测试人员 | 待测试 |
| 测试环境 | 待测试 |
| 执行时间 | 待测试 |

### 测试步骤执行情况

| 步骤 | 状态 | 执行时间 | 备注 |
|------|------|---------|------|
| 步骤1: 准备测试环境 | ⏳ 待执行 | - | - |
| 步骤2: 玩家登录获取authKey | ⏳ 待执行 | - | - |
| 步骤3: 构造获取角色列表请求 | ⏳ 待执行 | - | - |
| 步骤4: 发送获取角色列表请求 | ⏳ 待执行 | - | - |
| 步骤5: 接收并解析响应 | ⏳ 待执行 | - | - |
| 步骤6: 验证角色列表为空 | ⏳ 待执行 | - | - |
| 步骤7: 验证数据库无角色记录 | ⏳ 待执行 | - | - |
| 步骤8: 验证响应数据结构 | ⏳ 待执行 | - | - |
| 步骤9: 验证日志记录 | ⏳ 待执行 | - | - |
| 步骤10: 清理测试数据 | ⏳ 待执行 | - | - |

### 测试结果验证

| 验证项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 错误码为0 | 0 | 待测试 | ⏳ |
| 角色列表非空 | 非空 | 待测试 | ⏳ |
| 角色数量为0 | 0 | 待测试 | ⏳ |
| 数据库角色记录为0 | 0 | 待测试 | ⏳ |
| 响应对象不为null | 不为null | 待测试 | ⏳ |
| characters字段不为null | 不为null | 待测试 | ⏳ |
| characters数组为空 | 空 | 待测试 | ⏳ |
| 日志记录存在 | 存在 | 待测试 | ⏳ |

### 测试状态
- 总体状态: ⏳ 待测试
- 通过步骤: 0/10
- 失败步骤: 0/10
- 测试结论: 待测试

## 问题记录

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 状态 | 修复建议 |
|--------|----------|----------|------|----------|
| - | - | - | - | - |

### 已知问题

| 问题ID | 问题描述 | 影响 | 临时方案 |
|--------|----------|------|----------|
| - | - | - | - |

## 注意事项

1. **测试数据隔离**: 确保测试账号没有角色
2. **空数组处理**: 验证返回的是空数组而不是null
3. **数据验证**: 要验证数据库中的实际数据
4. **日志记录**: 详细记录测试过程和结果
5. **性能监控**: 记录每个步骤的执行时间
6. **资源清理**: 测试完成后必须清理所有测试数据
7. **异常处理**: 测试过程中要注意异常情况
8. **边界测试**: 注意空数组、null值等边界情况
9. **数据一致性**: 确保返回的数据与数据库数据一致
10. **错误处理**: 验证即使没有角色也不应该报错

## 参考资源

### Java代码
- Controller: `src/main/java/com/dnfm/game/character/CharacterController.java`
- Service: `src/main/java/com/dnfm/game/character/service/CharacterService.java`
- Model: `src/main/java/com/dnfm/game/character/model/CharacterInfo.java`

### Protobuf定义
- 请求: `REQ_GET_CHARACTER_LIST`
- 响应: `RES_GET_CHARACTER_LIST`

### 数据库表
- t_account: 账号表
- t_character: 角色表

### 测试工具
- JUnit: https://junit.org/junit4/
- Mockito: https://site.mockito.org/
