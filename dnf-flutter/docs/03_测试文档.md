# DNF Flutter客户端测试文档

## 测试概述

**测试框架**: Flutter Test
**测试类型**: 单元测试、Widget测试、集成测试、端到端测试
**测试覆盖率目标**: 80%+

## 测试环境

### 1. 测试依赖

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  
  # 测试框架
  mockito: ^5.4.0
  build_runner: ^2.4.0
  flutter_lints: ^3.0.0
  
  # 网络测试
  mock_web_socket_channel: ^0.1.0
```

### 2. 测试配置

```yaml
# analysis_options.yaml
analyzer:
  exclude:
    - "**/*.g.dart"
    - "**/*.mocks.dart"
```

## 测试结构

```
tests/
├── unit/                       # 单元测试
│   ├── models/
│   │   ├── player_test.dart
│   │   ├── skill_test.dart
│   │   └── item_test.dart
│   ├── network/
│   │   ├── game_client_test.dart
│   │   ├── message_handler_test.dart
│   │   └── sync_manager_test.dart
│   ├── game/
│   │   ├── components/
│   │   │   ├── fighter_test.dart
│   │   │   └── effect_test.dart
│   │   └── systems/
│   │       ├── combat_test.dart
│   │       └── physics_test.dart
│   └── utils/
│       ├── constants_test.dart
│       └── logger_test.dart
├── widget/                     # Widget测试
│   ├── screens/
│   │   ├── login_test.dart
│   │   ├── character_test.dart
│   │   └── room_test.dart
│   └── widgets/
│       ├── button_test.dart
│       └── health_bar_test.dart
├── integration/                # 集成测试
│   ├── login_flow_test.dart
│   ├── game_flow_test.dart
│   └── network_flow_test.dart
└── e2e/                       # 端到端测试
    ├── full_game_test.dart
    └── multiplayer_test.dart
```

## 单元测试

### 1. 模型测试

```dart
// tests/unit/models/player_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:dnf_game/models/player.dart';

void main() {
  group('Player', () {
    late Player player;
    
    setUp(() {
      player = Player(
        id: 'player_1',
        name: 'TestPlayer',
        level: 10,
        hp: 100,
      );
    });
    
    test('创建玩家时应该正确初始化属性', () {
      expect(player.id, 'player_1');
      expect(player.name, 'TestPlayer');
      expect(player.level, 10);
      expect(player.hp, 100);
    });
    
    test('玩家受到伤害时HP应该减少', () {
      player.takeDamage(20);
      expect(player.hp, 80);
    });
    
    test('玩家HP小于等于0时应该死亡', () {
      player.takeDamage(100);
      expect(player.isDead, true);
    });
    
    test('玩家升级时等级应该增加', () {
      player.levelUp();
      expect(player.level, 11);
    });
  });
}
```

### 2. 网络测试

```dart
// tests/unit/network/game_client_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:mock_web_socket_channel/mock_web_socket_channel.dart';
import 'package:dnf_game/network/game_client.dart';

void main() {
  group('GameClient', () {
    late GameClient client;
    late MockWebSocketChannel mockChannel;
    
    setUp(() {
      mockChannel = MockWebSocketChannel();
      client = GameClient(channel: mockChannel);
    });
    
    test('连接服务器时应该发送连接消息', () {
      client.connect('ws://localhost:8080');
      
      verify(mockChannel.sink.add(any)).called(1);
    });
    
    test('发送移动消息时应该正确格式化', () {
      client.sendMove(Vector2(100, 200));
      
      final captured = verify(mockChannel.sink.add(captureAny)).captured.single;
      final message = jsonDecode(captured as String);
      
      expect(message['type'], 'move');
      expect(message['data']['x'], 100);
      expect(message['data']['y'], 200);
    });
    
    test('接收消息时应该调用对应的处理器', () {
      final message = {
        'type': 'move',
        'playerId': 'player_1',
        'data': {'x': 100, 'y': 200}
      };
      
      mockChannel.sink.add(jsonEncode(message));
      
      // 验证处理器被调用
    });
  });
}
```

### 3. 游戏组件测试

```dart
// tests/unit/game/components/fighter_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:flame_test/flame_test.dart';
import 'package:dnf_game/game/components/fighter.dart';

void main() {
  group('FighterComponent', () {
    late FlameTest game;
    late Fighter fighter;
    
    setUp(() async {
      game = FlameTest();
      await game.setUp();
      
      fighter = Fighter();
      game.add(fighter);
    });
    
    tearDown(() {
      game.remove(fighter);
    });
    
    test('创建战士时应该正确初始化', () {
      expect(fighter.hp, 100);
      expect(fighter.maxHp, 100);
      expect(fighter.position, Vector2.zero());
    });
    
    test('战士移动时位置应该更新', () {
      final initialPosition = fighter.position.clone();
      fighter.move(Vector2(10, 0));
      
      expect(fighter.position.x, initialPosition.x + 10);
      expect(fighter.position.y, initialPosition.y);
    });
    
    test('战士攻击时应该造成伤害', () {
      final target = Fighter();
      game.add(target);
      
      fighter.attack(target);
      
      expect(target.hp, lessThan(100));
    });
  });
}
```

## Widget测试

### 1. 页面测试

```dart
// tests/widget/screens/login_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:dnf_game/ui/screens/login.dart';

void main() {
  group('LoginPage', () {
    testWidgets('应该显示登录表单', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: LoginPage(),
        ),
      );
      
      expect(find.text('登录'), findsOneWidget);
      expect(find.byType(TextField), findsNWidgets(2));
      expect(find.byType(ElevatedButton), findsOneWidget);
    });
    
    testWidgets('点击登录按钮时应该调用登录方法', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: LoginPage(),
        ),
      );
      
      await tester.enterText(find.byKey(Key('username')), 'testuser');
      await tester.enterText(find.byKey(Key('password')), 'password');
      
      await tester.tap(find.byType(ElevatedButton));
      await tester.pump();
      
      // 验证登录方法被调用
    });
    
    testWidgets('用户名或密码为空时应该显示错误', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: LoginPage(),
        ),
      );
      
      await tester.tap(find.byType(ElevatedButton));
      await tester.pump();
      
      expect(find.text('请输入用户名和密码'), findsOneWidget);
    });
  });
}
```

### 2. 组件测试

```dart
// tests/widget/widgets/health_bar_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:dnf_game/ui/widgets/health_bar.dart';

void main() {
  group('HealthBar', () {
    testWidgets('HP为100时应该显示满血条', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HealthBar(
              currentHp: 100,
              maxHp: 100,
            ),
          ),
        ),
      );
      
      final container = tester.widget<Container>(find.byType(Container));
      expect(container.color, Colors.green);
    });
    
    testWidgets('HP为50时应该显示半血条', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HealthBar(
              currentHp: 50,
              maxHp: 100,
            ),
          ),
        ),
      );
      
      final container = tester.widget<Container>(find.byType(Container));
      expect(container.color, Colors.yellow);
    });
    
    testWidgets('HP为0时应该显示空血条', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HealthBar(
              currentHp: 0,
              maxHp: 100,
            ),
          ),
        ),
      );
      
      final container = tester.widget<Container>(find.byType(Container));
      expect(container.color, Colors.red);
    });
  });
}
```

## 集成测试

### 1. 登录流程测试

```dart
// tests/integration/login_flow_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgets('登录流程测试', (WidgetTester tester) async {
    await tester.pumpWidget(MyApp());
    
    // 测试登录流程
    await tester.tap(find.text('登录'));
    await tester.enterText(find.byKey(Key('username')), 'testuser');
    await tester.enterText(find.byKey(Key('password')), 'password');
    await tester.tap(find.text('登录'));
    
    await tester.pumpAndSettle();
    
    // 验证进入角色选择页面
    expect(find.text('选择角色'), findsOneWidget);
  });
}
```

### 2. 游戏流程测试

```dart
// tests/integration/game_flow_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgets('游戏流程测试', (WidgetTester tester) async {
    await tester.pumpWidget(MyApp());
    
    // 1. 登录
    await performLogin(tester);
    
    // 2. 选择角色
    await selectCharacter(tester);
    
    // 3. 进入游戏
    await enterGame(tester);
    
    // 4. 验证游戏界面
    expect(find.byType(GameWidget), findsOneWidget);
  });
  
  Future<void> performLogin(WidgetTester tester) async {
    await tester.tap(find.text('登录'));
    await tester.enterText(find.byKey(Key('username')), 'testuser');
    await tester.enterText(find.byKey(Key('password')), 'password');
    await tester.tap(find.text('登录'));
    await tester.pumpAndSettle();
  }
  
  Future<void> selectCharacter(WidgetTester tester) async {
    await tester.tap(find.text('战士'));
    await tester.tap(find.text('开始游戏'));
    await tester.pumpAndSettle();
  }
  
  Future<void> enterGame(WidgetTester tester) async {
    await tester.pumpAndSettle(Duration(seconds: 2));
  }
}
```

## 端到端测试

### 1. 完整游戏测试

```dart
// tests/e2e/full_game_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgets('完整游戏流程测试', (WidgetTester tester) async {
    await tester.pumpWidget(MyApp());
    
    // 1. 登录
    await tester.tap(find.text('登录'));
    await tester.enterText(find.byKey(Key('username')), 'testuser');
    await tester.enterText(find.byKey(Key('password')), 'password');
    await tester.tap(find.text('登录'));
    await tester.pumpAndSettle();
    
    // 2. 选择角色
    expect(find.text('选择角色'), findsOneWidget);
    await tester.tap(find.text('战士'));
    await tester.tap(find.text('开始游戏'));
    await tester.pumpAndSettle();
    
    // 3. 进入游戏
    expect(find.byType(GameWidget), findsOneWidget);
    await tester.pumpAndSettle(Duration(seconds: 3));
    
    // 4. 测试移动
    await tester.sendKeyEvent(LogicalKeyboardKey.arrowRight);
    await tester.pump(Duration(milliseconds: 100));
    
    // 5. 测试攻击
    await tester.sendKeyEvent(LogicalKeyboardKey.space);
    await tester.pump(Duration(milliseconds: 100));
    
    // 6. 验证UI更新
    expect(find.byType(HealthBar), findsOneWidget);
  });
}
```

### 2. 多人对战测试

```dart
// tests/e2e/multiplayer_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgets('多人对战测试', (WidgetTester tester) async {
    await tester.pumpWidget(MyApp());
    
    // 模拟两个玩家
    final player1 = await createPlayer(tester, 'player1');
    final player2 = await createPlayer(tester, 'player2');
    
    // 玩家1移动
    await movePlayer(tester, player1, Vector2(100, 0));
    
    // 验证玩家2能看到玩家1的移动
    await tester.pump(Duration(milliseconds: 200));
    
    // 玩家2攻击
    await attackPlayer(tester, player2, player1);
    
    // 验证玩家1受到伤害
    await tester.pump(Duration(milliseconds: 200));
    expect(find.text('HP: 80'), findsOneWidget);
  });
  
  Future<String> createPlayer(WidgetTester tester, String name) async {
    await tester.tap(find.text('登录'));
    await tester.enterText(find.byKey(Key('username')), name);
    await tester.enterText(find.byKey(Key('password')), 'password');
    await tester.tap(find.text('登录'));
    await tester.pumpAndSettle();
    
    return name;
  }
  
  Future<void> movePlayer(WidgetTester tester, String player, Vector2 position) async {
    // 模拟移动输入
    await tester.sendKeyEvent(LogicalKeyboardKey.arrowRight);
    await tester.pump(Duration(milliseconds: 100));
  }
  
  Future<void> attackPlayer(WidgetTester tester, String attacker, String target) async {
    // 模拟攻击输入
    await tester.sendKeyEvent(LogicalKeyboardKey.space);
    await tester.pump(Duration(milliseconds: 100));
  }
}
```

## 测试运行

### 1. 运行所有测试

```bash
# 运行所有测试
flutter test

# 运行特定测试文件
flutter test tests/unit/models/player_test.dart

# 运行特定测试组
flutter test --name="Player"

# 运行带标签的测试
flutter test --tags="unit"
```

### 2. 运行集成测试

```bash
# 运行集成测试
flutter test integration_test/

# 运行特定集成测试
flutter test integration_test/login_flow_test.dart
```

### 3. 运行端到端测试

```bash
# 运行端到端测试
flutter drive --target=test_driver/app.dart

# 运行特定端到端测试
flutter drive --target=test_driver/app.dart test/e2e/full_game_test.dart
```

### 4. 生成覆盖率报告

```bash
# 运行测试并生成覆盖率
flutter test --coverage

# 生成HTML覆盖率报告
genhtml coverage/lcov.info -o coverage/html

# 查看覆盖率
open coverage/html/index.html
```

## 测试最佳实践

### 1. 测试命名

```dart
// 测试文件命名: *_test.dart
// player_test.dart

// 测试组命名: 描述性名称
group('Player', () {});

// 测试方法命名: should_期望行为
test('should_create_player_with_correct_attributes', () {});

// Widget测试命名: 应该显示/应该执行
testWidgets('should_display_login_form', (tester) async {});
```

### 2. 测试隔离

```dart
// 每个测试独立运行
test('test1', () {
  final player = Player();
  // 测试逻辑
});

// 使用setUp和tearDown
late Player player;

setUp(() {
  player = Player();
});

tearDown(() {
  player.dispose();
});
```

### 3. Mock使用

```dart
// 使用Mockito创建Mock
class MockGameClient extends Mock implements GameClient {}

test('应该调用游戏客户端', () {
  final mockClient = MockGameClient();
  final viewModel = GameViewModel(client: mockClient);
  
  viewModel.login('username', 'password');
  
  verify(mockClient.connect(any)).called(1);
});
```

### 4. 异步测试

```dart
// 使用async/await处理异步
testWidgets('异步加载测试', (tester) async {
  await tester.pumpWidget(MyWidget());
  
  await tester.pumpAndSettle();
  
  expect(find.text('加载完成'), findsOneWidget);
});

// 使用expectLater验证异步
test('异步操作测试', () async {
  final future = Future.delayed(Duration(seconds: 1));
  
  await expectLater(future, completes);
});
```

## 测试覆盖率

### 覆盖率目标

| 模块 | 目标覆盖率 | 当前覆盖率 |
|------|-----------|-----------|
| models | 90% | 0% |
| network | 85% | 0% |
| game/components | 80% | 0% |
| game/systems | 75% | 0% |
| ui/screens | 70% | 0% |
| ui/widgets | 80% | 0% |
| **总计** | **80%** | **0%** |

### 覆盖率提升

```dart
// 为未覆盖的代码添加测试
// 1. 运行覆盖率测试
flutter test --coverage

// 2. 查看覆盖率报告
open coverage/html/index.html

// 3. 找到未覆盖的代码
// 4. 编写测试用例
// 5. 重新运行覆盖率测试
```

## 测试CI/CD

### GitHub Actions配置

```yaml
# .github/workflows/test.yml
name: Flutter Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run tests
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
```

## 测试文档

### 测试用例文档

每个测试用例应该包含：
- 测试目的
- 测试步骤
- 预期结果
- 实际结果
- 测试状态

### 测试报告

定期生成测试报告：
- 测试执行时间
- 测试通过率
- 覆盖率统计
- 问题清单

---

*最后更新时间: 2026-02-06*
*文档维护者: AI Assistant*