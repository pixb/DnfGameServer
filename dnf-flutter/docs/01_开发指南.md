# DNF Flutter客户端开发指南

## 环境搭建

### 1. 安装Flutter SDK

#### macOS

```bash
# 使用Homebrew安装
brew install flutter

# 或下载官方安装包
# https://flutter.dev/docs/get-started/install/macos

# 验证安装
flutter doctor
```

#### Windows

```bash
# 下载Flutter SDK
# https://flutter.dev/docs/get-started/install/windows

# 添加到PATH
# 环境变量 -> 系统变量 -> Path
# 添加: C:\src\flutter\bin

# 验证安装
flutter doctor
```

#### Linux

```bash
# 下载并解压Flutter SDK
cd ~
wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.16.0-stable.tar.xz
tar xf flutter_linux_3.16.0-stable.tar.xz

# 添加到PATH
export PATH="$PATH:`pwd`/flutter/bin"

# 验证安装
flutter doctor
```

### 2. 配置IDE

#### VS Code

```bash
# 安装Flutter扩展
code --install-extension Dart-Code.flutter
code --install-extension Dart-Code.dart-code
```

#### Android Studio

```
File -> Settings -> Plugins
搜索 "Flutter" 和 "Dart"
安装并重启
```

#### IntelliJ IDEA

```
File -> Settings -> Plugins
搜索 "Flutter" 和 "Dart"
安装并重启
```

### 3. 配置Android开发

```bash
# 接受Android许可
flutter doctor --android-licenses

# 配置Android SDK路径
export ANDROID_HOME=$HOME/Library/Android/sdk
export PATH=$PATH:$ANDROID_HOME/emulator
export PATH=$PATH:$ANDROID_HOME/tools
export PATH=$PATH:$ANDROID_HOME/tools/bin
```

### 4. 配置iOS开发（仅macOS）

```bash
# 安装Xcode
# 从App Store安装Xcode

# 安装CocoaPods
sudo gem install cocoapods

# 配置iOS模拟器
open -a Simulator
```

## 项目初始化

### 1. 创建Flutter项目

```bash
cd /Users/pix/dev/code/java/DnfGameServer/dnf-flutter
flutter create --org com.dnf.game --project-name dnf_game .
```

### 2. 配置pubspec.yaml

```yaml
name: dnf_game
description: DNF横版格斗游戏
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter
  
  # 游戏引擎
  flame: ^1.10.0
  flame_forge2d: ^0.12.0
  box2d_flame: ^0.8.0
  
  # 状态管理
  flutter_riverpod: ^2.4.0
  
  # 网络通信
  web_socket_channel: ^2.4.0
  protobuf: ^2.1.0
  fixnum: ^1.0.0
  
  # 工具库
  json_annotation: ^4.8.0
  path_provider: ^2.1.0
  shared_preferences: ^2.2.0
  freezed_annotation: ^2.4.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  
  # 代码生成
  build_runner: ^2.4.0
  json_serializable: ^6.7.0
  freezed: ^2.4.0
  protoc: ^21.0.0
  
  # 代码质量
  flutter_lints: ^3.0.0

flutter:
  uses-material-design: true
  assets:
    - assets/images/
    - assets/audio/
    - assets/fonts/
    - assets/data/
```

### 3. 配置代码生成

```yaml
# build.yaml
targets:
  $default:
    builders:
      json_serializable:
        options:
          explicit_to_json: true
          include_if_null: false
      freezed:
        options:
          union_key: type
          union_value_key: data
```

### 4. 配置分析选项

```yaml
# analysis_options.yaml
analyzer:
  exclude:
    - "**/*.g.dart"
    - "**/*.freezed.dart"
  errors:
    invalid_annotation_target: ignore
  strong-mode:
    implicit-casts: false
    implicit-dynamic: false
```

## 开发流程

### 1. 分支管理

```bash
# 创建功能分支
git checkout -b feature/login-page

# 开发完成后
git add .
git commit -m "feat: 实现登录页面"
git push origin feature/login-page

# 创建PR合并到main
```

### 2. 代码生成

```bash
# 生成JSON序列化代码
flutter pub run build_runner build --delete-conflicting-outputs

# 监听模式（开发时使用）
flutter pub run build_runner watch --delete-conflicting-outputs

# 生成Protobuf代码
protoc --dart_out=lib/network/protobuf/generated \
  --proto_path=lib/network/protobuf \
  lib/network/protobuf/game.proto
```

### 3. 运行项目

```bash
# 运行Debug版本
flutter run

# 运行Release版本
flutter run --release

# 运行特定设备
flutter run -d chrome          # Web
flutter run -d iPhone 14 Pro   # iOS
flutter run -d Pixel 6        # Android

# 热重载
# 在运行时按 'r' 热重载
# 按 'R' 热重启
```

### 4. 测试

```bash
# 运行所有测试
flutter test

# 运行特定测试文件
flutter test test/unit/player_test.dart

# 运行带覆盖率的测试
flutter test --coverage

# 生成覆盖率报告
genhtml coverage/lcov.info -o coverage/html
```

## 代码规范

### 1. 命名规范

```dart
// 类名：大驼峰
class GamePlayer {}

// 变量名：小驼峰
final playerName = '';

// 常量名：大写下划线
const MAX_HP = 100;

// 私有成员：下划线前缀
int _privateVar = 0;

// 文件名：小写下划线
// player_component.dart
```

### 2. 注释规范

```dart
/// 战士组件
/// 
/// 负责处理战士的显示、动画和交互
class FighterComponent extends SpriteComponent {
  /// 当前生命值
  int hp = 100;
  
  /// 移动战士
  /// 
  /// [direction] 移动方向
  /// [speed] 移动速度
  void move(Vector2 direction, double speed) {
    position += direction * speed;
  }
}
```

### 3. 格式化

```bash
# 格式化代码
dart format .

# 检查格式
dart format --output=none --set-exit-if-changed .
```

### 4. 静态分析

```bash
# 运行静态分析
flutter analyze

# 修复问题
dart fix --apply
```

## 调试技巧

### 1. Flutter DevTools

```bash
# 启动DevTools
flutter pub global activate devtools
flutter pub global run devtools
```

### 2. 日志输出

```dart
import 'package:logging/logging.dart';

final logger = Logger('Game');

void someFunction() {
  logger.info('开始执行函数');
  logger.warning('警告信息');
  logger.severe('严重错误', error, stackTrace);
}
```

### 3. 性能分析

```dart
import 'package:flutter/foundation.dart';

void expensiveOperation() {
  final stopwatch = Stopwatch()..start();
  
  // 执行操作
  doSomething();
  
  stopwatch.stop();
  debugPrint('操作耗时: ${stopwatch.elapsedMilliseconds}ms');
}
```

## 常见问题

### 1. 依赖冲突

```bash
# 清理依赖
flutter clean
flutter pub get

# 升级依赖
flutter pub upgrade
```

### 2. 构建失败

```bash
# 清理构建缓存
flutter clean

# 删除pubspec.lock
rm pubspec.lock

# 重新获取依赖
flutter pub get
```

### 3. 热重载不工作

```bash
# 重启Flutter
# 检查是否有语法错误
flutter analyze

# 使用热重启
按 'R' 而不是 'r'
```

## 最佳实践

### 1. 性能优化

```dart
// 使用const构造函数
const Text('Hello');

// 避免在build中创建对象
class MyWidget extends StatelessWidget {
  final String text;
  
  const MyWidget({required this.text});
  
  @override
  Widget build(BuildContext context) {
    return Text(text);
  }
}

// 使用ListView.builder而不是ListView
ListView.builder(
  itemCount: items.length,
  itemBuilder: (context, index) => ItemWidget(items[index]),
)
```

### 2. 内存管理

```dart
// 及时释放资源
@override
void dispose() {
  _controller.dispose();
  super.dispose();
}

// 使用对象池
class ObjectPool<T> {
  final Queue<T> _pool = Queue();
  
  T acquire() {
    return _pool.isEmpty ? create() : _pool.removeFirst();
  }
  
  void release(T obj) {
    _pool.add(obj);
  }
}
```

### 3. 网络请求

```dart
// 使用FutureBuilder处理异步
FutureBuilder<String>(
  future: fetchData(),
  builder: (context, snapshot) {
    if (snapshot.connectionState == ConnectionState.waiting) {
      return CircularProgressIndicator();
    }
    if (snapshot.hasError) {
      return Text('错误: ${snapshot.error}');
    }
    return Text(snapshot.data!);
  },
)
```

## 学习资源

### 官方文档

- Flutter文档: https://flutter.dev/docs
- Dart语言: https://dart.dev/guides
- Flame框架: https://flame-engine.org/docs

### 推荐教程

- Flutter实战: https://book.flutterchina.club/
- Flame游戏开发: https://docs.flame-engine.org/
- Flutter状态管理: https://riverpod.dev/

### 社区资源

- Flutter中文网: https://flutter.cn/
- Flutter中文社区: https://flutter-io.cn/
- GitHub: https://github.com/flutter/flutter
